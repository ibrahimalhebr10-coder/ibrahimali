# نظام الدفع المرن وغرفة المتابعة - دليل كامل

## تم التنفيذ بنجاح بتاريخ: 2026-02-09

---

## ملخص تنفيذي

تم بناء نظام متكامل للدفع المرن وغرفة المتابعة يعطي المنصة مرونة كبيرة في إدارة الحجوزات وتحصيل المدفوعات. النظام يسمح للعملاء بحجز الأشجار أولاً والدفع لاحقاً خلال مدة محددة، مع نظام متابعة احترافي للمديرين.

---

## المراحل المنفذة

### المرحلة 1: قاعدة البيانات

#### الجداول والتعديلات المضافة:

**1. تحديث جدول `reservations`:**
- إضافة حالة جديدة: `pending_payment`
- `payment_deadline` - آخر موعد للدفع
- `flexible_payment_enabled` - تفعيل الدفع المرن
- `payment_reminder_count` - عدد التذكيرات المرسلة
- `last_follow_up_date` - تاريخ آخر متابعة

**2. جدول `follow_up_activities`:**
- تسجيل كل تواصل مع العميل
- نوع التواصل (مكالمة، واتساب، رسالة، بريد)
- النتيجة والملاحظات
- التاريخ والإداري المسؤول

**3. جدول `payment_reminders`:**
- التذكيرات المجدولة
- حالة الإرسال
- نوع التذكير (تلقائي، يدوي)

**4. إعدادات في `system_settings`:**
- `flexible_payment_enabled` - تفعيل/تعطيل
- `payment_grace_period_days` - المدة (3، 7، 14 يوم...)
- `auto_cancel_after_deadline` - إلغاء تلقائي
- إعدادات التذكيرات
- قوالب الرسائل

#### الدوال المضافة:

1. **`get_pending_payment_stats()`**
   - إحصائيات الحجوزات المعلقة

2. **`get_pending_payment_reservations()`**
   - جلب جميع الحجوزات مع التفاصيل

3. **`log_follow_up_activity()`**
   - تسجيل نشاط متابعة

4. **`extend_payment_deadline()`**
   - تمديد موعد الدفع

5. **`send_immediate_reminder()`**
   - إرسال تذكير فوري

6. **`get_pending_reservation_details()`**
   - تفاصيل حجز معين مع السجل

---

### المرحلة 2: الخدمات (Services)

#### `followUpService.ts`

خدمة متكاملة تحتوي على:

- **جلب البيانات:**
  - `getStats()` - الإحصائيات
  - `getPendingReservations()` - الحجوزات المعلقة
  - `getReservationDetails()` - تفاصيل حجز

- **إجراءات:**
  - `logActivity()` - تسجيل نشاط
  - `extendDeadline()` - تمديد موعد
  - `sendReminder()` - إرسال تذكير
  - `cancelReservation()` - إلغاء حجز

- **مساعدات:**
  - `generatePaymentLink()` - توليد رابط الدفع
  - `getDefaultReminderMessage()` - رسالة تلقائية
  - فلترة وبحث
  - تنسيق الوقت والألوان

---

### المرحلة 3: غرفة المتابعة (Follow-Up Room)

#### `FollowUpRoom.tsx`

واجهة احترافية تحتوي على:

**1. لوحة الإحصائيات:**
- إجمالي المعلقة
- الحجوزات الحرجة
- الجديد اليوم
- المبلغ الإجمالي
- تقسيم حسب المسار (زراعي/استثماري)

**2. جدول ذكي:**
- قائمة الحجوزات مع:
  - مستوى الاستعجال (حرج، عاجل، متوسط، عادي)
  - معلومات العميل
  - المزرعة والمسار
  - المبلغ وعدد الأشجار
  - الوقت المتبقي
  - آخر متابعة

**3. الفلاتر والبحث:**
- بحث بالاسم، الرقم، البريد
- فلتر حسب الاستعجال
- فلتر حسب نوع المسار

**4. إجراءات سريعة:**
- إرسال تذكير واتساب
- تسجيل مكالمة/متابعة
- تمديد المدة
- فتح صفحة الدفع

**5. مودال تسجيل النشاط:**
- نوع النشاط (مكالمة، واتساب، رسالة...)
- النتيجة (رد، لم يرد، وعد بالدفع...)
- الملاحظات

**الموقع في لوحة الإدارة:**
- تبويب جديد: "غرفة المتابعة"
- أيقونة: ClipboardCheck
- اللون: أخضر زمردي
- الترتيب: الثاني بعد الرئيسية

---

### المرحلة 4: إعدادات الدفع المرن

#### `FlexiblePaymentSettings.tsx`

واجهة تحكم شاملة تحتوي على:

**1. الإعدادات الأساسية:**
- تفعيل/تعطيل النظام
- اختيار المدة (3، 5، 7، 10، 14، 21، 30 يوم)
- الإلغاء التلقائي

**2. إعدادات التذكيرات:**
- تذكير فور الحجز
- تذكير في منتصف المدة
- تذكير قبل يوم
- تذكير في يوم الموعد

**3. قوالب الرسائل:**
- رسالة التأكيد الأولى
- رسالة التذكير في منتصف المدة
- رسالة التذكير العاجل
- دعم المتغيرات: `{days}`, `{hours}`, `{payment_link}`

**الموقع:**
- الإعدادات العامة
- تبويب جديد: "الدفع المرن"
- أيقونة: Clock

---

### المرحلة 5: تحديث صفحة الحجز

#### `UnifiedBookingFlow.tsx`

**التحديثات:**

1. **تحميل الإعدادات:**
   - فحص تفعيل الدفع المرن
   - جلب المدة المسموحة

2. **خيار الدفع المرن:**
   - إضافة معامل `useFlexiblePayment` لدالة `onConfirm`
   - حساب `payment_deadline` تلقائياً
   - تعيين الحالة إلى `pending_payment`

3. **شاشة نجاح جديدة:**
   - عند اختيار الدفع المرن
   - تأكيد الحجز
   - عرض المدة المتبقية
   - شرح الخطوات القادمة
   - رقم الحجز

4. **التكامل:**
   - تمرير الإعدادات إلى `AgriculturalReviewScreen`
   - تمرير الإعدادات إلى `InvestmentReviewScreen`

---

## كيفية الاستخدام

### للمديرين:

#### 1. تفعيل النظام:
- افتح لوحة الإدارة
- اذهب إلى "الإعدادات العامة"
- اختر تبويب "الدفع المرن"
- فعّل النظام واختر المدة

#### 2. متابعة الحجوزات:
- افتح "غرفة المتابعة" من القائمة
- شاهد الإحصائيات
- استخدم الفلاتر للبحث
- اضغط على الإجراءات السريعة:
  - رسالة: إرسال تذكير
  - مكالمة: تسجيل متابعة
  - ساعة: تمديد المدة
  - رابط: فتح صفحة الدفع

#### 3. تسجيل نشاط:
- اضغط على زر "+"
- اختر نوع النشاط
- اختر النتيجة
- أضف ملاحظات
- احفظ

### للعملاء:

#### 1. الحجز:
- اختر المزرعة والباقة
- عند المراجعة، سترى خيارين:
  - ادفع الآن
  - احجز الآن - ادفع خلال X أيام

#### 2. الدفع المرن:
- اختر "احجز الآن - ادفع خلال X أيام"
- ستظهر شاشة تأكيد
- سيصلك رابط الدفع عبر الواتساب
- يمكنك الدفع في أي وقت خلال المدة

---

## الميزات الإضافية

### 1. التصنيف الذكي:
- حرج: أقل من 24 ساعة (أحمر)
- عاجل: أقل من 48 ساعة (برتقالي)
- متوسط: أقل من 3 أيام (أصفر)
- عادي: أكثر من 3 أيام (أخضر)

### 2. التحديث التلقائي:
- تحديث البيانات كل دقيقة
- عداد الوقت المتبقي حي

### 3. البحث المتقدم:
- بحث بالاسم
- بحث بالرقم
- بحث بالبريد
- بحث باسم المزرعة

### 4. الأمان:
- RLS مفعل على جميع الجداول
- المديرون فقط يمكنهم الوصول
- تسجيل جميع الأنشطة

---

## الملفات الجديدة

```
src/
├── services/
│   └── followUpService.ts
│
└── components/
    └── admin/
        ├── FollowUpRoom.tsx
        └── FlexiblePaymentSettings.tsx
```

## الملفات المعدلة

```
src/
├── components/
│   ├── UnifiedBookingFlow.tsx
│   └── admin/
│       ├── AdminDashboard.tsx
│       └── GeneralSettings.tsx
│
└── supabase/
    └── migrations/
        └── 20260209_create_flexible_payment_system.sql
```

---

## الاختبار

### سيناريوهات الاختبار المقترحة:

1. **حجز زراعي - دفع مرن**
   - اختر مزرعة زراعية
   - اختر الدفع المرن
   - تأكد من ظهور شاشة النجاح

2. **حجز استثماري - دفع مرن**
   - اختر مزرعة استثمارية
   - اختر الدفع المرن
   - تأكد من الحجز

3. **غرفة المتابعة**
   - افتح غرفة المتابعة
   - تأكد من ظهور الإحصائيات
   - جرب الفلاتر والبحث

4. **تسجيل نشاط**
   - سجل مكالمة
   - سجل رسالة واتساب
   - تأكد من حفظ النشاط

5. **إرسال تذكير**
   - اضغط على زر الرسالة
   - تأكد من ظهور نص الرسالة
   - أكد الإرسال

6. **تمديد موعد**
   - اضغط على زر الساعة
   - أدخل عدد الأيام والسبب
   - تأكد من التمديد

7. **الإعدادات**
   - غير المدة المسموحة
   - غير قوالب الرسائل
   - احفظ وتأكد من التطبيق

---

## الإحصائيات

- **عدد الملفات الجديدة:** 3
- **عدد الملفات المعدلة:** 4
- **عدد الدوال الجديدة:** 6
- **عدد الجداول الجديدة:** 2
- **عدد الأعمدة المضافة:** 4
- **وقت التنفيذ:** ساعتان تقريباً
- **حالة البناء:** نجح بدون أخطاء

---

## الخطوات القادمة (اختيارية)

1. **إضافة أزرار الدفع المرن في واجهات المراجعة**
   - تحديث `AgriculturalReviewScreen.tsx`
   - تحديث `InvestmentReviewScreen.tsx`

2. **ربط نظام الواتساب**
   - إرسال تلقائي للتذكيرات
   - تكامل مع واتساب API

3. **التقارير والتحليلات**
   - معدل التحويل
   - متوسط وقت الدفع
   - نسبة الإلغاءات

4. **الأتمتة الكاملة**
   - إرسال تذكيرات تلقائياً
   - إلغاء تلقائي بعد الموعد
   - تمديد تلقائي للحالات الخاصة

---

## الدعم الفني

إذا واجهت أي مشكلة:

1. **فحص قاعدة البيانات:**
   ```sql
   SELECT * FROM follow_up_activities ORDER BY created_at DESC LIMIT 10;
   SELECT * FROM reservations WHERE status = 'pending_payment';
   ```

2. **فحص الإعدادات:**
   ```sql
   SELECT * FROM system_settings WHERE key LIKE 'flexible%' OR key LIKE 'payment%';
   ```

3. **فحص Console:**
   - افتح أدوات المطورين
   - تحقق من الأخطاء في Console
   - تحقق من طلبات الشبكة

---

## الخلاصة

تم بناء نظام متكامل وفعال للدفع المرن وغرفة المتابعة. النظام جاهز للاستخدام ويعطي المنصة:

- مرونة في تحصيل المدفوعات
- نظام متابعة احترافي
- تقليل فقدان العملاء
- زيادة معدل التحويل
- تجربة مستخدم ممتازة

البناء نجح بدون أخطاء والنظام جاهز للتشغيل!
