# إصلاح نظام دفع الفائض المالي

## المشكلة السابقة
عند إضافة:
- 10,000 ر.س إيراد في **أشجاري الذهبية**
- 5,000 ر.س مصروف في **أشجاري الخضراء**

**الرصيد الكلي** = +5,000 ر.س ✅

لكن:
- زر "دفع فائض مالي" كان يختفي عند الضغط على تبويب **أشجاري الخضراء** ❌
- كان يعرض رصيد سالب (-5,000 ر.س) في نافذة التحويل ❌
- كان الدفع مرتبط بالتبويب النشط وليس بالرصيد الكلي ❌

## الحل المطبق

### 1. تعديل الواجهة (FarmFinancialPage.tsx)
- **زر "دفع فائض مالي"**: الآن يظهر بناءً على `totalBalance` (الرصيد الكلي) وليس `pathBalance`
- **نافذة التحويل**: تعرض الرصيد الكلي بشكل واضح مع تفاصيل أرصدة المسارين
- **التحويل**: يتم من الرصيد الكلي للمزرعة

### 2. تعديل قاعدة البيانات
تم تحديث دالة `transfer_to_platform_wallet` لدعم وضعين:

#### الوضع 1: تحويل من مسار محدد (p_path_type محدد)
```sql
SELECT transfer_to_platform_wallet(farm_id, 5000, 'investment');
```
- يتحقق من رصيد المسار المحدد فقط
- يخصم المبلغ من ذلك المسار

#### الوضع 2: تحويل من الرصيد الكلي (p_path_type = NULL) ⭐ الجديد
```sql
SELECT transfer_to_platform_wallet(farm_id, 5000, NULL);
```
- يتحقق من الرصيد الكلي للمزرعة
- يوزع الخصم بشكل ذكي بين المسارين:
  * يأخذ من المسار الإيجابي أولاً
  * إذا كانت كلا المسارين إيجابيين، يوزع بينهما
  * يسجل عملية خصم منفصلة لكل مسار

### 3. المنطق الذكي للتوزيع
عند التحويل من الرصيد الكلي:

**مثال 1: المبلغ متوفر في مسار واحد**
- الذهبية: +10,000 ر.س
- الخضراء: -5,000 ر.س
- طلب تحويل: 5,000 ر.س
- النتيجة: يخصم 5,000 من الذهبية فقط ✅

**مثال 2: المبلغ موزع**
- الذهبية: +3,000 ر.س
- الخضراء: +2,000 ر.س
- طلب تحويل: 5,000 ر.س
- النتيجة: يخصم 3,000 من الذهبية + 2,000 من الخضراء ✅

**مثال 3: مبلغ كبير**
- الذهبية: +10,000 ر.س
- الخضراء: +5,000 ر.س
- طلب تحويل: 12,000 ر.س
- النتيجة: يخصم 10,000 من الذهبية + 2,000 من الخضراء ✅

## النتيجة النهائية

### قبل الإصلاح ❌
- الزر يختفي حسب التبويب النشط
- الدفع من مسار واحد فقط
- منطق مربك للمستخدم

### بعد الإصلاح ✅
- الزر يظهر عندما يكون **الرصيد الكلي** موجب
- الدفع من **الرصيد الكلي** (توزيع ذكي)
- واجهة واضحة تعرض الرصيد الكلي وتفاصيل المسارين
- لا يرتبط بالتبويب النشط

## الملفات المعدلة
1. `src/components/admin/FarmFinancialPage.tsx` - الواجهة
2. `src/services/platformWalletService.ts` - الخدمة
3. `supabase/migrations/20260205120000_fix_wallet_transfer_use_total_balance.sql` - قاعدة البيانات

## كيفية الاختبار
1. سجل دخول كمسؤول
2. انتقل إلى قسم المالية لأي مزرعة
3. أضف إيراد في أشجاري الذهبية (مثلاً 10,000 ر.س)
4. أضف مصروف في أشجاري الخضراء (مثلاً 5,000 ر.س)
5. تأكد من ظهور الرصيد الكلي = 5,000 ر.س
6. انتقل إلى أي تبويب (خضراء أو ذهبية)
7. زر "دفع فائض مالي" يجب أن يظهر في كل الأحوال ✅
8. اضغط على "دفع فائض مالي"
9. تأكد من عرض الرصيد الكلي = 5,000 ر.س ✅
10. أدخل مبلغ التحويل وأكمل العملية
11. تأكد من خصم المبلغ بشكل صحيح ✅
