# ✅ الحل الشامل لأخطاء 401 Unauthorized

## المشاكل

### 1. تتبع النشاط (Lead Tracking)
```
❌ 401 في lead_activities
❌ لا يمكن تسجيل نشاط الزوار
```

### 2. إنشاء الحجز (Reservations)
```
❌ 401 في reservations
❌ لا يمكن للزوار الحجز
❌ خطأ: CHECK constraint user_or_guest_check
```

---

## الحلول المطبّقة

### 1. إصلاح RLS لـ lead_activities
```sql
-- سماح للجميع بتسجيل النشاط
CREATE POLICY "Allow all users to insert lead activities"
  ON lead_activities FOR INSERT
  TO anon, authenticated
  WITH CHECK (true);
```

### 2. إصلاح RLS لـ reservations
```sql
-- سماح للزوار بإنشاء حجوزات pending
CREATE POLICY "Anonymous users can create pending reservations"
  ON reservations FOR INSERT
  TO anon, authenticated
  WITH CHECK (
    (status = 'pending' OR status = 'temporary') AND
    (user_id IS NULL OR user_id = auth.uid())
  );
```

### 3. إضافة guest_id في الكود
```typescript
// إنشاء معرّف للزائر غير المسجل
const guestId = !user?.id
  ? `guest_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
  : null;

// إضافته عند الحجز
.insert({
  user_id: user?.id || null,
  guest_id: guestId,  // ✅ هذا مهم!
  ...
})
```

---

## النتيجة

### قبل
```
❌ أخطاء 401 في كل مكان
❌ الزوار لا يمكنهم الحجز
❌ تتبع النشاط لا يعمل
```

### بعد
```
✅ لا أخطاء 401
✅ الزوار يمكنهم الحجز
✅ تتبع النشاط يعمل
✅ Lead Scoring يجمع البيانات
✅ Hot Leads Dashboard يعمل
```

---

## كيفية الاختبار

1. افتح المنصة **بدون تسجيل دخول** (كزائر)
2. افتح أي مزرعة
3. اختر باقة
4. اضغط "حجز الآن"
5. ✅ يجب أن يعمل بدون أخطاء!

---

✅ **تم الإصلاح الشامل**

الآن المنصة تعمل بسلاسة للزوار والمستخدمين المسجلين!
