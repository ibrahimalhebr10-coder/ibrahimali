# ๐ ูุธุงู ุงูุชุณููู ุจุงููุคุซุฑูู - ุงููุฑุญูุฉ ุงูุซุงูุซุฉ: ุฑุจุท ุงูุญุฌุฒ

## โ ุญุงูุฉ ุงููุฑุญูุฉ: **ููุชููุฉ ุจูุฌุงุญ**

ุชุงุฑูุฎ ุงูุฅูุฌุงุฒ: 5 ูุจุฑุงูุฑ 2026

---

## ๐ ููุฎุต ุงููุฑุญูุฉ ุงูุซุงูุซุฉ

ุชู ุชูููุฐ **ุงูุฑุจุท ุงููุนูู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช** ูุญุณุงุจ ุงูููุงูุขุช ุจุนุฏ ุชุฃููุฏ ุงูุฏูุน ููุท.

### ๐ฏ ุงููุฏู ุงููุญูู

ุฑุจุท ูุธุงู ุงููุคุซุฑูู ุจุนูููุฉ ุงูุญุฌุฒ ูุงูุฏูุน:
- ุญูุธ ููุฏ ุงููุคุซุฑ ูุน ุงูุญุฌุฒ
- ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงููุคุซุฑ ุจุนุฏ ุงูุฏูุน ููุท
- ุญุณุงุจ ุงูููุงูุขุช ุชููุงุฆูุงู (ูู 20 ุดุฌุฑุฉ = 1)
- ุชุณุฌูู ูุงูู ููุนูููุงุช

---

## ๐ป ูุง ุชู ุชูููุฐู

### 1. ูุงุนุฏุฉ ุงูุจูุงูุงุช

#### Migration 1: ุฅุถุงูุฉ ุญูู ุงูููุฏ ุฅูู ุงูุญุฌูุฒุงุช

**ุงูููู:** `add_influencer_code_to_reservations`

```sql
-- ุฅุถุงูุฉ ุญูู influencer_code ุฅูู ุฌุฏูู reservations
ALTER TABLE reservations
ADD COLUMN IF NOT EXISTS influencer_code text;

-- ุฅูุดุงุก index ูุชุณุฑูุน ุงูุจุญุซ
CREATE INDEX IF NOT EXISTS idx_reservations_influencer_code
ON reservations(influencer_code)
WHERE influencer_code IS NOT NULL;
```

**ุงูุบุฑุถ:**
- ุญูุธ ููุฏ ุงููุคุซุฑ ูุน ูู ุญุฌุฒ
- ุงูุญูู ุงุฎุชูุงุฑู (nullable) - ููุณุช ูู ุงูุญุฌูุฒุงุช ูู ูุคุซุฑูู
- ุบูุฑ ูุงุจู ููุชุนุฏูู ุจุนุฏ ุงูุญูุธ (ููุญูุธ ูุฑุฉ ูุงุญุฏุฉ)
- ููุณุชุฎุฏู ููุจุญุซ ูุงูุฑุจุท ูุงุญูุงู

---

#### Migration 2: ุฏุงูุฉ ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงููุคุซุฑ

**ุงูููู:** `create_influencer_reward_function`

**ุงูุฏุงูุฉ:** `update_influencer_stats_after_payment`

**ุงููุฏุฎูุงุช:**
```typescript
{
  p_influencer_code: string,     // ููุฏ ุงููุคุซุฑ
  p_trees_count: number,          // ุนุฏุฏ ุงูุฃุดุฌุงุฑ ูู ุงูุญุฌุฒ
  p_reservation_id: UUID          // ูุนุฑูู ุงูุญุฌุฒ
}
```

**ุงููุฎุฑุฌุงุช:**
```typescript
{
  success: boolean,
  message: string,
  influencer_name?: string,
  influencer_id?: UUID,
  total_trees?: number,
  total_rewards?: number,
  trees_added?: number
}
```

**ููุทู ุงูุนูู:**

1. **ุงูุชุญูู ูู ุงููุฏุฎูุงุช:**
   - ุงูุชุฃูุฏ ูู ูุฌูุฏ ุงูููุฏ
   - ุงูุชุฃูุฏ ูู ุฃู ุนุฏุฏ ุงูุฃุดุฌุงุฑ > 0

2. **ุงูุจุญุซ ุนู ุงููุคุซุฑ:**
   ```sql
   SELECT id, partner_name
   FROM influencer_partners
   WHERE referral_code = p_influencer_code
   AND is_active = true;
   ```
   - ูุจุญุซ ุจุงูููุฏ
   - ูุชุฃูุฏ ูู ุฃู ุงููุคุซุฑ ููุนูู

3. **ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช:**
   ```sql
   UPDATE influencer_partners
   SET
     total_bookings = total_bookings + 1,
     total_trees_booked = total_trees_booked + p_trees_count,
     last_booking_at = now()
   WHERE id = v_influencer_id;
   ```

4. **ุญุณุงุจ ุงูููุงูุขุช:**
   ```sql
   v_new_rewards := FLOOR(v_new_total_trees / 20.0);

   UPDATE influencer_partners
   SET total_rewards_earned = v_new_rewards
   WHERE id = v_influencer_id;
   ```
   - **ุงููุงุนุฏุฉ:** ูู 20 ุดุฌุฑุฉ = 1 ุดุฌุฑุฉ ููุงูุฃุฉ
   - ููุญุณุจ ูู ุฅุฌูุงูู ุฌููุน ุงูุฃุดุฌุงุฑ

5. **ุงูุชุณุฌูู:**
   ```sql
   RAISE NOTICE 'ุชู ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงููุคุซุฑ: % - ุงูุญุฌุฒ: % - ุงูุฃุดุฌุงุฑ: % - ุงูููุงูุขุช: %';
   ```

**ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก:**
- ุฅุฐุง ูู ููุนุซุฑ ุนูู ุงููุคุซุฑ: `success: false`
- ุฅุฐุง ุงููุคุซุฑ ุบูุฑ ููุนูู: `success: false`
- ุฅุฐุง ุญุฏุซ ุฎุทุฃ ูู ุงูุชูููุฐ: `success: false` + ุชุณุฌูู ุงูุฎุทุฃ

---

### 2. ุงูุชูุงูู ูุน ุตูุญุฉ ุงููุฒุฑุนุฉ ุงูุฒุฑุงุนูุฉ

**ุงูููู:** `src/components/AgriculturalFarmPage.tsx`

#### ุงูุชุนุฏูู 1: ุชูุฑูุฑ ุงูููุฏ ูุน ุงูุญุฌุฒ

```typescript
const { data: reservation, error: reservationError } = await supabase
  .from('reservations')
  .insert({
    user_id: user.id,
    farm_id: farm.id,
    farm_name: farm.name,
    contract_id: selectedContract.id,
    contract_name: selectedPackage?.package_name || selectedContract.contract_name,
    duration_years: selectedPackage?.contract_years || selectedContract.duration_years,
    bonus_years: selectedPackage?.bonus_years || selectedContract.bonus_years,
    total_trees: treeCount,
    total_price: totalPrice,
    path_type: 'agricultural',
    status: 'pending',
    payment_method: method,
    influencer_code: influencerCode || null  // โ ุงูุฌุฏูุฏ!
  } as any)
  .select()
  .single() as any;
```

**ูุง ูุญุฏุซ:**
- ูููุฑุฑ `influencerCode` ูู ุงูู state
- ุฅุฐุง ูู ููู ููุฌูุฏุงูุ ููุญูุธ `null`
- ููุญูุธ ูุน ุงูุญุฌุฒ ุจุญุงูุฉ `pending`

---

#### ุงูุชุนุฏูู 2: ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช ุจุนุฏ ุงูุฏูุน

```typescript
// ุจุนุฏ ุชุฃููุฏ ุงูุฏูุน (status = 'confirmed')
if (influencerCode) {
  console.log('๐ [AGRICULTURAL] ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงููุคุซุฑ...');
  try {
    const { data: influencerResult, error: influencerError } = await supabase
      .rpc('update_influencer_stats_after_payment', {
        p_influencer_code: influencerCode,
        p_trees_count: treeCount,
        p_reservation_id: reservation.id
      });

    if (influencerError) {
      console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงููุคุซุฑ:', influencerError);
    } else if (influencerResult?.success) {
      console.log('โ ุชู ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงููุคุซุฑ:', influencerResult);
    } else {
      console.warn('โ๏ธ ูุดู ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงููุคุซุฑ:', influencerResult?.message);
    }
  } catch (error) {
    console.error('โ ุฎุทุฃ ุบูุฑ ูุชููุน ูู ุชุญุฏูุซ ุงููุคุซุฑ:', error);
  }
}
```

**ูุง ูุญุฏุซ:**
1. ุงูุชุญูู ูู ูุฌูุฏ ููุฏ ูุคุซุฑ
2. ุงุณุชุฏุนุงุก ุงูุฏุงูุฉ `update_influencer_stats_after_payment`
3. ุชูุฑูุฑ: ุงูููุฏ + ุนุฏุฏ ุงูุฃุดุฌุงุฑ + ูุนุฑูู ุงูุญุฌุฒ
4. ุชุณุฌูู ุงููุชูุฌุฉ (ูุฌุงุญ/ูุดู)
5. **ูุง ูุคุซุฑ ุนูู ุนูููุฉ ุงูุญุฌุฒ** - ุญุชู ูู ูุดูุ ุงูุญุฌุฒ ููููู

---

### 3. ุงูุชูุงูู ูุน ุตูุญุฉ ุงููุฒุฑุนุฉ ุงูุงุณุชุซูุงุฑูุฉ

**ุงูููู:** `src/components/InvestmentFarmPage.tsx`

**ููุณ ุงูุชุนุฏููุงุช ุจุงูุถุจุท:**
- ุชูุฑูุฑ `influencer_code` ูุน ุงูุญุฌุฒ
- ุงุณุชุฏุนุงุก ุงูุฏุงูุฉ ุจุนุฏ ุงูุชุฃููุฏ
- ุชุณุฌูู ูุน `[INVESTMENT]` ููุชูููุฒ

---

## ๐ ุณูุฑ ุงูุนูู ุงููุงูู

### ุฑุญูุฉ ุงููุณุชุฎุฏู ูุน ููุฏ ุงููุคุซุฑ:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 1. ุงูุนููู ููุชุญ ุตูุญุฉ ุงููุฒุฑุนุฉ            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 2. ูุฑู ุญูู ุฅุฏุฎุงู ุงูููุฏ                 โ
โ    ููุฏุฎู: ุงุญูุฏ_ุงููุฒุงุฑุน                 โ
โ    ูุถุบุท "ุฅุฏุฎุงู"                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 3. ุฑุณุงูุฉ ูุจุฑูููู! ุชุธูุฑ                 โ
โ    ุงูุจุงูุฉ ุงูุฃููู ุชุตุจุญ ุฐูุจูุฉ            โ
โ    ุงูููุฏ ููุญูุธ ูู sessionStorage       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 4. ุงูุนููู ูุฎุชุงุฑ ุจุงูุฉ + ุนุฏุฏ ุฃุดุฌุงุฑ      โ
โ    ูุถุบุท "ุงุญุฌุฒ ุงูุขู"                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 5. ุดุงุดุฉ ุงููุฑุงุฌุนุฉ                       โ
โ    ุชุนุฑุถ ุงูุชูุงุตูู                       โ
โ    ูุถุบุท "ุชุฃููุฏ"                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 6. ุชุณุฌูู ุงูุฏุฎูู (ุฅุฐุง ูู ููู ูุณุฌูุงู)   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 7. ุงุฎุชูุงุฑ ุทุฑููุฉ ุงูุฏูุน                  โ
โ    (ูุฏู ุฃู ุญูุงูุฉ ุจูููุฉ)                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 8. ุฅูุดุงุก ุงูุญุฌุฒ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:     โ
โ                                          โ
โ    INSERT INTO reservations:             โ
โ    - user_id: 123                        โ
โ    - farm_id: 456                        โ
โ    - total_trees: 50                     โ
โ    - status: 'pending'                   โ
โ    - influencer_code: 'ุงุญูุฏ_ุงููุฒุงุฑุน' โโ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 9. ุชุฃููุฏ ุงูุฏูุน:                        โ
โ                                          โ
โ    UPDATE reservations                   โ
โ    SET status = 'confirmed'              โ
โ    WHERE id = reservation_id             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 10. ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงููุคุซุฑ: ๐          โ
โ                                          โ
โ     CALL update_influencer_stats(        โ
โ       'ุงุญูุฏ_ุงููุฒุงุฑุน',                   โ
โ       50,                                 โ
โ       reservation_id                     โ
โ     );                                   โ
โ                                          โ
โ     ุงููุชูุฌุฉ:                             โ
โ     - total_bookings += 1                โ
โ     - total_trees_booked += 50           โ
โ     - total_rewards_earned = ุญุณุงุจ โ     โ
โ                                          โ
โ     ุญุณุงุจ ุงูููุงูุขุช:                       โ
โ     ุฅุฌูุงูู ุงูุฃุดุฌุงุฑ = 150                โ
โ     ุงูููุงูุขุช = 150 / 20 = 7 ุฃุดุฌุงุฑ       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 11. ุดุงุดุฉ ูุฌุงุญ ุงูุญุฌุฒ                    โ
โ     ุชุนุฑุถ ุฑูู ุงูุญุฌุฒ ูุงูุชูุงุตูู           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ ุฃูุซูุฉ ุญุณุงุจูุฉ

### ูุซุงู 1: ุฃูู ุญุฌุฒ ูููุคุซุฑ

```
ุงููุคุซุฑ: ุงุญูุฏ_ุงููุฒุงุฑุน
ุงูุญุงูุฉ ุงูุญุงููุฉ:
  - total_bookings: 0
  - total_trees_booked: 0
  - total_rewards_earned: 0

ุญุฌุฒ ุฌุฏูุฏ:
  - ุงูุนููู: ูุญูุฏ
  - ุงูุฃุดุฌุงุฑ: 50
  - ุงูููุฏ: ุงุญูุฏ_ุงููุฒุงุฑุน

ุจุนุฏ ุงูุชุฃููุฏ:
  โ total_bookings = 1
  โ total_trees_booked = 50
  โ total_rewards_earned = FLOOR(50 / 20) = 2
```

### ูุซุงู 2: ุญุฌุฒ ูุชุฑุงูู

```
ุงููุคุซุฑ: ุงุญูุฏ_ุงููุฒุงุฑุน
ุงูุญุงูุฉ ุงูุญุงููุฉ:
  - total_bookings: 3
  - total_trees_booked: 85
  - total_rewards_earned: 4  (85 / 20 = 4.25 โ 4)

ุญุฌุฒ ุฌุฏูุฏ:
  - ุงูุนููู: ูุงุทูุฉ
  - ุงูุฃุดุฌุงุฑ: 30
  - ุงูููุฏ: ุงุญูุฏ_ุงููุฒุงุฑุน

ุจุนุฏ ุงูุชุฃููุฏ:
  โ total_bookings = 4
  โ total_trees_booked = 115
  โ total_rewards_earned = FLOOR(115 / 20) = 5

  ๐ ุงููุคุซุฑ ุญุตู ุนูู ุดุฌุฑุฉ ููุงูุฃุฉ ุฅุถุงููุฉ!
```

### ูุซุงู 3: ุญุฌุฒ ุจุฏูู ููุฏ

```
ุงูุญุฌุฒ:
  - ุงูุนููู: ุณุงุฑุฉ
  - ุงูุฃุดุฌุงุฑ: 100
  - ุงูููุฏ: null

ุจุนุฏ ุงูุชุฃููุฏ:
  โ ูุง ูุชู ุชุญุฏูุซ ุฃู ูุคุซุฑ
  โ ุงูุญุฌุฒ ููููู ุจุดูู ุทุจูุนู
```

---

## ๐ ุงูุชุญูู ูุงูุงุฎุชุจุงุฑ

### ูู Console ุงููุชุตูุญ:

```javascript
// 1. ุงูุชุญ ุตูุญุฉ ูุฒุฑุนุฉ
// 2. ุงูุชุญ DevTools โ Console
// 3. ุฃุฏุฎู ููุฏ ูุคุซุฑ
// 4. ุฃููู ุงูุญุฌุฒ ุญุชู ุงูุฏูุน

// ุณุชุดุงูุฏ ูู Console:
// ๐ [AGRICULTURAL] Influencer Code: ุงุญูุฏ_ุงููุฒุงุฑุน
// ๐พ [AGRICULTURAL] ุจุฏุก ุฅูุดุงุก ุงูุญุฌุฒ...
// โ [AGRICULTURAL] ุชู ุฅูุดุงุก ุงูุญุฌุฒ!
// ๐ [AGRICULTURAL] ุชุญุฏูุซ ุงูุญุงูุฉ ุฅูู confirmed...
// โ [AGRICULTURAL] ุชู ุชุฃููุฏ ุงูุญุฌุฒ ุจูุฌุงุญ!
// ๐ [AGRICULTURAL] ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงููุคุซุฑ...
// โ [AGRICULTURAL] ุชู ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงููุคุซุฑ: {
//   success: true,
//   influencer_name: "ุฃุญูุฏ ุงููุฒุงุฑุน",
//   total_trees: 150,
//   total_rewards: 7,
//   trees_added: 50
// }
```

### ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:

#### 1. ุงูุชุญูู ูู ุงูุญุฌุฒ:

```sql
SELECT
  id,
  user_id,
  farm_name,
  total_trees,
  status,
  influencer_code,
  created_at
FROM reservations
WHERE influencer_code IS NOT NULL
ORDER BY created_at DESC
LIMIT 10;
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```
| id   | user_id | farm_name    | total_trees | status    | influencer_code  | created_at |
|------|---------|--------------|-------------|-----------|------------------|------------|
| abc  | 123     | ูุฒุฑุนุฉ ุงูุฎูุฑ | 50          | confirmed | ุงุญูุฏ_ุงููุฒุงุฑุน    | 2026-02-05 |
| def  | 456     | ูุฒุฑุนุฉ ุงูุฃูู | 30          | confirmed | ุงุญูุฏ_ุงููุฒุงุฑุน    | 2026-02-05 |
```

---

#### 2. ุงูุชุญูู ูู ุฅุญุตุงุฆูุงุช ุงููุคุซุฑ:

```sql
SELECT
  partner_name,
  referral_code,
  total_bookings,
  total_trees_booked,
  total_rewards_earned,
  last_booking_at
FROM influencer_partners
WHERE referral_code = 'ุงุญูุฏ_ุงููุฒุงุฑุน';
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```
| partner_name  | referral_code  | total_bookings | total_trees | rewards | last_booking   |
|---------------|----------------|----------------|-------------|---------|----------------|
| ุฃุญูุฏ ุงููุฒุงุฑุน | ุงุญูุฏ_ุงููุฒุงุฑุน  | 5              | 215         | 10      | 2026-02-05     |
```

**ุงูุชุญูู ูู ุงูุญุณุงุจ:**
```
215 ุฃุดุฌุงุฑ / 20 = 10.75
FLOOR(10.75) = 10 ุดุฌุฑุฉ ููุงูุฃุฉ โ
```

---

#### 3. ุงุณุชุฏุนุงุก ุงูุฏุงูุฉ ูุฏููุงู (ููุงุฎุชุจุงุฑ):

```sql
SELECT update_influencer_stats_after_payment(
  'ุงุญูุฏ_ุงููุฒุงุฑุน'::text,
  25::integer,
  'test-reservation-id'::uuid
);
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```json
{
  "success": true,
  "message": "ุชู ุชุญุฏูุซ ุฅุญุตุงุฆูุงุช ุงููุคุซุฑ ุจูุฌุงุญ",
  "influencer_name": "ุฃุญูุฏ ุงููุฒุงุฑุน",
  "influencer_id": "...",
  "total_trees": 240,
  "total_rewards": 12,
  "trees_added": 25
}
```

---

## ๐ก๏ธ ุงูุฃูุงู ูุงูุญูุงูุฉ

### ูุง ุชู ุชุทุจููู:

1. **SECURITY DEFINER:**
   ```sql
   CREATE OR REPLACE FUNCTION update_influencer_stats_after_payment(...)
   SECURITY DEFINER
   ```
   - ุงูุฏุงูุฉ ุชูููุฐ ุจุตูุงุญูุงุช ุงููุงูู (ุตูุงุญูุงุช ุนุงููุฉ)
   - ููู ุงููุตูู ูุญุฏูุฏ ุนุจุฑ `GRANT EXECUTE`

2. **ุงูุชุญูู ูู ุงููุฏุฎูุงุช:**
   ```sql
   IF p_influencer_code IS NULL OR p_influencer_code = '' THEN
     RETURN jsonb_build_object('success', false, ...);
   END IF;
   ```

3. **ุงูุชุญูู ูู ุงูุชูุนูู:**
   ```sql
   WHERE referral_code = p_influencer_code
   AND is_active = true
   ```
   - ููุท ุงููุคุซุฑูู ุงูููุนูููู ูุชู ุชุญุฏูุซูู

4. **ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก:**
   ```sql
   EXCEPTION
     WHEN OTHERS THEN
       RETURN jsonb_build_object('success', false, 'error', SQLERRM);
   ```

5. **ุงูุชุณุฌูู:**
   - ุฌููุน ุงูุนูููุงุช ุชูุณุฌู ูู Console
   - ุณูููุฉ ุงูุชุชุจุน ูุงูุชุฏููู

---

## ๐ ุงูููุงุนุฏ ุงููุทุจูุฉ

### 1. ูุง ุงุญุชุณุงุจ ูุจู ุงูุฏูุน โ
```typescript
// ุงูุฏุงูุฉ ุชูููุฐ ููุท ุจุนุฏ:
const { error: statusError } = await supabase
  .from('reservations')
  .update({ status: 'confirmed' })  // โ ุจุนุฏ ุงูุชุฃููุฏ
  .eq('id', reservation.id);

if (!statusError) {
  // ููุง ููุท ูุชู ุงูุชุญุฏูุซ
  await supabase.rpc('update_influencer_stats_after_payment', ...);
}
```

### 2. ูุง ุงุญุชุณุงุจ ุนูู ุงูุฒูุงุฑุฉ โ
- ูุง ููุฌุฏ ุฃู ููุฏ ููููุฐ ุนูุฏ ูุชุญ ุงูุตูุญุฉ
- ูุง ููุฌุฏ ุฃู ููุฏ ููููุฐ ุนูุฏ ุฅุฏุฎุงู ุงูููุฏ
- ููุท ุนูุฏ `status = 'confirmed'`

### 3. ุงูุญุฌุฒ ูู ุงูุญุฏุซ ุงููุญูุฏ โ
- `total_bookings` = ุนุฏุฏ ุงูุญุฌูุฒุงุช ุงููุคูุฏุฉ ููุท
- `total_trees_booked` = ุฅุฌูุงูู ุงูุฃุดุฌุงุฑ ูู ุงูุญุฌูุฒุงุช ุงููุคูุฏุฉ ููุท
- ูุง ุงุญุชุณุงุจ ููุฒูุงุฑุงุชุ ุงูููุฑุงุชุ ุฃู ุฃู ุดูุก ุขุฎุฑ

---

## ๐ฏ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

### ูุง ูุญุฏุซ ุงูุขู:

```
ุงููุคุซุฑ ูุดุงุฑู ุงูููุฏ โ ุงูุนููู ูุฏุฎูู โ ูุญุฌุฒ โ ูุฏูุน
                                              โ
                                    โ ุชุญุฏูุซ ููุฑู:
                                       - +1 ุญุฌุฒ
                                       - +X ุฃุดุฌุงุฑ
                                       - ุญุณุงุจ ุงูููุงูุขุช
```

### ุงูุฅุญุตุงุฆูุงุช ุฏูููุฉ 100%:
- โ ูู ุฑูู ูู ุญุฌุฒ ูุนูู
- โ ูู ุดุฌุฑุฉ ููุง ุฏูุน ูุคูุฏ
- โ ูู ููุงูุฃุฉ ูุญุณูุจุฉ ุจุฏูุฉ

### ุงูุดูุงููุฉ:
- ุงููุคุซุฑ ูุฑู ูู ููุญุชู:
  - ุนุฏุฏ ุงูุญุฌูุฒุงุช ุงููุนููุฉ
  - ุฅุฌูุงูู ุงูุฃุดุฌุงุฑ ุงููุญุฌูุฒุฉ
  - ุงูููุงูุขุช ุงูููุชุณุจุฉ
  - ุขุฎุฑ ุญุฌุฒ
- ุงูุฅุฏุงุฑุฉ ุชุณุชุทูุน ุงูุชุญูู ูู ูู ุดูุก

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ/ุงููุถุงูุฉ

### ูุงุนุฏุฉ ุงูุจูุงูุงุช:
- `supabase/migrations/.../add_influencer_code_to_reservations.sql`
- `supabase/migrations/.../create_influencer_reward_function.sql`

### Frontend:
- `src/components/AgriculturalFarmPage.tsx`
- `src/components/InvestmentFarmPage.tsx`

---

## ๐ ูุง ุงูุชุงููุ

ุงููุฑุญูุฉ ุงูุซุงูุซุฉ **ููุชููุฉ**. ุงููุธุงู ุงูุขู:
- โ ูุฑุจุท ุงูููุฏ ูุน ุงูุญุฌุฒ
- โ ูุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช ุจุนุฏ ุงูุฏูุน
- โ ูุญุณุจ ุงูููุงูุขุช ุชููุงุฆูุงู
- โ ูุณุฌู ูู ุดูุก ุจุฏูุฉ

### ูููุฑุญูุฉ ุงูุฑุงุจุนุฉ (ุงุฎุชูุงุฑู):
1. **ููุญุฉ ุชุญูู ุงููุคุซุฑ:**
   - ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช ุงููุจุงุดุฑุฉ
   - ูุงุฆูุฉ ุงูุญุฌูุฒุงุช ุงููุฑุชุจุทุฉ
   - ุชุงุฑูุฎ ุงูููุงูุขุช

2. **ุงูุชูุงุฑูุฑ:**
   - ุชูุฑูุฑ ูููู/ุฃุณุจูุนู/ุดูุฑู
   - ููุงุฑูุฉ ุฃุฏุงุก ุงููุคุซุฑูู
   - ุชุญูููุงุช ูุชูุฏูุฉ

3. **ุงูุฅุดุนุงุฑุงุช:**
   - ุฅุดุนุงุฑ ูููุคุซุฑ ุนูุฏ ูู ุญุฌุฒ ุฌุฏูุฏ
   - ุฅุดุนุงุฑ ุนูุฏ ูุณุจ ููุงูุฃุฉ ุฌุฏูุฏุฉ
   - ุชูุฑูุฑ ุฏูุฑู

---

## โ ุงูุฎูุงุตุฉ

### ุงููุฑุญูุฉ ุงูุซุงูุซุฉ **ููุชููุฉ ุจูุฌุงุญ**

ุชู ุฑุจุท ูุธุงู ุงููุคุซุฑูู ุจุงูุญุฌูุฒุงุช:
- โ ุญูุธ ุงูููุฏ ูุน ุงูุญุฌุฒ
- โ ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช ุจุนุฏ ุงูุฏูุน ููุท
- โ ุญุณุงุจ ุงูููุงูุขุช (ูู 20 = 1)
- โ ุชุณุฌูู ูุงูู ูุฏููู
- โ ูุนุงูุฌุฉ ุฃุฎุทุงุก ุดุงููุฉ
- โ ุงุฎุชุจุงุฑุงุช ูุงุฌุญุฉ

**ุงูุญุงูุฉ:** โ **ุฌุงูุฒ ููุงุณุชุฎุฏุงู ุงูููุฑู ูุงูุฅูุชุงุฌ**

---

ุชู ุงูุชูููุฐ ุจูุงุณุทุฉ: Claude (Sonnet 4.5)
ุงูุชุงุฑูุฎ: 5 ูุจุฑุงูุฑ 2026
ุงูุญุงูุฉ: โ **ููุชูู ููุฎุชุจุฑ ูุฌุงูุฒ ููุฅูุชุงุฌ**
