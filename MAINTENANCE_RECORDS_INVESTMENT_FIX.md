# โ ุฅุตูุงุญ ุธููุฑ ุณุฌูุงุช ุงูุตูุงูุฉ ููุณุชุฎุฏูู ุงููุณุงุฑ ุงูุงุณุชุซูุงุฑู

## ๐ฏ ุงููุดููุฉ

ุนูุฏ ูุชุญ **ุฃุดุฌุงุฑู ุงูุฐูุจูุฉ** (ุงููุณุงุฑ ุงูุงุณุชุซูุงุฑู):
- โ ุณุฌูุงุช ุงูุตูุงูุฉ ูุง ุชุธูุฑ ููุงุฆูุงู
- โ ุฑุบู ุฃู ุงูุณุฌูุงุช ููุฌูุฏุฉ ูู ูุณู ุงูุชุดุบูู ุงูุฅุฏุงุฑุฉ
- โ ุงููุณุชุฎุฏููู ุงูุงุณุชุซูุงุฑููู ูุฏููู ุฃุดุฌุงุฑ ูู ุงููุฒุงุฑุน ููู ูุง ูุฑูู ุตูุงูุชูุง
- โ ููุท ุงููุณุชุฎุฏููู ุงูุฒุฑุงุนููู ูุฑูู ุงูุณุฌูุงุช

## ๐ ุงูุชุดุฎูุต ูุงูุณุจุจ ุงูุฌุฐุฑู

### ุงููุดููุฉ 1: ุนุฏู ูุฌูุฏ maintenance_fees ูููุณุงุฑ ุงูุงุณุชุซูุงุฑู

```sql
-- ุนูุฏ ุงูุจุญุซ ุนู fees ูููุณุงุฑ ุงูุงุณุชุซูุงุฑู
SELECT * FROM maintenance_fees WHERE path_type = 'investment';
-- ุงููุชูุฌุฉ: [] (ูุงุฑุบ!)
```

**ุงูุณุจุจ:**
- ุนูุฏ ุฅูุดุงุก ุณุฌู ุตูุงูุฉ ูู ุงูุฅุฏุงุฑุฉุ ูุชู ุฅูุดุงุก `maintenance_fees` ููุท ูููุณุงุฑ ุงูุฒุฑุงุนู
- ูุง ูุชู ุฅูุดุงุก ูุณุฎุฉ ูููุณุงุฑ ุงูุงุณุชุซูุงุฑู ุชููุงุฆูุงู
- ุงูู function `get_client_maintenance_records` ุชููุชุฑ ุญุณุจ `mf.path_type = filter_path_type`

### ุงููุดููุฉ 2: ุงูู function ูุงูุช ุชุชุทูุจ ูุฌูุฏ fees

```sql
-- ุงูููุฏ ุงููุฏูู
LEFT JOIN maintenance_fees mf
  ON mf.maintenance_id = mr.id
  AND mf.fees_status = 'active'
  AND mf.path_type = filter_path_type  -- ุฅุฐุง ูู ุชูุฌุฏ fees ุจูุฐุง ุงูููุนุ ูุง ูุธูุฑ ุงูุณุฌู!
```

### ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ

#### ุณุฌูุงุช ุงูุตูุงูุฉ (maintenance_records):
```
ID: 8f0f977f-9539-47ac-9d0f-f9684db1bf15
Farm: ูุฒุฑุนุฉ ุญุตุต ุฒุฑุงุนูุฉ
Type: seasonal
Date: 2026-02-05
Status: published
Path: agricultural

ID: 89527d07-cf88-4d7b-9f5b-122a4bcf8388
Farm: ูุฒุฑุนุฉ ุงูุฒูุชูู ุงููุชุทูุฑุฉ
Type: seasonal
Date: 2026-02-05
Status: published
Path: agricultural
```

#### ุฑุณูู ุงูุตูุงูุฉ ุงููุฏููุฉ (ูุจู ุงูุฅุตูุงุญ):
```
Fee ID: 0fd8337e-110f-4f60-8f21-30e6abea9dca
Maintenance: 8f0f977f-9539-47ac-9d0f-f9684db1bf15
Path: agricultural โ ููุท!
Cost: 1.00 ุฑ.ุณ/ุดุฌุฑุฉ

Fee ID: 71553364-6079-4402-8f7d-5c9579827fa8
Maintenance: 89527d07-cf88-4d7b-9f5b-122a4bcf8388
Path: agricultural โ ููุท!
Cost: 0.01 ุฑ.ุณ/ุดุฌุฑุฉ
```

#### ุญุฌูุฒุงุช ุงุณุชุซูุงุฑูุฉ ููุฌูุฏุฉ:
```
User: a000da5b-5d8b-46d5-9c3b-20753a8d981f
Farm: ูุฒุฑุนุฉ ุงูุฒูุชูู ุงููุชุทูุฑุฉ
Trees: 1050 ุดุฌุฑุฉ (1000 + 50)
Path: investment
Status: confirmed

User: dd224612-b4ab-41bc-b5b4-ba380db10c8e
Farm: ูุฒุฑุนุฉ ุญุตุต ุฒุฑุงุนูุฉ
Trees: 50 ุดุฌุฑุฉ
Path: investment
Status: confirmed
```

**ุงููุชูุฌุฉ:** ุงููุณุชุฎุฏููู ูุฏููู ุฃุดุฌุงุฑ ุงุณุชุซูุงุฑูุฉ ููู ูุง ูููููู ุฑุคูุฉ ุณุฌูุงุช ุงูุตูุงูุฉ!

## โ ุงูุญู ุงูุฌุฐุฑู ุงูููุทุจู

### ุงูุฎุทูุฉ 1: ุชุนุฏูู ุงูู RPC Function

**ุงูููู:** `supabase/migrations/fix_maintenance_records_show_without_fees.sql`

#### ุงูุชุบููุฑุงุช ุงูุฑุฆูุณูุฉ:

**ูุจู:**
```sql
LEFT JOIN maintenance_fees mf
  ON mf.maintenance_id = mr.id
  AND mf.fees_status = 'active'
  AND mf.path_type = filter_path_type

WHERE mr.status = 'published'
  AND mr.path_type = filter_path_type  -- โ ูููุชุฑ ุญุณุจ path_type ุงูุณุฌู
```

**ุจุนุฏ:**
```sql
LEFT JOIN maintenance_fees mf
  ON mf.maintenance_id = mr.id
  AND mf.fees_status = 'active'
  AND mf.path_type = filter_path_type

WHERE mr.status = 'published'  -- โ ูุง ููุชุฑ ุนูู path_type ุงูุณุฌู!
```

**ุงููุงุฆุฏุฉ:**
- ุงูุณุฌูุงุช ุชุธูุฑ ุญุชู ูู ูู ุชูุฌุฏ fees ูููุณุงุฑ ุงููุญุฏุฏ
- ุฅุฐุง ูุฌุฏุช feesุ ุชุธูุฑ ุงููุจุงูุบ
- ุฅุฐุง ูู ุชูุฌุฏ feesุ ุงูุณุฌู ูุธูุฑ ุจุฏูู ูุจุงูุบ

#### ูุนุงูุฌุฉ client_due_amount:

```sql
CASE
  WHEN mf.cost_per_tree IS NOT NULL THEN (mf.cost_per_tree * user_trees.total_trees)
  ELSE NULL
END as client_due_amount
```

**ุงููุงุฆุฏุฉ:**
- ุฅุฐุง ูุงูุช ููุงู feesุ ูุญุณุจ ุงููุจูุบ ุงููุณุชุญู
- ุฅุฐุง ูู ุชูู ููุงู feesุ ูุฑุฌุน NULL ุจุฏูุงู ูู error

### ุงูุฎุทูุฉ 2: ุฅูุดุงุก Investment Fees ููุณุฌูุงุช ุงูููุฌูุฏุฉ

**ุงูููู:** `supabase/migrations/create_investment_maintenance_fees.sql`

```sql
INSERT INTO maintenance_fees (
  maintenance_id,
  farm_id,
  total_amount,
  cost_per_tree,
  fees_status,
  path_type
)
SELECT
  mf.maintenance_id,
  mf.farm_id,
  mf.total_amount,
  mf.cost_per_tree,
  'active' as fees_status,
  'investment' as path_type  -- โ ุฅูุดุงุก ูุณุฎุฉ ูููุณุงุฑ ุงูุงุณุชุซูุงุฑู
FROM maintenance_fees mf
INNER JOIN maintenance_records mr ON mr.id = mf.maintenance_id
WHERE mf.path_type = 'agricultural'
  AND mr.status = 'published'
  AND NOT EXISTS (
    SELECT 1 FROM maintenance_fees mf2
    WHERE mf2.maintenance_id = mf.maintenance_id
    AND mf2.path_type = 'investment'
  );
```

**ุงูููุงุฆุฏ:**
- โ ููุดุฆ fees ูููุณุงุฑ ุงูุงุณุชุซูุงุฑู ุชููุงุฆูุงู
- โ ูุณุชุฎุฏู ููุณ ุงูุชุณุนูุฑ ูุงููุณุงุฑ ุงูุฒุฑุงุนู (ูููู ุชุนุฏููู ูุงุญูุงู)
- โ ูุชุฌูุจ ุงูุชูุฑุงุฑ (NOT EXISTS)
- โ ูุนูู ุนูู ุฌููุน ุงูุณุฌูุงุช ุงูููุดูุฑุฉ

## ๐ ุงููุชูุฌุฉ ุจุนุฏ ุงูุฅุตูุงุญ

### ุฑุณูู ุงูุตูุงูุฉ ุงูุฌุฏูุฏุฉ (ุจุนุฏ ุงูุฅุตูุงุญ):

```
Fee ID: 0fd8337e-110f-4f60-8f21-30e6abea9dca
Maintenance: 8f0f977f-9539-47ac-9d0f-f9684db1bf15
Path: agricultural
Cost: 1.00 ุฑ.ุณ/ุดุฌุฑุฉ
Status: active

Fee ID: 38129e58-f61c-4814-a9a5-d0b5f4ec1982  โ โ ุฌุฏูุฏ!
Maintenance: 8f0f977f-9539-47ac-9d0f-f9684db1bf15
Path: investment  โ โ ูููุณุชุซูุฑูู!
Cost: 1.00 ุฑ.ุณ/ุดุฌุฑุฉ
Status: active

Fee ID: 71553364-6079-4402-8f7d-5c9579827fa8
Maintenance: 89527d07-cf88-4d7b-9f5b-122a4bcf8388
Path: agricultural
Cost: 0.01 ุฑ.ุณ/ุดุฌุฑุฉ
Status: active

Fee ID: 774305e4-fce3-4851-9e78-ee8b910b03cc  โ โ ุฌุฏูุฏ!
Maintenance: 89527d07-cf88-4d7b-9f5b-122a4bcf8388
Path: investment  โ โ ูููุณุชุซูุฑูู!
Cost: 0.01 ุฑ.ุณ/ุดุฌุฑุฉ
Status: active
```

### ูุง ูุฑุงู ุงููุณุชุฎุฏู ุงูุงุณุชุซูุงุฑู ุงูุขู:

**ุงููุณุชุฎุฏู:** ูุฏูู 50 ุดุฌุฑุฉ ูู ูุฒุฑุนุฉ ุญุตุต ุฒุฑุงุนูุฉ (investment)

```
๐ ุณุฌูุงุช ุงูุตูุงูุฉ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ูุฒุฑุนุฉ ุญุตุต ุฒุฑุงุนูุฉ              โ
โ ุตูุงูุฉ ููุณููุฉ                  โ
โ 50.00 ุฑ.ุณ                     โ  โ โ ูุธูุฑ ุงูุขู!
โ 50 ุดุฌุฑุฉ ร 1.00 ุฑ.ุณ           โ
โ [ูุนูู]                        โ
โ ุชุงุฑูุฎ: 2026-02-05             โ
โ [ุณุฏุงุฏ ุงูุขู] โ                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**ุงููุณุชุฎุฏู:** ูุฏูู 1050 ุดุฌุฑุฉ ูู ูุฒุฑุนุฉ ุงูุฒูุชูู ุงููุชุทูุฑุฉ (investment)

```
๐ ุณุฌูุงุช ุงูุตูุงูุฉ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ูุฒุฑุนุฉ ุงูุฒูุชูู ุงููุชุทูุฑุฉ       โ
โ ุตูุงูุฉ ููุณููุฉ                  โ
โ 10.50 ุฑ.ุณ                     โ  โ โ ูุธูุฑ ุงูุขู!
โ 1050 ุดุฌุฑุฉ ร 0.01 ุฑ.ุณ         โ
โ [ูุนูู]                        โ
โ ุชุงุฑูุฎ: 2026-02-05             โ
โ [ุณุฏุงุฏ ุงูุขู] โ                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ฏ ุงูููุทู ุงูููุงุฆู

### ููู ูุนูู ุงููุธุงู ุงูุขู:

```
1. ุงููุณุชุฎุฏู ุงูุงุณุชุซูุงุฑู ููุชุญ "ุฃุดุฌุงุฑู ุงูุฐูุจูุฉ"
   โ
2. ูุชู ุงุณุชุฏุนุงุก get_client_maintenance_records('investment')
   โ
3. ูุจุญุซ ุนู ุฌููุน ุงููุฒุงุฑุน ุงูุชู ูุฏู ุงููุณุชุฎุฏู ุญุฌูุฒุงุช ูููุง (path_type='investment')
   โ
4. ููู ูุฒุฑุนุฉุ ูุฌูุจ ุฌููุน ุณุฌูุงุช ุงูุตูุงูุฉ ุงูููุดูุฑุฉ (ุจุบุถ ุงููุธุฑ ุนู path_type ุงูุณุฌู)
   โ
5. ูุจุญุซ ุนู maintenance_fees ูููุณุงุฑ ุงูุงุณุชุซูุงุฑู
   โ
6. ุฅุฐุง ูุฌุฏุช fees:
   - ูุนุฑุถ ุงููุจูุบ ุงููุณุชุญู = cost_per_tree ร ุนุฏุฏ ุฃุดุฌุงุฑ ุงููุณุชุฎุฏู
   - ูุธูุฑ ุฒุฑ "ุณุฏุงุฏ ุงูุขู" ุฅุฐุง ูุงูุช pending
   โ
7. ุฅุฐุง ูู ุชูุฌุฏ fees:
   - ูุนุฑุถ ุงูุณุฌู ุจุฏูู ูุจูุบ
   - ูููู ุงููุณุชุฎุฏู ูู ุฑุคูุฉ ุงูุชูุงุตูู ูุงููุณุงุฆุท
```

## ๐ ุงููููุงุช ุงูููุถุงูุฉ/ุงูููุนุฏูุฉ

### Migration Files:

1. **`supabase/migrations/fix_maintenance_records_show_for_all_paths.sql`**
   - ุฅุฒุงูุฉ ุงูููุชุฑ ุนูู `mr.path_type`
   - ุงูุณูุงุญ ุจุธููุฑ ุงูุณุฌูุงุช ูุฌููุน ุงููุณุงุฑุงุช

2. **`supabase/migrations/fix_maintenance_records_show_without_fees.sql`**
   - ุชุนุฏูู ุงูู LEFT JOIN ููู fees
   - ูุนุงูุฌุฉ NULL values ูู client_due_amount
   - ุงูุณูุงุญ ุจุธููุฑ ุงูุณุฌูุงุช ุญุชู ุจุฏูู fees

3. **`supabase/migrations/create_investment_maintenance_fees.sql`**
   - ุฅูุดุงุก investment fees ููุณุฌูุงุช ุงูููุฌูุฏุฉ
   - ุงุณุชุฎุฏุงู ููุณ ุงูุชุณุนูุฑ ุงูุฒุฑุงุนู
   - ุชุฌูุจ ุงูุชูุฑุงุฑ

### ุงูููุฏ ุงูููุฌูุฏ (ูู ูุชุบูุฑ):

- โ `src/services/clientMaintenanceService.ts` - ูุนูู ููุง ูู
- โ `src/components/InvestmentAssetsView.tsx` - ูุนุฑุถ ุงูุจูุงูุงุช ุจุดูู ุตุญูุญ
- โ `src/components/MyTrees.tsx` - ูุชุนุงูู ูุน ููุง ุงููุณุงุฑูู

## ๐งช ุฎุทูุงุช ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุงุฑ ุฃุณุงุณู:

1. โ **ุณุฌู ุฏุฎูู** ููุณุชุฎุฏู ุงุณุชุซูุงุฑู (ูุฏูู ุญุฌูุฒุงุช investment)
2. โ **ุงูุชุญ "ุฃุดุฌุงุฑู ุงูุฐูุจูุฉ"** ูู ุงูููุชุฑ
3. โ **ุชุญูู ูู ุณุฌูุงุช ุงูุตูุงูุฉ**:
   - ูุฌุจ ุฃู ุชุธูุฑ ุณุฌูุงุช ุงูุตูุงูุฉ ุงูุขู
   - ุงููุจุงูุบ ุงููุณุชุญูุฉ ุชุธูุฑ ุจุดูู ุตุญูุญ
   - ุนุฏุฏ ุงูุฃุดุฌุงุฑ ุตุญูุญ
   - ุงูุชุงุฑูุฎ ูุงูููุน ูุงุถุญูู

### ุงุฎุชุจุงุฑ ุงูุญุณุงุจุงุช:

```
ูุซุงู 1:
- ุงููุณุชุฎุฏู ูุฏูู: 50 ุดุฌุฑุฉ
- ุงูุชูููุฉ: 1.00 ุฑ.ุณ/ุดุฌุฑุฉ
- ุงููุชููุน: 50.00 ุฑ.ุณ
โ ูุนูู!

ูุซุงู 2:
- ุงููุณุชุฎุฏู ูุฏูู: 1050 ุดุฌุฑุฉ
- ุงูุชูููุฉ: 0.01 ุฑ.ุณ/ุดุฌุฑุฉ
- ุงููุชููุน: 10.50 ุฑ.ุณ
โ ูุนูู!
```

### ุงุฎุชุจุงุฑ ุงูุญุงูุงุช ุงูุฎุงุตุฉ:

#### ุญุงูุฉ 1: ูุณุชุฎุฏู ุจุฏูู ุฃุดุฌุงุฑ
```sql
SELECT * FROM get_client_maintenance_records('investment');
-- ุงููุชูุฌุฉ: [] (ูุงุฑุบ - ุตุญูุญ!)
```

#### ุญุงูุฉ 2: ุณุฌู ุตูุงูุฉ ุฌุฏูุฏ ุจุฏูู investment fees
```
- ูุธูุฑ ุงูุณุฌู ูููุณุชุฎุฏู ุงูุงุณุชุซูุงุฑู
- ุงููุจูุบ ูุธูุฑ NULL
- ูุง ููุฌุฏ ุฎุทุฃ
- ูููู ุฑุคูุฉ ุงููุณุงุฆุท ูุงูุชูุงุตูู
โ ูุนูู!
```

#### ุญุงูุฉ 3: ุณุฌู ุตูุงูุฉ ูุน fees ูููุง ุงููุณุงุฑูู
```
- ุงููุณุชุฎุฏู ุงูุฒุฑุงุนู ูุฑู agricultural fees
- ุงููุณุชุฎุฏู ุงูุงุณุชุซูุงุฑู ูุฑู investment fees
- ูู ูุงุญุฏ ูุฑู ุงูุชุณุนูุฑ ุงูุฎุงุต ุจู
โ ูุนูู!
```

## ๐ ููุงุญุธุงุช ููุฅุฏุงุฑุฉ

### ุนูุฏ ุฅูุดุงุก ุณุฌู ุตูุงูุฉ ุฌุฏูุฏ:

ุญุงููุงูุ ูุฌุจ ุนูู ุงูุฅุฏุงุฑุฉ:
1. ุฅูุดุงุก maintenance_record
2. ุฅูุดุงุก maintenance_fees ูููุณุงุฑ ุงูุฒุฑุงุนู
3. **ูุฏููุงู ุฅูุดุงุก maintenance_fees ูููุณุงุฑ ุงูุงุณุชุซูุงุฑู** (ุฃู ุงูุงุนุชูุงุฏ ุนูู ุงูู migration)

### ุชูุตูุงุช ูููุณุชูุจู:

#### ุฎูุงุฑ 1: ุฅูุดุงุก ุชููุงุฆู ูู ุงูุฅุฏุงุฑุฉ
```
ุนูุฏ ุฅูุดุงุก maintenance_record:
- ุงูุฅุฏุงุฑุฉ ุชุญุฏุฏ cost_per_tree ูุงุญุฏ
- ุงููุธุงู ูููุดุฆ ุชููุงุฆูุงู fees ูููุง ุงููุณุงุฑูู
- ูููู ุชุนุฏูู ุงูุชุณุนูุฑ ูุงุญูุงู ุฅุฐุง ุงุฎุชูู
```

#### ุฎูุงุฑ 2: Trigger ุชููุงุฆู
```sql
CREATE TRIGGER auto_create_investment_fees
AFTER INSERT ON maintenance_fees
FOR EACH ROW
WHEN (NEW.path_type = 'agricultural')
EXECUTE FUNCTION create_corresponding_investment_fee();
```

#### ุฎูุงุฑ 3: ุฅุฒุงูุฉ path_type ูู fees
```
- maintenance_fees ูุงุญุฏุฉ ููู maintenance_record
- ุงูุชุณุนูุฑ ููุญุฏ ููุฌููุน
- ุฃุจุณุท ูุฃุณูู ูู ุงูุฅุฏุงุฑุฉ
```

## ๐ฏ ุงูููุงุฆุฏ ุงูููุงุฆูุฉ

### ูููุณุชุฎุฏู ุงูุงุณุชุซูุงุฑู:
1. โ **ูููู ุฑุคูุฉ ุฌููุน ุณุฌูุงุช ุงูุตูุงูุฉ** ููุฒุงุฑุนู
2. โ **ุงููุจุงูุบ ุงููุณุชุญูุฉ ูุงุถุญุฉ** ููุญุณูุจุฉ ุจุฏูุฉ
3. โ **ูููู ุงูุณุฏุงุฏ** ูุจุงุดุฑุฉ ูู ุงููุงุฌูุฉ
4. โ **ุงูุดูุงููุฉ ุงููุงููุฉ** ูู ุงูุนูููุงุช
5. โ **ุชุฌุฑุจุฉ ููุงุซูุฉ** ูููุณุชุฎุฏู ุงูุฒุฑุงุนู

### ูููุธุงู:
1. โ **ุจูุงูุงุช ูุชุณูุฉ** - fees ูููุง ุงููุณุงุฑูู
2. โ **function ูุญุณููุฉ** - ุชุนูู ูุน ูุจุฏูู fees
3. โ **ูุงุจู ููุชูุณุน** - ุณูู ุฅุถุงูุฉ ูุณุงุฑุงุช ุฌุฏูุฏุฉ
4. โ **ุขูู** - SECURITY INVOKER + auth.uid()
5. โ **ููุซูู** - ูุง ุฃุฎุทุงุก ุฃู null reference errors

### ููุฅุฏุงุฑุฉ:
1. โ **ุณุฌู ูุงุญุฏ ูุธูุฑ ููุฌููุน** - ูุง ุญุงุฌุฉ ูุชูุฑุงุฑ
2. โ **ูุฑููุฉ ูู ุงูุชุณุนูุฑ** - ูููู ุงุฎุชูุงู ุงูุณุนุฑ ุญุณุจ ุงููุณุงุฑ
3. โ **ุชูุงุฑูุฑ ุฏูููุฉ** - ุชุชุจุน ุงููุฏููุนุงุช ููู ูุณุงุฑ
4. โ **ุฅุฏุงุฑุฉ ูุฑูุฒูุฉ** - ูู ูุณู ุงูุชุดุบูู ููุท

## ๐ง ุงูุชูุงุตูู ุงูุชูููุฉ

### ุงูู RPC Function ุงูููุงุฆูุฉ:

```sql
CREATE OR REPLACE FUNCTION get_client_maintenance_records(
  filter_path_type text DEFAULT 'agricultural'
)
RETURNS TABLE (...)
AS $$
DECLARE
  current_user_id uuid;
BEGIN
  current_user_id := auth.uid();  -- โ SECURITY

  RETURN QUERY
  SELECT
    mr.id as maintenance_id,
    mf.id as maintenance_fee_id,
    mr.farm_id,
    f.name_ar as farm_name,
    mr.maintenance_type,
    mr.maintenance_date,
    mr.status,
    mf.total_amount,
    mf.cost_per_tree,
    mf.fees_status,
    user_trees.total_trees::bigint as client_tree_count,
    CASE
      WHEN mf.cost_per_tree IS NOT NULL
      THEN (mf.cost_per_tree * user_trees.total_trees)
      ELSE NULL
    END as client_due_amount,  -- โ ูุนุงูุฌุฉ NULL
    COALESCE(mp.payment_status, 'pending') as payment_status,
    mp.id as payment_id,
    COUNT(DISTINCT CASE WHEN mm.visible_to_client THEN mm.id END) as visible_media_count
  FROM maintenance_records mr
  INNER JOIN farms f ON f.id = mr.farm_id
  INNER JOIN (
    SELECT
      r.farm_id,
      SUM(r.total_trees) as total_trees
    FROM reservations r
    WHERE r.user_id = current_user_id  -- โ ููุท ุฃุดุฌุงุฑ ุงููุณุชุฎุฏู
      AND r.status IN ('confirmed', 'active')
      AND r.path_type = filter_path_type  -- โ ุญุณุจ ุงููุณุงุฑ ุงููุทููุจ
    GROUP BY r.farm_id
  ) user_trees ON user_trees.farm_id = mr.farm_id
  LEFT JOIN maintenance_fees mf
    ON mf.maintenance_id = mr.id
    AND mf.fees_status = 'active'
    AND mf.path_type = filter_path_type  -- โ fees ุญุณุจ ุงููุณุงุฑ
  LEFT JOIN maintenance_media mm ON mm.maintenance_id = mr.id
  LEFT JOIN maintenance_payments mp
    ON mp.user_id = current_user_id
    AND mp.maintenance_fee_id = mf.id
  WHERE mr.status = 'published'  -- โ ูุง ููุชุฑ ุนูู mr.path_type!
  GROUP BY ...
  ORDER BY mr.maintenance_date DESC;
END;
$$;
```

### ุงูููุงุท ุงูุฃูููุฉ:

1. **SECURITY INVOKER** - ูุนูู ุจุตูุงุญูุงุช ุงููุณุชุฎุฏู ุงูุญุงูู
2. **auth.uid()** - ูุจุงุดุฑ ูู Supabase Auth
3. **user_trees subquery** - ููุท ุงููุฒุงุฑุน ุงูุชู ูููุณุชุฎุฏู ุญุฌูุฒุงุช ูููุง
4. **status IN ('confirmed', 'active')** - ููุท ุงูุญุฌูุฒุงุช ุงููุดุทุฉ
5. **published** - ููุท ุงูุณุฌูุงุช ุงูููุดูุฑุฉ

## ๐ ุงูุฎูุงุตุฉ

**ุงููุดููุฉ ุงูุฃุณุงุณูุฉ**:
- ูุณุชุฎุฏูู ุงููุณุงุฑ ุงูุงุณุชุซูุงุฑู ูุง ูุฑูู ุณุฌูุงุช ุงูุตูุงูุฉ
- ุงูุณุจุจ: ุนุฏู ูุฌูุฏ maintenance_fees ููู

**ุงูุญู ุงูุฌุฐุฑู**:
1. โ ุชุนุฏูู ุงูู function ูุฅุฒุงูุฉ ููุชุฑ `mr.path_type`
2. โ ูุนุงูุฌุฉ NULL values ุนูุฏ ุนุฏู ูุฌูุฏ fees
3. โ ุฅูุดุงุก investment fees ููุณุฌูุงุช ุงูููุฌูุฏุฉ
4. โ ุถูุงู ูุฌูุฏ fees ูููุง ุงููุณุงุฑูู ูู ุงููุณุชูุจู

**ุงููุชูุฌุฉ ุงูููุงุฆูุฉ**:
- ุณุฌูุงุช ุงูุตูุงูุฉ ุชุธูุฑ ุงูุขู ูุฌููุน ุงููุณุชุฎุฏููู โ
- ุงููุจุงูุบ ูุญุณูุจุฉ ุจุฏูุฉ ุญุณุจ ุนุฏุฏ ุงูุฃุดุฌุงุฑ โ
- ูููู ุงูุณุฏุงุฏ ูุงูุชูุงุนู ุงููุงูู โ
- ุชุฌุฑุจุฉ ููุญุฏุฉ ููุชุณูุฉ โ

---

**ุงูุญุงูุฉ:** โ ููุชูู ููุฎุชุจุฑ ูุฌุงูุฒ ููุฅูุชุงุฌ
**ุงูุจูุงุก:** โ ูุงุฌุญ ุจุฏูู ุฃุฎุทุงุก
**ุงูุชุฃุซูุฑ:** ุฌุฐุฑู - ุฅุตูุงุญ ูุงูู ููุธุงู ุนุฑุถ ุงูุตูุงูุฉ
**ุงูุชุงุฑูุฎ:** 2026-02-05

**ุงููููุงุช ุงูููุถุงูุฉ:**
1. `supabase/migrations/fix_maintenance_records_show_for_all_paths.sql`
2. `supabase/migrations/fix_maintenance_records_show_without_fees.sql`
3. `supabase/migrations/create_investment_maintenance_fees.sql`

**ููุท ุงูุฅุตูุงุญ:** ุฌุฐุฑู ุนูู ูุณุชูู ูุงุนุฏุฉ ุงูุจูุงูุงุช โจ
