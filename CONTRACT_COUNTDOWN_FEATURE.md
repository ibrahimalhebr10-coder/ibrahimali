# ميزة العداد التنازلي لعمر العقد

## نظرة عامة
تم إضافة نظام عداد تنازلي ديناميكي يعرض الوقت المتبقي في عمر العقد لكل حجز نشط.

## المزايا الرئيسية

### 1. عرض الوقت المتبقي
- **سنوات**: عدد السنوات الكاملة المتبقية
- **شهور**: عدد الأشهر المتبقية
- **أيام**: عدد الأيام المتبقية
- **تحديث تلقائي**: يتم تحديث العداد كل ساعة

### 2. مراحل العقد بألوان مميزة

#### المرحلة الأولى: العقد النشط (أخضر)
- **اللون**: أخضر
- **الأيقونة**: علامة صح (CheckCircle)
- **الوصف**: "العقد نشط"
- **المدة**: من بداية العقد حتى نهاية السنوات الرسمية

#### المرحلة الثانية: السنوات المجانية (أزرق)
- **اللون**: أزرق
- **الأيقونة**: هدية (Gift)
- **الوصف**: "السنوات المجانية"
- **المدة**: من نهاية العقد الرسمي حتى نهاية السنوات المجانية

#### المرحلة الثالثة: قرب الانتهاء (أحمر)
- **اللون**: أحمر مع تأشير وامض
- **الأيقونة**: تنبيه (AlertCircle)
- **الوصف**: "قرب الانتهاء"
- **المدة**: آخر 6 شهور من العقد
- **تأشير**: أيقونة وامضة للتنبيه

#### المرحلة الرابعة: منتهي (رمادي)
- **اللون**: رمادي
- **الأيقونة**: ساعة (Clock)
- **الوصف**: "منتهي"
- **المدة**: بعد انتهاء جميع سنوات العقد

## التطبيق التقني

### قاعدة البيانات
تم إضافة حقل `contract_start_date` لجدول `reservations`:
- تخزين تاريخ بداية العقد الفعلي
- تعيين تلقائي عند الموافقة على الحجز
- استخدام trigger لضمان تعيين القيمة

### المكونات الجديدة

#### 1. ContractCountdown Component
مكون مستقل مسؤول عن:
- حساب الوقت المتبقي
- تحديد المرحلة الحالية
- عرض العداد بالتنسيق المناسب
- التحديث التلقائي

#### 2. التكامل في MyReservations
- عرض العداد في بطاقات الحجوزات النشطة
- ظهور أسفل حالة "نشط"
- تصميم متجاوب مع باقي عناصر البطاقة

## تجربة المستخدم

### للمزارع
- معرفة المدة المتبقية لاستفادته من المزرعة
- تنبيه مبكر قبل 6 أشهر من الانتهاء
- رؤية واضحة للسنوات المجانية

### للمستثمر
- متابعة عمر الاستثمار
- تخطيط للتجديد أو الخروج
- معرفة متى يدخل في السنوات المجانية

## الحسابات

### حساب نهاية العقد الرسمي
```
تاريخ البداية + (عدد السنوات الرسمية)
```

### حساب نهاية العقد الكلي
```
تاريخ البداية + (عدد السنوات الرسمية + عدد السنوات المجانية)
```

### حساب بداية مرحلة "قرب الانتهاء"
```
تاريخ النهاية الكلي - 6 أشهر
```

## الملفات المعدلة

1. **Migration**: `add_contract_start_date_to_reservations.sql`
   - إضافة حقل contract_start_date
   - إنشاء trigger للتعيين التلقائي

2. **Component**: `ContractCountdown.tsx`
   - مكون العداد التنازلي الجديد

3. **Component**: `MyReservations.tsx`
   - دمج العداد في بطاقات الحجوزات
   - تحديث الـ interface

## الميزات المستقبلية المقترحة

1. **إشعارات تلقائية**
   - إرسال إشعار قبل شهر من الانتهاء
   - إرسال إشعار عند دخول السنوات المجانية

2. **إحصائيات**
   - عرض متوسط عمر العقود
   - عدد العقود القريبة من الانتهاء

3. **خيارات التجديد**
   - عرض خيار التجديد المبكر
   - عروض خاصة للتجديد

## الاختبار

للاختبار الكامل:
1. إنشاء حجز جديد
2. الموافقة عليه (status = 'active')
3. التحقق من ظهور العداد
4. اختبار المراحل المختلفة بتغيير contract_start_date يدوياً في قاعدة البيانات

---

تاريخ الإنشاء: 3 فبراير 2026
