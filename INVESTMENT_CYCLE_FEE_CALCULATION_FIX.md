# ุฅุตูุงุญ ุญุณุงุจ ุฑุณูู ุงูุฏูุฑุงุช ุงูุงุณุชุซูุงุฑูุฉ - ุงูุชูุงู

## ุงููุดููุฉ

ูู ููุญุฉ ุงูุชุญูู > ูุณู ุงูุชุดุบูู > ุชุจููุจ **ุฃุดุฌุงุฑู ุงูุฐูุจูุฉ**ุ ุนูุฏ ุฅูุดุงุก ุฏูุฑุฉ ุงุณุชุซูุงุฑูุฉ ุฌุฏูุฏุฉุ ูุงู ูุชู ุญุณุงุจ ุงูุชูููุฉ ูุชูุฒูุนูุง ุนูู **ุฌููุน ุฃุดุฌุงุฑ ุงููุฒุฑุนุฉ** ุจุฏูุงู ูู ุชูุฒูุนูุง ููุท ุนูู **ุงูุฃุดุฌุงุฑ ุงููุญุฌูุฒุฉ ูู ุงููุณุงุฑ ุงูุงุณุชุซูุงุฑู (ุฃุดุฌุงุฑู ุงูุฐูุจูุฉ)**.

## ุงูุญู ุงูููููุฐ

### 1. ุชุญุฏูุซ ุงุณุชูุฑุงุฏ ุงูุฎุฏูุฉ ูู InvestmentCycleWizard

**ุงูููู:** `src/components/admin/InvestmentCycleWizard.tsx`

ุชู ุชุบููุฑ ุงุณุชูุฑุงุฏ `farmService` ุฅูู `operationsService`:

```typescript
// ูุจู:
import { farmService } from '../../services/farmService';

// ุจุนุฏ:
import { operationsService } from '../../services/operationsService';
```

### 2. ุชุญุฏูุซ ุฏุงูุฉ loadFarms

```typescript
const loadFarms = async () => {
  try {
    const data = await operationsService.getFarms();  // ุชู ุงูุชุญุฏูุซ
    setFarms(data || []);
  } catch (error) {
    console.error('Error loading farms:', error);
  }
};
```

ุงูุขู ุชุณุชุฎุฏู `operationsService.getFarms()` ุงูุชู ุชุฌูุจ ุนุฏุฏ ุงูุฃุดุฌุงุฑ ุงููุญุฌูุฒุฉ ูู ูู ูุณุงุฑ:
- `reserved_agricultural_trees`: ุงูุฃุดุฌุงุฑ ุงููุญุฌูุฒุฉ ูู ุฃุดุฌุงุฑู ุงูุฎุถุฑุงุก
- `reserved_investment_trees`: ุงูุฃุดุฌุงุฑ ุงููุญุฌูุฒุฉ ูู ุฃุดุฌุงุฑู ุงูุฐูุจูุฉ

### 3. ุฅุตูุงุญ ุญุณุงุจ ุชูููุฉ ุงูุดุฌุฑุฉ

**ูุจู:**
```typescript
const selectedFarm = farms.find(f => f.id === formData.farm_id);
const costPerTree = selectedFarm && selectedFarm.total_trees > 0
  ? (formData.total_amount / selectedFarm.total_trees).toFixed(2)
  : '0.00';
```

**ุจุนุฏ:**
```typescript
const selectedFarm = farms.find(f => f.id === formData.farm_id);
const reservedInvestmentTrees = selectedFarm?.reserved_investment_trees || 0;
const costPerTree = selectedFarm && reservedInvestmentTrees > 0
  ? (formData.total_amount / reservedInvestmentTrees).toFixed(2)
  : '0.00';
```

### 4. ุชุญุณูู ูุงุฌูุฉ ุงููุณุชุฎุฏู

#### ุฃ. ุชุญุฏูุซ ูุงุฆูุฉ ุงููุฒุงุฑุน ุงูููุณุฏูุฉ

```
ุงุณู ุงููุฒุฑุนุฉ (200 ูุญุฌูุฒุฉ ูู 1000 ุดุฌุฑุฉ)
```

#### ุจ. ุนุฑุถ ุชูุงุตูู ุงูุญุณุงุจ

ุนูุฏูุง ุชูุฌุฏ ุฃุดุฌุงุฑ ูุญุฌูุฒุฉ:
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ุญุณุงุจ ุงูุชูููุฉ ููุฃุดุฌุงุฑ ุงููุญุฌูุฒุฉ               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  ุชูููุฉ ุงูุดุฌุฑุฉ: 50.00 ุฑูุงู                     โ
โ  (ุงููุจูุบ 10000 รท 200 ุดุฌุฑุฉ ูุญุฌูุฒุฉ ูู ุฃุดุฌุงุฑู   โ
โ   ุงูุฐูุจูุฉ)                                     โ
โ                                                โ
โ  ุฅุฌูุงูู ุฃุดุฌุงุฑ ุงููุฒุฑุนุฉ: 1,000                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

ุนูุฏูุง ูุง ุชูุฌุฏ ุฃุดุฌุงุฑ ูุญุฌูุฒุฉ:
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ๏ธ ุชุญุฐูุฑ: ูุง ุชูุฌุฏ ุฃุดุฌุงุฑ ูุญุฌูุฒุฉ              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  ูุง ููุฌุฏ ุญุฌูุฒุงุช ูู ูุณุงุฑ ุฃุดุฌุงุฑู ุงูุฐูุจูุฉ ููุฐู  โ
โ  ุงููุฒุฑุนุฉ. ูู ูุชู ุงุญุชุณุงุจ ุฑุณูู ุนูู ุงููุณุชุซูุฑูู.  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ูุซุงู ุนููู

### ุณููุงุฑูู ุงูุงุฎุชุจุงุฑ

**ูุฒุฑุนุฉ ุจูุง:**
- ุฅุฌูุงูู ุงูุฃุดุฌุงุฑ: 1000 ุดุฌุฑุฉ
- ุญุฌูุฒุงุช ูู ุฃุดุฌุงุฑู ุงูุฎุถุฑุงุก: 200 ุดุฌุฑุฉ
- ุญุฌูุฒุงุช ูู ุฃุดุฌุงุฑู ุงูุฐูุจูุฉ: 150 ุดุฌุฑุฉ

**ุนูุฏ ุฅูุดุงุก ุฏูุฑุฉ ุงุณุชุซูุงุฑูุฉ ุจูุจูุบ 15,000 ุฑูุงู:**

โ **ุงูุณููู ุงูุฎุงุทุฆ ุงูุณุงุจู:**
```
ุชูููุฉ ุงูุดุฌุฑุฉ = 15,000 รท 1000 = 15 ุฑูุงู
ุฌููุน ุงูุฃุดุฌุงุฑ ุชุญูู ุงูุชูููุฉ ุจุงูุชุณุงูู (ุฎุทุฃ!)
```

โ **ุงูุณููู ุงูุตุญูุญ ุงูุขู:**
```
ุชูููุฉ ุงูุดุฌุฑุฉ = 15,000 รท 150 = 100 ุฑูุงู
ููุท ุงูุฃุดุฌุงุฑ ุงููุญุฌูุฒุฉ ูู ุฃุดุฌุงุฑู ุงูุฐูุจูุฉ ุชุญูู ุงูุชูููุฉ
```

## ุงูุชูุงูู ุงููุงูู ูููุธุงู

### โ ุชุจููุจ ุฃุดุฌุงุฑู ุงูุฎุถุฑุงุก (MaintenanceRecordWizard)
- ูุญุณุจ ุงูุฑุณูู ุนูู ุฃุณุงุณ `reserved_agricultural_trees`
- ุงูุนููุงุก ูู ุงููุณุงุฑ ุงูุฒุฑุงุนู ููุท ูุชุญูููู ุงูุฑุณูู

### โ ุชุจููุจ ุฃุดุฌุงุฑู ุงูุฐูุจูุฉ (InvestmentCycleWizard)
- ูุญุณุจ ุงูุฑุณูู ุนูู ุฃุณุงุณ `reserved_investment_trees`
- ุงููุณุชุซูุฑูู ูู ุงููุณุงุฑ ุงูุงุณุชุซูุงุฑู ููุท ูุชุญูููู ุงูุฑุณูู

### ๐ ุงููุตู ุงูุชุงู ุจูู ุงููุณุงุฑูู
```
ูุฒุฑุนุฉ ูุงุญุฏุฉ
    โโโ ุฃุดุฌุงุฑู ุงูุฎุถุฑุงุก (200 ุดุฌุฑุฉ ูุญุฌูุฒุฉ)
    โ   โโโ ุฑุณูู ุตูุงูุฉ: 10,000 รท 200 = 50 ุฑ.ุณ/ุดุฌุฑุฉ
    โ
    โโโ ุฃุดุฌุงุฑู ุงูุฐูุจูุฉ (150 ุดุฌุฑุฉ ูุญุฌูุฒุฉ)
        โโโ ุฏูุฑุฉ ุงุณุชุซูุงุฑูุฉ: 15,000 รท 150 = 100 ุฑ.ุณ/ุดุฌุฑุฉ
```

## ุงูููุงุฆุฏ

1. โ **ุนุฏุงูุฉ ูุทููุฉ**: ูู ูุณุชุซูุฑ/ุนููู ูุฏูุน ุญุตุชู ุงูุตุญูุญุฉ ุญุณุจ ูุณุงุฑู
2. โ **ูุตู ุชุงู**: ูุง ูุชุฃุซุฑ ูุณุงุฑ ุจูุณุงุฑ ุขุฎุฑ
3. โ **ุดูุงููุฉ**: ุงููุฏูุฑ ูุฑู ุจูุถูุญ ุนุฏุฏ ุงูุฃุดุฌุงุฑ ุงููุญุฌูุฒุฉ ูู ูู ูุณุงุฑ
4. โ **ุชุญุฐูุฑุงุช ูุงุถุญุฉ**: ุงููุธุงู ููุจู ุนูุฏ ุนุฏู ูุฌูุฏ ุญุฌูุฒุงุช
5. โ **ุฏูุฉ ุงูุญุณุงุจุงุช**: ุงูุชูููุฉ ูุจููุฉ ุนูู ุงูุฃุดุฌุงุฑ ุงููุนููุฉ ุงููุญุฌูุฒุฉ ููุท

## ุงูุชูุซูู ุงูููู

### ุงููููุงุช ุงูููุนุฏูุฉ

1. `src/services/operationsService.ts`
   - ุชุนุฏูู `getFarms()` ูุฅุถุงูุฉ ุนุฏุฏ ุงูุฃุดุฌุงุฑ ุงููุญุฌูุฒุฉ

2. `src/components/admin/MaintenanceRecordWizard.tsx`
   - ุฅุตูุงุญ ุญุณุงุจ ุงูุชูููุฉ ูููุณุงุฑ ุงูุฒุฑุงุนู
   - ุชุญุณูู ูุงุฌูุฉ ุงููุณุชุฎุฏู

3. `src/components/admin/InvestmentCycleWizard.tsx`
   - ุชุบููุฑ ุงูุฎุฏูุฉ ุงููุณุชุฎุฏูุฉ
   - ุฅุตูุงุญ ุญุณุงุจ ุงูุชูููุฉ ูููุณุงุฑ ุงูุงุณุชุซูุงุฑู
   - ุชุญุณูู ูุงุฌูุฉ ุงููุณุชุฎุฏู

### ุฏุงูุฉ ูุฑูุฒูุฉ ููุญุณุงุจ

ุชู ุงุณุชุฎุฏุงู `operationsService.getReservedTreesCount()` ูู ููุง ุงููุณุงุฑูู:

```typescript
async getReservedTreesCount(farmId: string, pathType: 'agricultural' | 'investment'): Promise<number> {
  const { data, error } = await supabase
    .from('reservations')
    .select('total_trees')
    .eq('farm_id', farmId)
    .eq('path_type', pathType)
    .eq('status', 'confirmed');

  if (error) throw error;

  const total = (data || []).reduce((sum, reservation) => sum + (reservation.total_trees || 0), 0);
  return total;
}
```

## ุงุฎุชุจุงุฑ ุงูุฅุตูุงุญ

### ููุชุญูู ูู ุชุจููุจ ุฃุดุฌุงุฑู ุงูุฐูุจูุฉ:

1. ุณุฌู ุงูุฏุฎูู ููุฏูุฑ (super_admin@ashjari.sa)
2. ุงุฐูุจ ุฅูู ูุณู ุงูุชุดุบูู > ุชุจููุจ ุฃุดุฌุงุฑู ุงูุฐูุจูุฉ
3. ุงุถุบุท "ุฅูุดุงุก ุฏูุฑุฉ ุงุณุชุซูุงุฑูุฉ ุฌุฏูุฏุฉ"
4. ุงุฎุชุฑ ูุฒุฑุนุฉ ุจูุง ุญุฌูุฒุงุช ุงุณุชุซูุงุฑูุฉ
5. ุฃุฏุฎู ูุจูุบ ุงูุฏูุฑุฉ
6. ุชุญูู ูู:
   - โ ูุธูุฑ ุนุฏุฏ ุงูุฃุดุฌุงุฑ ุงููุญุฌูุฒุฉ ูู ุฃุดุฌุงุฑู ุงูุฐูุจูุฉ ููุท
   - โ ุชูููุฉ ุงูุดุฌุฑุฉ ูุญุณูุจุฉ ุจูุงุกู ุนูู ุงูุฃุดุฌุงุฑ ุงููุญุฌูุฒุฉ ููุท
   - โ ุฑุณุงูุฉ ุชุญุฐูุฑ ุฅุฐุง ูู ุชูุฌุฏ ุญุฌูุฒุงุช

## ุงูุญุงูุฉ ุงูููุงุฆูุฉ

โ **ุงูุฅุตูุงุญ ููุชูู ูู ููุง ุงูุชุจููุจูู**
โ **ุงูุจูุงุก ูุงุฌุญ**
โ **ุงูุงุฎุชุจุงุฑ ูุงุฌุญ**
โ **ุฌุงูุฒ ููุฅูุชุงุฌ**

---

**ููุงุญุธุฉ ูููุฉ:** ูุฐุง ุงูุฅุตูุงุญ ูุถูู ุฃู ูู ูุณุงุฑ (ุฃุดุฌุงุฑู ุงูุฎุถุฑุงุก / ุฃุดุฌุงุฑู ุงูุฐูุจูุฉ) ูุณุชูู ุชูุงูุงู ุนู ุงูุขุฎุฑ ูู ุญุณุงุจ ุงูุฑุณููุ ููุง ูุญูู ุงูุนุฏุงูุฉ ูุงูุดูุงููุฉ ุงููุงููุฉ ููุนููุงุก ูุงููุณุชุซูุฑูู.
