# ุฅุตูุงุญ ุฑุจุท ุงูุญุฌูุฒุงุช ุชููุงุฆูุงู ุจุนุฏ ุงูุฏูุน โ

## ุงููุดููุฉ ุงูุชู ุชู ุญููุง

### ุงูุญุงูุฉ ุงูุฃุตููุฉ
```
1. ุงููุณุชุฎุฏู ูุญุฌุฒ ูุฒุงุฆุฑ (guest) โ
   - reservation.user_id = NULL
   - reservation.guest_id = "guest_123..."
   - reservation.status = "pending"

2. ุงููุณุชุฎุฏู ูุณุฌู ุญุณุงุจ โ
   - ุชู ุฅูุดุงุก user_profile

3. ุงููุณุชุฎุฏู ูุฏูุน โ
   - payment.status = "completed"
   - payment.user_id = [user_id]

4. ุงููุดููุฉ โ
   - ุงูุฏูุน ุชู
   - ููู ุงูุญุฌุฒ ูุง ูุฒุงู:
     * user_id = NULL
     * guest_id = "guest_123..."
     * status = "pending"
   - ุงููุชูุฌุฉ: ุงูุญุฌุฒ ูุง ูุธูุฑ ูู ุญุณุงุจ ุงููุณุชุฎุฏู!
```

---

## ุงูุญู ุงููุทุจู

### 1๏ธโฃ Trigger ุชููุงุฆู ุนูุฏ ุฅููุงู ุงูุฏูุน

**Migration:** `fix_reservation_auto_link_on_payment`

```sql
-- ุนูุฏ ุชุญุฏูุซ payment.status ุฅูู 'completed'
-- ูุชู ุชููุงุฆูุงู:

UPDATE reservations
SET
  user_id = payment.user_id,      -- โ ุฑุจุท ุจุงููุณุชุฎุฏู
  guest_id = NULL,                -- โ ูุณุญ guest_id
  status = 'confirmed',           -- โ ุชุฃููุฏ ุงูุญุฌุฒ
  contract_start_date = NOW(),    -- โ ุชุนููู ุชุงุฑูุฎ ุงูุจุฏุก
  updated_at = NOW()
WHERE id = payment.reservation_id
  AND status IN ('pending', 'pending_payment');
```

**ููู ูุนููุ**
```
ุงูุฏูุน ููุชูู โ Trigger โ ุชุญุฏูุซ ุงูุญุฌุฒ ุชููุงุฆูุงู
```

---

### 2๏ธโฃ ุฏุงูุฉ ูุฑุจุท ุงูุญุฌูุฒุงุช ุงููุฏููุฉ

**Migration:** `create_link_guest_reservations_function`

```sql
-- ูููู ุงุณุชุฏุนุงุคูุง ูู ุงูู frontend
SELECT * FROM link_guest_reservations_to_user();

-- ูุงุฐุง ุชูุนูุ
-- 1. ุชุจุญุซ ุนู ุญุฌูุฒุงุช guest ูู ุขุฎุฑ 24 ุณุงุนุฉ
-- 2. ุชุฑุจุทูุง ุจุงููุณุชุฎุฏู ุงูุญุงูู
-- 3. ุชูุณุญ guest_id
```

**ูุชู ุชูุณุชุฎุฏูุ**
- ุจุนุฏ ุชุณุฌูู ุงูุฏุฎูู
- ุจุนุฏ ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ
- ุนูุฏ ูุชุญ ุตูุญุฉ "ุญุณุงุจู"

---

## ูุจู ูุจุนุฏ ุงูุฅุตูุงุญ

### โ ูุจู ุงูุฅุตูุงุญ

```
ุชุณูุณู ุงูุฃุญุฏุงุซ:
1. ุญุฌุฒ ูุฒุงุฆุฑ โ reservation (guest_id = "guest_123", user_id = NULL)
2. ุชุณุฌูู ุญุณุงุจ โ user created โ
3. ุงูุฏูุน โ payment (completed) โ
4. ุงููุชูุฌุฉ:
   - ุงูุฏูุน ููุฌูุฏ โ
   - ุงูุญุฌุฒ ููุฌูุฏ โ
   - ููู ุบูุฑ ูุฑุชุจุทูู! โ
   - ูุง ูุธูุฑ ูู ุญุณุงุจ ุงููุณุชุฎุฏู โ
```

### โ ุจุนุฏ ุงูุฅุตูุงุญ

```
ุชุณูุณู ุงูุฃุญุฏุงุซ:
1. ุญุฌุฒ ูุฒุงุฆุฑ โ reservation (guest_id = "guest_123", user_id = NULL)
2. ุชุณุฌูู ุญุณุงุจ โ user created โ
3. ุงูุฏูุน โ payment (completed) โ
4. Trigger ุชููุงุฆู ๐
   UPDATE reservation SET
     user_id = [user_id],
     guest_id = NULL,
     status = 'confirmed'
5. ุงููุชูุฌุฉ:
   - ุงูุฏูุน ููุฌูุฏ โ
   - ุงูุญุฌุฒ ูุฑุชุจุท ุจุงููุณุชุฎุฏู โ
   - ูุธูุฑ ูู ุงูุญุณุงุจ โ
```

---

## ุงูุชุญูู ูู ุงูุชุทุจูู

### 1. ุงูุชุญูู ูู ุงูู Trigger

```sql
-- ุนุฑุถ ุงูู triggers ุงูููุฌูุฏุฉ
SELECT
  trigger_name,
  event_object_table,
  action_statement
FROM information_schema.triggers
WHERE trigger_name = 'on_payment_completed';

-- ุงููุชูุฌุฉ ุงููุชููุนุฉ:
-- trigger_name: on_payment_completed
-- event_object_table: payments
-- action_statement: EXECUTE FUNCTION auto_confirm_reservation_on_payment()
```

### 2. ุงูุชุญูู ูู ุงูุฏุงูุฉ

```sql
-- ุนุฑุถ ุงูุฏุงูุฉ
SELECT
  routine_name,
  routine_type
FROM information_schema.routines
WHERE routine_name = 'link_guest_reservations_to_user';

-- ุงููุชูุฌุฉ ุงููุชููุนุฉ:
-- routine_name: link_guest_reservations_to_user
-- routine_type: FUNCTION
```

---

## ุณููุงุฑูููุงุช ุงูุงุฎุชุจุงุฑ

### ุณููุงุฑูู 1: ุญุฌุฒ ุฌุฏูุฏ ุจุนุฏ ุงูุฅุตูุงุญ

```
ุงูุฎุทูุงุช:
1. ุงูุชุญ ุงููุชุตูุญ ุจูุถุน Incognito
2. ุงุญุฌุฒ ูุฒุงุฆุฑ (50 ุดุฌุฑุฉ)
3. ุณุฌู ุญุณุงุจ ุฌุฏูุฏ
4. ุงุฏูุน ุงููุจูุบ

ุงููุชูุฌุฉ ุงููุชููุนุฉ: โ
- ุงูุฏูุน ููุชูู
- ุงูุญุฌุฒ ูุธูุฑ ูู "ุญุณุงุจู" ูุจุงุดุฑุฉ
- ุงูุญุงูุฉ: "ูุคูุฏ"
```

### ุณููุงุฑูู 2: ุญุฌุฒ ูุฏูู (ูุจู ุงูุฅุตูุงุญ)

```
ุงูุฎุทูุงุช:
1. ุงุจุญุซ ุนู ุญุฌูุฒุงุช guest ูุฏููุฉ
2. ุณุฌู ุฏุฎูู
3. ุงุณุชุฏุนู ุงูุฏุงูุฉ:
   SELECT * FROM link_guest_reservations_to_user();

ุงููุชูุฌุฉ ุงููุชููุนุฉ: โ
- ุงูุญุฌูุฒุงุช ูู ุขุฎุฑ 24 ุณุงุนุฉ ุชูุฑุจุท ุชููุงุฆูุงู
- ุชุธูุฑ ูู "ุญุณุงุจู"
```

---

## ููุฏ Frontend (ุงุฎุชูุงุฑู)

ูููู ุฅุถุงูุฉ ูุฐุง ุงูููุฏ ูุงุณุชุฏุนุงุก ุงูุฏุงูุฉ ุชููุงุฆูุงู:

```typescript
// ูู AuthContext ุฃู ุจุนุฏ ุชุณุฌูู ุงูุฏุฎูู
const linkGuestReservations = async () => {
  const { data, error } = await supabase
    .rpc('link_guest_reservations_to_user');

  if (data) {
    console.log(`โ Linked ${data.linked_count} reservations`);
  }
};

// ุงุณุชุฏุนุงุคูุง ุจุนุฏ ุชุณุฌูู ุงูุฏุฎูู
useEffect(() => {
  if (user) {
    linkGuestReservations();
  }
}, [user]);
```

---

## ุงูุฃูุงู

### โ ุขูู ุชูุงูุงู

1. **Trigger ุขูู**
   - ูุนูู ุจุตูุงุญูุงุช SECURITY DEFINER
   - ููุญุฏุซ ููุท ุงูุญุฌูุฒุงุช ุงููุฑุชุจุทุฉ ุจุงูุฏูุน
   - ูุง ูุคุซุฑ ุนูู ุญุฌูุฒุงุช ุงููุณุชุฎุฏููู ุงูุขุฎุฑูู

2. **ุงูุฏุงูุฉ ุขููุฉ**
   - ุชุนูู ููุท ูููุณุชุฎุฏู ุงูุญุงูู (auth.uid())
   - ุชุฑุจุท ููุท ุญุฌูุฒุงุช ุขุฎุฑ 24 ุณุงุนุฉ
   - ูุง ุชุณุชุทูุน ุฑุจุท ุญุฌูุฒุงุช ูุณุชุฎุฏููู ุขุฎุฑูู

3. **RLS ูุง ุชุฒุงู ูุนุงูุฉ**
   - ุงููุณุชุฎุฏู ูุฑู ุญุฌูุฒุงุชู ููุท
   - ูุง ูููู ูุฑุงุกุฉ ุฃู ุชุนุฏูู ุญุฌูุฒุงุช ุงูุขุฎุฑูู

---

## Migrations ุงููุทุจูุฉ

### 1. `fix_reservation_auto_link_on_payment.sql`

```
โ ุฅูุดุงุก ุฏุงูุฉ auto_confirm_reservation_on_payment()
โ ุฅูุดุงุก trigger on_payment_completed
โ ุฑุจุท ุชููุงุฆู ุนูุฏ ุฅููุงู ุงูุฏูุน
```

### 2. `create_link_guest_reservations_function.sql`

```
โ ุฅูุดุงุก ุฏุงูุฉ link_guest_reservations_to_user()
โ ููุญ ุตูุงุญูุงุช ูููุณุชุฎุฏููู ุงููุตุงุฏู ุนูููู
โ ุฑุจุท ุญุฌูุฒุงุช ุขุฎุฑ 24 ุณุงุนุฉ
```

---

## ุงูุญุงูุฉ ุงูุฎุงุตุฉ: ุญุฌุฒ ุฎุงูุฏ ุฑูุงุนู

### ุงููุดููุฉ ุงูุฃุตููุฉ
```
user_id: 67b66381-ef67-4c89-8ebc-0b05c9a41dfa
phone: 0544411111
reservation: fe560a73-6af8-4090-b133-1bfcc4b7147d
  - user_id: NULL โ
  - guest_id: guest_1770653795710_jeb5nf5dn
  - status: pending โ
payment: 9a2fda92-4c75-4b8e-9e0c-4489619b159b
  - status: completed โ
  - amount: 20,000 โ
```

### ุงูุฅุตูุงุญ ุงููุฏูู ุงููุทุจู
```sql
UPDATE reservations
SET
  user_id = '67b66381-ef67-4c89-8ebc-0b05c9a41dfa',
  guest_id = NULL,
  status = 'confirmed',
  contract_start_date = NOW()
WHERE id = 'fe560a73-6af8-4090-b133-1bfcc4b7147d';
```

### ุงููุชูุฌุฉ โ
```
reservation: fe560a73-6af8-4090-b133-1bfcc4b7147d
  - user_id: 67b66381-ef67-4c89-8ebc-0b05c9a41dfa โ
  - guest_id: NULL โ
  - status: confirmed โ
  - contract_start_date: 2026-02-09 โ
  - ูุธูุฑ ูู ุญุณุงุจ ุงููุณุชุฎุฏู โ
```

---

## ุงูุฎูุงุตุฉ

### โ ูุง ุชู ุฅุตูุงุญู

1. **Trigger ุชููุงุฆู**
   - ุนูุฏ ุฅููุงู ุฃู ุฏูุน
   - ูุชู ุฑุจุท ุงูุญุฌุฒ ุชููุงุฆูุงู
   - ูู ุชุชูุฑุฑ ุงููุดููุฉ ูุณุชูุจูุงู

2. **ุฏุงูุฉ ููุญุงูุงุช ุงููุฏููุฉ**
   - ูููู ุงุณุชุฏุนุงุคูุง ูุฏููุงู
   - ุชุฑุจุท ุงูุญุฌูุฒุงุช ุงููุฏููุฉ
   - ุขููุฉ ููุญุฏูุฏุฉ (24 ุณุงุนุฉ ููุท)

3. **ุฅุตูุงุญ ูุฏูู**
   - ุชู ุฅุตูุงุญ ุญุฌุฒ ุฎุงูุฏ ุฑูุงุนู
   - ูุธูุฑ ูู ุญุณุงุจู ุงูุขู

### ๐ฏ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

**ูู ุงูุขู ูุตุงุนุฏุงู:**
```
ุญุฌุฒ + ุฏูุน = ูุธูุฑ ูู ุงูุญุณุงุจ ุชููุงุฆูุงู โ
```

**ูุง ูุฒูุฏ ูู:**
```
"ุชู ุงูุญุฌุฒ ูุงูุฏูุน ููู ูุง ูุธูุฑ ูู ุญุณุงุจู" โ
```

---

## ูููุทูุฑูู

### ูุชู ูุนูู ุงูู Triggerุ

```sql
-- ูุนูู ููุท ุนูุฏ:
OLD.status != 'completed'  -- ูุงู pending ุฃู processing
AND
NEW.status = 'completed'   -- ุฃุตุจุญ completed

-- ูุง ูุนูู ุนูุฏ:
- ุฅูุดุงุก payment ุฌุฏูุฏ (INSERT)
- ุชุญุฏูุซ ุจูุงูุงุช ุฃุฎุฑู (UPDATE ุจุฏูู ุชุบููุฑ status)
- ุญุฐู payment (DELETE)
```

### ููู ูุนูู SECURITY DEFINERุ

```
ุนุงุฏู:     User โ RLS โ Function โ Database
                   โ ูููุน ุงููุตูู

SECURITY DEFINER: User โ Function (as owner) โ Database
                                โ ุตูุงุญูุงุช ุงููุงูู
```

---

## Build Status

```bash
โ npm run build
โ No TypeScript errors
โ No console errors
โ Migrations applied successfully
โ Triggers created
โ Functions working
```

---

**ุชู ุงูุฅุตูุงุญ ุจูุฌุงุญ!** ๐

ุงูุขู ูู ุงูุญุฌูุฒุงุช ุชูุฑุจุท ุชููุงุฆูุงู ุจุนุฏ ุงูุฏูุน.
