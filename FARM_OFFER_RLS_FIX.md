# ุฅุตูุงุญ ุณูุงุณุฉ RLS ููููุฐุฌ ุนุฑุถ ุงููุฒุฑุนุฉ

## ุงููุดููุฉ

ุนูุฏ ูุญุงููุฉ ุฅุฑุณุงู ุนุฑุถ ูุฒุฑุนุฉ ุฌุฏูุฏ ูู ุฎูุงู ูููุฐุฌ "ุงุนุฑุถ ูุฒุฑุนุชู"ุ ูุงู ูุธูุฑ ุงูุฎุทุฃ ุงูุชุงูู:

```
POST https://fyxxrplokeqbgkrvscto.supabase.co/rest/v1/farm_offers... 401 (Unauthorized)

Error: new row violates row-level security policy for table "farm_offers"
```

### ุงูุณุจุจ ุงูุฌุฐุฑู

ุงูุณูุงุณุฉ ุงููุฏููุฉ ูู ุฌุฏูู `farm_offers` ูุงูุช:

```sql
CREATE POLICY "Anyone can submit farm offer"
  ON farm_offers
  FOR INSERT
  TO public
  WITH CHECK (true);
```

**ุงููุดููุฉ:** ุงุณุชุฎุฏุงู `TO public` ูุง ูุนูู ุจุดูู ุตุญูุญ ูู Supabase ูููุณุชุฎุฏููู ุบูุฑ ุงููุณุฌููู (anonymous users).

## ุงูุญู ุงููุทุจู

ุชู ุงุณุชุจุฏุงู ุงูุณูุงุณุฉ ุงููุฏููุฉ ุจุณูุงุณุชูู ุฌุฏูุฏุชูู:

### 1. ุณูุงุณุฉ ูููุณุชุฎุฏููู ุบูุฑ ุงููุณุฌููู (Anonymous)

```sql
CREATE POLICY "Anonymous users can submit farm offers"
  ON farm_offers
  FOR INSERT
  TO anon
  WITH CHECK (true);
```

**ุงูููุฒุงุช:**
- โ ุชุณูุญ ููุฒูุงุฑ ุบูุฑ ุงููุณุฌููู ุจุฅุฑุณุงู ุนุฑูุถ ุงููุฒุงุฑุน
- โ ูุง ุชุญุชุงุฌ ุฅูู ุชุณุฌูู ุฏุฎูู
- โ ุชุณุชุฎุฏู `anon` role ุจุฏูุงู ูู `public`

### 2. ุณูุงุณุฉ ูููุณุชุฎุฏููู ุงููุณุฌููู (Authenticated)

```sql
CREATE POLICY "Authenticated users can submit farm offers"
  ON farm_offers
  FOR INSERT
  TO authenticated
  WITH CHECK (true);
```

**ุงูููุฒุงุช:**
- โ ุชุณูุญ ูููุณุชุฎุฏููู ุงููุณุฌููู ุจุฅุฑุณุงู ุนุฑูุถ ุงููุฒุงุฑุน
- โ ุชููุฑ ุทุจูุฉ ุฅุถุงููุฉ ูู ุงูุชุบุทูุฉ
- โ ุชุถูู ุนูู ุงููููุฐุฌ ูู ุฌููุน ุงูุญุงูุงุช

## ุงูุณูุงุณุงุช ุงููุงููุฉ ูุฌุฏูู farm_offers

### ุณูุงุณุงุช INSERT (ุงูุฅุถุงูุฉ)

```sql
-- 1. ูููุณุชุฎุฏููู ุบูุฑ ุงููุณุฌููู
CREATE POLICY "Anonymous users can submit farm offers"
  ON farm_offers FOR INSERT TO anon
  WITH CHECK (true);

-- 2. ูููุณุชุฎุฏููู ุงููุณุฌููู
CREATE POLICY "Authenticated users can submit farm offers"
  ON farm_offers FOR INSERT TO authenticated
  WITH CHECK (true);
```

### ุณูุงุณุงุช SELECT (ุงููุฑุงุกุฉ)

```sql
-- ุงูุฅุฏุงุฑููู ููุท ูููููู ูุฑุงุกุฉ ุฌููุน ุงูุนุฑูุถ
CREATE POLICY "Admins can view all offers"
  ON farm_offers FOR SELECT TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM admins
      WHERE admins.user_id = auth.uid()
    )
  );
```

### ุณูุงุณุงุช UPDATE (ุงูุชุญุฏูุซ)

```sql
-- ุงูุฅุฏุงุฑููู ููุท ูููููู ุชุญุฏูุซ ุงูุนุฑูุถ
CREATE POLICY "Admins can update offers"
  ON farm_offers FOR UPDATE TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM admins
      WHERE admins.user_id = auth.uid()
    )
  )
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM admins
      WHERE admins.user_id = auth.uid()
    )
  );
```

## ุงููุฑู ุจูู public ู anon ู authenticated

### public
- โ ูุง ูุนูู ุจุดูู ุตุญูุญ ูู Supabase
- โ ุบูุฑ ููุตู ุจู ููุงุณุชุฎุฏุงู

### anon
- โ ูููุณุชุฎุฏููู ุบูุฑ ุงููุณุฌููู (anonymous)
- โ ูุณุชุฎุฏู anon key ูู ุฅุนุฏุงุฏุงุช Supabase
- โ ููุงุณุจ ููููุงุฐุฌ ุงูุนุงูุฉ

### authenticated
- โ ูููุณุชุฎุฏููู ุงููุณุฌููู ููุท
- โ ูุชุทูุจ ุชุณุฌูู ุฏุฎูู
- โ ูููุฑ ุฃูุงู ุฅุถุงูู

## ุงุฎุชุจุงุฑ ุงูุฅุตูุงุญ

### ุญุงูุฉ ุงูุงุฎุชุจุงุฑ 1: ูุณุชุฎุฏู ุบูุฑ ูุณุฌู
```
1. ูุชุญ ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ
2. ุงูููุฑ ุนูู "ุงุนุฑุถ ูุฒุฑุนุชู"
3. ููุก ุงููููุฐุฌ ุจุงูุจูุงูุงุช
4. ุงูููุฑ ุนูู "ุชูุฏูู ุงูุนุฑุถ"
5. โ ูุฌุจ ุฃู ูุชู ุงูุฅุฑุณุงู ุจูุฌุงุญ
6. โ ุนุฑุถ ุดุงุดุฉ ุงููุฌุงุญ
```

### ุญุงูุฉ ุงูุงุฎุชุจุงุฑ 2: ูุณุชุฎุฏู ูุณุฌู
```
1. ุชุณุฌูู ุงูุฏุฎูู
2. ุงูููุฑ ุนูู "ุงุนุฑุถ ูุฒุฑุนุชู"
3. ููุก ุงููููุฐุฌ ุจุงูุจูุงูุงุช
4. ุงูููุฑ ุนูู "ุชูุฏูู ุงูุนุฑุถ"
5. โ ูุฌุจ ุฃู ูุชู ุงูุฅุฑุณุงู ุจูุฌุงุญ
6. โ ุนุฑุถ ุดุงุดุฉ ุงููุฌุงุญ
```

## ุงูุฃูุงู

### ูุง ุชู ุงูุณูุงุญ ุจู โ
- ุฅุถุงูุฉ ุนุฑูุถ ูุฒุงุฑุน ุฌุฏูุฏุฉ (ููุฌููุน)
- ูุฑุงุกุฉ ุงูุนุฑูุถ (ููุฅุฏุงุฑููู ููุท)
- ุชุญุฏูุซ ุงูุนุฑูุถ (ููุฅุฏุงุฑููู ููุท)

### ูุง ุชู ููุนู โ
- โ ุงููุณุชุฎุฏููู ุงูุนุงุฏููู ูุง ูููููู ูุฑุงุกุฉ ุนุฑูุถ ุงูุขุฎุฑูู
- โ ุงููุณุชุฎุฏููู ุงูุนุงุฏููู ูุง ูููููู ุชุญุฏูุซ ุฃู ุนุฑูุถ
- โ ุงููุณุชุฎุฏููู ุงูุนุงุฏููู ูุง ูููููู ุญุฐู ุนุฑูุถ
- โ ูุง ููุฌุฏ ุณูุงุณุฉ DELETE (ูุญูู ุจุงููุงูู)

## ุงูุจูุงูุงุช ุงููุญููุธุฉ

ุนูุฏ ุฅุฑุณุงู ุนุฑุถ ูุฒุฑุนุฉุ ูุชู ุญูุธ:

```typescript
{
  owner_name: string,           // ุงุณู ุงููุฒุงุฑุน
  phone: string,                // ุฑูู ุงููุงุชู
  email?: string,               // ุงูุจุฑูุฏ ุงูุฅููุชุฑููู (ุงุฎุชูุงุฑู)
  location: string,             // ูููุน ุงููุฒุฑุนุฉ
  current_crop_type: string,    // ููุน ุงูุฒุฑุงุนุฉ ุงูุฑุฆูุณู
  tree_count: number,           // ุนุฏุฏ ุงูุฃุดุฌุงุฑ
  tree_varieties: Array<{       // ุฃููุงุน ุงูุฃุดุฌุงุฑ ุงููุชุนุฏุฏุฉ
    type: string,
    count: number
  }>,
  total_tree_count: number,     // ุงูุฅุฌูุงูู ุงูููู
  has_legal_docs: string,       // ุงูุชูุซูู ุงููุงูููู
  offer_type: string,           // ููุน ุงูุนุฑุถ
  proposed_price?: number,      // ุงูุณุนุฑ ุงูููุชุฑุญ (ุงุฎุชูุงุฑู)
  partnership_acknowledgment: boolean, // ุฅูุฑุงุฑ ุงููุดุงุฑูุฉ
  additional_notes?: string,    // ููุงุญุธุงุช ุฅุถุงููุฉ
  status: 'under_review',       // ุงูุญุงูุฉ ุงูุงูุชุฑุงุถูุฉ
  submitted_at: timestamp,      // ุชุงุฑูุฎ ุงูุฅุฑุณุงู
  reference_number: string      // ุฑูู ุงููุฑุฌุน (ุชููุงุฆู)
}
```

## ุฑูู ุงููุฑุฌุน ุงูุชููุงุฆู

ูุชู ุชูููุฏ ุฑูู ูุฑุฌุน ูุฑูุฏ ุชููุงุฆูุงู ููู ุนุฑุถ:

```
Format: FM-YYYY-NNNNN
Example: FM-2026-00001
```

**ุงูููุฒุงุช:**
- โ ูุฑูุฏ ููู ุนุฑุถ
- โ ูุญุชูู ุนูู ุงูุณูุฉ
- โ ุฑูู ุชุณูุณูู ูููู ูู 5 ุฎุงูุงุช
- โ ูุชู ุฅูุดุงุคู ุชููุงุฆูุงู ุนูุฏ ุงูุฅุฏุฎุงู

## ุงูุชุญุฏูุซุงุช ุงูุชููุงุฆูุฉ

### 1. Trigger: set_offer_reference
```sql
-- ูููู ุจุชุนููู ุฑูู ุงููุฑุฌุน ุชููุงุฆูุงู ูุจู ุงูุฅุฏุฎุงู
CREATE TRIGGER set_offer_reference_trigger
  BEFORE INSERT ON farm_offers
  FOR EACH ROW
  EXECUTE FUNCTION set_offer_reference();
```

### 2. Trigger: update_farm_offer_timestamp
```sql
-- ูููู ุจุชุญุฏูุซ last_updated_at ุชููุงุฆูุงู ุนูุฏ ุงูุชุนุฏูู
CREATE TRIGGER update_farm_offer_timestamp_trigger
  BEFORE UPDATE ON farm_offers
  FOR EACH ROW
  EXECUTE FUNCTION update_farm_offer_timestamp();
```

### 3. Trigger: add_offer_timeline
```sql
-- ูุถูู ุณุฌู ูู timeline ุนูุฏ ุชุบููุฑ ุงูุญุงูุฉ
CREATE TRIGGER add_offer_timeline_trigger
  AFTER UPDATE ON farm_offers
  FOR EACH ROW
  EXECUTE FUNCTION add_offer_timeline();
```

## ุญุงูุงุช ุงูุนุฑุถ (Status)

```typescript
type OfferStatus =
  | 'submitted'              // ุชู ุงูุชูุฏูู
  | 'under_review'           // ููุฏ ุงููุฑุงุฌุนุฉ (ุงูุชุฑุงุถู)
  | 'technical_eval'         // ุงูุชูููู ุงูููู
  | 'field_visit_scheduled'  // ุฒูุงุฑุฉ ูุฌุฏููุฉ
  | 'field_visit_done'       // ุชูุช ุงูุฒูุงุฑุฉ
  | 'approved'               // ุชู ุงููุจูู
  | 'rejected';              // ุชู ุงูุฑูุถ
```

**ุงูุญุงูุฉ ุงูุงูุชุฑุงุถูุฉ:** `under_review`

## ุงูุชุชุจุน ุงูุฒููู (Timeline)

ูู ุชุบููุฑ ูู ุญุงูุฉ ุงูุนุฑุถ ูุชู ุชุณุฌููู ุชููุงุฆูุงู ูู ุฌุฏูู `farm_offer_timeline`:

```typescript
{
  id: uuid,
  offer_id: uuid,
  status: string,
  note?: string,
  created_by?: uuid,
  created_at: timestamp
}
```

## ููุญุฉ ุงูุชุญูู ุงูุฅุฏุงุฑูุฉ

ุงูุฅุฏุงุฑููู ูููููู:

1. โ ุนุฑุถ ุฌููุน ุงูุนุฑูุถ
2. โ ุชุตููุฉ ุงูุนุฑูุถ ุญุณุจ ุงูุญุงูุฉ
3. โ ุชุญุฏูุซ ุญุงูุฉ ุงูุนุฑุถ
4. โ ุฅุถุงูุฉ ููุงุญุธุงุช ุฅุฏุงุฑูุฉ
5. โ ุฌุฏููุฉ ุฒูุงุฑุงุช ููุฏุงููุฉ
6. โ ุนุฑุถ ุงูุชุงุฑูุฎ ุงูุฒููู ููุนุฑุถ
7. โ ูุจูู ุฃู ุฑูุถ ุงูุนุฑูุถ

## ุงูุชูุงูู ูุน ุงููุธุงู

### ุชุฏูู ุงูุนูู ุงููุงูู

```
1. ุงูุฒุงุฆุฑ ููุชุญ "ุงุนุฑุถ ูุฒุฑุนุชู"
   โ
2. ูููุฃ ุงููููุฐุฌ ุจุงูุจูุงูุงุช
   โ
3. ูุฑุณู ุงูุนุฑุถ (INSERT ูู farm_offers)
   โ
4. ูุชู ุชูููุฏ ุฑูู ุงููุฑุฌุน ุชููุงุฆูุงู
   โ
5. ุงูุญุงูุฉ ุชูุถุจุท ุนูู "under_review"
   โ
6. ุนุฑุถ ุดุงุดุฉ ุงููุฌุงุญ ูุน:
   - ุฑุณุงูุฉ ุดูุฑ
   - ุฑูู ุงููุฑุฌุน
   - ูุณุงุฆู ุงูุชูุงุตู
   โ
7. ุงูุฅุฏุงุฑุฉ ุชุณุชูู ุงูุทูุจ
   โ
8. ุงููุฑุงุฌุนุฉ ูุงูุชูููู
   โ
9. ุงูุชูุงุตู ูุน ุงููุฒุงุฑุน ุฎูุงู 48 ุณุงุนุฉ
```

## ุงูููุงุฆุฏ ุงูุฃูููุฉ

### ูุจู ุงูุฅุตูุงุญ โ
```
- ุณูุงุณุฉ ุบูุฑ ูุนุงูุฉ
- ุนุฏู ุงููุฏุฑุฉ ุนูู ุฅุฑุณุงู ุงูุนุฑูุถ
- ุฎุทุฃ 401 Unauthorized
- ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุณูุฆุฉ
```

### ุจุนุฏ ุงูุฅุตูุงุญ โ
```
- ุณูุงุณุงุช ูุงุถุญุฉ ููุญุฏุฏุฉ
- ุฅููุงููุฉ ุฅุฑุณุงู ุงูุนุฑูุถ ููุฌููุน
- ุฃูุงู ูุญูู ูููุฑุงุกุฉ ูุงูุชุนุฏูู
- ุชุฌุฑุจุฉ ูุณุชุฎุฏู ููุชุงุฒุฉ
- ุญูุงูุฉ ุจูุงูุงุช ุงูุนุฑูุถ
```

## ุงูุฎูุงุตุฉ

ุชู ุฅุตูุงุญ ุณูุงุณุฉ RLS ุจูุฌุงุญ ูุฌุฏูู `farm_offers` ุนู ุทุฑูู:

1. โ ุงุณุชุจุฏุงู `TO public` ุจู `TO anon`
2. โ ุฅุถุงูุฉ ุณูุงุณุฉ ูููุตูุฉ ูููุณุชุฎุฏููู ุงููุณุฌููู
3. โ ุงูุญูุงุธ ุนูู ุงูุฃูุงู ูููุฑุงุกุฉ ูุงูุชุนุฏูู
4. โ ุงุฎุชุจุงุฑ ุฌููุน ุงูุญุงูุงุช

ุงููุธุงู ุงูุขู ูุนูู ุจุดูู ูุงูู ููุณูุญ ููุฌููุน ุจุฅุฑุณุงู ุนุฑูุถ ุงููุฒุงุฑุน ุจูุฌุงุญ! ๐

---

**ุชุงุฑูุฎ ุงูุฅุตูุงุญ:** 2026-02-03
**Migration:** `fix_farm_offers_rls_policy_for_anonymous_users.sql`
**ุงูุญุงูุฉ:** โ ููุชูู ููุฎุชุจุฑ
