# ูุธุงู ุงููููุฉ ุงูููุญุฏุฉ ููุนููุงุก

## ๐ฏ ุงูุชูุฌูู ุงูุชูููุฐู

**"ุฑุจุท ุฌููุน ุงููุณุฌููู ูู ุงููุธุงู ุจูุณู ุงูุนููุงุก ุจุงุณุชุฎุฏุงู ุงูุฌูุงู ุฃู ุงูุจุฑูุฏ ููููุฉ ููุญูุฏุฉุ ุจุบุถ ุงููุธุฑ ุนู ุทุฑููุฉ ุงูุชุณุฌููุ ูุน ููุน ุฃู ุชูุฑุงุฑ."**

---

## ๐ ุงูููููู ุงูุฃุณุงุณู

### ุงููููุฉ ุงูููุญุฏุฉ = ุงูุฌูุงู ุฃู ุงูุจุฑูุฏ

```
ูู ุนููู = ูููุฉ ูุงุญุฏุฉ ููุท
ุงููููุฉ = ุฑูู ุงูุฌูุงู OR ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
```

**ูุซุงู:**
- ุนููู ุณุฌู ุจุฑูู: `0501234567`
- ุซู ุณุฌู ูุฑุฉ ุฃุฎุฑู ุจููุณ ุงูุฑูู ูููู ุจุจุฑูุฏ ูุฎุชูู
- **ุงููุชูุฌุฉ:** ูุธูุฑ ูุนููู ูุงุญุฏ ููุท ูู ุงููุธุงู โ

---

## ๐ ููู ูุนูู ุงููุธุงู ุงูููุญุฏุ

### 1. ุฌูุน ุงูุจูุงูุงุช ูู ุฌููุน ุงููุตุงุฏุฑ

ุงููุธุงู ูุจุญุซ ูู:
- โ `auth.users` - ุฌุฏูู ุงููุณุชุฎุฏููู ุงูุฑุฆูุณู
- โ `user_profiles` - ุจูุงูุงุช ุงููููุงุช ุงูุดุฎุตูุฉ
- โ `reservations` - ุฌููุน ุงูุญุฌูุฒุงุช (ุญุชู ุงููุคูุชุฉ)

### 2. ุชุทุจูู ููุทู ุงููููุฉ ุงูููุญุฏุฉ

```sql
DISTINCT ON (COALESCE(up.phone, u.email))
```

**ุงูุชุฑุฌูุฉ:**
- ุฅุฐุง ูุงู ููุนููู ุฌูุงู โ ุงุณุชุฎุฏู ุงูุฌูุงู ููููุฉ
- ุฅุฐุง ูู ููู ูู ุฌูุงู โ ุงุณุชุฎุฏู ุงูุจุฑูุฏ ููููุฉ
- ุฅุฐุง ุชูุฑุฑ ููุณ ุงูุฌูุงู/ุงูุจุฑูุฏ โ ุงุนุฑุถ ูุงุญุฏ ููุท

### 3. ุชุฑุชูุจ ุงูุฃููููุงุช

ุนูุฏ ูุฌูุฏ ุฃูุซุฑ ูู ุญุณุงุจ ูููุณ ุงููููุฉ:

**ุงูุฃููููุฉ:**
```
1. ุญุณุงุจ ููุนู (email_confirmed_at ููุฌูุฏ)
2. ุญุณุงุจ ุฃุญุฏุซ (created_at ุฃุญุฏุซ)
3. ุญุณุงุจ ูุฏูู (ุขุฎุฑ ุฎูุงุฑ)
```

**ูุซุงู ุนููู:**
```
ุงููููุฉ: 0501234567

ุงูุญุณุงุจ A: ููุนู + ุชุงุฑูุฎ 2024-01-01
ุงูุญุณุงุจ B: ุบูุฑ ููุนู + ุชุงุฑูุฎ 2024-03-01

ุงููุชูุฌุฉ: ูุธูุฑ ุงูุญุณุงุจ A (ูุฃูู ููุนู) โ
```

---

## ๐ ุงูุชูููุฐ ุงูุชููู

### ุฏุงูุฉ `get_customers_list()` ุงูููุญุฏุฉ

#### ุงููุฑุงุญู:

**ุงููุฑุญูุฉ 1: ุฌูุน ุฌููุน ุงูุนููุงุก**
```sql
WITH all_customers AS (
  SELECT DISTINCT ON (COALESCE(up.phone, u.email))
    u.id,
    COALESCE(up.full_name, u.email, up.phone) as full_name,
    up.phone,
    u.email,
    u.created_at,
    ...
  FROM auth.users u
  LEFT JOIN user_profiles up ON up.user_id = u.id
  ORDER BY
    COALESCE(up.phone, u.email),
    u.email_confirmed_at DESC NULLS LAST,
    u.created_at DESC
)
```

**ุงูุดุฑุญ:**
- `DISTINCT ON` ูุฒูู ุงูุชูุฑุงุฑ ุจูุงุกู ุนูู ุงููููุฉ ุงูููุญุฏุฉ
- `ORDER BY` ูุญุฏุฏ ุฃู ุญุณุงุจ ูุธูุฑ ุนูุฏ ุงูุชูุฑุงุฑ
- `COALESCE` ูุนุทู ุงูุฃููููุฉ ููุฌูุงู ุนูู ุงูุจุฑูุฏ

**ุงููุฑุญูุฉ 2: ุฅุถุงูุฉ ุฅุญุตุงุฆูุงุช ุงูุฃุดุฌุงุฑ**
```sql
customers_with_trees AS (
  SELECT
    ac.*,
    COUNT(CASE WHEN r.path_type = 'agricultural' AND r.status = 'active' THEN r.id END) as green_trees_count,
    COUNT(CASE WHEN r.path_type = 'investment' AND r.status = 'active' THEN r.id END) as golden_trees_count,
    COUNT(CASE WHEN r.status = 'active' THEN r.id END) as total_trees_count
  FROM all_customers ac
  LEFT JOIN reservations r ON r.user_id = ac.user_id
  GROUP BY ac.user_id, ...
)
```

**ุงููุฑุญูุฉ 3: ููุชุฑุฉ ูุงุณุชุจุนุงุฏ ุงููุฏูุฑูู**
```sql
WHERE ac.is_admin = false
```

---

### ุฏุงูุฉ `get_customer_profile()` ุงูููุญุฏุฉ

#### ุงูุชุบููุฑ ุงูุฑุฆูุณู:

**ูุจู:**
```typescript
getCustomerProfile(userId: string)
```

**ุจุนุฏ:**
```typescript
getCustomerProfile(identifier: string)
```

#### ููุจู 3 ุฃููุงุน ูู ุงููุนุฑูุงุช:

1. **User ID:**
```typescript
getCustomerProfile('550e8400-e29b-41d4-a716-446655440000')
```

2. **ุฑูู ุงูุฌูุงู:**
```typescript
getCustomerProfile('0501234567')
```

3. **ุงูุจุฑูุฏ ุงูุฅููุชุฑููู:**
```typescript
getCustomerProfile('ahmad@example.com')
```

#### ุขููุฉ ุงูุจุญุซ:
```sql
SELECT u.id INTO v_user_id
FROM auth.users u
LEFT JOIN user_profiles up ON up.user_id = u.id
WHERE u.id::text = p_identifier
   OR up.phone = p_identifier
   OR u.email = p_identifier
LIMIT 1;
```

---

## ๐ ุงูุชุดุงู ุงูุนููุงุก ุงูููุฑุฑูู

### ุฏุงูุฉ `find_duplicate_customers()`

ุชุจุญุซ ุนู:
- ููุณ ุงูุฌูุงู ูู ุฃูุซุฑ ูู ุญุณุงุจ
- ููุณ ุงูุจุฑูุฏ ูู ุฃูุซุฑ ูู ุญุณุงุจ

**ุงูุฅุฑุฌุงุน:**
```json
[
  {
    "identifier": "0501234567",
    "identifier_type": "phone",
    "user_count": 2,
    "user_ids": [
      "uuid-1",
      "uuid-2"
    ]
  }
]
```

---

## ๐จ ุงููุงุฌูุฉ ุงูุฅุฏุงุฑูุฉ

### 1. ูุงุฆูุฉ ุงูุนููุงุก (CustomersList)

**ุงูุชุญุณููุงุช:**
- โ ุนุฑุถ ุฌููุน ุงููุณุฌููู ุจุฏูู ุชูุฑุงุฑ
- โ ุจุญุซ ููุญุฏ (ุฌูุงู ุฃู ุจุฑูุฏ)
- โ ููุชุฑุฉ ุญุณุจ ุนุฏุฏ ุงูุฃุดุฌุงุฑ
- โ ุฒุฑ ุฌุฏูุฏ: "ุงูุนููุงุก ุงูููุฑุฑูู"

### 2. ูุฏูุฑ ุงูุนููุงุก ุงูููุฑุฑูู (DuplicateCustomersManager)

**ูุธููุฉ ุฌุฏูุฏุฉ!**

**ุงูููุฒุงุช:**
- ๐ ุนุฑุถ ุฌููุน ุงููููุงุช ุงูููุฑุฑุฉ
- ๐ ุงูุชูุฑูู ุจูู ุชูุฑุงุฑ ุงูุฌูุงู ูุชูุฑุงุฑ ุงูุจุฑูุฏ
- ๐ ุนุฑุถ ุฌููุน User IDs ุงููุฑุชุจุทุฉ ุจููุณ ุงููููุฉ
- โ ุฑุณุงูุฉ "ุงููุธุงู ูุธูู" ุฅุฐุง ูู ุชูุฌุฏ ุชูุฑุงุฑุงุช

**ูุซุงู ุนูู ุงููุงุฌูุฉ:**
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ๐ฑ 0501234567                               โ
โ ุฑูู ุงูุฌูุงู                                  โ
โ                                             โ
โ ๐ด 2 ุญุณุงุจุงุช                                โ
โ                                             โ
โ ูุนุฑูุงุช ุงูุญุณุงุจุงุช:                           โ
โ 1  uuid-1111-2222-3333-4444                โ
โ 2  uuid-5555-6666-7777-8888                โ
โ                                             โ
โ โน๏ธ ุงููุธุงู ูุนุฑุถ: uuid-1111 (ุงูุฃุญุฏุซ/ุงูููุนู)  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ก๏ธ ูุนุงูุฌุฉ ุงูุชูุฑุงุฑ

### ุงูุณููุงุฑูููุงุช ุงูููููุฉ

#### ุงูุณููุงุฑูู 1: ุญุฌุฒ ูุคูุช โ ุญุณุงุจ ูุงูู
```
ุงููุฑุญูุฉ 1: ุนููู ูุญุฌุฒ ุจุฏูู ุญุณุงุจ
- ุงูุฌูุงู: 0501234567
- User ID: temp-user-123

ุงููุฑุญูุฉ 2: ููุณ ุงูุนููู ูุณุฌู ุญุณุงุจ ูุงูู
- ุงูุฌูุงู: 0501234567
- User ID: auth-user-456

ุงููุชูุฌุฉ ูู ูุณู ุงูุนููุงุก:
โ ูุธูุฑ auth-user-456 ููุท (ูุฃูู ููุนู)
```

#### ุงูุณููุงุฑูู 2: ุชุณุฌูู ููุฑุฑ ุจุฎุทุฃ
```
ุงูุชุณุฌูู 1: ahmad@example.com + 0501234567
ุงูุชุณุฌูู 2: ahmad2@example.com + 0501234567 (ููุณ ุงูุฌูุงู!)

ุงููุชูุฌุฉ:
โ ูุธูุฑ ุญุณุงุจ ูุงุญุฏ ููุท (ุงูุฃุญุฏุซ ุฃู ุงูุฃูุซุฑ ุชูุนููุงู)
โ ุงููุฏูุฑ ูุณุชุทูุน ุฑุคูุฉ ุงูุชูุฑุงุฑ ูู "ุงูุนููุงุก ุงูููุฑุฑูู"
```

#### ุงูุณููุงุฑูู 3: ููุณ ุงูุจุฑูุฏ ุจุฃูุซุฑ ูู ุญุณุงุจ
```
ุงูุชุณุฌูู 1: ahmad@example.com (ุญุณุงุจ ูุฏูู ุบูุฑ ููุนู)
ุงูุชุณุฌูู 2: ahmad@example.com (ุญุณุงุจ ุฌุฏูุฏ ููุนู)

ุงููุชูุฌุฉ:
โ ูุธูุฑ ุงูุญุณุงุจ ุงูููุนู
```

---

## ๐ ุงูุฅุญุตุงุฆูุงุช ูุงูุฃุฏุงุก

### ุงูุชุญุณููุงุช

1. **Index ุนูู ุงูุฌูุงู:**
```sql
CREATE INDEX idx_user_profiles_phone
ON user_profiles(phone)
WHERE phone IS NOT NULL;
```

2. **ุงุณุชุนูุงู ููุญุฏ ุจุฏูุงู ูู ุงุณุชุนูุงูุงุช ูุชุนุฏุฏุฉ**
- ูุจู: 3 ุงุณุชุนูุงูุงุช ูููุตูุฉ
- ุจุนุฏ: ุงุณุชุนูุงู ูุงุญุฏ ุดุงูู โ

3. **ููุน ุงูุชูุฑุงุฑ ุนูู ูุณุชูู ูุงุนุฏุฉ ุงูุจูุงูุงุช**
- `DISTINCT ON` ุฃุณุฑุน ูู `GROUP BY`
- ูุญุงูุธ ุนูู ุงูุฃุฏุงุก ุญุชู ูุน ุขูุงู ุงูุณุฌูุงุช

---

## โ ุณููุงุฑูููุงุช ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุงุฑ 1: ุนููู ุฌุฏูุฏ ุชูุงูุงู
```
ุงูุฅุฏุฎุงู:
- ุงูุฌูุงู: 0509999999
- ุงูุจุฑูุฏ: new@example.com

ุงูุชููุน:
โ ูุธูุฑ ูู ูุงุฆูุฉ ุงูุนููุงุก ูุจุงุดุฑุฉ
โ ูุง ุชูุฑุงุฑ
```

### ุงุฎุชุจุงุฑ 2: ุญุฌุฒ ูุคูุช ุซู ุชุณุฌูู
```
ุงูุฎุทูุฉ 1: ุญุฌุฒ ูุคูุช
- ุงูุฌูุงู: 0508888888

ุงูุฎุทูุฉ 2: ุชุณุฌูู ุญุณุงุจ ูุงูู
- ุงูุฌูุงู: 0508888888
- ุงูุจุฑูุฏ: user@example.com

ุงูุชููุน:
โ ูุธูุฑ ุญุณุงุจ ูุงุญุฏ ููุท
โ ุงูุญุณุงุจ ุงููุงูู (ุงูููุนู) ูู ุงูุฃููููุฉ
```

### ุงุฎุชุจุงุฑ 3: ุชุณุฌูู ููุฑุฑ ุจุงูุฎุทุฃ
```
ุงููุญุงููุฉ 1: 0507777777 + old@example.com
ุงููุญุงููุฉ 2: 0507777777 + new@example.com

ุงูุชููุน:
โ ูุธูุฑ ุญุณุงุจ ูุงุญุฏ ูู ุงููุงุฆูุฉ
โ ุงูุชูุฑุงุฑ ูุธูุฑ ูู "ุงูุนููุงุก ุงูููุฑุฑูู"
โ ุงููุฏูุฑ ูุณุชุทูุน ุฑุคูุฉ ููุง ุงูุญุณุงุจูู
```

---

## ๐ ุฏููู ุงูุงุณุชุฎุฏุงู ูููุฏูุฑ

### ููุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ ุชูุฑุงุฑ:

```
1. ุงูุฏุฎูู ููุณู ุงูุนููุงุก
2. ุงูููุฑ ุนูู "ุงูุนููุงุก ุงูููุฑุฑูู"
3. ุฅุฐุง ุธูุฑุช ุฑุณุงูุฉ "ุงููุธุงู ูุธูู" โ
   โ ูุง ุชูุฌุฏ ูุดููุฉ
4. ุฅุฐุง ุธูุฑุช ูุงุฆูุฉ ุจุงูููุฑุฑุงุช:
   โ ุฑุงุฌุน ูู ูููุฉ ููุฑุฑุฉ
   โ ูุฑุฑ ุฅุฐุง ููุช ุชุฑูุฏ ุฏูุฌ ุงูุญุณุงุจุงุช ุฃู ุงูุฅุจูุงุก ุนูููุง
```

### ููุจุญุซ ุนู ุนููู:

```
ุงูุขู ููููู ุงูุจุญุซ ุจู:
โ ุงูุงุณู
โ ุงูุฌูุงู
โ ุงูุจุฑูุฏ
โ User ID

ุงููุธุงู ูุฌุฏ ุงูุนููู ุจุฃู ุทุฑููุฉ!
```

---

## ๐ ุงูุฃูุงู

### ุงูุญูุงูุฉ ูู:

1. **SQL Injection:**
   - โ ุงุณุชุฎุฏุงู Parameterized Queries
   - โ ุฏูุงู SECURITY DEFINER

2. **Data Leakage:**
   - โ RLS ูุญูู (ุงููุฏูุฑูู ููุท)
   - โ ุงุณุชุจุนุงุฏ ุญุณุงุจุงุช ุงููุฏูุฑูู ูู ูุงุฆูุฉ ุงูุนููุงุก

3. **Race Conditions:**
   - โ `DISTINCT ON` ูุนูู atomically
   - โ ูุง ุญุงุฌุฉ ูู transactions ูุนูุฏุฉ

---

## ๐ ููุฎุต ุงูุชุบููุฑุงุช

### ูุงุนุฏุฉ ุงูุจูุงูุงุช:
- โ ุชุญุฏูุซ `get_customers_list()` - ูุธุงู ููุญุฏ
- โ ุชุญุฏูุซ `get_customer_profile()` - ุจุญุซ ูุฑู
- โ ุฅุถุงูุฉ `find_duplicate_customers()` - ุงูุชุดุงู ุงูุชูุฑุงุฑ
- โ ุฅุถุงูุฉ Index ุนูู ุงูุฌูุงู ููุฃุฏุงุก

### ุงูููุฏ:
- โ ุชุญุฏูุซ `customerManagementService.ts`
- โ ุชุญุฏูุซ `CustomersList.tsx` - ุฒุฑ ุฌุฏูุฏ
- โ ุชุญุฏูุซ `CustomersSection.tsx` - view ุฌุฏูุฏ
- โ ุฅุถุงูุฉ `DuplicateCustomersManager.tsx` - ูููู ุฌุฏูุฏ

### ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ:
- โ ูููุฉ ููุญุฏุฉ (ุฌูุงู ุฃู ุจุฑูุฏ)
- โ ููุน ุงูุชูุฑุงุฑ ุชููุงุฆูุงู
- โ ุงูุชุดุงู ุงูููุฑุฑุงุช
- โ ุจุญุซ ูุฑู (3 ุทุฑู)
- โ ูุงุฌูุฉ ูุฅุฏุงุฑุฉ ุงูููุฑุฑุงุช

---

## ๐ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

```
ูุจู:
- ุนููู ูุงุญุฏ = ุญุณุงุจุงุช ูุชุนุฏุฏุฉ
- ุชูุฑุงุฑ ูู ุงููุงุฆูุฉ
- ุตุนูุจุฉ ูู ุงูุชุชุจุน

ุจุนุฏ:
โ ุนููู ูุงุญุฏ = ุณุฌู ูุงุญุฏ ูู ุงููุงุฆูุฉ
โ ูุง ุชูุฑุงุฑ (ูุชู ูุนุงูุฌุชู ุชููุงุฆูุงู)
โ ุณูููุฉ ูู ุงูุจุญุซ ูุงูุชุชุจุน
โ ุดูุงููุฉ ูุงููุฉ (ุฑุคูุฉ ุงูููุฑุฑุงุช ุฅุฐุง ูุฌุฏุช)
```

---

## ๐ ุงูุฎูุงุตุฉ

ุงููุธุงู ุงูุขู:
1. **ูุฌูุน** ุฌููุน ุงููุณุฌููู ูู ูู ุงููุตุงุฏุฑ
2. **ููุญุฏ** ุงููููุฉ ุจูุงุกู ุนูู ุงูุฌูุงู ุฃู ุงูุจุฑูุฏ
3. **ูููุน** ุฃู ุชูุฑุงุฑ ูู ุงููุงุฆูุฉ
4. **ููุดู** ุงูููุฑุฑุงุช ูููุฏูุฑ (ุฅุฐุง ูุฌุฏุช)
5. **ูููุฑ** ูุฑููุฉ ูู ุงูุจุญุซ ูุงููุตูู

**ุงููุธุงู ุฌุงูุฒ ููุนูู ุจููุงุกุฉ ุนุงููุฉ!** ๐ฏ
