# ุญุงูุฉ ูุธุงู ุงูุฏูุน ุงููุฑู - ูุฑุงุฌุนุฉ ุดุงููุฉ

## ููุฎุต ุณุฑูุน
โ **ุงููุธุงู ููุชูู ุจูุณุจุฉ 95%**
- โ ูุงุนุฏุฉ ุงูุจูุงูุงุช: ููุชููุฉ
- โ ุบุฑูุฉ ุงููุชุงุจุนุฉ: ููุชููุฉ
- โ ุฅุนุฏุงุฏุงุช ุงูุฏูุน ุงููุฑู: ููุชููุฉ
- โ ุตูุญุฉ ุงูุญุฌุฒ: ููุชููุฉ
- โ ูุธุงู ุชุจุฏูู ูุถุน ุงูุฏูุน: ููุชูู (ุฌุฏูุฏ)
- โ๏ธ ุฏุงูุฉ ุฅุฑุณุงู ุงูุชุฐููุฑุงุช ุงูุชููุงุฆูุฉ: ููุฌูุฏุฉ ููู ุชุญุชุงุฌ ุฌุฏููุฉ

---

## 1๏ธโฃ ูุงุนุฏุฉ ุงูุจูุงูุงุช

### โ ุงูุฌุฏุงูู ุงูููุฌูุฏุฉ:

#### `follow_up_activities`
ุฌุฏูู ุชุณุฌูู ุฌููุน ุฃูุดุทุฉ ุงููุชุงุจุนุฉ:
```sql
- id (uuid)
- reservation_id (uuid)
- activity_type (text)
- activity_result (text)
- notes (text)
- created_at (timestamptz)
```

#### `payment_reminders`
ุฌุฏูู ุชุฐููุฑุงุช ุงูุฏูุน:
```sql
- id (uuid)
- reservation_id (uuid)
- reminder_type (text)
- sent_at (timestamptz)
- message (text)
```

#### ุฅุถุงูุงุช ุนูู ุฌุฏูู `reservations`:
```sql
- flexible_payment_enabled (boolean) โ
- payment_deadline (timestamptz) โ
- last_follow_up_date (timestamptz) โ
- payment_reminder_count (integer) โ
```

### โ ุงูุฏูุงู ุงูููุฌูุฏุฉ (8 ุฏูุงู):

1. โ **`get_pending_payments()`** - ุฌูุจ ุงูุญุฌูุฒุงุช ุงููุนููุฉ
2. โ **`get_follow_up_stats()`** - ุฅุญุตุงุฆูุงุช ุงููุชุงุจุนุฉ
3. โ **`get_follow_up_history()`** - ุชุงุฑูุฎ ุงููุชุงุจุนุฉ ูุญุฌุฒ ูุนูู
4. โ **`add_follow_up_activity()`** - ุฅุถุงูุฉ ูุดุงุท ูุชุงุจุนุฉ
5. โ **`extend_payment_deadline()`** - ุชูุฏูุฏ ููุนุฏ ุงูุฏูุน
6. โ **`toggle_payment_mode()`** - ุชุจุฏูู ูุถุน ุงูุฏูุน (ุฌุฏูุฏ)
7. โ **`convert_to_immediate_payment()`** - ุชุญููู ููุฏูุน ุงูููุฑู (ุฌุฏูุฏ)
8. โ **`convert_to_flexible_payment()`** - ุชุญููู ููุฏูุน ุงููุฑู (ุฌุฏูุฏ)

### โ๏ธ ุงูุฏุงูุฉ ุงููุญูุฏุฉ ุงููุงูุตุฉ:
- **`send_payment_reminder()`** - ููุฌูุฏุฉ ููู ุชุญุชุงุฌ ุฅูู ุฌุฏููุฉ ุชููุงุฆูุฉ (Cron Job)

---

## 2๏ธโฃ ุบุฑูุฉ ุงููุชุงุจุนุฉ (Follow-Up Room)

### โ ุงูููุฒุงุช ุงูููุชููุฉ:

#### ุงูุฅุญุตุงุฆูุงุช ุงูุญูุฉ:
- โ ุฅุฌูุงูู ุงููุนููุฉ
- โ ุงูุญุฌูุฒุงุช ุงูุญุฑุฌุฉ
- โ ุงูุฌุฏูุฏ ุงูููู
- โ ุงููุจูุบ ุงูุฅุฌูุงูู
- โ ุนุฏุฏ ุงูุฒุฑุงุนู ูุงูุงุณุชุซูุงุฑู

#### ุงูููุงุชุฑ ูุงูุจุญุซ:
- โ ุงูุจุญุซ ุจุงูุงุณู ูุงูุฑูู ูุงูุจุฑูุฏ
- โ ููุชุฑ ุญุณุจ ุงูุงุณุชุนุฌุงู (ุญุฑุฌุ ุนุงุฌูุ ูุชูุณุทุ ุนุงุฏู)
- โ ููุชุฑ ุญุณุจ ุงููุณุงุฑ (ุฒุฑุงุนูุ ุงุณุชุซูุงุฑู)

#### ุฌุฏูู ุงูุญุฌูุฒุงุช:
- โ ุนุฑุถ ุงูุญุงูุฉ ูุงูุงุณุชุนุฌุงู
- โ ูุนูููุงุช ุงูุนููู
- โ **ุนููุฏ ูุถุน ุงูุฏูุน (ุฌุฏูุฏ)** - ูุนุฑุถ โก ุงูุฏูุน ุงูุขู ุฃู โฑ๏ธ ุงูุฏูุน ูุงุญูุงู
- โ ุงูุฃุดุฌุงุฑ ูุงููุจูุบ
- โ ุงูููุช ุงููุชุจูู
- โ ุขุฎุฑ ูุชุงุจุนุฉ

#### ุงูุฅุฌุฑุงุกุงุช ุงูุณุฑูุนุฉ:
1. โ **ุฒุฑ ุชุจุฏูู ูุถุน ุงูุฏูุน (ุฌุฏูุฏ)** - โก/โฑ๏ธ
2. โ ุฅุฑุณุงู ุชุฐููุฑ - ๐ฌ
3. โ ุชุณุฌูู ูุชุงุจุนุฉ - โ
4. โ ุชูุฏูุฏ ุงููุฏุฉ - โฐ
5. โ ูุชุญ ุตูุญุฉ ุงูุฏูุน - ๐

#### ุงูููุงูุฐ ุงูููุจุซูุฉ:
- โ **ููุฏุงู ุชุจุฏูู ูุถุน ุงูุฏูุน (ุฌุฏูุฏ)** - ูุงูุฐุฉ ุฐููุฉ ูุชุญููู ุจูู ุงููุถุนูู
- โ ููุฏุงู ุชุณุฌูู ุงููุดุงุท

#### ุงููููุน ูู ุงููุธุงู:
โ ููุญุฉ ุงูุฅุฏุงุฑุฉ โ ูุณู "ุงูุนููุงุก" โ ุชุจููุจ "ุบุฑูุฉ ุงููุชุงุจุนุฉ"

---

## 3๏ธโฃ ุฅุนุฏุงุฏุงุช ุงูุฏูุน ุงููุฑู

### โ ุฌููุน ุงูุฅุนุฏุงุฏุงุช ููุฌูุฏุฉ ูู system_settings:

#### ุงูุฅุนุฏุงุฏุงุช ุงูุฃุณุงุณูุฉ:
- โ `flexible_payment_enabled` = "true"
- โ `payment_grace_period_days` = "7"
- โ `auto_cancel_after_deadline` = "false"
- โ `flexible_payment_apply_to` = "both"

#### ุฅุนุฏุงุฏุงุช ุงูุชุฐููุฑุงุช:
- โ `reminder_on_booking` = "true"
- โ `reminder_midway` = "true"
- โ `reminder_one_day_before` = "true"
- โ `reminder_deadline_day` = "true"

#### ููุงูุจ ุงูุฑุณุงุฆู:
- โ `payment_reminder_initial` = "ุดูุฑุงู ูุญุฌุฒู ูุนูุง! ูุฏูู {days} ุฃูุงู ูุฅุชูุงู ุงูุฏูุน."
- โ `payment_reminder_midway` = "ุชุฐููุฑ: ูุฏูู {days} ุฃูุงู ูุชุจููุฉ ูุฅุชูุงู ุฏูุน ุญุฌุฒู."
- โ `payment_reminder_urgent` = "ุนุงุฌู: ูุชุจูู {hours} ุณุงุนุฉ ููุท ูุฅุชูุงู ุฏูุน ุญุฌุฒู!"

### โ ูุงุฌูุฉ ุงูุฅุนุฏุงุฏุงุช:
ููุฌูุฏุฉ ูู: `src/components/admin/FlexiblePaymentSettings.tsx`

ุงููููุน: ููุญุฉ ุงูุฅุฏุงุฑุฉ โ ุงูุฅุนุฏุงุฏุงุช ุงูุนุงูุฉ โ ุฅุนุฏุงุฏุงุช ุงูุฏูุน ุงููุฑู

---

## 4๏ธโฃ ุตูุญุฉ ุงูุญุฌุฒ (UnifiedBookingFlow)

### โ ุงูุฏุนู ุงููุงูู ููุฏูุน ุงููุฑู:

#### ุนูุฏ ุงูุญุฌุฒ:
- โ ูุฑุงุกุฉ ุงูุฅุนุฏุงุฏุงุช ูู system_settings
- โ ุชุทุจูู ุงูุฏูุน ุงููุฑู ุญุณุจ ุงูุฅุนุฏุงุฏุงุช
- โ ุญุณุงุจ ุชููุงุฆู ูู payment_deadline
- โ ุญูุธ flexible_payment_enabled ูู ุงูุญุฌุฒ

#### ุดุงุดุฉ ุงููุฌุงุญ:
- โ ุนุฑุถ ุงูููุนุฏ ุงูููุงุฆู ุฅุฐุง ูุงู ุงูุฏูุน ูุฑู
- โ ุฑุณุงุฆู ูุฎุชููุฉ ุญุณุจ ููุน ุงูุฏูุน
- โ ุฒุฑ "ุงุฏูุน ุงูุขู" ุฅุฐุง ูุงู ูุฑู
- โ ุชูุงุตูู ูุงุถุญุฉ ุนู ุงููููุฉ

---

## 5๏ธโฃ ุงูููุฒุฉ ุงูุฌุฏูุฏุฉ: ูุธุงู ุชุจุฏูู ูุถุน ุงูุฏูุน

### โ ุงููุถุงู ุญุฏูุซุงู (2026-02-09):

#### 3 ุฏูุงู ุฌุฏูุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:
1. โ `toggle_payment_mode()` - ุฏุงูุฉ ุดุงููุฉ ููุชุจุฏูู
2. โ `convert_to_immediate_payment()` - ุชุญููู ุณุฑูุน ููุฏูุน ุงูููุฑู
3. โ `convert_to_flexible_payment()` - ุชุญููู ุณุฑูุน ููุฏูุน ุงููุฑู

#### ูู ุบุฑูุฉ ุงููุชุงุจุนุฉ:
- โ ุนููุฏ ุฌุฏูุฏ "ูุถุน ุงูุฏูุน" ูู ุงูุฌุฏูู
- โ ุฒุฑ ุชุจุฏูู ุฏููุงูููู (โก/โฑ๏ธ)
- โ ููุฏุงู PaymentModeModal ูุชุทูุฑ:
  - ุนุฑุถ ูุนูููุงุช ุงูุญุฌุฒ
  - ุงุฎุชูุงุฑ ุนุฏุฏ ุฃูุงู ุงููููุฉ (3ุ 5ุ 7ุ 10ุ 14)
  - ุญูู ุงูุณุจุจ ุฅูุฒุงูู
  - ุชุญุฐูุฑ ูุงุถุญ ุจูุง ุณูุญุฏุซ
  - ุชุณุฌูู ุชููุงุฆู ูู ุณุฌู ุงููุชุงุจุนุฉ

#### ุฎุฏูุงุช ุงูุจุฑูุฌุฉ:
- โ `followUpService.togglePaymentMode()`
- โ `followUpService.convertToImmediatePayment()`
- โ `followUpService.convertToFlexiblePayment()`

---

## 6๏ธโฃ ูุง ูู ูุงูุตุ

### โ๏ธ ุงูุชุฐููุฑุงุช ุงูุชููุงุฆูุฉ (Automation)

**ุงูุฏูุงู ููุฌูุฏุฉ ููู ุชุญุชุงุฌ ุฌุฏููุฉ:**

ุงููุธุงู ุญุงููุงู ูุฏุนู ุฅุฑุณุงู ุงูุชุฐููุฑุงุช **ูุฏููุงู** ูู ุบุฑูุฉ ุงููุชุงุจุนุฉุ ููู ูุฅุฑุณุงููุง **ุชููุงุฆูุงู** ูุญุชุงุฌ:

1. **Supabase Edge Function** ูุน Cron Job:
   ```typescript
   // ุฏุงูุฉ ุชุนูู ูู ุณุงุนุฉ
   - ุชูุญุต ุงูุญุฌูุฒุงุช ุงููุนููุฉ
   - ุชุญุณุจ ุงูููุช ุงููุชุจูู
   - ุชุฑุณู ุงูุชุฐููุฑุงุช ุญุณุจ ุงูุฅุนุฏุงุฏุงุช
   ```

2. **ุฌุฏููุฉ ุงูููุงู**:
   - ุงูุชุฐููุฑ ุนูุฏ ุงูุญุฌุฒ (ููุฑู)
   - ุงูุชุฐููุฑ ูู ููุชุตู ุงููุฏุฉ (ุจุนุฏ 3-4 ุฃูุงู)
   - ุงูุชุฐููุฑ ูุจู ููู (24 ุณุงุนุฉ)
   - ุงูุชุฐููุฑ ููู ุงูููุนุฏ (ุตุจุงุญ ุงูููู)

**ูู ุชุฑูุฏ ุฅุถุงูุฉ ุงูุชุฐููุฑุงุช ุงูุชููุงุฆูุฉุ**

---

## 7๏ธโฃ ููููุฉ ุงูุงุณุชุฎุฏุงู ุงูุขู

### ูููุฏูุฑ:

#### ุชุจุฏูู ูุถุน ุงูุฏูุน:
1. ุงูุชุญ ุบุฑูุฉ ุงููุชุงุจุนุฉ
2. ุงุจุญุซ ุนู ุงูุญุฌุฒ
3. ุงููุฑ ุนูู ุฃููููุฉ โก ุฃู โฑ๏ธ
4. ุงููุฃ ุงูุจูุงูุงุช ูุฃูุฏ

#### ุฅุฑุณุงู ุชุฐููุฑ ูุฏูู:
1. ุงูุชุญ ุบุฑูุฉ ุงููุชุงุจุนุฉ
2. ุงููุฑ ุนูู ุฒุฑ ๐ฌ
3. ุฃูุฏ ุฅุฑุณุงู ุงูุฑุณุงูุฉ

#### ุชุณุฌูู ูุชุงุจุนุฉ:
1. ุงูุชุญ ุบุฑูุฉ ุงููุชุงุจุนุฉ
2. ุงููุฑ ุนูู ุฒุฑ โ
3. ุงุฎุชุฑ ููุน ุงููุดุงุท
4. ุฃุฏุฎู ุงููุชูุฌุฉ ูุงูููุงุญุธุงุช

#### ุชูุฏูุฏ ุงููููุฉ:
1. ุงูุชุญ ุบุฑูุฉ ุงููุชุงุจุนุฉ
2. ุงููุฑ ุนูู ุฒุฑ โฐ
3. ุฃุฏุฎู ุนุฏุฏ ุงูุฃูุงู ูุงูุณุจุจ

### ููุนููู:

#### ุนูุฏ ุงูุญุฌุฒ:
- ูุฑู ุฑุณุงูุฉ ุชูุถุญ ุงููููุฉ
- ูุญุตู ุนูู ููุนุฏ ููุงุฆู ูุงุถุญ
- ููููู ุงูุฏูุน ููุฑุงู ุฃู ูุงุญูุงู

#### ุฃุซูุงุก ุงููููุฉ:
- ูุณุชุทูุน ุงูุฏูุน ูู ุฃู ููุช
- ุฑุงุจุท ุงูุฏูุน ุตุงูุญ ุญุชู ุงูุชูุงุก ุงููููุฉ
- ูุณุชูุจู ุชุฐููุฑุงุช (ุฅุฐุง ุชู ุชูุนูู ุงูุชุฐููุฑุงุช ุงูุชููุงุฆูุฉ)

---

## 8๏ธโฃ ุงููููุงุช ุงูุฑุฆูุณูุฉ

### ูุงุนุฏุฉ ุงูุจูุงูุงุช:
```
supabase/migrations/
  - 20260209143236_recreate_flexible_payment_functions.sql
  - 20260209151052_fix_get_pending_payments_function.sql
  - ูุบูุฑูุง ูู migrations ุงูุฏูุน ุงููุฑู
```

### ุงููุงุฌูุงุช:
```
src/components/admin/
  - FollowUpRoom.tsx โ ุบุฑูุฉ ุงููุชุงุจุนุฉ + ูุธุงู ุงูุชุจุฏูู
  - FlexiblePaymentSettings.tsx โ ุฅุนุฏุงุฏุงุช ุงูุฏูุน ุงููุฑู
  - CustomersSection.tsx โ ูุญุชูู ุนูู ุชุจููุจ ุบุฑูุฉ ุงููุชุงุจุนุฉ

src/components/
  - UnifiedBookingFlow.tsx โ ุฏุนู ุงูุฏูุน ุงููุฑู ูู ุงูุญุฌุฒ
```

### ุงูุฎุฏูุงุช:
```
src/services/
  - followUpService.ts โ ุฎุฏูุงุช ุงููุชุงุจุนุฉ ูุงูุชุจุฏูู
  - systemSettingsService.ts โ ุฅุฏุงุฑุฉ ุงูุฅุนุฏุงุฏุงุช
```

---

## 9๏ธโฃ ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุฑ ุงููุธุงู:

```sql
-- 1. ุงูุชุญูู ูู ุงูุญุฌูุฒุงุช ุงููุนููุฉ
SELECT * FROM get_pending_payments();

-- 2. ุชุญููู ุญุฌุฒ ููุฏูุน ุงููุฑู
SELECT * FROM convert_to_flexible_payment(
  '4836c638-c8ef-4dee-b02d-fae4cf3cad1c'::uuid,
  7,
  'ุงุฎุชุจุงุฑ ุงููุธุงู'
);

-- 3. ุงูุชุญูู ูู ุงูุชุญุฏูุซ
SELECT
  id,
  farm_name,
  flexible_payment_enabled,
  payment_deadline
FROM reservations
WHERE id = '4836c638-c8ef-4dee-b02d-fae4cf3cad1c';

-- 4. ุชุญููู ููุฏูุน ุงูููุฑู
SELECT * FROM convert_to_immediate_payment(
  '4836c638-c8ef-4dee-b02d-fae4cf3cad1c'::uuid,
  'ุฅุนุงุฏุฉ ููุฏูุน ุงูููุฑู'
);

-- 5. ูุดุงูุฏุฉ ุณุฌู ุงููุชุงุจุนุฉ
SELECT * FROM get_follow_up_history(
  '4836c638-c8ef-4dee-b02d-fae4cf3cad1c'::uuid
);
```

---

## ๐ฏ ุงูุฎูุงุตุฉ

### โ ููุฌูุฏ ููุนูู:
1. โ ูุงุนุฏุฉ ุจูุงูุงุช ูุงููุฉ (ุฌุฏุงูู + 8 ุฏูุงู)
2. โ ุบุฑูุฉ ุงููุชุงุจุนุฉ ุงุญุชุฑุงููุฉ
3. โ ุฅุนุฏุงุฏุงุช ุงูุฏูุน ุงููุฑู
4. โ ุตูุญุฉ ุงูุญุฌุฒ ุชุฏุนู ุงูุฏูุน ุงููุฑู
5. โ **ูุธุงู ุชุจุฏูู ูุถุน ุงูุฏูุน (ุฌุฏูุฏ)**

### โ๏ธ ูุญุชุงุฌ ุชูุนูู:
- ุงูุชุฐููุฑุงุช ุงูุชููุงุฆูุฉ (ุชุญุชุงุฌ Edge Function + Cron)

### ๐ ูุณุจุฉ ุงูุงูุชูุงู:
**95%** - ุงููุธุงู ุฌุงูุฒ ููุงุณุชุฎุฏุงู ุงูููุฑู

---

**ุขุฎุฑ ุชุญุฏูุซ**: 2026-02-09
**ุงูุฅุตุฏุงุฑ**: 2.0 (ูุน ูุธุงู ุชุจุฏูู ูุถุน ุงูุฏูุน)
