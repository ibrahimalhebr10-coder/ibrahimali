/*
  # Ù…Ù†Ø¸ÙˆÙ…Ø© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… (Advanced AI Assistant System)

  ## Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©
  Ù…Ù†Ø¸ÙˆÙ…Ø© Ù…ØªÙƒØ§Ù…Ù„Ø© Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ ØªØªØ¶Ù…Ù†:
  - Ù‚Ø§Ø¹Ø¯Ø© Ù…Ø¹Ø±ÙÙŠØ© Ù…Ù†Ø¸Ù…Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª
  - ÙÙ‡Ù… Ø°ÙƒÙŠ Ù„Ù„Ù†ÙŠØ© (Intent Recognition)
  - ÙˆØ¹ÙŠ Ø¨Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Context Awareness)
  - Ù†Ø¸Ø§Ù… ØªØ¹Ù„Ù… Ù…Ù†Ø¶Ø¨Ø· (Controlled Learning)
  - ØªØ­Ù„ÙŠÙ„Ø§Øª ÙˆØ¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø©

  ## Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©

  ### 1. knowledge_domains
  Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:
  - Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠ
  - Ø§Ù„Ø£Ø´Ø¬Ø§Ø± ÙˆØ§Ù„Ù…Ø­Ø§ØµÙŠÙ„
  - Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„
  - Ø´Ø±ÙŠÙƒ Ø§Ù„Ù†Ø¬Ø§Ø­
  - Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ§Ù„ØµÙŠØ§Ù†Ø©

  ### 2. knowledge_topics
  Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹ Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ù…Ø¬Ø§Ù„ Ø§Ù„Ù…Ø¹Ø±ÙÙŠ

  ### 3. knowledge_articles
  Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ Ø§Ù„Ù…ÙØµÙ„

  ### 4. faqs (Frequently Asked Questions)
  Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© Ù…Ø¹ Ø£Ø¬ÙˆØ¨ØªÙ‡Ø§ ÙˆØ£Ù†Ù…Ø§Ø· Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø®ØªÙ„ÙØ©

  ### 5. intent_patterns
  Ø£Ù†Ù…Ø§Ø· ÙÙ‡Ù… Ø§Ù„Ù†ÙŠØ© Ù…Ù† Ø§Ù„Ø³Ø¤Ø§Ù„

  ### 6. conversation_sessions
  Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†

  ### 7. conversation_messages
  Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ø¬Ù„Ø³Ø© Ù…Ø­Ø§Ø¯Ø«Ø©

  ### 8. user_context_tracking
  ØªØªØ¨Ø¹ Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ³Ù„ÙˆÙƒÙ‡ ÙÙŠ Ø§Ù„Ù…Ù†ØµØ©

  ### 9. learning_suggestions
  Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„ØªØ­Ø³ÙŠÙ† Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©

  ### 10. unanswered_questions
  Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªÙŠ Ù„Ù… ÙŠØ³ØªØ·Ø¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„ÙŠÙ‡Ø§

  ### 11. assistant_analytics
  Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØªØ­Ù„ÙŠÙ„Ø§Øª Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯

  ## Ø§Ù„Ø£Ù…Ø§Ù†
  - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ù…Ø­Ù…ÙŠØ© Ø¨Ù€ RLS
  - Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ø¯ÙŠÙ‡Ø§ ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒØ§Ù…Ù„Ø©
  - Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„ØªÙØ§Ø¹Ù„ ÙÙ‚Ø·
  - Ø§Ù„Ø²ÙˆØ§Ø± ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø¨Ø´ÙƒÙ„ Ù…Ø­Ø¯ÙˆØ¯
*/

-- ==========================================
-- 1. Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙÙŠØ© (Knowledge Domains)
-- ==========================================

CREATE TABLE IF NOT EXISTS knowledge_domains (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name_ar text NOT NULL,
  name_en text NOT NULL,
  description_ar text,
  description_en text,
  icon text,
  color text DEFAULT '#10b981',
  display_order int DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

ALTER TABLE knowledge_domains ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙŠÙ…ÙƒÙ†Ù‡Ù… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©"
  ON knowledge_domains FOR SELECT
  USING (is_active = true);

CREATE POLICY "Ø§Ù„Ù…Ø¯ÙŠØ±ÙˆÙ† ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª"
  ON knowledge_domains FOR ALL
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM admins 
      WHERE admins.user_id = auth.uid() 
      AND admins.is_active = true
    )
  )
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM admins 
      WHERE admins.user_id = auth.uid() 
      AND admins.is_active = true
    )
  );

-- ==========================================
-- 2. Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹ (Knowledge Topics)
-- ==========================================

CREATE TABLE IF NOT EXISTS knowledge_topics (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  domain_id uuid NOT NULL REFERENCES knowledge_domains(id) ON DELETE CASCADE,
  title_ar text NOT NULL,
  title_en text NOT NULL,
  summary_ar text,
  summary_en text,
  content_ar text,
  content_en text,
  keywords text[], -- ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ© Ù„Ù„Ø¨Ø­Ø«
  target_audience text DEFAULT 'all', -- all, visitor, investor, partner
  response_tone text DEFAULT 'professional', -- professional, friendly, reassuring
  detail_level text DEFAULT 'medium', -- basic, medium, detailed
  related_page_url text, -- Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
  display_order int DEFAULT 0,
  is_active boolean DEFAULT true,
  views_count int DEFAULT 0,
  helpful_count int DEFAULT 0,
  not_helpful_count int DEFAULT 0,
  created_by uuid REFERENCES auth.users(id),
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

ALTER TABLE knowledge_topics ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙŠÙ…ÙƒÙ†Ù‡Ù… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹ Ø§Ù„Ù†Ø´Ø·Ø©"
  ON knowledge_topics FOR SELECT
  USING (is_active = true);

CREATE POLICY "Ø§Ù„Ù…Ø¯ÙŠØ±ÙˆÙ† ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹"
  ON knowledge_topics FOR ALL
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM admins 
      WHERE admins.user_id = auth.uid() 
      AND admins.is_active = true
    )
  )
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM admins 
      WHERE admins.user_id = auth.uid() 
      AND admins.is_active = true
    )
  );

-- ==========================================
-- 3. Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© (FAQs)
-- ==========================================

CREATE TABLE IF NOT EXISTS assistant_faqs (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  topic_id uuid REFERENCES knowledge_topics(id) ON DELETE CASCADE,
  domain_id uuid REFERENCES knowledge_domains(id) ON DELETE CASCADE,
  question_ar text NOT NULL,
  question_en text NOT NULL,
  answer_ar text NOT NULL,
  answer_en text NOT NULL,
  question_variations jsonb DEFAULT '[]'::jsonb, -- ØµÙŠØº Ù…Ø®ØªÙ„ÙØ© Ù„Ù„Ø³Ø¤Ø§Ù„
  intent_tags text[], -- tags Ù„Ù„Ù†ÙŠØ©
  context_requirements jsonb DEFAULT '{}'::jsonb, -- Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø³ÙŠØ§Ù‚
  target_audience text DEFAULT 'all',
  confidence_threshold float DEFAULT 0.7, -- Ø­Ø¯ Ø§Ù„Ø«Ù‚Ø© Ù„Ù„ØªØ·Ø§Ø¨Ù‚
  display_order int DEFAULT 0,
  is_active boolean DEFAULT true,
  is_approved boolean DEFAULT false, -- Ù…Ø¹ØªÙ…Ø¯ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
  usage_count int DEFAULT 0,
  helpful_count int DEFAULT 0,
  not_helpful_count int DEFAULT 0,
  created_by uuid REFERENCES auth.users(id),
  approved_by uuid REFERENCES auth.users(id),
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  approved_at timestamptz
);

ALTER TABLE assistant_faqs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙŠÙ…ÙƒÙ†Ù‡Ù… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©"
  ON assistant_faqs FOR SELECT
  USING (is_active = true AND is_approved = true);

CREATE POLICY "Ø§Ù„Ù…Ø¯ÙŠØ±ÙˆÙ† ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©"
  ON assistant_faqs FOR ALL
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM admins 
      WHERE admins.user_id = auth.uid() 
      AND admins.is_active = true
    )
  )
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM admins 
      WHERE admins.user_id = auth.uid() 
      AND admins.is_active = true
    )
  );

-- ==========================================
-- 4. Ø£Ù†Ù…Ø§Ø· ÙÙ‡Ù… Ø§Ù„Ù†ÙŠØ© (Intent Patterns)
-- ==========================================

CREATE TABLE IF NOT EXISTS intent_patterns (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  intent_name text NOT NULL UNIQUE,
  intent_name_ar text NOT NULL,
  description text,
  patterns text[], -- Ø£Ù†Ù…Ø§Ø· regex Ø£Ùˆ keywords
  examples jsonb DEFAULT '[]'::jsonb, -- Ø£Ù…Ø«Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
  priority int DEFAULT 0, -- Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
  is_active boolean DEFAULT true,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

ALTER TABLE intent_patterns ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙŠÙ…ÙƒÙ†Ù‡Ù… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù†Ø´Ø·Ø©"
  ON intent_patterns FOR SELECT
  USING (is_active = true);

CREATE POLICY "Ø§Ù„Ù…Ø¯ÙŠØ±ÙˆÙ† ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù†Ù…Ø§Ø·"
  ON intent_patterns FOR ALL
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM admins 
      WHERE admins.user_id = auth.uid() 
      AND admins.is_active = true
    )
  )
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM admins 
      WHERE admins.user_id = auth.uid() 
      AND admins.is_active = true
    )
  );

-- ==========================================
-- 5. Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© (Conversation Sessions)
-- ==========================================

CREATE TABLE IF NOT EXISTS conversation_sessions (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES auth.users(id) ON DELETE SET NULL,
  session_fingerprint text, -- Ù„Ù„Ø²ÙˆØ§Ø±
  user_type text DEFAULT 'visitor', -- visitor, authenticated, investor, partner, admin
  current_page text, -- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  user_context jsonb DEFAULT '{}'::jsonb, -- Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  language text DEFAULT 'ar',
  is_active boolean DEFAULT true,
  satisfaction_rating int, -- 1-5
  feedback_text text,
  started_at timestamptz DEFAULT now(),
  ended_at timestamptz,
  last_activity_at timestamptz DEFAULT now()
);

ALTER TABLE conversation_sessions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† ÙŠÙ…ÙƒÙ†Ù‡Ù… Ù‚Ø±Ø§Ø¡Ø© Ø¬Ù„Ø³Ø§ØªÙ‡Ù…"
  ON conversation_sessions FOR SELECT
  TO authenticated
  USING (user_id = auth.uid());

CREATE POLICY "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø§Øª"
  ON conversation_sessions FOR INSERT
  WITH CHECK (true);

CREATE POLICY "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† ÙŠÙ…ÙƒÙ†Ù‡Ù… ØªØ­Ø¯ÙŠØ« Ø¬Ù„Ø³Ø§ØªÙ‡Ù…"
  ON conversation_sessions FOR UPDATE
  TO authenticated
  USING (user_id = auth.uid())
  WITH CHECK (user_id = auth.uid());

CREATE POLICY "Ø§Ù„Ø²ÙˆØ§Ø± ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø§Øª Ù…Ø¤Ù‚ØªØ©"
  ON conversation_sessions FOR INSERT
  TO anon
  WITH CHECK (user_id IS NULL);

CREATE POLICY "Ø§Ù„Ù…Ø¯ÙŠØ±ÙˆÙ† ÙŠÙ…ÙƒÙ†Ù‡Ù… Ù‚Ø±Ø§Ø¡Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ù„Ø³Ø§Øª"
  ON conversation_sessions FOR SELECT
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM admins 
      WHERE admins.user_id = auth.uid() 
      AND admins.is_active = true
    )
  );

-- ==========================================
-- 6. Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© (Conversation Messages)
-- ==========================================

CREATE TABLE IF NOT EXISTS conversation_messages (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id uuid NOT NULL REFERENCES conversation_sessions(id) ON DELETE CASCADE,
  message_type text NOT NULL, -- user, assistant, system
  content text NOT NULL,
  intent_detected text,
  confidence_score float,
  matched_faq_id uuid REFERENCES assistant_faqs(id),
  matched_topic_id uuid REFERENCES knowledge_topics(id),
  response_time_ms int, -- ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø¨Ø§Ù„Ù…ÙŠÙ„ÙŠ Ø«Ø§Ù†ÙŠØ©
  was_helpful boolean,
  user_feedback text,
  metadata jsonb DEFAULT '{}'::jsonb,
  created_at timestamptz DEFAULT now()
);

ALTER TABLE conversation_messages ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† ÙŠÙ…ÙƒÙ†Ù‡Ù… Ù‚Ø±Ø§Ø¡Ø© Ø±Ø³Ø§Ø¦Ù„ Ø¬Ù„Ø³Ø§ØªÙ‡Ù…"
  ON conversation_messages FOR SELECT
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM conversation_sessions 
      WHERE conversation_sessions.id = conversation_messages.session_id 
      AND conversation_sessions.user_id = auth.uid()
    )
  );

CREATE POLICY "Ø§Ù„Ø¬Ù…ÙŠØ¹ ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ø¦Ù„ Ù„Ø¬Ù„Ø³Ø§ØªÙ‡Ù…"
  ON conversation_messages FOR INSERT
  WITH CHECK (true);

CREATE POLICY "Ø§Ù„Ù…Ø¯ÙŠØ±ÙˆÙ† ÙŠÙ…ÙƒÙ†Ù‡Ù… Ù‚Ø±Ø§Ø¡Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„"
  ON conversation_messages FOR SELECT
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM admins 
      WHERE admins.user_id = auth.uid() 
      AND admins.is_active = true
    )
  );

-- ==========================================
-- 7. ØªØªØ¨Ø¹ Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (User Context Tracking)
-- ==========================================

CREATE TABLE IF NOT EXISTS user_context_tracking (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE,
  session_fingerprint text,
  current_page text,
  previous_pages text[],
  time_on_page int, -- seconds
  actions_taken jsonb DEFAULT '[]'::jsonb,
  user_investments jsonb DEFAULT '{}'::jsonb,
  user_interests jsonb DEFAULT '{}'::jsonb,
  tracked_at timestamptz DEFAULT now()
);

ALTER TABLE user_context_tracking ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† ÙŠÙ…ÙƒÙ†Ù‡Ù… Ù‚Ø±Ø§Ø¡Ø© Ø³ÙŠØ§Ù‚Ù‡Ù…"
  ON user_context_tracking FOR SELECT
  TO authenticated
  USING (user_id = auth.uid());

CREATE POLICY "Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠÙ…ÙƒÙ†Ù‡ ØªØªØ¨Ø¹ Ø§Ù„Ø³ÙŠØ§Ù‚"
  ON user_context_tracking FOR INSERT
  WITH CHECK (true);

CREATE POLICY "Ø§Ù„Ù…Ø¯ÙŠØ±ÙˆÙ† ÙŠÙ…ÙƒÙ†Ù‡Ù… Ù‚Ø±Ø§Ø¡Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³ÙŠØ§Ù‚Ø§Øª"
  ON user_context_tracking FOR SELECT
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM admins 
      WHERE admins.user_id = auth.uid() 
      AND admins.is_active = true
    )
  );

-- ==========================================
-- 8. Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„ØªØ­Ø³ÙŠÙ† (Learning Suggestions)
-- ==========================================

CREATE TABLE IF NOT EXISTS learning_suggestions (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  suggestion_type text NOT NULL, -- new_topic, improve_answer, new_faq, update_content
  subject_ar text NOT NULL,
  subject_en text,
  description text NOT NULL,
  confidence_score float DEFAULT 0,
  supporting_data jsonb DEFAULT '{}'::jsonb,
  frequency int DEFAULT 1, -- Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª ØªÙƒØ±Ø§Ø± Ù†ÙØ³ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­
  status text DEFAULT 'pending', -- pending, approved, rejected, implemented
  priority text DEFAULT 'medium', -- low, medium, high
  reviewed_by uuid REFERENCES auth.users(id),
  review_notes text,
  created_at timestamptz DEFAULT now(),
  reviewed_at timestamptz,
  implemented_at timestamptz
);

ALTER TABLE learning_suggestions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Ø§Ù„Ù…Ø¯ÙŠØ±ÙˆÙ† ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª"
  ON learning_suggestions FOR ALL
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM admins 
      WHERE admins.user_id = auth.uid() 
      AND admins.is_active = true
    )
  )
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM admins 
      WHERE admins.user_id = auth.uid() 
      AND admins.is_active = true
    )
  );

-- ==========================================
-- 9. Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØºÙŠØ± Ø§Ù„Ù…Ø¬Ø§Ø¨Ø© (Unanswered Questions)
-- ==========================================

CREATE TABLE IF NOT EXISTS unanswered_questions (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id uuid REFERENCES conversation_sessions(id) ON DELETE CASCADE,
  question text NOT NULL,
  user_type text,
  user_context jsonb DEFAULT '{}'::jsonb,
  current_page text,
  frequency int DEFAULT 1,
  status text DEFAULT 'new', -- new, reviewed, answered, ignored
  assigned_to uuid REFERENCES auth.users(id),
  notes text,
  created_at timestamptz DEFAULT now(),
  reviewed_at timestamptz
);

ALTER TABLE unanswered_questions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Ø§Ù„Ù…Ø¯ÙŠØ±ÙˆÙ† ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØºÙŠØ± Ø§Ù„Ù…Ø¬Ø§Ø¨Ø©"
  ON unanswered_questions FOR ALL
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM admins 
      WHERE admins.user_id = auth.uid() 
      AND admins.is_active = true
    )
  )
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM admins 
      WHERE admins.user_id = auth.uid() 
      AND admins.is_active = true
    )
  );

-- ==========================================
-- 10. Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ (Assistant Analytics)
-- ==========================================

CREATE TABLE IF NOT EXISTS assistant_analytics (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  metric_type text NOT NULL, -- sessions, messages, satisfaction, response_time, etc.
  metric_value float NOT NULL,
  metric_details jsonb DEFAULT '{}'::jsonb,
  time_period text DEFAULT 'day', -- hour, day, week, month
  recorded_at timestamptz DEFAULT now()
);

ALTER TABLE assistant_analytics ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Ø§Ù„Ù…Ø¯ÙŠØ±ÙˆÙ† ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡Ù… Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª"
  ON assistant_analytics FOR SELECT
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM admins 
      WHERE admins.user_id = auth.uid() 
      AND admins.is_active = true
    )
  );

CREATE POLICY "Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠÙ…ÙƒÙ†Ù‡ Ø¥Ø¶Ø§ÙØ© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª"
  ON assistant_analytics FOR INSERT
  WITH CHECK (true);

-- ==========================================
-- Ø¥Ù†Ø´Ø§Ø¡ Indexes Ù„Ù„Ø£Ø¯Ø§Ø¡
-- ==========================================

CREATE INDEX IF NOT EXISTS idx_knowledge_topics_domain 
  ON knowledge_topics(domain_id) WHERE is_active = true;

CREATE INDEX IF NOT EXISTS idx_assistant_faqs_topic 
  ON assistant_faqs(topic_id) WHERE is_active = true AND is_approved = true;

CREATE INDEX IF NOT EXISTS idx_assistant_faqs_domain 
  ON assistant_faqs(domain_id) WHERE is_active = true AND is_approved = true;

CREATE INDEX IF NOT EXISTS idx_conversation_sessions_user 
  ON conversation_sessions(user_id) WHERE is_active = true;

CREATE INDEX IF NOT EXISTS idx_conversation_messages_session 
  ON conversation_messages(session_id);

CREATE INDEX IF NOT EXISTS idx_unanswered_questions_status 
  ON unanswered_questions(status) WHERE status = 'new';

CREATE INDEX IF NOT EXISTS idx_learning_suggestions_status 
  ON learning_suggestions(status) WHERE status = 'pending';

-- ==========================================
-- Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„ÙŠØ©
-- ==========================================

-- Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
INSERT INTO knowledge_domains (name_ar, name_en, description_ar, description_en, icon, color, display_order) VALUES
  ('Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠ', 'Agricultural Investment', 'ÙƒÙ„ Ù…Ø§ ÙŠØªØ¹Ù„Ù‚ Ø¨Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ø±Ø¹ ÙˆØ§Ù„Ø£Ø´Ø¬Ø§Ø±', 'Everything about farm and tree investments', 'ğŸŒ¾', '#10b981', 1),
  ('Ø§Ù„Ø£Ø´Ø¬Ø§Ø± ÙˆØ§Ù„Ù…Ø­Ø§ØµÙŠÙ„', 'Trees and Crops', 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ø´Ø¬Ø§Ø± ÙˆØ§Ù„Ù…Ø­Ø§ØµÙŠÙ„ Ø§Ù„Ù…ØªØ§Ø­Ø©', 'Information about available tree types and crops', 'ğŸŒ³', '#22c55e', 2),
  ('Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„', 'Accounts and Registration', 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆØ¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ø¬ÙŠÙ„', 'Account management and registration process', 'ğŸ‘¤', '#3b82f6', 3),
  ('Ø´Ø±ÙŠÙƒ Ø§Ù„Ù†Ø¬Ø§Ø­', 'Success Partner', 'Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø´Ø±ÙŠÙƒ Ø§Ù„Ù†Ø¬Ø§Ø­ ÙˆØ§Ù„ØªØ³ÙˆÙŠÙ‚ Ø¨Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©', 'Success Partner program and affiliate marketing', 'ğŸ¤', '#f59e0b', 4),
  ('Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ§Ù„ØµÙŠØ§Ù†Ø©', 'Monitoring and Maintenance', 'Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª ÙˆØ±Ø³ÙˆÙ… Ø§Ù„ØµÙŠØ§Ù†Ø©', 'Investment monitoring and maintenance fees', 'ğŸ”§', '#8b5cf6', 5)
ON CONFLICT DO NOTHING;

-- Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù†ÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
INSERT INTO intent_patterns (intent_name, intent_name_ar, description, patterns, priority) VALUES
  ('ask_profit', 'Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù† Ø§Ù„Ø£Ø±Ø¨Ø§Ø­', 'Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø§Ù„Ø¹ÙˆØ§Ø¦Ø¯ ÙˆØ§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©', ARRAY['Ø±Ø¨Ø­', 'Ø¹Ø§Ø¦Ø¯', 'Ø£Ø±Ø¨Ø§Ø­', 'Ù…ÙƒØ³Ø¨', 'ÙØ§Ø¦Ø¯Ø©'], 10),
  ('ask_process', 'Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', 'Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¹Ù† ÙƒÙŠÙÙŠØ© Ø§Ù„Ø¨Ø¯Ø¡ ÙˆØ§Ù„Ø®Ø·ÙˆØ§Øª', ARRAY['ÙƒÙŠÙ', 'Ø·Ø±ÙŠÙ‚Ø©', 'Ø®Ø·ÙˆØ§Øª', 'Ø¹Ù…Ù„ÙŠØ©', 'Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª'], 8),
  ('ask_security', 'Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù† Ø§Ù„Ø£Ù…Ø§Ù†', 'Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ø¶Ù…Ø§Ù†Ø§Øª', ARRAY['Ø¢Ù…Ù†', 'Ø¶Ù…Ø§Ù†', 'Ù…ÙˆØ«ÙˆÙ‚', 'Ø­Ù…Ø§ÙŠØ©', 'Ø£Ù…Ø§Ù†'], 9),
  ('ask_duration', 'Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù† Ø§Ù„Ù…Ø¯Ø©', 'Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¹Ù† Ù…Ø¯Ø© Ø§Ù„Ø¹Ù‚Ø¯ ÙˆØ§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±', ARRAY['Ù…Ø¯Ø©', 'ÙØªØ±Ø©', 'Ø³Ù†Ø©', 'Ø´Ù‡Ø±', 'Ù…ØªÙ‰'], 7),
  ('ask_cost', 'Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù† Ø§Ù„ØªÙƒÙ„ÙØ©', 'Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„ØªÙƒØ§Ù„ÙŠÙ', ARRAY['Ø³Ø¹Ø±', 'ØªÙƒÙ„ÙØ©', 'ÙƒÙ…', 'Ù…Ø¨Ù„Øº', 'Ù‚ÙŠÙ…Ø©'], 10)
ON CONFLICT DO NOTHING;
