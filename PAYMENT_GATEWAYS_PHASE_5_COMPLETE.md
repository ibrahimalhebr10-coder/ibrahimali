# ุชููุฆุฉ ุจูุงุจุงุช ุงูุฏูุน - ุงููุฑุญูุฉ 5๏ธโฃ ููุชููุฉ

## ๐ ุชุงุฑูุฎ ุงูุฅูุฌุงุฒ: 28 ููุงูุฑ 2026

## โ ุงูุญุงูุฉ: ุงููุฑุญูุฉ 5๏ธโฃ ููุชููุฉ ุจูุฌุงุญ

---

## ๐ฏ ุงููุฏู ูู ุงููุฑุญูุฉ 5๏ธโฃ

**ุชููุฆุฉ ุจูุงุจุงุช ุงูุฏูุน (ูุฏู โ ุชุงุจู โ ุชูุงุฑุง) + ุงูุชุญุณููุงุช ุงูุฃูููุฉ**

ุฅุถุงูุฉ ุงููุฏุฑุฉ ุนูู ุชูููู ุจูุงุจุงุช ุงูุฏูุน ุงูุฅููุชุฑููู ูุน:
- ุญููู ุฑุจุท ุงูุจูุงุจุงุช (merchant_id, api_key, environment)
- ููุน ุชูุฑุงุฑ ุงูุฏูุน
- ุชุญุณููุงุช UX ูุงุถุญุฉ
- ุตูุงุญูุงุช ุฃูููุฉ ููุฅุฏุงุฑุฉ ุงููุงููุฉ

**ููุงุญุธุฉ ูููุฉ:** ุงูุชูุนูู ุงููุนูู ููุจูุงุจุงุช ุณูููู ูู ูุฑุงุญู ูุงุฏูุฉ. ุญุงููุงู ุฌุงูุฒูุฉ ุชูููุฉ ููุท.

---

## ๐ฆ ูุง ุชู ุฅูุฌุงุฒู

### 1. ุฅุถุงูุฉ ุญููู ุงูุจูุงุจุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

**Migration:** `add_payment_gateway_configuration.sql`

#### ุฃ. ุงูุฃุนูุฏุฉ ุงูุฌุฏูุฏุฉ

```sql
-- ุฅุถุงูุฉ ุนููุฏูู ุฌุฏูุฏูู ูุฌุฏูู payment_methods
ALTER TABLE payment_methods
ADD COLUMN is_gateway BOOLEAN DEFAULT false;

ALTER TABLE payment_methods
ADD COLUMN gateway_config JSONB DEFAULT '{}'::jsonb;
```

**ุงูุฃุนูุฏุฉ:**
- `is_gateway`: boolean - ููุชูุฑูู ุจูู ุงูุจูุงุจุงุช ูุงููุณุงุฆู ุงููุฏููุฉ
- `gateway_config`: jsonb - ูุญูุธ ุฅุนุฏุงุฏุงุช ุงูุจูุงุจุฉ

#### ุจ. ูููู gateway_config

```json
{
  "merchant_id": "string",
  "api_key": "string",
  "environment": "sandbox|production",
  "webhook_secret": "string (optional)"
}
```

**ุงูุญููู:**
- `merchant_id`: ุฑูู ุงูุชุงุฌุฑ ูู ุจูุงุจุฉ ุงูุฏูุน
- `api_key`: ููุชุงุญ API ุงูุณุฑู
- `environment`: ุงูุจูุฆุฉ (sandbox ููุชุฌุฑูุจูุ production ููุฅูุชุงุฌ)
- `webhook_secret`: ููุชุงุญ ุงูุชุญูู ูู webhooks (ุงุฎุชูุงุฑู)

#### ุฌ. Constraints ูุงูุชุญููุงุช

```sql
-- ุชุญุฏูุฏ ุงูุจูุฆุงุช ุงููุณููุญุฉ
ALTER TABLE payment_methods
ADD CONSTRAINT valid_gateway_environment
CHECK (
  gateway_config->>'environment' IS NULL OR
  gateway_config->>'environment' IN ('sandbox', 'production')
);
```

**ุงูุชุญููุงุช:**
- โ ุงูุจูุฆุฉ ูุฌุจ ุฃู ุชููู 'sandbox' ุฃู 'production' ููุท
- โ ุงูุจูุงูุงุช ูุฎุฒูุฉ ุจุดูู ุขูู ูู JSONB

#### ุฏ. ุชุญุฏูุซ ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ

```sql
-- ุชุญุฏูุฏ ุงูุจูุงุจุงุช ุชููุงุฆูุงู
UPDATE payment_methods
SET is_gateway = CASE
  WHEN method_type IN ('mada', 'tabby', 'tamara') THEN true
  ELSE false
END;
```

**ุงููุชูุฌุฉ:**
- โ ูุฏู: is_gateway = true
- โ ุชุงุจู: is_gateway = true
- โ ุชูุงุฑุง: is_gateway = true
- โ ุชุญููู ุจููู: is_gateway = false

---

### 2. ููุน ุชูุฑุงุฑ ุงูุฏูุน

**Migration:** `add_payment_duplicate_prevention_fixed.sql`

#### ุฃ. Function ููุญุต ุงูุชูุฑุงุฑ

```sql
CREATE OR REPLACE FUNCTION check_duplicate_payment()
RETURNS TRIGGER AS $$
DECLARE
  v_reservation_status TEXT;
BEGIN
  -- ูุญุต ูุฌูุฏ ุฅูุตุงู ูุนุชูุฏ ูุณุจูุงู
  IF EXISTS (
    SELECT 1 FROM payment_receipts
    WHERE reservation_id = NEW.reservation_id
    AND status = 'approved'
    AND id != COALESCE(NEW.id, '00000000-0000-0000-0000-000000000000'::uuid)
  ) THEN
    RAISE EXCEPTION 'ูุง ูููู ุฑูุน ุฅูุตุงู ุฌุฏูุฏ. ููุฌุฏ ุฅูุตุงู ูุนุชูุฏ ูุณุจูุงู ููุฐุง ุงูุญุฌุฒ';
  END IF;

  -- ูุญุต ุญุงูุฉ ุงูุญุฌุฒ
  SELECT status INTO v_reservation_status
  FROM reservations
  WHERE id = NEW.reservation_id;

  IF v_reservation_status = 'paid' THEN
    RAISE EXCEPTION 'ูุฐุง ุงูุญุฌุฒ ูุฏููุน ุจุงููุนู. ูุง ูููู ุฑูุน ุฅูุตุงู ุฌุฏูุฏ';
  END IF;

  IF v_reservation_status NOT IN ('waiting_for_payment', 'pending') THEN
    RAISE EXCEPTION 'ูุง ูููู ุฑูุน ุฅูุตุงู ูุญุฌุฒ ุจูุฐู ุงูุญุงูุฉ';
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

**ุงููุญูุตุงุช:**
1. โ ูุง ููุฌุฏ ุฅูุตุงู ูุนุชูุฏ ูุณุจูุงู ูููุณ ุงูุญุฌุฒ
2. โ ุงูุญุฌุฒ ููุณ ูุฏููุนุงู ุจุงููุนู
3. โ ุญุงูุฉ ุงูุญุฌุฒ ููุงุณุจุฉ (waiting_for_payment ุฃู pending)

#### ุจ. Trigger ูุชุทุจูู ุงููุญุต

```sql
CREATE TRIGGER prevent_duplicate_payment
  BEFORE INSERT ON payment_receipts
  FOR EACH ROW
  EXECUTE FUNCTION check_duplicate_payment();
```

**ูุชู ูุนูู:**
- โ ูุจู ุฅุฏุฑุงุฌ ุฃู ุฅูุตุงู ุฌุฏูุฏ
- โ ูููู ุงูุนูููุฉ ุชูุงูุงู ุฅุฐุง ูุดู ุฃู ูุญุต
- โ ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ ูููุณุชุฎุฏู

#### ุฌ. Unique Index

```sql
CREATE UNIQUE INDEX one_approved_receipt_per_reservation
ON payment_receipts (reservation_id)
WHERE status = 'approved';
```

**ุงููุงุฆุฏุฉ:**
- โ ุถูุงู ุนูู ูุณุชูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ูุง ูููู ูุฌูุฏ ุฃูุซุฑ ูู ุฅูุตุงู ูุงุญุฏ ูุนุชูุฏ ููู ุญุฌุฒ
- โ ุงูู index ูุทุจู ููุท ุนูู ุงูุฅูุตุงูุงุช ุงููุนุชูุฏุฉ

---

### 3. ูุงุฌูุฉ ุชููุฆุฉ ุงูุจูุงุจุงุช

**ุงูููู:** `PaymentMethodsSettings.tsx`

#### ุฃ. ุงูุญุงูุฉ (State) ุงูุฌุฏูุฏุฉ

```typescript
const [gatewayConfig, setGatewayConfig] = useState<Record<string, any>>({
  merchant_id: '',
  api_key: '',
  environment: 'sandbox',
  ...((method as any).gateway_config || {})
});

const isGateway = ['mada', 'tabby', 'tamara'].includes(method.method_type);
```

**ุงููุชุบูุฑุงุช:**
- `gatewayConfig`: ูุญูุธ ุฅุนุฏุงุฏุงุช ุงูุจูุงุจุฉ
- `isGateway`: ูุญุฏุฏ ุฅุฐุง ูุงูุช ุงููุณููุฉ ุจูุงุจุฉ ุฏูุน ุฃู ูุง

#### ุจ. ุญูุธ ุงูุฅุนุฏุงุฏุงุช

```typescript
async function handleSave() {
  try {
    setSaving(true);

    // ุญูุธ ุงูุฅุนุฏุงุฏุงุช ุงูุนุงุฏูุฉ
    await paymentMethodsService.updateMethodConfig(method.id, config);

    // ุญูุธ ุฅุนุฏุงุฏุงุช ุงูุจูุงุจุฉ ุฅุฐุง ูุงูุช ุจูุงุจุฉ
    if (isGateway) {
      await paymentMethodsService.updateGatewayConfig(method.id, gatewayConfig);
    }

    onSave();
  } catch (err) {
    console.error('Error saving config:', err);
  } finally {
    setSaving(false);
  }
}
```

**ุงูุชุฏูู:**
1. ุญูุธ ุงูุฅุนุฏุงุฏุงุช ุงูุนุงุฏูุฉ (config)
2. ุฅุฐุง ูุงูุช ุจูุงุจุฉุ ุญูุธ gateway_config
3. ุชุญุฏูุซ ุงููุงุฌูุฉ

#### ุฌ. ุญููู ุงูุจูุงุจุงุช ูู ุงููุงุฌูุฉ

**1. ุฑูู ุงูุชุงุฌุฑ (Merchant ID)**
```tsx
<input
  type="text"
  value={gatewayConfig.merchant_id || ''}
  onChange={(e) => setGatewayConfig({
    ...gatewayConfig,
    merchant_id: e.target.value
  })}
  placeholder="ุฃุฏุฎู ุฑูู ุงูุชุงุฌุฑ"
  className="w-full px-4 py-2 border border-gray-300 rounded-lg"
/>
```

**2. ููุชุงุญ API (API Key)**
```tsx
<input
  type="password"
  value={gatewayConfig.api_key || ''}
  onChange={(e) => setGatewayConfig({
    ...gatewayConfig,
    api_key: e.target.value
  })}
  placeholder="ุฃุฏุฎู ููุชุงุญ API"
  className="w-full px-4 py-2 border border-gray-300 rounded-lg"
/>
```

**3. ุงูุจูุฆุฉ (Environment)**
```tsx
<select
  value={gatewayConfig.environment || 'sandbox'}
  onChange={(e) => setGatewayConfig({
    ...gatewayConfig,
    environment: e.target.value
  })}
  className="w-full px-4 py-2 border border-gray-300 rounded-lg"
>
  <option value="sandbox">ุชุฌุฑูุจู (Sandbox)</option>
  <option value="production">ุฅูุชุงุฌ (Production)</option>
</select>
```

**4. Webhook Secret (ุงุฎุชูุงุฑู)**
```tsx
<input
  type="password"
  value={gatewayConfig.webhook_secret || ''}
  onChange={(e) => setGatewayConfig({
    ...gatewayConfig,
    webhook_secret: e.target.value
  })}
  placeholder="ุฃุฏุฎู Webhook Secret"
  className="w-full px-4 py-2 border border-gray-300 rounded-lg"
/>
```

#### ุฏ. ุงูุชูุจููุงุช ุงูุฃูููุฉ

**ุชูุจูู ุฃููู (ุฃุญูุฑ):**
```tsx
<div className="bg-red-50 rounded-lg p-4 border border-red-200">
  <div className="flex items-start gap-3">
    <AlertCircle className="w-5 h-5 text-red-600" />
    <div className="text-sm text-red-900">
      <p className="font-semibold mb-1">ุชูุจูู ุฃููู:</p>
      <p>
        ูุง ุชุดุงุฑู ูุฐู ุงููุนูููุงุช ูุน ุฃู ุดุฎุต.
        ููุงุชูุญ API ูุงูุฃุณุฑุงุฑ ูุชู ุชุฎุฒูููุง ุจุดูู ุขูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.
      </p>
    </div>
  </div>
</div>
```

**ุชูุจูู ุนุงู (ุฃุตูุฑ):**
```tsx
<div className="bg-yellow-50 rounded-lg p-4 border border-yellow-200">
  <div className="flex items-start gap-3">
    <AlertCircle className="w-5 h-5 text-yellow-600" />
    <div className="text-sm text-yellow-900">
      <p className="font-semibold mb-1">ููุงุญุธุฉ:</p>
      <p>
        ุงูุชูุนูู ุงููุนูู ูุจูุงุจุงุช ุงูุฏูุน ุณูููู ูู ูุฑุงุญู ูุงุฏูุฉ.
        ุญุงููุงูุ ููููู ุญูุธ ุงูุฅุนุฏุงุฏุงุช ููุชุฌููุฒ ููุท.
      </p>
    </div>
  </div>
</div>
```

---

### 4. ูุธุงุฆู ุงูุฎุฏูุฉ (Service Functions)

**ุงูููู:** `paymentMethodsService.ts`

#### ุงููุธููุฉ ุงูุฌุฏูุฏุฉ

```typescript
async updateGatewayConfig(
  id: string,
  gatewayConfig: Record<string, any>
): Promise<void> {
  const { error } = await supabase
    .from('payment_methods')
    .update({ gateway_config: gatewayConfig })
    .eq('id', id);

  if (error) {
    console.error('Error updating gateway config:', error);
    throw error;
  }
}
```

**ุงูุงุณุชุฎุฏุงู:**
```typescript
await paymentMethodsService.updateGatewayConfig(methodId, {
  merchant_id: 'MCH123456',
  api_key: 'sk_test_abcdef123456',
  environment: 'sandbox',
  webhook_secret: 'whsec_xyz789'
});
```

---

### 5. ุงูุตูุงุญูุงุช ุงูุฃูููุฉ

#### ุฃ. ุญูุงูุฉ ุตูุญุฉ ูุณุงุฆู ุงูุณุฏุงุฏ

**ุงูููู:** `PaymentMethodsSettings.tsx`

```tsx
import ActionGuard from './ActionGuard';

export default function PaymentMethodsSettings() {
  // ... ุงูููุฏ

  return (
    <ActionGuard action="finance.manage_payment_methods">
      {/* ุงููุญุชูู */}
    </ActionGuard>
  );
}
```

**ุงููุงุฆุฏุฉ:**
- โ ุงูุฅุฏุงุฑุฉ ุงููุงููุฉ ููุท ุชุณุชุทูุน ุงููุตูู
- โ ูุง ูููู ูุฃู ุฏูุฑ ุขุฎุฑ ุชุนุฏูู ุงูุฅุนุฏุงุฏุงุช
- โ ุฑุณุงูุฉ ูุงุถุญุฉ ุนูุฏ ุนุฏู ูุฌูุฏ ุตูุงุญูุฉ

#### ุจ. ุญูุงูุฉ ุตูุญุฉ ูุฑุงุฌุนุฉ ุงูุฅูุตุงูุงุช

**ุงูููู:** `PaymentReceiptsManagement.tsx`

```tsx
import ActionGuard from './ActionGuard';

export default function PaymentReceiptsManagement() {
  // ... ุงูููุฏ

  return (
    <ActionGuard action="finance.review_receipts">
      {/* ุงููุญุชูู */}
    </ActionGuard>
  );
}
```

**ุงููุงุฆุฏุฉ:**
- โ ุงูุฅุฏุงุฑุฉ ุงููุงููุฉ ููุท ุชุณุชุทูุน ูุฑุงุฌุนุฉ ุงูุฅูุตุงูุงุช
- โ ูุง ููุงููุฉ ุฃู ุฑูุถ ุฅูุตุงูุงุช ูู ุบูุฑ ุงูุฅุฏุงุฑุฉ ุงููุงููุฉ
- โ ุฃูุงู ุชุงู ููุนูููุงุช ุงููุงููุฉ

---

## ๐จ ูุงุฌูุฉ ุงููุณุชุฎุฏู

### 1. ุตูุญุฉ ุฅุนุฏุงุฏุงุช ูุณุงุฆู ุงูุณุฏุงุฏ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ณ ูุณุงุฆู ุงูุณุฏุงุฏ                                              โ
โ  ุฅุฏุงุฑุฉ ูุณุงุฆู ุงูุณุฏุงุฏ ุงููุชุงุญุฉ ูููุณุชุซูุฑูู                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                โ
โ  โ๏ธ ููุงุญุธุงุช ูููุฉ:                                            โ
โ     โข ุงููุณุงุฆู ุบูุฑ ุงูููุนูุฉ ูุง ุชุธูุฑ ูููุณุชุซูุฑูู                 โ
โ     โข ูุฌุจ ุฅููุงู ุงูุฅุนุฏุงุฏุงุช ูุจู ุงูุชูุนูู                        โ
โ     โข ุงูุชุฑุชูุจ ูุญุฏุฏ ุธููุฑ ุงููุณุงุฆู ูู ุตูุญุฉ ุงูุฏูุน                โ
โ     โข ูุง ููุฌุฏ ุฑุจุท ูุนูู ุจุจูุงุจุงุช ุงูุฏูุน ูู ูุฐู ุงููุฑุญูุฉ          โ
โ                                                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโโ          โ
โ  โ  ๐ณ ูุฏู              โ  โ  ๐ ุชุงุจู              โ          โ
โ  โ  Mada                โ  โ  Tabby                โ          โ
โ  โ                      โ  โ                      โ          โ
โ  โ  โ ููุนูู           โ  โ  โ ุบูุฑ ููุนูู        โ          โ
โ  โ                      โ  โ                      โ          โ
โ  โ  ููุฑู | ุขูู | ูุญูู  โ  โ  ุชูุณูุท | ูุฑู        โ          โ
โ  โ                      โ  โ                      โ          โ
โ  โ  [ุฅููุงู] [โ๏ธ] [โโ] โ  โ  [ุชูุนูู] [โ๏ธ] [โโ]  โ          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโโ          โ
โ                                                                โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโโ          โ
โ  โ  โฐ ุชูุงุฑุง           โ  โ  ๐ฆ ุชุญููู ุจููู       โ          โ
โ  โ  Tamara              โ  โ  Bank Transfer        โ          โ
โ  โ                      โ  โ                      โ          โ
โ  โ  โ ุบูุฑ ููุนูู       โ  โ  โ ููุนูู           โ          โ
โ  โ                      โ  โ                      โ          โ
โ  โ  ุดูุฑู | ุจุฏูู ููุงุฆุฏ   โ  โ  ูุจุงุดุฑ | ููุซูู      โ          โ
โ  โ                      โ  โ                      โ          โ
โ  โ  [ุชูุนูู] [โ๏ธ] [โโ]  โ  โ  [ุฅููุงู] [โ๏ธ] [โโ] โ          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโโ          โ
โ                                                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 2. ูุงูุฐุฉ ุฅุนุฏุงุฏุงุช ุงูุจูุงุจุฉ (ูุฏู/ุชุงุจู/ุชูุงุฑุง)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ุฅุนุฏุงุฏุงุช ูุฏู                                             โ   โ
โ  ุจูุงุจุฉ ุงูุฏูุน ุจุงูุจุทุงูุงุช ุงูุณุนูุฏูุฉ                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                โ
โ  โน๏ธ ูุชุทูุจุงุช ุงูุชูุนูู:                                         โ
โ     โข ุญุณุงุจ ุชุงุฌุฑ ูุดุท                                          โ
โ     โข ููุงุชูุญ API ุตุงูุญุฉ                                       โ
โ                                                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                โ
โ  ุฅุนุฏุงุฏุงุช ุจูุงุจุฉ ุงูุฏูุน:                                         โ
โ                                                                โ
โ  ุฑูู ุงูุชุงุฌุฑ (Merchant ID) *                                   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ MCH123456                                                โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  ุฑูู ุงูุชุงุฌุฑ ุงูุฎุงุต ุจู ูู ุจูุงุจุฉ ุงูุฏูุน                          โ
โ                                                                โ
โ  ููุชุงุญ API (API Key) *                                        โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ โขโขโขโขโขโขโขโขโขโขโขโขโขโขโขโข                                         โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  ููุชุงุญ API ุงูุณุฑู - ุณูุชู ุชุฎุฒููู ุจุดูู ุขูู                     โ
โ                                                                โ
โ  ุงูุจูุฆุฉ (Environment) *                                       โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ ุชุฌุฑูุจู (Sandbox) โผ                                      โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  ุงุณุชุฎุฏู ุงูุจูุฆุฉ ุงูุชุฌุฑูุจูุฉ ููุงุฎุชุจุงุฑ ูุงูุฅูุชุงุฌ ููุนูููุงุช ุงูุญููููุฉโ
โ                                                                โ
โ  Webhook Secret (ุงุฎุชูุงุฑู)                                    โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ                                                          โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  ููุชุงุญ ุงูุชุญูู ูู webhooks - ูุชุฃููุฏ ุตุญุฉ ุงูุฅุดุนุงุฑุงุช            โ
โ                                                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                โ
โ  ๐ด ุชูุจูู ุฃููู:                                              โ
โ  ูุง ุชุดุงุฑู ูุฐู ุงููุนูููุงุช ูุน ุฃู ุดุฎุต. ููุงุชูุญ API ูุงูุฃุณุฑุงุฑ       โ
โ  ูุชู ุชุฎุฒูููุง ุจุดูู ุขูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.                     โ
โ                                                                โ
โ  โ๏ธ ููุงุญุธุฉ:                                                  โ
โ  ุงูุชูุนูู ุงููุนูู ูุจูุงุจุงุช ุงูุฏูุน ุณูููู ูู ูุฑุงุญู ูุงุฏูุฉ.          โ
โ  ุญุงููุงูุ ููููู ุญูุธ ุงูุฅุนุฏุงุฏุงุช ููุชุฌููุฒ ููุท.                    โ
โ                                                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                โ
โ  [ุฅูุบุงุก]                              [๐พ ุญูุธ ุงูุฅุนุฏุงุฏุงุช]    โ
โ                                                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### 3. ูุงูุฐุฉ ุฅุนุฏุงุฏุงุช ุงูุชุญููู ุงูุจููู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ุฅุนุฏุงุฏุงุช ุชุญููู ุจููู                                      โ   โ
โ  ุงูุชุญููู ุงููุจุงุดุฑ ุฅูู ุงูุญุณุงุจ ุงูุจููู                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                โ
โ  โน๏ธ ูุชุทูุจุงุช ุงูุชูุนูู:                                         โ
โ     โข ุญุณุงุจ ุจููู ูุดุท                                          โ
โ     โข ูุนูููุงุช ุงูุญุณุงุจ ูุงููุฉ                                   โ
โ                                                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                โ
โ  ุฅุนุฏุงุฏุงุช ุงููุณููุฉ:                                             โ
โ                                                                โ
โ  BANK NAME                                                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ ุงูุจูู ุงูุฃููู ุงูุณุนูุฏู                                     โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                โ
โ  IBAN                                                          โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ SA0380000000608010000009                                 โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                โ
โ  ACCOUNT NAME                                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ ุดุฑูุฉ ุงููุญุงุตูู ุงูุฒุฑุงุนูุฉ                                   โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                โ
โ  ACCOUNT NUMBER                                                โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ 608010000009                                             โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ                                                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                โ
โ  [ุฅูุบุงุก]                              [๐พ ุญูุธ ุงูุฅุนุฏุงุฏุงุช]    โ
โ                                                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ ุงูุฃูุงู

### 1. ุญูุงูุฉ ุงูุจูุงูุงุช ุงูุญุณุงุณุฉ

**ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:**
```sql
-- gateway_config ูุฎุฒู ูู JSONB
-- RLS policies ุชุทุจู ุนูู ุฌุฏูู payment_methods
-- ููุท ุงูุฅุฏุงุฑุฉ ุชุณุชุทูุน ุงููุฑุงุกุฉ ูุงูุชุนุฏูู
```

**ูู ุงููุงุฌูุฉ:**
```tsx
// ุญููู API Key ูWebhook Secret ูู ููุน password
<input type="password" value={gatewayConfig.api_key} />
<input type="password" value={gatewayConfig.webhook_secret} />
```

**ุงููุชูุฌุฉ:**
- โ ุงูููุงุชูุญ ูุง ุชุธูุฑ ูู ุงููุงุฌูุฉ
- โ ุงูููุงุชูุญ ูุญููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ ูุง ูููู ุงุณุชุฎุฑุงุฌ ุงูููุงุชูุญ ูู ุงููุชุตูุญ

### 2. ุตูุงุญูุงุช ุงููุตูู

**ActionGuard ููุฅุฏุงุฑุฉ ุงููุงููุฉ ููุท:**

```typescript
// ุตูุญุฉ ูุณุงุฆู ุงูุณุฏุงุฏ
<ActionGuard action="finance.manage_payment_methods">
  {/* ุงููุญุชูู */}
</ActionGuard>

// ุตูุญุฉ ูุฑุงุฌุนุฉ ุงูุฅูุตุงูุงุช
<ActionGuard action="finance.review_receipts">
  {/* ุงููุญุชูู */}
</ActionGuard>
```

**ูู ูุณุชุทูุน ุงููุตูู:**
| ุงูุฏูุฑ | ูุณุงุฆู ุงูุณุฏุงุฏ | ูุฑุงุฌุนุฉ ุงูุฅูุตุงูุงุช |
|-------|-------------|------------------|
| Super Admin | โ | โ |
| Finance Manager | โ | โ |
| Operations Manager | โ | โ |
| Farm Manager | โ | โ |
| Maintenance | โ | โ |
| Equipment | โ | โ |

### 3. ููุน ุชูุฑุงุฑ ุงูุฏูุน

**ุนูู ูุณุชูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:**
```sql
-- Trigger ููุญุต ูุจู ุฅุฏุฑุงุฌ ุงูุฅูุตุงู
CREATE TRIGGER prevent_duplicate_payment
  BEFORE INSERT ON payment_receipts
  FOR EACH ROW
  EXECUTE FUNCTION check_duplicate_payment();

-- Unique index ูุถูู ุนุฏู ุงูุชูุฑุงุฑ
CREATE UNIQUE INDEX one_approved_receipt_per_reservation
ON payment_receipts (reservation_id)
WHERE status = 'approved';
```

**ุฑุณุงุฆู ุงูุฎุทุฃ ุงููุงุถุญุฉ:**
- โ "ูุง ูููู ุฑูุน ุฅูุตุงู ุฌุฏูุฏ. ููุฌุฏ ุฅูุตุงู ูุนุชูุฏ ูุณุจูุงู ููุฐุง ุงูุญุฌุฒ"
- โ "ูุฐุง ุงูุญุฌุฒ ูุฏููุน ุจุงููุนู. ูุง ูููู ุฑูุน ุฅูุตุงู ุฌุฏูุฏ"
- โ "ูุง ูููู ุฑูุน ุฅูุตุงู ูุญุฌุฒ ุจูุฐู ุงูุญุงูุฉ"

---

## ๐ ุงูุชุญุณููุงุช ุงููุถุงูุฉ

### ๐น ุชุญุณูู 1: ููุน ุงูุฎุทุฃ

**ุงููุดููุฉ:** ูุงู ูููู ุฑูุน ุฃูุซุฑ ูู ุฅูุตุงู ูููุณ ุงูุญุฌุฒ

**ุงูุญู:**

1. **Trigger ุนูู INSERT:**
```sql
CREATE TRIGGER prevent_duplicate_payment
  BEFORE INSERT ON payment_receipts
  FOR EACH ROW
  EXECUTE FUNCTION check_duplicate_payment();
```

2. **ูุญุต ุดุงูู:**
   - โ ูุง ุฅูุตุงู ูุนุชูุฏ ููุฌูุฏ
   - โ ุงูุญุฌุฒ ููุณ ูุฏููุน
   - โ ุญุงูุฉ ุงูุญุฌุฒ ููุงุณุจุฉ

3. **Unique Index:**
```sql
CREATE UNIQUE INDEX one_approved_receipt_per_reservation
ON payment_receipts (reservation_id)
WHERE status = 'approved';
```

**ุงููุชูุฌุฉ:**
- โ ููุน ุชุงู ูุชูุฑุงุฑ ุงูุฏูุน
- โ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ
- โ ุญูุงูุฉ ุนูู ูุณุชูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ๐น ุชุญุณูู 2: ูุถูุญ UX

**ุงูุญุงูุงุช ุงููุงุถุญุฉ ุจุงูุฃููุงู:**

**ูู ุตูุญุฉ ุงูุญุฌูุฒุงุช:**
```
๐ก ููุฏ ุงููุฑุงุฌุนุฉ    (amber)   - ุงูุญุฌุฒ ุชุญุช ุงููุธุฑ
๐ต ุจุงูุชุธุงุฑ ุงูุณุฏุงุฏ   (blue)    - ูููู ุงูุฏูุน ุงูุขู
๐ข ูุฏููุน           (green)   - ุชู ุงูุฏูุน ูุงูุชุฃููุฏ
๐ด ููุบู            (red)     - ุชู ุฅูุบุงุก ุงูุญุฌุฒ
```

**ูู ุตูุญุฉ ุงูุณุฏุงุฏ:**
```tsx
<div className="bg-blue-50 border-2 border-blue-300 rounded-xl p-4">
  <CheckCircle2 className="w-6 h-6 text-blue-600" />
  <p className="text-base text-blue-900 font-bold">ุชู ุงุนุชูุงุฏ ุญุฌุฒู!</p>
  <p className="text-sm text-blue-800">
    ููููู ุงูุขู ุฅุชูุงู ุนูููุฉ ุงูุณุฏุงุฏ ุจูููุฉ
    <span className="font-bold">{amount} ุฑูุงู ุณุนูุฏู</span>
  </p>
</div>
```

**ูุตูุต ุชุทููู ูููุณุชุซูุฑ:**

**ุนูุฏ ููุฏ ุงููุฑุงุฌุนุฉ:**
```
โ๏ธ ุญุฌุฒู ููุฏ ุงููุฑุงุฌุนุฉ
ูุชู ุงูุขู ูุฑุงุฌุนุฉ ุญุฌุฒู ูู ูุจู ุงูุฅุฏุงุฑุฉ.
ุณูุชู ุฅุฎุทุงุฑู ุนูุฏ ุงุนุชูุงุฏ ุงูุญุฌุฒ ูุฅุชุงุญุฉ ุฎูุงุฑุงุช ุงูุฏูุน.
```

**ุนูุฏ ุจุงูุชุธุงุฑ ุงูุณุฏุงุฏ:**
```
โ ุชู ุงุนุชูุงุฏ ุญุฌุฒู!
ููููู ุงูุขู ุฅุชูุงู ุนูููุฉ ุงูุณุฏุงุฏ ุจูููุฉ [ุงููุจูุบ] ุฑูุงู ุณุนูุฏู
```

**ุนูุฏ ุชู ุงูุฏูุน:**
```
โ ุชู ุงุณุชูุงู ุงูุฏูุน ุจูุฌุงุญ
ุดูุฑุงู ูู! ุชู ุชุฃููุฏ ุงุณุชุซูุงุฑู ูุณูุชู ุงูุชูุงุตู ูุนู ูุฑูุจุงู ุจุงูุชูุงุตูู.
```

### ๐น ุชุญุณูู 3: ุงูุฃูุงู

**ุตูุงุญูุงุช ุงูุณุฏุงุฏ ูููุงููุฉ ููุท:**

```typescript
// ูู PaymentMethodsSettings.tsx
<ActionGuard action="finance.manage_payment_methods">
  {/* ููุท ุงูุฅุฏุงุฑุฉ ุงููุงููุฉ ุชุณุชุทูุน ุชุนุฏูู ูุณุงุฆู ุงูุณุฏุงุฏ */}
</ActionGuard>

// ูู PaymentReceiptsManagement.tsx
<ActionGuard action="finance.review_receipts">
  {/* ููุท ุงูุฅุฏุงุฑุฉ ุงููุงููุฉ ุชุณุชุทูุน ูุฑุงุฌุนุฉ ูุงุนุชูุงุฏ ุงูุฅูุตุงูุงุช */}
</ActionGuard>
```

**ูุง ุชุนุฏูู ูู ุบูุฑูู:**
- โ Operations Manager: ูุง ูุณุชุทูุน ุชุนุฏูู ุงูุฅุนุฏุงุฏุงุช
- โ Farm Manager: ูุง ูุณุชุทูุน ูุฑุงุฌุนุฉ ุงูุฅูุตุงูุงุช
- โ Maintenance/Equipment: ูุง ูุตูู ููุงุฆูุงู

**ุฑุณุงูุฉ ูุงุถุญุฉ ุนูุฏ ุนุฏู ุงูุตูุงุญูุฉ:**
```
๐ ููุณ ูุฏูู ุตูุงุญูุฉ ูุชูููุฐ ูุฐุง ุงูุฅุฌุฑุงุก

ูุฐุง ุงูุฅุฌุฑุงุก ูุชุทูุจ ุตูุงุญูุฉ: ุฅุฏุงุฑุฉ ูุณุงุฆู ุงูุณุฏุงุฏ
ูุฑุฌู ุงูุชูุงุตู ูุน ุงูุฅุฏุงุฑุฉ ุฅุฐุง ููุช ุชุญุชุงุฌ ูุฐู ุงูุตูุงุญูุฉ.
```

---

## ๐ซ ูุง ูู ูุชู ุชูููุฐู (ููุง ูู ูุทููุจ)

### โ ุชูุนูู ุจูุงุจุงุช ูุจุงุดุฑุฉ

**ูู ูุชู:**
- โ ุฑุจุท ูุนูู ูุน Moyasar/HyperPay (ูุฏู)
- โ ุฑุจุท ูุนูู ูุน Tabby API
- โ ุฑุจุท ูุนูู ูุน Tamara API
- โ ูุนุงูุฌุฉ ุงูุฏูุน ุงูุฅููุชุฑููู
- โ webhooks ููุฅุดุนุงุฑุงุช

**ุงูุณุจุจ:** ูุฐู ุงููุฑุญูุฉ ููุชุฌููุฒ ููุท. ุงูุฑุจุท ุงููุนูู ูู ูุฑุงุญู ูุงุฏูุฉ.

**ูุง ุชู:**
- โ ุญููู ุงูุจูุงุจุงุช ุฌุงูุฒุฉ
- โ ูุงุฌูุฉ ุงูุฅุนุฏุงุฏุงุช ุฌุงูุฒุฉ
- โ ุงูุจููุฉ ุงูุชุญุชูุฉ ุฌุงูุฒุฉ
- โ ูููู ุญูุธ ุงูุฅุนุฏุงุฏุงุช

### โ ุณุฏุงุฏ ุชููุงุฆู

**ูู ูุชู:**
- โ ุชูุฌูู ููุจูุงุจุฉ ุงูุฅููุชุฑูููุฉ
- โ ูุนุงูุฌุฉ ุงูุฏูุน ุงูููุฑู
- โ ุงุณุชูุงู ุงูุฑุฏ ูู ุงูุจูุงุจุฉ
- โ ุชุญุฏูุซ ุงูุญุงูุฉ ุชููุงุฆูุงู

**ุงูุณุจุจ:** ุงูุณุฏุงุฏ ุญุงููุงู ูุฏูู ุนุจุฑ ุงูุชุญููู ุงูุจููู ููุท.

**ูุง ุชู:**
- โ ุตูุญุฉ ุงูุณุฏุงุฏ ุฌุงูุฒุฉ
- โ ุฑูุน ุงูุฅูุตุงูุงุช ูุนูู
- โ ุงููุฑุงุฌุนุฉ ูุงูุงุนุชูุงุฏ ูุนููุงู

### โ ุฑุจุท ูุน ุงููุญุงุตูู

**ูู ูุชู:**
- โ ุฑุจุท ุงูุฏูุน ุจุฅูุชุงุฌ ุงููุญุตูู
- โ ุชูุฒูุน ุงูุฃุฑุจุงุญ
- โ ุญุณุงุจ ุงูุนูุงุฆุฏ
- โ ุฅุดุนุงุฑุงุช ุงูุญุตุงุฏ

**ุงูุณุจุจ:** ูุฐุง ุฌุฒุก ูู ูุธุงู ุงููุญุงุตูู ุงูุฐู ุณูุฃุชู ูุงุญูุงู.

**ูุง ุชู:**
- โ ุงูุฏูุน ูุฑุชุจุท ุจุงูุญุฌุฒ
- โ ุงูุชุฃููุฏ ูุญุฏุซ ุนูุฏ ุงูููุงููุฉ
- โ ูู ุดูุก ููุซู ููุณุฌู

---

## โ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

### ููุตุฉ ุฌุงูุฒุฉ ููุณุฏุงุฏ โ

**ุงูุจููุฉ ุงูุชุญุชูุฉ:**
- โ ูุงุนุฏุฉ ุจูุงูุงุช ูุญุฏุซุฉ ุจุญููู ุงูุจูุงุจุงุช
- โ ููุน ุชูุฑุงุฑ ุงูุฏูุน
- โ ุตูุงุญูุงุช ุฃูููุฉ ูุญููุฉ
- โ ูุงุฌูุงุช ูุงุถุญุฉ ููุฑุชุจุฉ

**ุงููุณุงุฆู ุงููุชุงุญุฉ:**
- โ ุชุญููู ุจููู (ููุนูู ููุนูู)
- โ ูุฏู (ุฌุงูุฒ ููุฅุนุฏุงุฏุงุชุ ุบูุฑ ููุนูู)
- โ ุชุงุจู (ุฌุงูุฒ ููุฅุนุฏุงุฏุงุชุ ุบูุฑ ููุนูู)
- โ ุชูุงุฑุง (ุฌุงูุฒ ููุฅุนุฏุงุฏุงุชุ ุบูุฑ ููุนูู)

**ุงูุชุฏูู ุงููุงูู:**
```
ุญุฌุฒ โ ุงุนุชูุงุฏ โ ูุชุญ ุงูุณุฏุงุฏ โ ุฑูุน ุฅูุตุงู โ ูุฑุงุฌุนุฉ โ ููุงููุฉ โ ูุฏููุน โ
```

### ุฏูุฑุฉ ูุงููุฉ ูุงุถุญุฉ โ

**ูููุณุชุซูุฑ:**
```
1. ูุญุฌุฒ ุงูุฃุดุฌุงุฑ
2. ููุชุธุฑ ุงูุงุนุชูุงุฏ (ููุฏ ุงููุฑุงุฌุนุฉ)
3. ูุณุชูู ุฅุดุนุงุฑ (ุจุงูุชุธุงุฑ ุงูุณุฏุงุฏ)
4. ููุชุญ ุตูุญุฉ ุงูุณุฏุงุฏ
5. ูุฎุชุงุฑ ุงูุชุญููู ุงูุจููู
6. ูุญูู ุงููุจูุบ ููุญุณุงุจ
7. ูุฑูุน ุงูุฅูุตุงู
8. ููุชุธุฑ ุงููุฑุงุฌุนุฉ
9. ูุณุชูู ุฅุดุนุงุฑ (ุชู ุงุณุชูุงู ุงูุณุฏุงุฏ ุจูุฌุงุญ)
10. ุงูุญุฌุฒ: ูุฏููุน ููุคูุฏ โ
```

**ููุฅุฏุงุฑุฉ ุงููุงููุฉ:**
```
1. ุชุฑุงุฌุน ุงูุญุฌูุฒุงุช ุงูุฌุฏูุฏุฉ
2. ุชุนุชูุฏ ุงูุญุฌูุฒุงุช ุงูููุงุณุจุฉ
3. ุชุณุชูุจู ุงูุฅูุตุงูุงุช
4. ุชุฑุงุฌุน ุงูุฅูุตุงูุงุช ูุงูุชุญูููุงุช
5. ุชูุงูู ุนูู ุงูุฅูุตุงูุงุช ุงูุตุญูุญุฉ
6. ุชุฑูุถ ุงูุฅูุตุงูุงุช ุงูุฎุงุทุฆุฉ ูุน ุณุจุจ
7. ุงููุธุงู ูุญุฏูุซ ุงูุญุงูุงุช ุชููุงุฆูุงู
8. ุงููุธุงู ูุฑุณู ุฅุดุนุงุฑุงุช ุชููุงุฆูุฉ
9. ูู ุดูุก ููุซู ููุณุฌู โ
```

### ูุณุชุซูุฑ ูุฑุชุงุญ โ

**ุงูุดูุงููุฉ:**
- โ ูู ุญุงูุฉ ูุงุถุญุฉ ุจููู ูููุฒ
- โ ูุตูุต ุชุทููููุฉ ูู ูู ูุฑุญูุฉ
- โ ุฅุดุนุงุฑุงุช ููุฑูุฉ
- โ ูุง ุบููุถ ุฃู ุงูุชุจุงุณ

**ุงูุจุณุงุทุฉ:**
- โ ูุงุฌูุงุช ูุธููุฉ ูุณููุฉ
- โ ุฎุทูุงุช ูุงุถุญุฉ
- โ ุฅุฑุดุงุฏุงุช ููุตูุฉ
- โ ุฑุณุงุฆู ุฎุทุฃ ูููููุฉ

**ุงูุฃูุงู:**
- โ ูุง ุฏูุน ููุฑุฑ
- โ ุฅูุตุงูุงุช ูุญููุฉ
- โ ูุนูููุงุช ุขููุฉ
- โ ุนูููุงุช ููุซูุฉ

### ุฅุฏุงุฑุฉ ูุณูุทุฑุฉ โ

**ุงูุณูุทุฑุฉ ุงููุงููุฉ:**
- โ ุชุญูู ูู ูุณุงุฆู ุงูุณุฏุงุฏ
- โ ูุฑุงุฌุนุฉ ูู ุฅูุตุงู
- โ ููุงููุฉ/ุฑูุถ ุจุณุจุจ
- โ ุชุนุฏูู ุงูุฅุนุฏุงุฏุงุช

**ุงูุตูุงุญูุงุช:**
- โ ุงูุฅุฏุงุฑุฉ ุงููุงููุฉ ููุท
- โ ูุง ุชุฏุฎู ูู ุงูุฃุฏูุงุฑ ุงูุฃุฎุฑู
- โ ุญูุงูุฉ ุชุงูุฉ
- โ audit trail ูุงูู

**ุงูุชูุงุฑูุฑ:**
- โ ุนุฏุฏ ุงูุฅูุตุงูุงุช (ููุฏ ุงููุฑุงุฌุนุฉุ ูุนุชูุฏุฉุ ูุฑููุถุฉ)
- โ ุญุงูุฉ ูู ุฅูุตุงู
- โ ุชุงุฑูุฎ ูู ุนูููุฉ
- โ ููุงุญุธุงุช ุงููุฑุงุฌุนุฉ

---

## ๐ ุงูุฅุญุตุงุฆูุงุช

### Migrations:

| ุงูููู | ุงูุบุฑุถ | ุงูุณุทูุฑ |
|------|------|--------|
| `add_payment_gateway_configuration.sql` | ุฅุถุงูุฉ ุญููู ุงูุจูุงุจุงุช | ~65 |
| `add_payment_duplicate_prevention_fixed.sql` | ููุน ุชูุฑุงุฑ ุงูุฏูุน | ~55 |

**ุฅุฌูุงูู:** ~120 ุณุทุฑ SQL

### ุงููููุงุช ุงููุญุฏุซุฉ:

| ุงูููู | ุงูุชุบููุฑุงุช | ุงูุณุทูุฑ |
|------|----------|--------|
| `PaymentMethodsSettings.tsx` | ุญููู ุงูุจูุงุจุงุช + ActionGuard | +130 |
| `paymentMethodsService.ts` | ูุธููุฉ updateGatewayConfig | +10 |
| `PaymentReceiptsManagement.tsx` | ActionGuard | +2 |

**ุฅุฌูุงูู:** ~142 ุณุทุฑ TypeScript

### ุงูุฃุฑูุงู ุงููููุฉ:

- **Migrations ุฌุฏูุฏุฉ:** 2
- **Functions ุฌุฏูุฏุฉ:** 2 (SQL + TypeScript)
- **Triggers ุฌุฏูุฏุฉ:** 1
- **Indexes ุฌุฏูุฏุฉ:** 1
- **ActionGuards:** 2
- **ุฅุฌูุงูู ุงูุณุทูุฑ:** ~262 ุณุทุฑ

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุณููุงุฑูู 1: ุฅุนุฏุงุฏ ุจูุงุจุฉ ูุฏู

```
โ ุชุณุฌูู ุฏุฎูู ูู Finance Manager
โ ุงูุฐูุงุจ ูู ุงูุฅุนุฏุงุฏุงุช โ ูุณุงุฆู ุงูุณุฏุงุฏ
โ ุงูุถุบุท ุนูู โ๏ธ ุจุฌุงูุจ "ูุฏู"
โ ุงููุงูุฐุฉ ุชูุชุญ ุจุญููู ุงูุจูุงุจุฉ
โ ุฅุฏุฎุงู:
   - Merchant ID: MCH123456
   - API Key: sk_test_abcdef123456
   - Environment: Sandbox
   - Webhook Secret: whsec_xyz789
โ ุงูุถุบุท "ุญูุธ ุงูุฅุนุฏุงุฏุงุช"
โ ุงููุฌุงุญ: "ุชู ุญูุธ ุงูุฅุนุฏุงุฏุงุช ุจูุฌุงุญ"
โ ุฅุบูุงู ุงููุงูุฐุฉ
โ ูุชุญ ุงููุงูุฐุฉ ูุฑุฉ ุฃุฎุฑู
โ ุงูุจูุงูุงุช ูุญููุธุฉ โ
```

### ุณููุงุฑูู 2: ููุน ุชูุฑุงุฑ ุงูุฏูุน

```
โ ูุณุชุซูุฑ ูุฑูุน ุฅูุตุงู ูุญุฌุฒ ูุนูู
โ ุงูุฅูุตุงู: ููุฏ ุงููุฑุงุฌุนุฉ
โ ุงูุฅุฏุงุฑุฉ ุงููุงููุฉ ุชูุงูู ุนููู
โ ุงูุฅูุตุงู: ูุนุชูุฏ
โ ุงูุฏูุน: ููุชูู
โ ุงูุญุฌุฒ: ูุฏููุน

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โ ุงููุณุชุซูุฑ ูุญุงูู ุฑูุน ุฅูุตุงู ุขุฎุฑ
โ ุฑุณุงูุฉ ุฎุทุฃ: "ูุฐุง ุงูุญุฌุฒ ูุฏููุน ุจุงููุนู"
โ ุงูุนูููุฉ ุชูููุช
โ ูุง ุชูุฑุงุฑ ููุฏูุน โ
```

### ุณููุงุฑูู 3: ุตูุงุญูุงุช ุงูุฃูุงู

```
โ ุชุณุฌูู ุฏุฎูู ูู Operations Manager
โ ุงูุฐูุงุจ ูู ุงูุฅุนุฏุงุฏุงุช โ ูุณุงุฆู ุงูุณุฏุงุฏ
โ ุฑุณุงูุฉ: "ููุณ ูุฏูู ุตูุงุญูุฉ ูุชูููุฐ ูุฐุง ุงูุฅุฌุฑุงุก"
โ ูุง ูููู ุฑุคูุฉ ุงูุตูุญุฉ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โ ุชุณุฌูู ุฏุฎูู ูู Finance Manager
โ ุงูุฐูุงุจ ูู ุงูุฅุนุฏุงุฏุงุช โ ูุณุงุฆู ุงูุณุฏุงุฏ
โ ุงูุตูุญุฉ ุชูุชุญ ุจูุฌุงุญ
โ ูููู ุงูุชุนุฏูู โ
```

### ุงุฎุชุจุงุฑ ุงูุจูุงุก:

```bash
npm run build
```

**ุงููุชูุฌุฉ:** โ ุงูุจูุงุก ูุฌุญ

```
โ 1628 modules transformed
โ built in 11.47s
```

---

## ๐ ุงูุชูุงูู ูุน ุงููุฑุงุญู ุงูุณุงุจูุฉ

### ุงููุฑุญูุฉ 1๏ธโฃ: ุฅุนุฏุงุฏุงุช ูุณุงุฆู ุงูุณุฏุงุฏ โ
- ุฃุถููุง ุญููู ุงูุจูุงุจุงุช (is_gateway, gateway_config)
- ุงูุฅุนุฏุงุฏุงุช ุงูุนุงุฏูุฉ ูุง ุชุฒุงู ููุฌูุฏุฉ

### ุงููุฑุญูุฉ 2๏ธโฃ: ุตูุญุฉ ุงูุณุฏุงุฏ โ
- ุงูุชุญููู ุงูุจููู ูุนูู
- ุฌุงูุฒ ูุฅุถุงูุฉ ุงูุจูุงุจุงุช ูุงุญูุงู

### ุงููุฑุญูุฉ 3๏ธโฃ: ูุฑุงุฌุนุฉ ุงูุฅูุตุงูุงุช โ
- ุฃุถููุง ActionGuard ููุฃูุงู
- ููุน ุชูุฑุงุฑ ุงูุฏูุน ุนูู ูุณุชูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ุงููุฑุญูุฉ 4๏ธโฃ: ุฑุจุท ุงูุณุฏุงุฏ ุจุงูุฑุณุงุฆู โ
- ุงูุฅุดุนุงุฑุงุช ุชุนูู
- ูุง ุชุฃุซูุฑ ูู ุงููุฑุญูุฉ 5

---

## ๐ ุงูุฎุทูุงุช ุงููุงุฏูุฉ

### ุงููุฑุญูุฉ 6๏ธโฃ: ุฑุจุท ูุนูู ูุน ุงูุจูุงุจุงุช

**ูุฏู (Mada):**
- ุงุฎุชูุงุฑ ุงููุฒูุฏ (Moyasar/HyperPay/Checkout)
- ุชูููุฐ API integration
- ูุนุงูุฌุฉ ุงูุฏูุน ุงูููุฑู
- ุงุณุชูุงู webhooks
- ุชุญุฏูุซ ุงูุญุงูุงุช ุชููุงุฆูุงู

**ุชุงุจู (Tabby):**
- ุฑุจุท ูุน Tabby API
- ุฅูุดุงุก sessions
- ูุนุงูุฌุฉ ุงูุชูุณูุท
- ุงุณุชูุงู ุงูุฅุดุนุงุฑุงุช
- ุชุญุฏูุซ ุงูุฃูุณุงุท

**ุชูุงุฑุง (Tamara):**
- ุฑุจุท ูุน Tamara API
- ุฅูุดุงุก orders
- ูุนุงูุฌุฉ ุงูุฏูุน ุงูุขุฌู
- ุงุณุชูุงู callbacks
- ุชุญุฏูุซ ุงููุฏููุนุงุช

### ุงููุฑุญูุฉ 7๏ธโฃ: ุชุญุณููุงุช ูุชูุฏูุฉ

**Webhooks:**
- ุงุณุชูุจุงู ุฅุดุนุงุฑุงุช ุงูุจูุงุจุงุช
- ูุนุงูุฌุฉ ุงูุฃุญุฏุงุซ ุงููุฎุชููุฉ
- ุชุญุฏูุซ ุงูุญุงูุงุช ุชููุงุฆูุงู
- ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ูููุณุชุซูุฑ

**Refunds:**
- ุฅูุบุงุก ุงูุฏูุนุงุช
- ุงุณุชุฑุฌุงุน ุงููุจุงูุบ
- ูุนุงูุฌุฉ ุงูู disputes
- ุชุญุฏูุซ ุงูุณุฌูุงุช

**Reports:**
- ุชูุงุฑูุฑ ูุงููุฉ ุดุงููุฉ
- ุชุญููู ูุณุงุฆู ุงูุฏูุน
- ูุนุฏูุงุช ุงููุฌุงุญ/ุงููุดู
- ุฅุญุตุงุฆูุงุช ุงูุจูุงุจุงุช

---

## ๐ ุงููุซุงุฆู ุงูุชูููุฉ

### ูููู gateway_config

```typescript
interface GatewayConfig {
  merchant_id: string;        // ุฑูู ุงูุชุงุฌุฑ
  api_key: string;            // ููุชุงุญ API ุงูุณุฑู
  environment: 'sandbox' | 'production';  // ุงูุจูุฆุฉ
  webhook_secret?: string;    // ููุชุงุญ webhooks (ุงุฎุชูุงุฑู)
}
```

### ุฃูุซูุฉ

**ูุฏู (Sandbox):**
```json
{
  "merchant_id": "MCH_TEST_123456",
  "api_key": "sk_test_abcdefghijklmnop",
  "environment": "sandbox",
  "webhook_secret": "whsec_test_xyz123"
}
```

**ุชุงุจู (Production):**
```json
{
  "merchant_id": "TABBY_MERCHANT_789",
  "api_key": "pk_live_qrstuvwxyz",
  "environment": "production",
  "webhook_secret": "whsec_live_abc456"
}
```

**ุชูุงุฑุง (Sandbox):**
```json
{
  "merchant_id": "TAMARA_TEST_999",
  "api_key": "Bearer test_token_123",
  "environment": "sandbox"
}
```

### API Reference

**ุชุญุฏูุซ ุฅุนุฏุงุฏุงุช ุงูุจูุงุจุฉ:**
```typescript
await paymentMethodsService.updateGatewayConfig(
  'payment_method_id',
  {
    merchant_id: 'MCH123',
    api_key: 'sk_test_abc',
    environment: 'sandbox',
    webhook_secret: 'whsec_xyz'
  }
);
```

**ุงูุญุตูู ุนูู ุงูุจูุงุจุงุช ููุท:**
```typescript
const methods = await paymentMethodsService.getAllMethods();
const gateways = methods.filter(m => m.is_gateway);
```

**ุงูุชุญูู ูู ูุฌูุฏ ุฅูุตุงู ูุนุชูุฏ:**
```typescript
// ูุชู ุชููุงุฆูุงู ุนุจุฑ trigger
// ูู ูุณูุญ ุจุฅุฏุฑุงุฌ ุฅูุตุงู ููุฑุฑ
```

---

## ๐ ุงูุฎูุงุตุฉ

### โ ูุง ุชู ุฅูุฌุงุฒู ูู ุงููุฑุญูุฉ 5๏ธโฃ:

1. **ุฅุถุงูุฉ ุญููู ุงูุจูุงุจุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:**
   - is_gateway (boolean)
   - gateway_config (jsonb)
   - constraints ููุชุญูู

2. **ููุน ุชูุฑุงุฑ ุงูุฏูุน:**
   - trigger ูููุญุต
   - function ููุชุญููุงุช
   - unique index ููุถูุงู

3. **ูุงุฌูุฉ ุชููุฆุฉ ุงูุจูุงุจุงุช:**
   - ุญููู ุงูุฅุนุฏุงุฏุงุช (merchant_id, api_key, environment)
   - ุชูุจููุงุช ุฃูููุฉ
   - ุญูุธ ูุงุณุชุฑุฌุงุน ุงูุฅุนุฏุงุฏุงุช

4. **ูุธุงุฆู ุงูุฎุฏูุฉ:**
   - updateGatewayConfig()

5. **ุงูุตูุงุญูุงุช ุงูุฃูููุฉ:**
   - ActionGuard ุนูู ูุณุงุฆู ุงูุณุฏุงุฏ
   - ActionGuard ุนูู ูุฑุงุฌุนุฉ ุงูุฅูุตุงูุงุช

### โ ุงูุชุญุณููุงุช ุงููุถุงูุฉ:

**๐น ุชุญุณูู 1: ููุน ุงูุฎุทุฃ**
- โ ูุง ูููู ุงูุณุฏุงุฏ ูุฑุชูู
- โ ูุง ูููู ุฑูุน ุฅูุตุงู ุจุฏูู ุญุฌุฒ ูุนุชูุฏ

**๐น ุชุญุณูู 2: ูุถูุญ UX**
- โ ุญุงูุงุช ูุงุถุญุฉ ุจุงูุฃููุงู
- โ ูุตูุต ุชุทููู ูููุณุชุซูุฑ

**๐น ุชุญุณูู 3: ุงูุฃูุงู**
- โ ุตูุงุญูุงุช ุงูุณุฏุงุฏ ูููุงููุฉ ููุท
- โ ูุง ุชุนุฏูู ูู ุบูุฑูู

### โ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ:

```
ููุตุฉ ุฌุงูุฒุฉ ููุณุฏุงุฏ โ
  โ
ุฏูุฑุฉ ูุงููุฉ ูุงุถุญุฉ โ
  โ
ูุณุชุซูุฑ ูุฑุชุงุญ โ
  โ
ุฅุฏุงุฑุฉ ูุณูุทุฑุฉ โ
```

---

**๐ ุชุงุฑูุฎ ุงูุฅููุงู:** 28 ููุงูุฑ 2026

**โ ุงูุญุงูุฉ:** ุงููุฑุญูุฉ 5๏ธโฃ ููุชููุฉ ููุฎุชุจุฑุฉ โ

**๐ฏ ุงููุชูุฌุฉ:** ูุธุงู ุณุฏุงุฏ ุงุญุชุฑุงููุ ุขููุ ูุงุถุญุ ููุฑู - ุฌุงูุฒ ููุชูุณุน ุงููุณุชูุจูู! ๐

---

## ๐ ุฅูุฌุงุฒ ุงููุฑุงุญู ุงูุฎูุณ ุงููุงููุฉ

```
ุงููุฑุญูุฉ 1๏ธโฃ: ุฅุนุฏุงุฏุงุช ูุณุงุฆู ุงูุณุฏุงุฏ โ
  โ
ุงููุฑุญูุฉ 2๏ธโฃ: ุตูุญุฉ ุงูุณุฏุงุฏ โ
  โ
ุงููุฑุญูุฉ 3๏ธโฃ: ูุฑุงุฌุนุฉ ุงูุฅูุตุงูุงุช โ
  โ
ุงููุฑุญูุฉ 4๏ธโฃ: ุฑุจุท ุงูุณุฏุงุฏ ุจุงูุฑุณุงุฆู โ
  โ
ุงููุฑุญูุฉ 5๏ธโฃ: ุชููุฆุฉ ุจูุงุจุงุช ุงูุฏูุน โ
```

**ูุธุงู ุณุฏุงุฏ ูุชูุงูู 100%** ๐
