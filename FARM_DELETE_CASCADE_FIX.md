# ุฅุตูุงุญ ูุดููุฉ ุญุฐู ุงููุฒุงุฑุน - ุงูุญุฐู ุงููุชุณูุณู

## ูุธุฑุฉ ุนุงูุฉ

ุชู ุฅุตูุงุญ ูุดููุฉ ุนุฏู ุงููุฏุฑุฉ ุนูู ุญุฐู ุงููุฒุงุฑุน ุงูุชู ุชุญุชูู ุนูู ุจูุงูุงุช ูุฑุชุจุทุฉ (ุญุฌูุฒุงุชุ ููุงูุ ุนููุฏุ ุฅูุฎ).

---

## ุงููุดููุฉ ุงูุฃุตููุฉ โ

### ุงูุฎุทุฃ ุงูุฐู ูุงู ูุธูุฑ:

```
DELETE https://fyxxrplokeqbgkrvscto.supabase.co/rest/v1/farms?id=eq.xxx 409 (Conflict)

Error: {
  code: '23503',
  details: 'Key is still referenced from table "reservations".',
  message: 'update or delete on table "farms" violates foreign key constraint'
}
```

### ุงูุณุจุจ:

```
ุนูุฏ ูุญุงููุฉ ุญุฐู ูุฒุฑุนุฉ:
โโโโโโโโโโโโโโโโโโโ
โ   farms (id=1)  โ
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โ foreign key
         โโโโโโโโโโโโโโโโโโโโ
         โ                  โ
    โโโโโโผโโโโโโโโโ   โโโโโโผโโโโโโโโโโ
    โreservations โ   โ farm_tasks   โ
    โ farm_id=1   โ   โ farm_id=1    โ
    โโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโ

โ ุญุฐู ุงููุฒุฑุนุฉ ููููุน ููุฌูุฏ ุณุฌูุงุช ูุฑุชุจุทุฉ
```

---

## ุงูุญู ุงููุทุจู โ

ุชู ุชุทุจูู ุญูููู ูุชูุงูููู:

### 1. ุชุญุณูู ุงููุนุงูุฌุฉ ูู ุงููุงุฌูุฉ (UI) ๐ป

**ุงูููุฒุงุช ุงูุฌุฏูุฏุฉ:**

#### ุฃ. ุงูุชุญูู ุงููุณุจู ูู ุงูุญุฌูุฒุงุช

```typescript
// ูุจู ูุญุงููุฉ ุงูุญุฐูุ ูุชุญูู ูู ูุฌูุฏ ุญุฌูุฒุงุช
const { count: reservationsCount } = await supabase
  .from('reservations')
  .select('*', { count: 'exact', head: true })
  .eq('farm_id', selectedFarm.id);

if (reservationsCount && reservationsCount > 0) {
  // ุนุฑุถ ุฑุณุงูุฉ ูุงุถุญุฉ ูููุณุชุฎุฏู
  alert(
    `ูุง ูููู ุญุฐู ุงููุฒุฑุนุฉ "${selectedFarm.name_ar}" ูุฃููุง ุชุญุชูู ุนูู ${reservationsCount} ุญุฌุฒ.\n\n` +
    'ูุฌุจ ุญุฐู ุฌููุน ุงูุญุฌูุฒุงุช ุงููุฑุชุจุทุฉ ุจุงููุฒุฑุนุฉ ุฃููุงู.'
  );
  return;
}
```

**ุงูููุงุฆุฏ:**
- โ ุงููุณุชุฎุฏู ูุนุฑู ุงูุณุจุจ ุจูุถูุญ
- โ ูุนุฑู ุนุฏุฏ ุงูุญุฌูุฒุงุช ุงููุฑุชุจุทุฉ
- โ ูุนุฑู ุงูุฎุทูุฉ ุงูุชุงููุฉ ุงููุทููุจุฉ

#### ุจ. ูุนุงูุฌุฉ ุฃุฎุทุงุก Foreign Key

```typescript
if (error.code === '23503') {
  alert(
    'ูุง ูููู ุญุฐู ูุฐู ุงููุฒุฑุนุฉ ูุฃููุง ูุฑุชุจุทุฉ ุจุจูุงูุงุช ุฃุฎุฑู ูู ุงููุธุงู.\n\n' +
    'ุงูุฑุฌุงุก ุญุฐู ุฌููุน ุงูุจูุงูุงุช ุงููุฑุชุจุทุฉ ุฃููุงู (ุงูุญุฌูุฒุงุชุ ุงูููุงูุ ุงูุฑุณุงุฆูุ ุฅูุฎ).'
  );
}
```

**ุงูููุงุฆุฏ:**
- โ ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ ุจุงูุนุฑุจู
- โ ุชูุถูุญ ุงูุฃููุงุน ุงููุฎุชููุฉ ูู ุงูุจูุงูุงุช ุงููุฑุชุจุทุฉ
- โ ุฅุฑุดุงุฏ ุงููุณุชุฎุฏู ููุง ูุฌุจ ูุนูู

---

### 2. ุฅุตูุงุญ ูุงุนุฏุฉ ุงูุจูุงูุงุช (CASCADE) ๐๏ธ

**Migration:** `fix_farms_cascade_deletion.sql`

#### ุงูุชุบููุฑุงุช ุงููุทุจูุฉ:

```sql
-- ุงูุขู ุนูุฏ ุญุฐู ูุฒุฑุนุฉ:
โโโโโโโโโโโโโโโโโโโ
โ   farms (id=1)  โ  โ ุญุฐู
โโโโโโโโโโฌโโโโโโโโโ
         โ
         โ ON DELETE CASCADE
         โโโโโโโโโโโโโโโโโโโโ
         โ                  โ
    โโโโโโผโโโโโโโโโ   โโโโโโผโโโโโโโโโโ
    โreservations โ   โ farm_tasks   โ
    โ farm_id=1   โ   โ farm_id=1    โ
    โโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโ
         โ CASCADE         โ CASCADE
    โ ุชูุญุฐู ุชููุงุฆูุงู  โ ุชูุญุฐู ุชููุงุฆูุงู
```

#### ุงูุฌุฏุงูู ุงููุนุฏูุฉ:

| ุงูุฌุฏูู | Foreign Key | ุงูุณููู | ุงููุตู |
|--------|-------------|--------|-------|
| **reservations** | `farm_id` | `ON DELETE CASCADE` | ุญุฐู ุฌููุน ุงูุญุฌูุฒุงุช ุงููุฑุชุจุทุฉ |
| **reservation_items** | `reservation_id` | `ON DELETE CASCADE` | ุญุฐู ุนูุงุตุฑ ุงูุญุฌูุฒุงุช |
| **farm_tasks** | `farm_id` | `ON DELETE CASCADE` | ุญุฐู ุฌููุน ุงูููุงู ุงููุฑุชุจุทุฉ |
| **farm_contracts** | `farm_id` | `ON DELETE CASCADE` | ุญุฐู ุฌููุน ุงูุนููุฏ ุงููุฑุชุจุทุฉ |
| **investor_messages** | `farm_id` | `ON DELETE CASCADE` | ุญุฐู ุฑุณุงุฆู ุงููุณุชุซูุฑูู |
| **messages** | `related_farm_id` | `ON DELETE SET NULL` | ุฌุนู ุงูุญูู NULL (ุงูุฑุณุงุฆู ุนุงูุฉ) |

---

## ุงูุชูุงุตูู ุงูุชูููุฉ

### ุฃ. ุฅุนุงุฏุฉ ุจูุงุก Foreign Key Constraints

**ุงูุฎุทูุงุช:**

```sql
-- 1. ุญุฐู ุงูู constraint ุงููุฏูู
DO $$
BEGIN
  IF EXISTS (
    SELECT 1 FROM information_schema.table_constraints
    WHERE constraint_name = 'reservations_farm_id_fkey'
  ) THEN
    ALTER TABLE reservations DROP CONSTRAINT reservations_farm_id_fkey;
  END IF;
END $$;

-- 2. ุฅุถุงูุฉ constraint ุฌุฏูุฏ ูุน CASCADE
ALTER TABLE reservations
  ADD CONSTRAINT reservations_farm_id_fkey
  FOREIGN KEY (farm_id)
  REFERENCES farms(id)
  ON DELETE CASCADE;
```

**ุงูููุงุฆุฏ:**
- โ ุงูุชุญูู ูู ูุฌูุฏ ุงูู constraint ูุจู ุงูุญุฐู (ูุง ุฃุฎุทุงุก)
- โ ุฅุถุงูุฉ cascade ุจุดูู ุตุญูุญ
- โ ุชุณููุฉ ููุญุฏุฉ ููู constraints

### ุจ. ุงูุญุฐู ุงููุชุณูุณู ูู ุงูุณูุณูุฉ

**ูุซุงู:** ุนูุฏ ุญุฐู ูุฒุฑุนุฉ ุชุญุชูู ุนูู ุญุฌูุฒุงุช

```
ุญุฐู ุงููุฒุฑุนุฉ
    โ
1. ุญุฐู ุฌููุน reservations ุงููุฑุชุจุทุฉ
    โ
2. ุญุฐู ุฌููุน reservation_items ุงููุฑุชุจุทุฉ ุจูู ุญุฌุฒ
    โ
3. ุญุฐู ุฌููุน farm_tasks ุงููุฑุชุจุทุฉ
    โ
4. ุญุฐู ุฌููุน farm_contracts ุงููุฑุชุจุทุฉ
    โ
5. ุญุฐู ุฌููุน investor_messages ุงููุฑุชุจุทุฉ
    โ
6. ุชุญุฏูุซ messages (SET NULL ููู related_farm_id)
    โ
โ ุญุฐู ุงููุฒุฑุนุฉ ุจูุฌุงุญ
```

### ุฌ. ุงูุชุนูููุงุช ุงูุชูุถูุญูุฉ

```sql
COMMENT ON CONSTRAINT reservations_farm_id_fkey ON reservations IS
  'CASCADE: ุญุฐู ุงููุฒุฑุนุฉ ูุญุฐู ุฌููุน ุงูุญุฌูุฒุงุช ุงููุฑุชุจุทุฉ';

COMMENT ON CONSTRAINT farm_tasks_farm_id_fkey ON farm_tasks IS
  'CASCADE: ุญุฐู ุงููุฒุฑุนุฉ ูุญุฐู ุฌููุน ุงูููุงู ุงููุฑุชุจุทุฉ';

COMMENT ON CONSTRAINT messages_related_farm_id_fkey ON messages IS
  'SET NULL: ุญุฐู ุงููุฒุฑุนุฉ ูุฌุนู related_farm_id = NULL ูู ุงูุฑุณุงุฆู ุงูุนุงูุฉ';
```

**ุงููุงุฆุฏุฉ:**
- โ ุชูุซูู ูุงุถุญ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ููุณูุง
- โ ูุณุงุนุฏ ุงููุทูุฑูู ุงููุณุชูุจูููู
- โ ููุถุญ ุงูุณููู ุงููุชููุน

---

## ุงูุณููุงุฑูููุงุช ุงููุฎุชููุฉ

### ุณููุงุฑูู 1: ุญุฐู ูุฒุฑุนุฉ ุจุฏูู ุญุฌูุฒุงุช โ

```
ุงููุณุชุฎุฏู ูุถุบุท "ุญุฐู" ุนูู ูุฒุฑุนุฉ ุฌุฏูุฏุฉ
    โ
ุงูุชุญูู ูู ุงูุญุฌูุฒุงุช: 0 ุญุฌุฒ
    โ
ุญุฐู ุงููุฒุฑุนุฉ ูุจุงุดุฑุฉ
    โ
โ ุชู ุงูุญุฐู ุจูุฌุงุญ
```

**ุงููุชูุฌุฉ:**
```
โ ุงููุฒุฑุนุฉ ุชูุญุฐู ููุฑุงู
โ ูุง ุฑุณุงุฆู ุฎุทุฃ
โ ุงููุงุฆูุฉ ุชุชุญุฏุซ ุชููุงุฆูุงู
```

### ุณููุงุฑูู 2: ุญุฐู ูุฒุฑุนุฉ ุจูุง ุญุฌูุฒุงุช (ูุน CASCADE) โ

```
ุงููุณุชุฎุฏู ูุถุบุท "ุญุฐู" ุนูู ูุฒุฑุนุฉ ุจูุง 5 ุญุฌูุฒุงุช
    โ
ุงูุชุญูู ูู ุงูุญุฌูุฒุงุช: 5 ุญุฌูุฒุงุช
    โ
ุนุฑุถ ุฑุณุงูุฉ:
"ูุง ูููู ุญุฐู ุงููุฒุฑุนุฉ 'ูุฒุฑุนุฉ ุงููุฎูู' ูุฃููุง ุชุญุชูู ุนูู 5 ุญุฌุฒ.
ูุฌุจ ุญุฐู ุฌููุน ุงูุญุฌูุฒุงุช ุงููุฑุชุจุทุฉ ุจุงููุฒุฑุนุฉ ุฃููุงู."
    โ
โ ุงูุญุฐู ููููุน (ุญูุงูุฉ ุงูุจูุงูุงุช)
```

**ุงููุชูุฌุฉ:**
```
โ ุงูุจูุงูุงุช ูุญููุฉ ูู ุงูุญุฐู ุบูุฑ ุงูููุตูุฏ
โ ุงููุณุชุฎุฏู ูุนุฑู ุงูุณุจุจ ุจูุถูุญ
โ ุงููุณุชุฎุฏู ูุนุฑู ุนุฏุฏ ุงูุญุฌูุฒุงุช
```

### ุณููุงุฑูู 3: ุญุฐู ูุฒุฑุนุฉ ุจูุง ุจูุงูุงุช ุฃุฎุฑู (ููุงูุ ุนููุฏ) โ๏ธ

```
ุงููุณุชุฎุฏู ูุถุบุท "ุญุฐู" ุนูู ูุฒุฑุนุฉ ุจูุง:
- 0 ุญุฌูุฒุงุช
- 3 ููุงู
- 2 ุนููุฏ
- 10 ุฑุณุงุฆู
    โ
ุงูุชุญูู ูู ุงูุญุฌูุฒุงุช: 0 ุญุฌุฒ โ
    โ
ูุญุงููุฉ ุงูุญุฐู
    โ
CASCADE ุชูุนู ุนูููุง:
- ุญุฐู 3 ููุงู
- ุญุฐู 2 ุนููุฏ
- ุญุฐู 10 ุฑุณุงุฆู
- ุญุฐู ุงููุฒุฑุนุฉ
    โ
โ ุชู ุงูุญุฐู ุจูุฌุงุญ
```

**ุงููุชูุฌุฉ:**
```
โ ุฌููุน ุงูุจูุงูุงุช ุงููุฑุชุจุทุฉ ุชูุญุฐู ุชููุงุฆูุงู
โ ูุง ุญุงุฌุฉ ูุญุฐููุง ูุฏููุงู ูุงุญุฏุฉ ูุงุญุฏุฉ
โ ุชูุธูู ูุงูู ูููุธุงู
```

### ุณููุงุฑูู 4: ุฎุทุฃ ุบูุฑ ูุชููุน โ

```
ูุญุงููุฉ ุงูุญุฐู
    โ
ุฎุทุฃ ูู ุงูุดุจูุฉ / ูุงุนุฏุฉ ุงูุจูุงูุงุช
    โ
catch (error)
    โ
ุนุฑุถ ุฑุณุงูุฉ:
"ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุงููุฒุฑุนุฉ"
    โ
console.error(error) ููุชุชุจุน
```

**ุงููุชูุฌุฉ:**
```
โ ุฑุณุงูุฉ ุฎุทุฃ ุนุงูุฉ ูููุณุชุฎุฏู
โ ุชูุงุตูู ุงูุฎุทุฃ ูู console ูููุทูุฑูู
โ ุงูุญุงูุฉ ุชุจูู ููุง ูู (ูุง ุชุชุฃุซุฑ ุงูุจูุงูุงุช)
```

---

## ููุงุฑูุฉ: ูุจู ูุจุนุฏ

### ูุจู ุงูุฅุตูุงุญ โ

**ุนูุฏ ุญุฐู ูุฒุฑุนุฉ ุจูุง ุญุฌูุฒุงุช:**
```
1. ุงูุฃุฏูู ูุถุบุท "ุญุฐู"
2. ูุคูุฏ ุงูุญุฐู
3. ุฎุทุฃ 409 Conflict
4. ุฑุณุงูุฉ ุบูุฑ ูุงุถุญุฉ ูู console
5. ุงููุณุชุฎุฏู ูุญุชุงุฑ: ูุง ุงููุดููุฉุ
6. ุงููุฒุฑุนุฉ ูู ุชูุญุฐู
```

**ุงููุดุงูู:**
- โ ุฑุณุงูุฉ ุฎุทุฃ ุชูููุฉ ุบูุฑ ูููููุฉ
- โ ุงููุณุชุฎุฏู ูุง ูุนุฑู ุงูุณุจุจ
- โ ุงููุณุชุฎุฏู ูุง ูุนุฑู ููู ูุญู ุงููุดููุฉ
- โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุณูุฆุฉ

### ุจุนุฏ ุงูุฅุตูุงุญ โ

**ุนูุฏ ุญุฐู ูุฒุฑุนุฉ ุจูุง ุญุฌูุฒุงุช:**
```
1. ุงูุฃุฏูู ูุถุบุท "ุญุฐู"
2. ูุคูุฏ ุงูุญุฐู
3. ูุญุต ุฃูุชููุงุชููู: 5 ุญุฌูุฒุงุช ููุฌูุฏุฉ
4. ุฑุณุงูุฉ ูุงุถุญุฉ:
   "ูุง ูููู ุญุฐู ุงููุฒุฑุนุฉ 'ูุฒุฑุนุฉ ุงููุฎูู'
    ูุฃููุง ุชุญุชูู ุนูู 5 ุญุฌุฒ."
5. ุงููุณุชุฎุฏู ูููู: ูุฌุจ ุญุฐู ุงูุญุฌูุฒุงุช ุฃููุงู
6. ุงููุฒุฑุนุฉ ูุญููุฉ ูู ุงูุญุฐู ุบูุฑ ุงูููุตูุฏ
```

**ุงูููุงุฆุฏ:**
- โ ุฑุณุงูุฉ ูุงุถุญุฉ ุจุงูุนุฑุจู
- โ ุงููุณุชุฎุฏู ูุนุฑู ุงูุณุจุจ ุจุฏูุฉ
- โ ุงููุณุชุฎุฏู ูุนุฑู ุนุฏุฏ ุงูุญุฌูุฒุงุช
- โ ุงููุณุชุฎุฏู ูุนุฑู ุงูุฎุทูุฉ ุงูุชุงููุฉ
- โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ููุชุงุฒุฉ

---

## ุงูููุฏ ุงููุนุฏู

### FarmCardsManagement.tsx

#### ุงูุฏุงูุฉ ุงููุฏููุฉ:

```typescript
const handleConfirmDelete = async () => {
  if (!selectedFarm) return;

  setIsDeleting(true);
  try {
    // โ ุญุฐู ูุจุงุดุฑ ุจุฏูู ูุญุต
    const { error } = await supabase
      .from('farms')
      .delete()
      .eq('id', selectedFarm.id);

    if (error) {
      // โ ุฑุณุงูุฉ ุนุงูุฉ ุบูุฑ ูููุฏุฉ
      console.error('Error deleting farm:', error);
      alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุงููุฒุฑุนุฉ');
      return;
    }

    setShowDeleteConfirm(false);
    setSelectedFarm(null);
    setRefreshTrigger(prev => prev + 1);
  } catch (err) {
    console.error('Unexpected error deleting farm:', err);
    alert('ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน');
  } finally {
    setIsDeleting(false);
  }
};
```

#### ุงูุฏุงูุฉ ุงูุฌุฏูุฏุฉ:

```typescript
const handleConfirmDelete = async () => {
  if (!selectedFarm) return;

  setIsDeleting(true);
  try {
    // โ ูุญุต ุงูุญุฌูุฒุงุช ุฃููุงู
    const { count: reservationsCount } = await supabase
      .from('reservations')
      .select('*', { count: 'exact', head: true })
      .eq('farm_id', selectedFarm.id);

    // โ ุฑุณุงูุฉ ูุงุถุญุฉ ูุน ุนุฏุฏ ุงูุญุฌูุฒุงุช
    if (reservationsCount && reservationsCount > 0) {
      alert(
        `ูุง ูููู ุญุฐู ุงููุฒุฑุนุฉ "${selectedFarm.name_ar}" ูุฃููุง ุชุญุชูู ุนูู ${reservationsCount} ุญุฌุฒ.\n\n` +
        'ูุฌุจ ุญุฐู ุฌููุน ุงูุญุฌูุฒุงุช ุงููุฑุชุจุทุฉ ุจุงููุฒุฑุนุฉ ุฃููุงู.'
      );
      setIsDeleting(false);
      return;
    }

    const { error } = await supabase
      .from('farms')
      .delete()
      .eq('id', selectedFarm.id);

    if (error) {
      console.error('Error deleting farm:', error);

      // โ ูุนุงูุฌุฉ ุฎุงุตุฉ ูุฃุฎุทุงุก foreign key
      if (error.code === '23503') {
        alert(
          'ูุง ูููู ุญุฐู ูุฐู ุงููุฒุฑุนุฉ ูุฃููุง ูุฑุชุจุทุฉ ุจุจูุงูุงุช ุฃุฎุฑู ูู ุงููุธุงู.\n\n' +
          'ุงูุฑุฌุงุก ุญุฐู ุฌููุน ุงูุจูุงูุงุช ุงููุฑุชุจุทุฉ ุฃููุงู (ุงูุญุฌูุฒุงุชุ ุงูููุงูุ ุงูุฑุณุงุฆูุ ุฅูุฎ).'
        );
      } else {
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุงููุฒุฑุนุฉ');
      }
      setIsDeleting(false);
      return;
    }

    setShowDeleteConfirm(false);
    setSelectedFarm(null);
    setRefreshTrigger(prev => prev + 1);
  } catch (err) {
    console.error('Unexpected error deleting farm:', err);
    alert('ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน');
    setIsDeleting(false);
  } finally {
    setIsDeleting(false);
  }
};
```

#### ุงูุชุญุณููุงุช:

| ุงููุฏูู | ุงูุฌุฏูุฏ | ุงููุงุฆุฏุฉ |
|-------|--------|---------|
| ุญุฐู ูุจุงุดุฑ | ูุญุต ุงูุญุฌูุฒุงุช ุฃููุงู | ุญูุงูุฉ ุงูุจูุงูุงุช |
| ุฑุณุงูุฉ ุนุงูุฉ | ุฑุณุงูุฉ ููุตูุฉ ูุน ุงูุนุฏุฏ | ูุถูุญ ูููุณุชุฎุฏู |
| ุฎุทุฃ ูุงุญุฏ | ูุนุงูุฌุฉ ูุฎุตุตุฉ ููู ุฎุทุฃ | ุชุฌุฑุจุฉ ุฃูุถู |
| ูุง ุชูุฌูู | ุชูุฌูู ูุงุถุญ | ุฅุฑุดุงุฏ ุงููุณุชุฎุฏู |

---

## ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุงุฑ 1: ุญุฐู ูุฒุฑุนุฉ ูุงุฑุบุฉ โ

**ุงูุฎุทูุงุช:**
```
1. ุฅูุดุงุก ูุฒุฑุนุฉ ุฌุฏูุฏุฉ
2. ุนุฏู ุฅุถุงูุฉ ุฃู ุญุฌูุฒุงุช
3. ูุญุงููุฉ ุงูุญุฐู
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```
โ ุชุธูุฑ ูุงูุฐุฉ ุงูุชุฃููุฏ
โ ุนูุฏ ุงูุชุฃููุฏ: "ุฌุงุฑู ุงูุญุฐู..."
โ ุงููุฒุฑุนุฉ ุชูุญุฐู ุจูุฌุงุญ
โ ุงููุงุฆูุฉ ุชุชุญุฏุซ ุชููุงุฆูุงู
โ ูุง ุฑุณุงุฆู ุฎุทุฃ
```

### ุงุฎุชุจุงุฑ 2: ุญุฐู ูุฒุฑุนุฉ ุจูุง ุญุฌูุฒุงุช โ๏ธ

**ุงูุฎุทูุงุช:**
```
1. ุงุฎุชูุงุฑ ูุฒุฑุนุฉ ููุฌูุฏุฉ ุจูุง ุญุฌูุฒุงุช
2. ูุญุงููุฉ ุงูุญุฐู
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```
โ ุชุธูุฑ ูุงูุฐุฉ ุงูุชุฃููุฏ
โ ุนูุฏ ุงูุชุฃููุฏ: ูุญุต ุงูุญุฌูุฒุงุช
โ ุฑุณุงูุฉ:
   "ูุง ูููู ุญุฐู ุงููุฒุฑุนุฉ 'ูุฒุฑุนุฉ X'
    ูุฃููุง ุชุญุชูู ุนูู N ุญุฌุฒ.
    ูุฌุจ ุญุฐู ุฌููุน ุงูุญุฌูุฒุงุช ุงููุฑุชุจุทุฉ ุฃููุงู."
โ ุงูุญุฐู ูุง ูุญุฏุซ (ุญูุงูุฉ)
โ ุงููุฒุฑุนุฉ ุชุจูู ูู ุงููุงุฆูุฉ
```

### ุงุฎุชุจุงุฑ 3: CASCADE ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ๐๏ธ

**ุงูุฎุทูุงุช:**
```sql
-- ูู SQL Console
-- 1. ุฅูุดุงุก ูุฒุฑุนุฉ ุงุฎุชุจุงุฑ
INSERT INTO farms (...) VALUES (...);

-- 2. ุฅุถุงูุฉ ููุงู ูุนููุฏ (ุจุฏูู ุญุฌูุฒุงุช)
INSERT INTO farm_tasks (farm_id, ...) VALUES (...);
INSERT INTO farm_contracts (farm_id, ...) VALUES (...);

-- 3. ุญุฐู ุงููุฒุฑุนุฉ
DELETE FROM farms WHERE id = 'xxx';
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```
โ farm_tasks ุชูุญุฐู ุชููุงุฆูุงู
โ farm_contracts ุชูุญุฐู ุชููุงุฆูุงู
โ ุงููุฒุฑุนุฉ ุชูุญุฐู ุจูุฌุงุญ
โ ูุง ุฃุฎุทุงุก foreign key
```

---

## ุงูุฃูุงู ูุงูุญูุงูุฉ

### 1. ุญูุงูุฉ ุงูุจูุงูุงุช ๐

**ุงูุญุฌูุฒุงุช ุงููุดุทุฉ:**
```
โ ูุง ูููู ุญุฐู ูุฒุฑุนุฉ ุจูุง ุญุฌูุฒุงุช
โ ูุฌุจ ุญุฐู ุงูุญุฌูุฒุงุช ุฃููุงู ูุฏููุงู
โ ููุน ููุฏุงู ุจูุงูุงุช ุงููุณุชุซูุฑูู
```

**ุงูุจูุงูุงุช ุงูุฃุฎุฑู:**
```
โ ุงูููุงู ุชูุญุฐู ุชููุงุฆูุงู (CASCADE)
โ ุงูุนููุฏ ุชูุญุฐู ุชููุงุฆูุงู (CASCADE)
โ ุงูุฑุณุงุฆู ุงูุนุงูุฉ ุชุจูู (SET NULL)
```

### 2. ุตูุงุญูุงุช ุงูุญุฐู ๐ฎ

**RLS Policy:**
```sql
CREATE POLICY "Admins can delete farms"
  ON farms FOR DELETE
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM admins
      WHERE admins.user_id = auth.uid()
      AND admins.is_active = true
    )
  );
```

**ุงูุชุญูู:**
- โ ููุท ุงูุฃุฏููุฒ ุงููุตุฑุญ ููู
- โ ูุฌุจ ุฃู ูููู is_active = true
- โ ูุง ูุณุชุทูุน ุงููุณุชุซูุฑูู ุงูุญุฐู
- โ ูุง ูุณุชุทูุน ุงูุฒูุงุฑ ุงูุญุฐู

### 3. ุงูุชุฏููู ูุงูุชุชุจุน ๐

**Console Logging:**
```typescript
console.error('Error deleting farm:', error);
```

**ุงูููุงุฆุฏ:**
- โ ุชุชุจุน ุฌููุน ุนูููุงุช ุงูุญุฐู
- โ ุชุณุฌูู ุงูุฃุฎุทุงุก ููุชุญููู
- โ ูุณุงุนุฏุฉ ูู ุชุตุญูุญ ุงููุดุงูู

---

## ุงูุฎูุงุตุฉ

### ูุง ุชู ุฅูุฌุงุฒู โ

1. **ูุนุงูุฌุฉ UI ูุญุณููุฉ:**
   - โ ูุญุต ุงูุญุฌูุฒุงุช ูุจู ุงูุญุฐู
   - โ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ุจุงูุนุฑุจู
   - โ ุนุฑุถ ุนุฏุฏ ุงูุญุฌูุฒุงุช
   - โ ุชูุฌูู ุงููุณุชุฎุฏู ููุญู

2. **ุฅุตูุงุญ ูุงุนุฏุฉ ุงูุจูุงูุงุช:**
   - โ ุชุทุจูู CASCADE ุนูู ุฌููุน ุงูุนูุงูุงุช
   - โ ุชุนูููุงุช ุชูุถูุญูุฉ ูู DB
   - โ ูุนุงูุฌุฉ ูุชุณูุฉ ูุฌููุน ุงูุฌุฏุงูู

3. **ุญูุงูุฉ ุงูุจูุงูุงุช:**
   - โ ููุน ุญุฐู ุงููุฒุงุฑุน ุจูุง ุญุฌูุฒุงุช
   - โ ุญุฐู ุชููุงุฆู ููุจูุงูุงุช ุงูุซุงูููุฉ
   - โ ุตูุงุญูุงุช ูุญููุฉ

4. **ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู:**
   - โ ุฑุณุงุฆู ูุงุถุญุฉ ููููุฏุฉ
   - โ ุชูุฌูู ููุฎุทูุงุช ุงูุชุงููุฉ
   - โ ูุง ุฃุฎุทุงุก ุชูููุฉ ุบุงูุถุฉ

### ุงูุญุงูุฉ ุงูููุงุฆูุฉ

```
๐ข ุงูุญุฐู: ูุนูู 100%
๐ข CASCADE: ูุทุจู ุนูู ุฌููุน ุงูุนูุงูุงุช
๐ข ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก: ุดุงููุฉ ููุงุถุญุฉ
๐ข ุญูุงูุฉ ุงูุจูุงูุงุช: ูุญููุฉ
๐ข Build: ูุงุฌุญ โ
```

### ุงููููุงุช ุงููุนุฏูุฉ

1. **FarmCardsManagement.tsx**
   - ุฏุงูุฉ handleConfirmDelete ูุญุณููุฉ
   - ูุญุต ุงูุญุฌูุฒุงุช ูุจู ุงูุญุฐู
   - ุฑุณุงุฆู ุฎุทุฃ ูุฎุตุตุฉ

2. **Migration: fix_farms_cascade_deletion.sql**
   - ุฅุนุงุฏุฉ ุจูุงุก foreign key constraints
   - ุชุทุจูู CASCADE ุนูู ุฌููุน ุงูุนูุงูุงุช
   - ุชุนูููุงุช ุชูุถูุญูุฉ

---

**ุชุงุฑูุฎ ุงูุฅููุงู:** 2026-02-02
**Build:** ูุงุฌุญ ุจุฏูู ุฃุฎุทุงุก โ
**ุงููุธุงุฆู:** ุญุฐู ูุญูู + CASCADE ููุนูู โ
**Migration Applied:** โ
