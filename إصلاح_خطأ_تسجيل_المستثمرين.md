# Ø¥ØµÙ„Ø§Ø­ Ø®Ø·Ø£ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ«Ù…Ø±ÙŠÙ† âœ…

## Ø§Ù„Ù…Ø´ÙƒÙ„Ø©

Ø¹Ù†Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ù…Ø³ØªØ«Ù…Ø± Ø¬Ø¯ÙŠØ¯ØŒ ÙƒØ§Ù† ÙŠØ¸Ù‡Ø± Ø§Ù„Ø®Ø·Ø£ Ø§Ù„ØªØ§Ù„ÙŠ:

```
POST /auth/v1/signup 500 (Internal Server Error)
Database error saving new user
```

---

## Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø¬Ø°Ø±ÙŠ

ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ **Ù…Ø´ÙƒÙ„ØªØ§Ù† Ø±Ø¦ÙŠØ³ÙŠØªØ§Ù†**:

### 1ï¸âƒ£ Ù…Ø´ÙƒÙ„Ø© RLS Policy
```
âŒ Policy Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©:
"Users can insert own profile"
  ON user_profiles FOR INSERT
  TO authenticated  â† Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù‡Ù†Ø§!
  WITH CHECK (auth.uid() = id)
```

**Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:**
- Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… **Ù„ÙŠØ³ Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡ Ø¨Ø¹Ø¯** (not authenticated)
- Ø§Ù„Ù€ trigger ÙŠØ­Ø§ÙˆÙ„ Ø¥Ù†Ø´Ø§Ø¡ user_profile
- Ù„ÙƒÙ† RLS ØªÙ…Ù†Ø¹Ù‡ Ù„Ø£Ù†Ù‡Ø§ ØªØ·Ù„Ø¨ `TO authenticated`

### 2ï¸âƒ£ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø¯Ø§Ù„Ø© handle_new_user
```sql
-- Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© âŒ
INSERT INTO user_profiles (id, account_type, primary_identity)
VALUES (NEW.id, 'regular', 'agricultural')
-- Ù„Ø§ ØªØ­ÙØ¸ full_name ÙˆÙ„Ø§ phone!
```

**Ø§Ù„Ù…Ø´ÙƒÙ„Ø©:**
- Ø§Ù„Ø¯Ø§Ù„Ø© ÙƒØ§Ù†Øª Ù„Ø§ ØªØ­ÙØ¸ `full_name` Ùˆ `phone` Ù…Ù† metadata
- Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† ÙŠØ³Ø¬Ù„ÙˆÙ† Ù„ÙƒÙ† Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ù… Ù„Ø§ ØªÙØ­ÙØ¸

---

## Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø·Ø¨Ù‚

### âœ… 1. Ø¥ØµÙ„Ø§Ø­ RLS Policy

```sql
-- Policy Ø¬Ø¯ÙŠØ¯Ø© ØªØ³Ù…Ø­ Ø¨Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
CREATE POLICY "Allow profile creation during signup"
  ON user_profiles FOR INSERT
  WITH CHECK (true);  â† ÙŠØ³Ù…Ø­ Ù„Ù„Ù€ trigger Ø¨Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡

-- Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«
CREATE POLICY "Users can view own profile"
  ON user_profiles FOR SELECT
  TO authenticated
  USING (auth.uid() = id);

CREATE POLICY "Users can update own profile"
  ON user_profiles FOR UPDATE
  TO authenticated
  USING (auth.uid() = id)
  WITH CHECK (auth.uid() = id);

-- Ù…Ù†Ø¹ Ø§Ù„Ø­Ø°Ù Ù„Ù„Ø£Ù…Ø§Ù†
CREATE POLICY "Prevent profile deletion"
  ON user_profiles FOR DELETE
  USING (false);
```

### âœ… 2. Ø¥ØµÙ„Ø§Ø­ Ø¯Ø§Ù„Ø© handle_new_user

```sql
CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS TRIGGER AS $$
DECLARE
  v_partner_exists boolean;
  v_full_name text;
  v_phone text;
  v_primary_identity text;
BEGIN
  -- âœ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† metadata
  v_full_name := COALESCE(
    NEW.raw_user_meta_data->>'full_name',
    'Ù…Ø³ØªØ®Ø¯Ù…'
  );
  v_phone := COALESCE(
    NEW.raw_user_meta_data->>'phone_number',
    NEW.phone
  );

  -- Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø´Ø±ÙƒØ§Ø¡
  SELECT EXISTS (
    SELECT 1 FROM influencer_partners
    WHERE user_id = NEW.id
  ) INTO v_partner_exists;

  IF v_partner_exists THEN
    -- Ø§Ù„Ø´Ø±ÙŠÙƒ â†’ Ù‡ÙˆÙŠØ© Ø²Ø±Ø§Ø¹ÙŠØ©
    v_primary_identity := 'agricultural';
  ELSE
    -- Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ â†’ Ù‡ÙˆÙŠØ© Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ©
    v_primary_identity := 'investment';
  END IF;

  -- âœ… Ø­ÙØ¸ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  INSERT INTO user_profiles (
    id,
    full_name,      -- âœ… Ø¬Ø¯ÙŠØ¯
    phone,          -- âœ… Ø¬Ø¯ÙŠØ¯
    account_type,
    primary_identity,
    created_at
  )
  VALUES (
    NEW.id,
    v_full_name,    -- âœ… Ù…Ù† metadata
    v_phone,        -- âœ… Ù…Ù† metadata
    CASE WHEN v_partner_exists THEN 'partner' ELSE 'regular' END,
    v_primary_identity,
    NOW()
  )
  ON CONFLICT (id) DO UPDATE
  SET
    full_name = COALESCE(EXCLUDED.full_name, user_profiles.full_name),
    phone = COALESCE(EXCLUDED.phone, user_profiles.phone);

  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

---

## Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª

### Ù‚Ø¨Ù„ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ âŒ
```
1. Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ³Ø¬Ù„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
2. âŒ Ø®Ø·Ø£: Database error saving new user
3. âŒ Ù„Ø§ ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨
4. âŒ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø§ ØªÙØ­ÙØ¸
```

### Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ âœ…
```
1. Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ³Ø¬Ù„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
2. âœ… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ auth.user Ø¨Ù†Ø¬Ø§Ø­
3. âœ… Ø§Ù„Ù€ trigger ÙŠÙ†Ø´Ø¦ user_profile ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
4. âœ… ÙŠØªÙ… Ø­ÙØ¸:
   - full_name âœ…
   - phone âœ…
   - primary_identity = 'investment' âœ…
   - account_type = 'regular' âœ…
5. âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­
```

---

## Ø§Ù„Ø£Ù…Ø§Ù†

### âœ… RLS Policy Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¢Ù…Ù†Ø©
```sql
-- Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:
WITH CHECK (true)  â† ÙŠØ³Ù…Ø­ Ù„Ù„Ù€ trigger ÙÙ‚Ø·ØŒ Ù„Ø£Ù† Ø§Ù„Ù€ trigger ÙŠØ¹Ù…Ù„ Ø¨Ù€ SECURITY DEFINER

-- Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©:
TO authenticated USING (auth.uid() = id)  â† ÙÙ‚Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ÙØ³Ù‡

-- Ø§Ù„ØªØ­Ø¯ÙŠØ«:
TO authenticated USING (auth.uid() = id)  â† ÙÙ‚Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†ÙØ³Ù‡

-- Ø§Ù„Ø­Ø°Ù:
USING (false)  â† Ù…Ù…Ù†ÙˆØ¹ ØªÙ…Ø§Ù…Ø§Ù‹
```

### ðŸ”’ Ø§Ù„Ø­Ù…Ø§ÙŠØ©
- âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø§ ÙŠØ³ØªØ·ÙŠØ¹ Ù‚Ø±Ø§Ø¡Ø© profiles Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†
- âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø§ ÙŠØ³ØªØ·ÙŠØ¹ ØªØ¹Ø¯ÙŠÙ„ profiles Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†
- âœ… Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù profiles
- âœ… Ø§Ù„Ù€ trigger ÙÙ‚Ø· ÙŠØ³ØªØ·ÙŠØ¹ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„

---

## ÙƒÙŠÙ ØªØ®ØªØ¨Ø± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ØŸ

### Ø§Ø®ØªØ¨Ø§Ø± 1: ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ«Ù…Ø± Ø¬Ø¯ÙŠØ¯
```
1. Ø§ÙØªØ­ ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
2. Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:
   - Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„
   - Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„
   - ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
3. Ø§Ø¶ØºØ· "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨"
4. âœ… ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­
5. âœ… ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
```

### Ø§Ø®ØªØ¨Ø§Ø± 2: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
```sql
-- Ø§ÙØªØ­ Supabase Database
SELECT
  id,
  full_name,
  phone,
  primary_identity,
  account_type
FROM user_profiles
WHERE phone = '0512345678';

-- Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©:
-- full_name: "Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯"  âœ…
-- phone: "0512345678"      âœ…
-- primary_identity: "investment"  âœ…
-- account_type: "regular"  âœ…
```

---

## Migrations Ø§Ù„Ù…Ø·Ø¨Ù‚Ø©

### 1. `fix_user_registration_rls_policy.sql`
```
âœ… Ø¥Ø³Ù‚Ø§Ø· policies Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
âœ… Ø¥Ù†Ø´Ø§Ø¡ policy Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¥Ù†Ø´Ø§Ø¡
âœ… Ø¥Ù†Ø´Ø§Ø¡ policies Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«
âœ… Ù…Ù†Ø¹ Ø§Ù„Ø­Ø°Ù
```

### 2. `fix_handle_new_user_function_complete.sql`
```
âœ… Ø­ÙØ¸ full_name Ù…Ù† metadata
âœ… Ø­ÙØ¸ phone Ù…Ù† metadata
âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… 'investment' Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†
âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… 'agricultural' Ù„Ù„Ø´Ø±ÙƒØ§Ø¡
âœ… Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø´Ø±ÙƒØ§Ø¡
```

---

## Ø§Ù„Ø®Ù„Ø§ØµØ©

### âœ… ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­
- âŒ Database error saving new user
- âœ… ÙŠØ¹Ù…Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯
- âœ… ÙŠØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
- âœ… RLS Ø¢Ù…Ù†Ø© ÙˆÙ…Ø­Ù…ÙŠØ©
- âœ… Ø§Ù„Ù€ trigger ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­

### ðŸ“‹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©
- Database migrations (2 files)
- Ù„Ø§ ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Frontend

### ðŸŽ¯ Ø§Ù„Ù†ØªÙŠØ¬Ø©
**Ø§Ù„Ø¢Ù† ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ù†Ø¬Ø§Ø­!** ðŸŽ‰

---

## Ù„Ù„Ù…Ø·ÙˆØ±ÙŠÙ†

### Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ‚Ù†ÙŠØ©

#### RLS Policy Pattern
```sql
-- Pattern Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
CREATE POLICY "policy_name"
  ON table_name FOR INSERT
  WITH CHECK (true);  -- Ù„Ù„Ù€ SECURITY DEFINER triggers
```

#### Trigger Pattern
```sql
-- Pattern Ù„Ø­ÙØ¸ metadata ÙÙŠ trigger
CREATE FUNCTION handle_new_user() RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO user_profiles (
    id,
    full_name,
    phone
  )
  VALUES (
    NEW.id,
    NEW.raw_user_meta_data->>'full_name',
    NEW.raw_user_meta_data->>'phone_number'
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

---

## Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ

```bash
âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ migrations
âœ… ØªÙ… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­ (npm run build)
âœ… RLS policies Ù…Ø­Ø¯Ù‘Ø«Ø©
âœ… handle_new_user trigger Ù…Ø­Ø¯Ù‘Ø«
âœ… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
```

**Ø¬Ø±Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø¢Ù† ÙˆØ³ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­!** ðŸš€
