# ูุธุงู ุฏูุน ุฑุณูู ุงูุตูุงูุฉ - ุงูุชูุงู ุงููุณุงุฑ ุงููุงูู

## ุงูุชุงุฑูุฎ: 2026-02-04
## ุงูุญุงูุฉ: โ ููุชูู ูููุฎุชุจุฑ

---

## ๐ฏ ูุธุฑุฉ ุนุงูุฉ

ุชู ุจูุงุก ูุธุงู ุฏูุน ุฑุณูู ุงูุตูุงูุฉ ุงููุงูู ุจูุฌุงุญุ ูุบุทู ุงููุณุงุฑ ูู ุฒุฑ "ุณุฏุงุฏ ุงูุฑุณูู" ูู ูุงุฌูุฉ ุงูุนููู ุญุชู ุงูุชุญุฏูุซ ุงูุชููุงุฆู ูู ููุญุฉ ุงูุฅุฏุงุฑุฉ.

---

## ๐ ุงููุณุงุฑ ุงููุงูู

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ            1๏ธโฃ ูุงุฌูุฉ ุงูุนููู (Frontend)               โ
โ                                                       โ
โ  ุฃุดุฌุงุฑู ุงูุฎุถุฑุงุก โ ุชูุงุตูู ุงูุตูุงูุฉ โ ุณุฏุงุฏ ุงูุฑุณูู     โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         2๏ธโฃ ูุนุงูุฌุฉ ุงูุฏูุน (Backend Service)          โ
โ                                                       โ
โ  - ุญุณุงุจ ุงููุจูุบ (ุนุฏุฏ ุงูุฃุดุฌุงุฑ ร ุชูููุฉ ุงูุดุฌุฑุฉ)        โ
โ  - ุฅูุดุงุก ุณุฌู ุฏูุน                                    โ
โ  - ููู ุงููุจูุบ (ูุง ูุชุบูุฑ)                           โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ         3๏ธโฃ ุฅุชูุงู ุงูุฏูุน (Simulation / Gateway)      โ
โ                                                       โ
โ  - ูุญุงูุงุฉ ุฏูุน ูุงุฌุญ (ููุชุฌุฑูุจ ุญุงููุงู)                โ
โ  - ุชุญุฏูุซ ุญุงูุฉ ุงูุฏูุน ุฅูู "paid"                     โ
โ  - ุชุณุฌูู ุฑูู ุงูุนูููุฉ ูุชุงุฑูุฎ ุงูุณุฏุงุฏ                 โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ        4๏ธโฃ ุงูุชุญุฏูุซ ุงูุชููุงุฆู (Auto-Update)          โ
โ                                                       โ
โ  โโโโโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  โ  ูุงุฌูุฉ ุงูุนููู      โ   โ  ููุญุฉ ุงูุฅุฏุงุฑุฉ        โโ
โ  โ  โโโโโโโโโโโโโ      โ   โ  โโโโโโโโโโโโโ        โโ
โ  โ  โ ุฅุฎูุงุก ุฒุฑ        โ   โ  โ ุฒูุงุฏุฉ ุงููุณุฏุฏูู   โโ
โ  โ     ุงูุณุฏุงุฏ          โ   โ  โ ุฒูุงุฏุฉ ุงููุญุตู     โโ
โ  โ  โ ุนุฑุถ "ุชู ุงูุณุฏุงุฏ" โ   โ  โ ุชูููู ุงููุชุจูู    โโ
โ  โโโโโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโโโโโโโ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐๏ธ ุงูุจููุฉ ุงูุชุญุชูุฉ (Database)

### ุงูุฌุฏุงูู

#### 1. `maintenance_payments` (ููุฌูุฏ ูููุญุฏูุซ)
```sql
- id                    : uuid
- user_id               : uuid โ auth.users
- maintenance_fee_id    : uuid โ maintenance_fees
- farm_id               : uuid โ farms
- tree_count            : integer
- amount_due            : decimal(10,2)  -- ุงููุจูุบ ุงูููููู
- amount_paid           : decimal(10,2)  -- ุงููุจูุบ ุงููุณุฏุฏ
- payment_status        : text (pending, paid, failed)
- payment_date          : timestamptz
- payment_gateway       : text
- payment_gateway_ref   : text
- transaction_id        : text (unique)
- payment_method        : text
- gateway_response      : jsonb
- created_at            : timestamptz
- updated_at            : timestamptz
```

### ุงูุฏูุงู (Functions)

#### 1. `create_maintenance_payment_record()`
**ุงููุธููุฉ:** ุฅูุดุงุก ุณุฌู ุฏูุน ุฌุฏูุฏ

**ุงูููุทู:**
1. ุชุญุฏูุฏ ูููุฉ ุงููุณุชุฎุฏู (agricultural / investment)
2. ุญุณุงุจ ุนุฏุฏ ุงูุฃุดุฌุงุฑ ูู ุงูุฌุฏูู ุงูููุงุณุจ
3. ุฌูุจ ุชูููุฉ ุงูุดุฌุฑุฉ ูู ุณุฌู ุงูุตูุงูุฉ
4. ุญุณุงุจ ุงููุจูุบ ุงูุฅุฌูุงูู = ุนุฏุฏ ุงูุฃุดุฌุงุฑ ร ุชูููุฉ ุงูุดุฌุฑุฉ
5. ุฅูุดุงุก ุณุฌู ุงูุฏูุน ุจุญุงูุฉ "pending"

**ุงููุฎุฑุฌุงุช:**
```json
{
  "payment_id": "uuid",
  "trees_count": 100,
  "cost_per_tree": 50.00,
  "total_amount": 5000.00
}
```

**ุงูุญูุงูุฉ:**
- โ ููุน ุงูุณุฏุงุฏ ุงูููุฑุฑ
- โ ุงูุชุญูู ูู ูุฌูุฏ ุฃุดุฌุงุฑ
- โ ุงูุชุญูู ูู ูุฌูุฏ ุณุฌู ุงูุตูุงูุฉ

#### 2. `check_maintenance_payment_status()`
**ุงููุธููุฉ:** ุงูุชุญูู ูู ุญุงูุฉ ุงูุฏูุน

**ุงููุฎุฑุฌุงุช:**
```json
{
  "has_payment": true,
  "payment_id": "uuid",
  "status": "paid",
  "amount_due": 5000.00,
  "amount_paid": 5000.00,
  "payment_date": "2026-02-04T12:00:00Z",
  "transaction_id": "TXN-123456"
}
```

#### 3. `complete_maintenance_payment()`
**ุงููุธููุฉ:** ุฅุชูุงู ุงูุฏูุน ูุชุญุฏูุซ ุงูุญุงูุฉ

**ุงููุฏุฎูุงุช:**
- `payment_id`: ูุนุฑูู ุณุฌู ุงูุฏูุน
- `transaction_id`: ุฑูู ุงูุนูููุฉ ูู ุงูุจูุงุจุฉ
- `amount_paid`: ุงููุจูุบ ุงููุณุฏุฏ (ุงุฎุชูุงุฑู)
- `payment_method`: ุทุฑููุฉ ุงูุฏูุน (ุงุฎุชูุงุฑู)
- `gateway_response`: ุงุณุชุฌุงุจุฉ ุงูุจูุงุจุฉ (ุงุฎุชูุงุฑู)

**ุงูููุทู:**
1. ุงูุชุญูู ูู ูุฌูุฏ ุณุฌู ุงูุฏูุน
2. ุงูุชุญูู ูู ุนุฏู ุงูุณุฏุงุฏ ุงููุณุจู
3. ุชุญุฏูุซ ุงูุญุงูุฉ ุฅูู "paid"
4. ุชุณุฌูู ุชุงุฑูุฎ ุงูุณุฏุงุฏ ูุฑูู ุงูุนูููุฉ

**ุงูุญูุงูุฉ:**
- โ ููุน ุงูุณุฏุงุฏ ุงูููุฑุฑ
- โ ุงูุชุญูู ูู ุงูุญุงูุฉ ูุจู ุงูุชุญุฏูุซ

#### 4. `get_maintenance_payment_stats()`
**ุงููุธููุฉ:** ุงูุญุตูู ุนูู ุฅุญุตุงุฆูุงุช ุงูุณุฏุงุฏ (ููุฅุฏุงุฑุฉ)

**ุงููุฎุฑุฌุงุช:**
```json
{
  "total_clients": 50,
  "paid_count": 30,
  "pending_count": 5,
  "unpaid_count": 20,
  "total_amount": 250000.00,
  "paid_amount": 150000.00,
  "remaining_amount": 100000.00,
  "payment_percentage": 60.00,
  "collection_percentage": 60.00
}
```

**ุงูุญุณุงุจุงุช:**
- `total_clients`: ุฌููุน ุงููุณุชุฎุฏููู ุงูุฐูู ูุฏููู ุฃุดุฌุงุฑ
- `paid_count`: ุนุฏุฏ ุงููุณุชุฎุฏููู ุงูุฐูู ุณุฏุฏูุง
- `pending_count`: ุนุฏุฏ ุงููุณุชุฎุฏููู ูู ุญุงูุฉ ุงูุชุธุงุฑ
- `unpaid_count`: total_clients - paid_count
- `total_amount`: (ุฅุฌูุงูู ุงูุฃุดุฌุงุฑ ร ุชูููุฉ ุงูุดุฌุฑุฉ)
- `paid_amount`: ูุฌููุน ุงููุจุงูุบ ุงููุณุฏุฏุฉ
- `remaining_amount`: total_amount - paid_amount

---

## ๐ป Backend Services

### ุงูููู: `src/services/maintenancePaymentService.ts`

#### ุงูุฎุฏูุงุช ุงููุชุงุญุฉ:

1. **`createPaymentRecord()`**
   - ุฅูุดุงุก ุณุฌู ุฏูุน ุฌุฏูุฏ
   - ุงุณุชุฏุนุงุก ุฏุงูุฉ `create_maintenance_payment_record()`

2. **`checkPaymentStatus()`**
   - ุงูุชุญูู ูู ุญุงูุฉ ุงูุฏูุน
   - ุงุณุชุฏุนุงุก ุฏุงูุฉ `check_maintenance_payment_status()`

3. **`completePayment()`**
   - ุฅุชูุงู ุงูุฏูุน
   - ุงุณุชุฏุนุงุก ุฏุงูุฉ `complete_maintenance_payment()`

4. **`getPaymentStats()`**
   - ุงูุญุตูู ุนูู ุฅุญุตุงุฆูุงุช ุงูุณุฏุงุฏ
   - ุงุณุชุฏุนุงุก ุฏุงูุฉ `get_maintenance_payment_stats()`

5. **`initiatePayment()`**
   - ุจุฏุก ุนูููุฉ ุงูุฏูุน
   - ุฅูุดุงุก ุณุฌู ุงูุฏูุน
   - ุฅูุดุงุก ุฑุงุจุท ุงูุฏูุน (simulation ุญุงููุงู)

6. **`simulatePaymentSuccess()`**
   - ูุญุงูุงุฉ ุฏูุน ูุงุฌุญ (ููุชุฌุฑูุจ)
   - ุฅูุดุงุก ุฑูู ุนูููุฉ ูููู
   - ุฅุชูุงู ุงูุฏูุน ุชููุงุฆูุงู

7. **`getUserPayments()`**
   - ุงูุญุตูู ุนูู ุณุฌูุงุช ุฏูุน ุงููุณุชุฎุฏู

8. **`getPaymentById()`**
   - ุงูุญุตูู ุนูู ุจูุงูุงุช ุฏูุนุฉ ูุญุฏุฏุฉ

---

## ๐จ ูุงุฌูุฉ ุงูุนููู

### ุงูููู: `src/components/MyGreenTrees.tsx`

#### ุงูุชุญุฏูุซุงุช:

1. **ุงุณุชูุฑุงุฏ ุงูุฎุฏูุฉ:**
```typescript
import { maintenancePaymentService } from '../services/maintenancePaymentService';
```

2. **ุฏุงูุฉ ุงูุณุฏุงุฏ ุงูููุญุฏูุซุฉ:**
```typescript
const handlePayFee = async (record: ClientMaintenanceRecord) => {
  // ุงูุชุญูู ูู ูุฌูุฏ ุฑุณูู
  if (!record.total_amount || !record.cost_per_tree || !record.maintenance_fee_id) {
    alert('ูุฐู ุงูุตูุงูุฉ ูุง ุชุญุชูู ุนูู ุฑุณูู');
    return;
  }

  // ุงูุชุญูู ูู ุงูุณุฏุงุฏ ุงููุณุจู
  if (record.payment_status === 'paid') {
    alert('ุชู ุณุฏุงุฏ ุฑุณูู ูุฐู ุงูุตูุงูุฉ ูุณุจูุงู');
    return;
  }

  try {
    setProcessingPayment(true);

    // ุทูุจ ุงูุชุฃููุฏ ูู ุงููุณุชุฎุฏู
    const confirmPayment = confirm(
      `ุณุฏุงุฏ ุฑุณูู ุงูุตูุงูุฉ\n\nุงููุจูุบ ุงููุณุชุญู: ${record.client_due_amount} ุฑ.ุณ\nุนุฏุฏ ุงูุฃุดุฌุงุฑ: ${record.client_tree_count}\n\nุณูุชู ุชุญูููู ุฅูู ุตูุญุฉ ุงูุฏูุน ูุฅุชูุงู ุงูุนูููุฉ.\n\nูู ุชุฑูุฏ ุงููุชุงุจุนุฉุ`
    );

    if (confirmPayment) {
      // ุจุฏุก ุนูููุฉ ุงูุฏูุน
      const paymentInfo = await maintenancePaymentService.initiatePayment(
        record.maintenance_fee_id,
        record.user_id
      );

      // ูุญุงูุงุฉ ุฏูุน ูุงุฌุญ (ููุชุฌุฑูุจ)
      await maintenancePaymentService.simulatePaymentSuccess(
        paymentInfo.paymentId,
        paymentInfo.amount
      );

      alert('ุชู ุชุณุฌูู ุงูุณุฏุงุฏ ุจูุฌุงุญ');

      // ุฅุนุงุฏุฉ ุชุญููู ุงูุณุฌูุงุช (ุงูุชุญุฏูุซ ุงูุชููุงุฆู)
      loadMaintenanceRecords();
    }
  } catch (error) {
    console.error('Error processing payment:', error);
    alert('ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงูุณุฏุงุฏ');
  } finally {
    setProcessingPayment(false);
  }
};
```

#### ุฒุฑ ุงูุณุฏุงุฏ ูู ูุงุฌูุฉ ุงูุชูุงุตูู:
```tsx
{maintenanceDetails.payment_status === 'pending' && currentRecord && (
  <button
    onClick={() => currentRecord && handlePayFee(currentRecord)}
    disabled={processingPayment}
    className="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-4 rounded-xl hover:from-blue-700 hover:to-indigo-700 transition-all font-bold text-lg disabled:opacity-50 disabled:cursor-not-allowed"
  >
    <DollarSign className="w-6 h-6" />
    {processingPayment ? 'ุฌุงุฑู ุงููุนุงูุฌุฉ...' : 'ุณุฏุงุฏ ุงูุฑุณูู ุงูุขู'}
  </button>
)}
```

**ุงูุญุงูุงุช ุงููุนุฑูุถุฉ:**
- โ **pending**: ุนุฑุถ ุฒุฑ "ุณุฏุงุฏ ุงูุฑุณูู ุงูุขู"
- โ **paid**: ุนุฑุถ badge "ุชู ุงูุณุฏุงุฏ"
- โ **processing**: ุนุฑุถ "ุฌุงุฑู ุงููุนุงูุฌุฉ..." ูุชุนุทูู ุงูุฒุฑ

---

## ๐ง ููุญุฉ ุงูุฅุฏุงุฑุฉ

### ุงูููู: `src/components/admin/MaintenancePaymentsTab.tsx`

**ุงููููุน:** ูุณู ุงูุชุดุบูู โ ุชุจููุจ "ูุชุงุจุนุฉ ุงูุณุฏุงุฏ"

#### ุงููููุฒุงุช:

1. **ุงูุฅุญุตุงุฆูุงุช ุงูุญูุฉ:**
   - ุฅุฌูุงูู ุงูุนููุงุก
   - ุนุฏุฏ ุงููุณุฏุฏูู + ุงููุจูุบ ุงููุญุตู
   - ุนุฏุฏ ุงููุชุฃุฎุฑูู + ุงููุจูุบ ุงููุชุจูู
   - ูุณุจุฉ ุงูุชุญุตูู

2. **ูุงุฆูุฉ ุงูุฏูุนุงุช:**
   - ูุนูููุงุช ุงูุนููู
   - ูุนูููุงุช ุงููุฒุฑุนุฉ ูุงูุตูุงูุฉ
   - ุงููุจูุบ ุงููุณุชุญู / ุงููุณุฏุฏ
   - ุญุงูุฉ ุงูุณุฏุงุฏ
   - ุชุงุฑูุฎ ุงูุณุฏุงุฏ (ุฅู ููุฌุฏ)

3. **ุงูุจุญุซ ูุงูููุชุฑุฉ:**
   - ุจุญุซ ุจุงูุงุณู ุฃู ุงููุฒุฑุนุฉ
   - ููุชุฑุฉ ุญุณุจ ุงูุญุงูุฉ (ุงููู / ูุณุฏุฏ / ูุนูู)

4. **ุงูุชุญุฏูุซ ุงูุชููุงุฆู:**
   - ุนูุฏ ูุฌุงุญ ุงูุฏูุน ูู ุงูุนููู
   - ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช ุชููุงุฆูุงู
   - ุชุญุฏูุซ ุญุงูุฉ ุงูุณุฌู ูู ุงููุงุฆูุฉ

---

## ๐ ุงูุฃูุงู ูุงูุญูุงูุฉ

### Row Level Security (RLS)

#### ุฌุฏูู `maintenance_payments`:
```sql
-- ุงููุณุชุฎุฏููู ูุฑูู ุณุฌูุงุชูู ููุท
CREATE POLICY "Users can view own payments"
  ON maintenance_payments
  FOR SELECT
  TO authenticated
  USING (user_id = auth.uid());

-- ุงูุฅุฏุงุฑุฉ ุชุฑู ุฌููุน ุงูุณุฌูุงุช
CREATE POLICY "Admins can view all payments"
  ON maintenance_payments
  FOR SELECT
  TO authenticated
  USING (
    EXISTS (
      SELECT 1 FROM admins
      WHERE user_id = auth.uid()
    )
  );
```

### ุงููููุฏ ูุงูุญูุงูุฉ:

1. **ููุน ุงูุณุฏุงุฏ ุงูููุฑุฑ:**
   - โ ุงูุชุญูู ูู ุงูุฏุงูุฉ ูุจู ุงูุฅูุดุงุก
   - โ ุงูุชุญูู ูู ุงููุงุฌูุฉ ูุจู ุงูุนุฑุถ
   - โ ุงูุชุญูู ูุจู ุฅุชูุงู ุงูุฏูุน

2. **ููู ุงููุจูุบ:**
   - โ ููุญุณุจ ูุฑุฉ ูุงุญุฏุฉ ุนูุฏ ุงูุฅูุดุงุก
   - โ ูุง ูุชุบูุฑ ุจุนุฏ ุงูุฅูุดุงุก
   - โ ูุฎุฒู ูู `amount_due`

3. **ุงูุชุญูู ูู ุงูุจูุงูุงุช:**
   - โ ุงูุชุญูู ูู ูุฌูุฏ ุฃุดุฌุงุฑ
   - โ ุงูุชุญูู ูู ูุฌูุฏ ุณุฌู ุงูุตูุงูุฉ
   - โ ุงูุชุญูู ูู ุตูุงุญูุฉ ุงููุณุชุฎุฏู

4. **ุนุฏู ุงูุณูุงุญ ุจุงูุชุนุฏูู ุงููุจุงุดุฑ:**
   - โ ุฌููุน ุงูุนูููุงุช ุนุจุฑ ุงูุฏูุงู ููุท
   - โ ูุง ุชูุฌุฏ policies ููู INSERT/UPDATE ุงููุจุงุดุฑ
   - โ ุงุณุชุฎุฏุงู SECURITY DEFINER

---

## ๐ ุงููุณุงุฑ ุงูุชูุตููู ููุฏูุน

### 1๏ธโฃ ุงููุณุชุฎุฏู ูุถุบุท ุนูู "ุณุฏุงุฏ ุงูุฑุณูู"

**ูู:** `MyGreenTrees.tsx`
```typescript
onClick={() => handlePayFee(record)}
```

**ุงูุชุญููุงุช:**
- โ ูุฌูุฏ ุฑุณูู
- โ ุนุฏู ุงูุณุฏุงุฏ ุงููุณุจู
- โ ุชุฃููุฏ ุงููุณุชุฎุฏู

### 2๏ธโฃ ุฅูุดุงุก ุณุฌู ุงูุฏูุน

**ุงุณุชุฏุนุงุก:**
```typescript
maintenancePaymentService.initiatePayment(
  maintenance_fee_id,
  user_id
)
```

**ูู ุงูู Backend:**
```sql
create_maintenance_payment_record(
  p_maintenance_fee_id,
  p_user_id
)
```

**ุงูุนูููุงุช:**
1. ุฌูุจ ูููุฉ ุงููุณุชุฎุฏู
2. ุญุณุงุจ ุนุฏุฏ ุงูุฃุดุฌุงุฑ ูู ุงูุฌุฏูู ุงูููุงุณุจ
3. ุฌูุจ ุชูููุฉ ุงูุดุฌุฑุฉ
4. ุญุณุงุจ ุงููุจูุบ = ุนุฏุฏ ุงูุฃุดุฌุงุฑ ร ุชูููุฉ ุงูุดุฌุฑุฉ
5. ุฅูุดุงุก ุณุฌู ูู `maintenance_payments`

**ุงููุฎุฑุฌุงุช:**
```json
{
  "paymentId": "uuid",
  "paymentUrl": "simulation-url",
  "amount": 5000.00
}
```

### 3๏ธโฃ ูุญุงูุงุฉ ุงูุฏูุน ุงููุงุฌุญ (ุญุงููุงู)

**ุงุณุชุฏุนุงุก:**
```typescript
maintenancePaymentService.simulatePaymentSuccess(
  paymentId,
  amount
)
```

**ุงูุนูููุงุช:**
1. ุฅูุดุงุก ุฑูู ุนูููุฉ ูููู
2. ุงุณุชุฏุนุงุก `completePayment()`
3. ุชุญุฏูุซ ุญุงูุฉ ุงูุณุฌู ุฅูู "paid"
4. ุชุณุฌูู ุชุงุฑูุฎ ุงูุณุฏุงุฏ

### 4๏ธโฃ ุงูุชุญุฏูุซ ุงูุชููุงุฆู

**ูู ุงููุงุฌูุฉ:**
```typescript
loadMaintenanceRecords(); // ุฅุนุงุฏุฉ ุฌูุจ ุงูุจูุงูุงุช
```

**ุงููุชุงุฆุฌ:**
- โ ุฅุฎูุงุก ุฒุฑ "ุณุฏุงุฏ ุงูุฑุณูู"
- โ ุนุฑุถ badge "ุชู ุงูุณุฏุงุฏ"
- โ ุชุญุฏูุซ ุญุงูุฉ ุงูุณุฌู

**ูู ููุญุฉ ุงูุฅุฏุงุฑุฉ:**
- โ ุฒูุงุฏุฉ ุนุฏุฏ ุงููุณุฏุฏูู
- โ ุฒูุงุฏุฉ ุงููุจูุบ ุงููุญุตู
- โ ุชูููู ุนุฏุฏ ุงููุชุฃุฎุฑูู
- โ ุชูููู ุงููุจูุบ ุงููุชุจูู
- โ ุชุญุฏูุซ ูุณุจุฉ ุงูุชุญุตูู

---

## ๐งช ุงุฎุชุจุงุฑ ุงููุธุงู

### ุงูุณููุงุฑูู ุงููุงูู:

#### 1. ูุนููู (ูุณุชุฎุฏู):

```
1. ุชุณุฌูู ุงูุฏุฎูู
   โ ุญุณุงุจ ุนููู (ูุฒุงุฑุน ุฃู ูุณุชุซูุฑ)

2. ุงูุฐูุงุจ ุฅูู "ุฃุดุฌุงุฑู ุงูุฎุถุฑุงุก"
   โ ุนุฑุถ ูุงุฆูุฉ ุณุฌูุงุช ุงูุตูุงูุฉ

3. ุงุฎุชูุงุฑ ุณุฌู ุตูุงูุฉ
   โ ุงูุถุบุท ุนูู "ุนุฑุถ ุงูุชูุงุตูู"

4. ูู ุตูุญุฉ ุงูุชูุงุตูู
   โ ุนุฑุถ ุงููุนูููุงุช:
      - ุชูููุฉ ุงูุดุฌุฑุฉ
      - ุนุฏุฏ ุฃุดุฌุงุฑู
      - ุงููุจูุบ ุงููุณุชุญู
   โ ุนุฑุถ ุฒุฑ "ุณุฏุงุฏ ุงูุฑุณูู ุงูุขู"

5. ุงูุถุบุท ุนูู ุฒุฑ ุงูุณุฏุงุฏ
   โ ุนุฑุถ ุฑุณุงูุฉ ุชุฃููุฏ
   โ ุงูุถุบุท ุนูู "OK"

6. ูุนุงูุฌุฉ ุงูุฏูุน
   โ ุนุฑุถ "ุฌุงุฑู ุงููุนุงูุฌุฉ..."
   โ ูุญุงูุงุฉ ุฏูุน ูุงุฌุญ

7. ุงููุชูุฌุฉ
   โ ุนุฑุถ "ุชู ุชุณุฌูู ุงูุณุฏุงุฏ ุจูุฌุงุญ"
   โ ุฅุฎูุงุก ุฒุฑ ุงูุณุฏุงุฏ
   โ ุนุฑุถ badge "ุชู ุงูุณุฏุงุฏ"
```

#### 2. ููุฏูุฑ (Admin):

```
1. ุชุณุฌูู ุงูุฏุฎูู ููุฏูุฑ
   โ ุญุณุงุจ admin

2. ุงูุฐูุงุจ ุฅูู ูุณู ุงูุชุดุบูู
   โ Operations Section

3. ุงุฎุชูุงุฑ ุชุจููุจ "ูุชุงุจุนุฉ ุงูุณุฏุงุฏ"
   โ Maintenance Payments Tab

4. ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช
   โ ุฅุฌูุงูู ุงูุนููุงุก
   โ ุนุฏุฏ ุงููุณุฏุฏูู + ุงููุจูุบ
   โ ุนุฏุฏ ุงููุชุฃุฎุฑูู + ุงููุจูุบ
   โ ูุณุจุฉ ุงูุชุญุตูู

5. ุนุฑุถ ูุงุฆูุฉ ุงูุฏูุนุงุช
   โ ุฌููุน ุงูุณุฌูุงุช ุงููุงููุฉ
   โ ุญุงูุฉ ูู ุฏูุนุฉ
   โ ูุนูููุงุช ุงูุนููู ูุงููุฒุฑุนุฉ

6. ุงูุชุญุฏูุซ ุงูุชููุงุฆู
   โ ุนูุฏ ูุฌุงุญ ุฏูุน ูู ุนููู
   โ ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช ููุฑุงู
   โ ุชุญุฏูุซ ุญุงูุฉ ุงูุณุฌู ูู ุงููุงุฆูุฉ
```

---

## ๐ ุงูุฅุญุตุงุฆูุงุช ูุงูุชูุงุฑูุฑ

### ูู ููุญุฉ ุงูุฅุฏุงุฑุฉ:

#### ุงูุจุทุงูุงุช ุงูุฅุญุตุงุฆูุฉ:
```
โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ุนููุงุก ูุฏููู ุงูุชุฒุงูุงุช  โ
โ      50 ุนููู           โ
โ  ูู ุณุฌูุงุช ููุดูุฑุฉ       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ     ุงููุณุฏุฏูู           โ
โ      30 ุนููู           โ
โ   150,000 ุฑ.ุณ          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ     ุงููุชุฃุฎุฑูู          โ
โ      20 ุนููู           โ
โ   100,000 ุฑ.ุณ          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโ
```

#### ุงูููุฎุต ุงููุงูู:
```
ุฅุฌูุงูู ุงููุณุชุญูุงุช: 250,000 ุฑ.ุณ
ุฅุฌูุงูู ุงููุญุตู:    150,000 ุฑ.ุณ
ุงููุชุจูู:           100,000 ุฑ.ุณ
ูุณุจุฉ ุงูุชุญุตูู:     60%
```

---

## ๐ ุงูุฎุทูุงุช ุงููุณุชูุจููุฉ (ุงุฎุชูุงุฑู)

### 1. ุฑุจุท ุจูุงุจุฉ ุฏูุน ุญููููุฉ

**ุญุงููุงู:** ูุญุงูุงุฉ (simulation)
**ูุณุชูุจูุงู:**
- ุฑุจุท ูุน Stripe
- ุฑุจุท ูุน PayTabs
- ุฑุจุท ูุน Moyasar
- ุฑุจุท ูุน Tap Payments

**ุงูุชุนุฏููุงุช ุงููุทููุจุฉ:**
```typescript
// ูู initiatePayment()
// ุจุฏูุงู ูู simulationุ ุงุณุชุฏุนุงุก API ุจูุงุจุฉ ุงูุฏูุน
const paymentUrl = await paymentGateway.createSession({
  amount: paymentRecord.total_amount,
  currency: 'SAR',
  customer: userId,
  metadata: {
    payment_id: paymentRecord.payment_id,
    maintenance_fee_id: maintenanceFeeId
  }
});
```

### 2. ุฅูุดุงุก Webhook ูุงุณุชูุจุงู ูุชุงุฆุฌ ุงูุฏูุน

**ุงูููู:** `supabase/functions/payment-webhook/index.ts`

```typescript
Deno.serve(async (req) => {
  // ุงูุชุญูู ูู signature ุงูุจูุงุจุฉ
  // ุงุณุชุฎุฑุงุฌ ุจูุงูุงุช ุงูุฏูุน
  // ุงุณุชุฏุนุงุก complete_maintenance_payment()
  // ุฅุฑุฌุงุน 200 OK
});
```

### 3. ุตูุญุฉ ูุชูุฌุฉ ุงูุฏูุน

**ุงูููู:** `src/components/PaymentResult.tsx`

```tsx
// ุนุฑุถ ูุชูุฌุฉ ุงูุฏูุน (ูุฌุงุญ / ูุดู)
// ุฒุฑ ุงูุนูุฏุฉ ุฅูู "ุฃุดุฌุงุฑู ุงูุฎุถุฑุงุก"
// ุนุฑุถ ุชูุงุตูู ุงูุนูููุฉ
```

### 4. ุฅุดุนุงุฑุงุช ุงูุฏูุน

**ููุนููู:**
- ุฅุดุนุงุฑ ูู ุงูุชุทุจูู
- ุฑุณุงูุฉ SMS (ุงุฎุชูุงุฑู)
- ุจุฑูุฏ ุฅููุชุฑููู (ุงุฎุชูุงุฑู)

**ููุฅุฏุงุฑุฉ:**
- ุฅุดุนุงุฑ ุจุงูุฏูุนุงุช ุงูุฌุฏูุฏุฉ
- ุชูุงุฑูุฑ ููููุฉ

### 5. ุชูุงุฑูุฑ ูุชูุฏูุฉ

**ูู ููุญุฉ ุงูุฅุฏุงุฑุฉ:**
- ุชูุฑูุฑ ุงูุฏูุนุงุช ุงููููู
- ุชูุฑูุฑ ุงูุฏูุนุงุช ุงูุดูุฑู
- ุชูุฑูุฑ ุงููุชุฃุฎุฑุงุช
- ุชุญููู ุฃุฏุงุก ุงูุชุญุตูู

---

## โ ูุง ุชู ุฅูุฌุงุฒู

### ุงูุจููุฉ ุงูุชุญุชูุฉ (Database):
- โ ุชุญุฏูุซ ุฌุฏูู `maintenance_payments`
- โ ุฅูุดุงุก ุฏุงูุฉ `create_maintenance_payment_record()`
- โ ุฅูุดุงุก ุฏุงูุฉ `check_maintenance_payment_status()`
- โ ุฅูุดุงุก ุฏุงูุฉ `complete_maintenance_payment()`
- โ ุฅูุดุงุก ุฏุงูุฉ `get_maintenance_payment_stats()`
- โ ุฅุนุฏุงุฏ RLS policies ูุงููุฉ
- โ ุฅุถุงูุฉ ุงูููุงุฑุณ ุงููุทููุจุฉ

### Backend Services:
- โ ุฅูุดุงุก `maintenancePaymentService.ts`
- โ ุฏุงูุฉ `createPaymentRecord()`
- โ ุฏุงูุฉ `checkPaymentStatus()`
- โ ุฏุงูุฉ `completePayment()`
- โ ุฏุงูุฉ `getPaymentStats()`
- โ ุฏุงูุฉ `initiatePayment()`
- โ ุฏุงูุฉ `simulatePaymentSuccess()` (ููุชุฌุฑูุจ)
- โ ุฏุงูุฉ `getUserPayments()`
- โ ุฏุงูุฉ `getPaymentById()`

### ูุงุฌูุฉ ุงูุนููู:
- โ ุชุญุฏูุซ `MyGreenTrees.tsx`
- โ ุงุณุชูุฑุงุฏ `maintenancePaymentService`
- โ ุชุญุฏูุซ ุฏุงูุฉ `handlePayFee()`
- โ ุฒุฑ "ุณุฏุงุฏ ุงูุฑุณูู ุงูุขู" ูุนูู
- โ ุนุฑุถ ุญุงูุฉ "ุฌุงุฑู ุงููุนุงูุฌุฉ..."
- โ ุงูุชุญุฏูุซ ุงูุชููุงุฆู ุจุนุฏ ุงูุณุฏุงุฏ
- โ ุฅุฎูุงุก ุงูุฒุฑ ุจุนุฏ ุงูุณุฏุงุฏ
- โ ุนุฑุถ badge "ุชู ุงูุณุฏุงุฏ"

### ููุญุฉ ุงูุฅุฏุงุฑุฉ:
- โ ุชุจููุจ `MaintenancePaymentsTab` ููุฌูุฏ
- โ ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช ุงูุญูุฉ
- โ ูุงุฆูุฉ ุงูุฏูุนุงุช ุงููุงููุฉ
- โ ุงูุจุญุซ ูุงูููุชุฑุฉ
- โ ุงูุชุญุฏูุซ ุงูุชููุงุฆู

### ุงูุฃูุงู:
- โ RLS policies ูุญููุฉ
- โ ููุน ุงูุณุฏุงุฏ ุงูููุฑุฑ
- โ ููู ุงููุจูุบ
- โ ุงูุชุญูู ูู ุงูุจูุงูุงุช
- โ ุนุฏู ุงูุณูุงุญ ุจุงูุชุนุฏูู ุงููุจุงุดุฑ

### ุงูุงุฎุชุจุงุฑ:
- โ Build ูุงุฌุญ
- โ ูุง ุฃุฎุทุงุก ูู ุงูููุฏ
- โ ุงููุณุงุฑ ุงููุงูู ูุงุถุญ
- โ ุงูุชูุซูู ุดุงูู

---

## ๐ ููุงุญุธุงุช ูููุฉ

### 1. ุงููุญุงูุงุฉ ุงูุญุงููุฉ:
- ุงููุธุงู ูุณุชุฎุฏู `simulatePaymentSuccess()` ููุชุฌุฑูุจ
- ุงูุฏูุน ููุฌุญ ุชููุงุฆูุงู ุจุฏูู ุตูุญุฉ ุฏูุน ุฎุงุฑุฌูุฉ
- ููุงุณุจ ููุชุทููุฑ ูุงูุงุฎุชุจุงุฑ

### 2. ุงูุฑุจุท ุงููุณุชูุจูู:
- ุณูู ุงูุฑุจุท ูุน ุฃู ุจูุงุจุฉ ุฏูุน
- ุงูุจููุฉ ุงูุชุญุชูุฉ ุฌุงูุฒุฉ
- ูุญุชุงุฌ ููุท ุชุญุฏูุซ `initiatePayment()` ู webhook

### 3. ุงูุฃูุงู:
- ุฌููุน ุงูุนูููุงุช ูุญููุฉ
- RLS policies ูููุฉ
- ูุง ุชุนุฏูู ูุจุงุดุฑ ุนูู ุงูุจูุงูุงุช

### 4. ุงูุฃุฏุงุก:
- ุงูุฏูุงู ูุญุณููุฉ
- ุงูููุงุฑุณ ููุฌูุฏุฉ
- ุงูุงุณุชุนูุงูุงุช ุณุฑูุนุฉ

---

## ๐ ุงูุฎูุงุตุฉ

ุชู ุจูุงุก ูุธุงู ุฏูุน ุฑุณูู ุงูุตูุงูุฉ ุงููุงูู ุจูุฌุงุญ! ุงููุธุงู ูุบุทู:

1. โ **ูุงุฌูุฉ ุงูุนููู** - ุฒุฑ ุณุฏุงุฏ ูุงุถุญ ูุณูู
2. โ **ูุนุงูุฌุฉ ุงูุฏูุน** - ุญุณุงุจ ุฏููู ููุญูู
3. โ **ุงูุชุญุฏูุซ ุงูุชููุงุฆู** - ููุนููู ูุงูุฅุฏุงุฑุฉ
4. โ **ููุญุฉ ุงูุฅุฏุงุฑุฉ** - ูุชุงุจุนุฉ ุดุงููุฉ ููุณุฏุงุฏ
5. โ **ุงูุฃูุงู** - ุญูุงูุฉ ูุงููุฉ ูููุน ุงูุชูุงุนุจ
6. โ **ุงูุชูุซูู** - ุดุงูู ูููุตู

**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุงุณุชุฎุฏุงู ูุงูุชุฌุฑูุจ
**Build:** โ ูุงุฌุญ ุจุฏูู ุฃุฎุทุงุก
**ุงููุณุงุฑ:** โ ูุงูู ูููุฎุชุจุฑ

---

**ุงูุชุงุฑูุฎ:** 2026-02-04
**ุงููุทูุฑ:** Claude (Sonnet 4.5)
**ุงูุญุงูุฉ:** ููุชูู โ
