# إصلاح حساب رسوم الصيانة - اكتمال

## المشكلة

في لوحة التحكم > قسم التشغيل > تبويب أشجاري الخضراء (والذهبية)، عند إنشاء سجل صيانة جديد، كان يتم حساب رسوم الصيانة وتوزيعها على **جميع أشجار المزرعة** بدلاً من توزيعها فقط على **الأشجار المحجوزة في المسار المحدد**.

### مثال توضيحي

مزرعة بها:
- إجمالي الأشجار: 1000 شجرة
- الأشجار المحجوزة في مسار "أشجاري الخضراء": 200 شجرة
- الأشجار المحجوزة في مسار "أشجاري الذهبية": 150 شجرة
- رسوم الصيانة: 10,000 ريال

**السلوك الخاطئ السابق:**
- تكلفة الشجرة الواحدة = 10,000 ÷ 1000 = 10 ريال

**السلوك الصحيح الآن:**
- في مسار "أشجاري الخضراء": تكلفة الشجرة = 10,000 ÷ 200 = 50 ريال
- في مسار "أشجاري الذهبية": تكلفة الشجرة = 10,000 ÷ 150 = 66.67 ريال

## الحل المُنفذ

### 1. تعديل operationsService.getFarms()

**الملف:** `src/services/operationsService.ts`

تم تعديل الدالة لجلب عدد الأشجار المحجوزة في كل مسار:

```typescript
async getFarms() {
  const { data: farmsData, error } = await supabase
    .from('farms')
    .select('id, name_ar, name_en, total_trees')
    .order('name_ar');

  if (error) throw error;

  const farms = await Promise.all(
    (farmsData || []).map(async (farm) => {
      const agricultureTreesCount = await this.getReservedTreesCount(farm.id, 'agricultural');
      const investmentTreesCount = await this.getReservedTreesCount(farm.id, 'investment');

      return {
        ...farm,
        reserved_agricultural_trees: agricultureTreesCount,
        reserved_investment_trees: investmentTreesCount
      };
    })
  );

  return farms;
}
```

### 2. تحديث واجهة Farm في MaintenanceRecordWizard

**الملف:** `src/components/admin/MaintenanceRecordWizard.tsx`

```typescript
interface Farm {
  id: string;
  name_ar: string;
  total_trees: number;
  reserved_agricultural_trees?: number;
  reserved_investment_trees?: number;
}
```

### 3. إصلاح حساب تكلفة الشجرة

تم تعديل الحساب ليستخدم عدد الأشجار المحجوزة في المسار المحدد:

```typescript
const getReservedTreesCount = () => {
  if (!selectedFarm) return 0;
  if (formData.path_type === 'agricultural') {
    return selectedFarm.reserved_agricultural_trees || 0;
  }
  if (formData.path_type === 'investment') {
    return selectedFarm.reserved_investment_trees || 0;
  }
  return 0;
};

const reservedTreesCount = getReservedTreesCount();
const costPerTree = formData.total_amount && reservedTreesCount > 0
  ? (parseFloat(formData.total_amount) / reservedTreesCount).toFixed(2)
  : '0.00';
```

### 4. تحسين واجهة المستخدم

#### عرض معلومات أكثر دقة:

```
الأشجار المحجوزة في أشجاري الخضراء: 200 شجرة
إجمالي الأشجار بالمزرعة: 1000 شجرة
```

#### عرض تفصيلي للرسوم:

```
┌─────────────────┬───────────────────────┬─────────────────────┐
│ إجمالي الرسوم  │ عدد الأشجار المحجوزة │ تكلفة الشجرة الواحدة│
│   10,000 ر.س   │         200          │      50.00 ر.س     │
└─────────────────┴───────────────────────┴─────────────────────┘
```

#### تحذير عند عدم وجود حجوزات:

إذا لم توجد أشجار محجوزة في المسار المحدد، يظهر تحذير:

```
⚠️ تحذير: لا توجد أشجار محجوزة
لا يوجد حجوزات في مسار أشجاري الخضراء لهذه المزرعة.
لن يتم احتساب رسوم على العملاء.
```

## التطبيق على المسارين

هذا الإصلاح ينطبق على:

### ✅ المسار الزراعي (أشجاري الخضراء)
- يتم حساب الرسوم فقط على الأشجار المحجوزة ذات `path_type = 'agricultural'`
- يتم توزيع التكلفة على العملاء الذين حجزوا في هذا المسار فقط

### ✅ المسار الاستثماري (أشجاري الذهبية)
- يتم حساب الرسوم فقط على الأشجار المحجوزة ذات `path_type = 'investment'`
- يتم توزيع التكلفة على المستثمرين الذين حجزوا في هذا المسار فقط

## الفوائد

1. ✅ **عدالة التوزيع**: كل عميل يدفع حصته الصحيحة بناءً على المسار الذي اختاره
2. ✅ **دقة الحسابات**: الرسوم تُحسب بناءً على الأشجار الفعلية المحجوزة
3. ✅ **شفافية**: المدير يرى بوضوح عدد الأشجار المحجوزة في كل مسار
4. ✅ **تحذيرات مبكرة**: النظام ينبه المدير إذا حاول إنشاء رسوم لمزرعة بدون حجوزات

## اختبار الإصلاح

### سيناريو الاختبار

1. قم بتسجيل الدخول كمدير (super_admin@ashjari.sa)
2. انتقل إلى قسم التشغيل > تبويب أشجاري الخضراء
3. اضغط "إنشاء سجل صيانة جديد"
4. اختر مزرعة بها حجوزات
5. في خطوة الرسوم، لاحظ:
   - عدد الأشجار المحجوزة في أشجاري الخضراء
   - حساب تكلفة الشجرة الواحدة بناءً على الأشجار المحجوزة فقط
   - التحذير إذا لم توجد حجوزات

### النتائج المتوقعة

- ✅ تكلفة الشجرة = إجمالي الرسوم ÷ عدد الأشجار المحجوزة في المسار
- ✅ كل عميل في قاعدة البيانات سيرى رسومه الصحيحة حسب عدد أشجاره
- ✅ العملاء في المسار الآخر لن يتأثروا بهذه الرسوم

## الحالة

✅ **الإصلاح مكتمل ومُختبر**
✅ **البناء ناجح**
✅ **جاهز للاستخدام في الإنتاج**
