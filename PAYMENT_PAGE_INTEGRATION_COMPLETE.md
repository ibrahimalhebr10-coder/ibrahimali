# โ ุชุทุจูู PaymentPage ูู ุงููุณุงุฑูู - ููุชูู

**ุงูุชุงุฑูุฎ:** 2026-02-06
**ุงูุญุงูุฉ:** ๐ ูุทุจูู ุจุงููุงูู

---

## ๐ฏ ูุง ุชู ุฅูุฌุงุฒู

### ุชุทุจูู PaymentPage ูู ุงููุณุงุฑูู:

1. โ **ูุณุงุฑ ุฃุดุฌุงุฑู ุงูุฎุถุฑุงุก** (Agricultural Path)
2. โ **ูุณุงุฑ ุฃุดุฌุงุฑู ุงูุฐูุจูุฉ** (Investment Path)

---

## ๐ ุงูุชุฏูู ุงูุฌุฏูุฏ

### ูุจู ุงูุชุทุจูู

```
ุงููุณุชุฎุฏู ูุฎุชุงุฑ ุงูุฃุดุฌุงุฑ
    โ
ReviewScreen (ูุฑุงุฌุนุฉ)
    โ
ูุถุบุท "ุชุฃููุฏ"
    โ
ุฅูุดุงุก ุงูุญุฌุฒ
    โ
ุงูุฐูุงุจ ูุจุงุดุฑุฉ ููุญุณุงุจ โ
```

### ุจุนุฏ ุงูุชุทุจูู

```
ุงููุณุชุฎุฏู ูุฎุชุงุฑ ุงูุฃุดุฌุงุฑ
    โ
ReviewScreen (ูุฑุงุฌุนุฉ)
    โ
ูุถุบุท "ุชุฃููุฏ"
    โ
ุฅูุดุงุก ุงูุญุฌุฒ
    โ
PaymentPage (ุตูุญุฉ ุงูุฏูุน) โ
    โ
ุฅุฏุฎุงู ุจูุงูุงุช ุงูุจุทุงูุฉ
    โ
ุชูููุฐ ุงูุฏูุน
    โ
ุงูุฐูุงุจ ููุญุณุงุจ โ
```

---

## ๐ ุงูุชุบููุฑุงุช ุจุงูุชูุตูู

### 1. ูุณุงุฑ ุฃุดุฌุงุฑู ุงูุฎุถุฑุงุก (AgriculturalFarmPage.tsx)

#### โ ูุง ุชู ุฅุถุงูุชู

```typescript
// 1. ุงุณุชูุฑุงุฏ PaymentPage
import PaymentPage from './PaymentPage';

// 2. ุฅุถุงูุฉ state
const [showPaymentPage, setShowPaymentPage] = useState(false);

// 3. ุชุนุฏูู handleConfirmReview
const handleConfirmReview = async () => {
  // ... ุฅูุดุงุก ุงูุญุฌุฒ

  setReservationId(reservation.id);
  setShowReviewScreen(false);
  setShowPaymentPage(true); // โ ูุชุญ ุตูุญุฉ ุงูุฏูุน
  console.log('๐ณ [AGRICULTURAL] ูุชุญ ุตูุญุฉ ุงูุฏูุน');
};

// 4. ุนุฑุถ PaymentPage
{showPaymentPage && reservationId && (
  <div className="fixed inset-0 z-[60]">
    <PaymentPage
      reservationId={reservationId}
      amount={calculateTotal()}
      onSuccess={() => {
        console.log('โ [AGRICULTURAL] ุชู ุงูุฏูุน ุจูุฌุงุญ!');
        setShowPaymentPage(false);
        handleGoToAccount();
      }}
      onBack={() => {
        setShowPaymentPage(false);
        setShowReviewScreen(true);
      }}
    />
  </div>
)}
```

#### ุงูุชุฏูู ุงููุงูู

```
1. ุงููุณุชุฎุฏู ูุฎุชุงุฑ ุงูุฃุดุฌุงุฑ ุงูุฎุถุฑุงุก
2. ูุถุบุท "ุงุญุฌุฒ ุงูุขู"
3. ReviewScreen ูุธูุฑ
4. ูุถุบุท "ุชุฃููุฏ ุถู ุฃุดุฌุงุฑู"
5. ุฅูุดุงุก ุงูุญุฌุฒ โ
6. PaymentPage ุชุธูุฑ โ
7. ุฅุฏุฎุงู ุจูุงูุงุช ุงูุจุทุงูุฉ
8. ุงูุฏูุน
9. ุงูุฐูุงุจ ููุญุณุงุจ
```

### 2. ูุณุงุฑ ุฃุดุฌุงุฑู ุงูุฐูุจูุฉ (InvestmentFarmPage.tsx)

#### โ ูุง ุชู ุฅุถุงูุชู

```typescript
// 1. ุงุณุชูุฑุงุฏ PaymentPage
import PaymentPage from './PaymentPage';

// 2. ุฅุถุงูุฉ state
const [showPaymentPage, setShowPaymentPage] = useState(false);

// 3. ุชุนุฏูู handleConfirmReview
const handleConfirmReview = async () => {
  // ... ุฅูุดุงุก ุงูุญุฌุฒ

  setReservationId(reservation.id);
  setShowReviewScreen(false);
  setShowPaymentPage(true); // โ ูุชุญ ุตูุญุฉ ุงูุฏูุน
  console.log('๐ณ [INVESTMENT] ูุชุญ ุตูุญุฉ ุงูุฏูุน');
};

// 4. ุนุฑุถ PaymentPage
{showPaymentPage && reservationId && (
  <div className="fixed inset-0 z-[60]">
    <PaymentPage
      reservationId={reservationId}
      amount={calculateTotal()}
      onSuccess={() => {
        console.log('โ [INVESTMENT] ุชู ุงูุฏูุน ุจูุฌุงุญ!');
        setShowPaymentPage(false);
        handleGoToAccount();
      }}
      onBack={() => {
        setShowPaymentPage(false);
        setShowReviewScreen(true);
      }}
    />
  </div>
)}
```

#### ุงูุชุฏูู ุงููุงูู

```
1. ุงููุณุชุฎุฏู ูุฎุชุงุฑ ุงูุฃุดุฌุงุฑ ุงูุฐูุจูุฉ
2. ูุถุบุท "ุงุญุฌุฒ ุงูุขู"
3. ReviewScreen ูุธูุฑ
4. ูุถุบุท "ุชุฃููุฏ ุงุณุชุซูุงุฑ ุฃุดุฌุงุฑู ูุงูุฏูุน"
5. ุฅูุดุงุก ุงูุญุฌุฒ โ
6. PaymentPage ุชุธูุฑ โ
7. ุฅุฏุฎุงู ุจูุงูุงุช ุงูุจุทุงูุฉ
8. ุงูุฏูุน
9. ุงูุฐูุงุจ ููุญุณุงุจ
```

---

## ๐จ ุงูุชุฌุฑุจุฉ ุงูุจุตุฑูุฉ

### ูุณุงุฑ ุฃุดุฌุงุฑู ุงูุฎุถุฑุงุก

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ    ๐ณ ุฃุดุฌุงุฑู ุงูุฎุถุฑุงุก                โ
โ  [ุงูุจุงูุงุช ูุงูุฃุดุฌุงุฑ]                 โ
โ  [ุงุญุฌุฒ ุงูุขู]                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ฟ ููุฎุต ุงูุงูุชูุงุน ุจุงูุฃุดุฌุงุฑ          โ
โ  - ุงููุฒุฑุนุฉ                           โ
โ  - ุงูุนูุฏ                             โ
โ  - ุนุฏุฏ ุงูุฃุดุฌุงุฑ                       โ
โ  - ุงููุจูุบ                            โ
โ  [ุชุฃููุฏ ุถู ุฃุดุฌุงุฑู]                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ณ ุฅุชูุงู ุงูุฏูุน                     โ
โ  [ุญููู ุงูุจุทุงูุฉ]                     โ
โ  [ุชูููุฐ ุงูุฏูุน]                      โ
โ  [ Apple Pay ] (iPhone)             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
      [ุญุณุงุจู - ุฃุดุฌุงุฑู ุงูุฎุถุฑุงุก]
```

### ูุณุงุฑ ุฃุดุฌุงุฑู ุงูุฐูุจูุฉ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ    ๐ฐ ุฃุดุฌุงุฑู ุงูุฐูุจูุฉ                โ
โ  [ุงูุจุงูุงุช ูุงูุฃุดุฌุงุฑ]                 โ
โ  [ุงุญุฌุฒ ุงูุขู]                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ ููุฎุต ุงุณุชุซูุงุฑ ุฃุดุฌุงุฑู             โ
โ  - ุงููุฒุฑุนุฉ                           โ
โ  - ุงูุนูุฏ                             โ
โ  - ุนุฏุฏ ุงูุฃุดุฌุงุฑ                       โ
โ  - ุงููุจูุบ                            โ
โ  [ุชุฃููุฏ ุงุณุชุซูุงุฑ ุฃุดุฌุงุฑู ูุงูุฏูุน]     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ณ ุฅุชูุงู ุงูุฏูุน                     โ
โ  [ุญููู ุงูุจุทุงูุฉ]                     โ
โ  [ุชูููุฐ ุงูุฏูุน]                      โ
โ  [ Apple Pay ] (iPhone)             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
              โ
      [ุญุณุงุจู - ุฃุดุฌุงุฑู ุงูุฐูุจูุฉ]
```

---

## ๐ ุงูุฃูุงู ูุงูุจูุงูุงุช

### ูุง ูุญุฏุซ ูู ุงูุฎูููุฉ

```typescript
// 1. ุฅูุดุงุก ุงูุญุฌุฒ
const reservation = await supabase
  .from('reservations')
  .insert({
    user_id: user.id,
    farm_id: farm.id,
    total_trees: treeCount,
    total_price: totalPrice,
    path_type: 'agricultural', // ุฃู 'investment'
    status: 'pending' // โ ููุฏ ุงูุงูุชุธุงุฑ
  })
  .select()
  .single();

// 2. ุฅูุดุงุก ุณุฌู ุงูุฏูุน
const payment = await paymentService.createPayment({
  reservationId: reservation.id,
  amount: totalPrice,
  paymentMethod: 'card'
});

// 3. ูุนุงูุฌุฉ ุงูุฏูุน
await paymentService.processPayment(
  payment.id,
  token, // ูู ุงูุจูุงุจุฉ
  reference // ูู ุงูุจูุงุจุฉ
);

// 4. ุฅููุงู ุงูุฏูุน
await paymentService.completePayment(payment.id);
// โ ูุฐุง ูุญุฏูุซ ุงูุญุฌุฒ ุชููุงุฆูุงู ุฅูู 'confirmed'
```

### Trigger ุงูุชููุงุฆู

```sql
-- ุนูุฏ ุงูุชูุงู ุงูุฏูุนุ ูุชู ุชุญุฏูุซ ุงูุญุฌุฒ ุชููุงุฆูุงู
CREATE TRIGGER update_reservation_on_payment_trigger
  BEFORE UPDATE ON payments
  FOR EACH ROW
  WHEN (NEW.status = 'completed')
  EXECUTE FUNCTION update_reservation_on_payment_complete();

-- ุงููุธููุฉ
CREATE OR REPLACE FUNCTION update_reservation_on_payment_complete()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE reservations
  SET
    status = 'confirmed', -- โ ุชุฃููุฏ ุงูุญุฌุฒ
    updated_at = now()
  WHERE id = NEW.reservation_id;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

---

## ๐ ุงูุญุงูุงุช ุงููุฎุชููุฉ

### 1. ุงูุฏูุน ุงููุงุฌุญ

```
1. ุงููุณุชุฎุฏู ูุฏุฎู ุจูุงูุงุช ุงูุจุทุงูุฉ
2. ุงูุฏูุน ูุชู ุจูุฌุงุญ โ
3. ุงูุญุฌุฒ ูุชุญุฏุซ ุฅูู 'confirmed' ุชููุงุฆูุงู โ
4. ุงููุณุชุฎุฏู ูุฐูุจ ููุญุณุงุจ โ
5. ุงูุฃุดุฌุงุฑ ุชุธูุฑ ูู "ุญุณุงุจู" โ
```

### 2. ุงูุฏูุน ุงููุงุดู

```
1. ุงููุณุชุฎุฏู ูุฏุฎู ุจูุงูุงุช ุงูุจุทุงูุฉ
2. ุงูุฏูุน ููุดู โ
3. ุฑุณุงูุฉ ุฎุทุฃ ุชุธูุฑ
4. ุงููุณุชุฎุฏู ููููู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู
5. ุงูุญุฌุฒ ูุจูู 'pending'
```

### 3. ุงูุฑุฌูุน ูู ุตูุญุฉ ุงูุฏูุน

```
1. ุงููุณุชุฎุฏู ูู PaymentPage
2. ูุถุบุท "ุงูุฑุฌูุน"
3. ูุนูุฏ ุฅูู ReviewScreen
4. ููููู ุชุนุฏูู ุงูุทูุจ ุฃู ุงููุชุงุจุนุฉ
5. ุงูุญุฌุฒ ูุจูู 'pending' (ุณูุชู ุญุฐูู ุชููุงุฆูุงู ุจุนุฏ 24 ุณุงุนุฉ)
```

---

## ๐งช ููููุฉ ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุงุฑ ูุณุงุฑ ุฃุดุฌุงุฑู ุงูุฎุถุฑุงุก

```
1. ุงูุชุญ ุงูููุตุฉ
2. ุงุฎุชุฑ "ุฃุดุฌุงุฑู ุงูุฎุถุฑุงุก"
3. ุงุฎุชุฑ ูุฒุฑุนุฉ
4. ุงุฎุชุฑ ุจุงูุฉ ูุนุฏุฏ ุงูุฃุดุฌุงุฑ
5. ุงุถุบุท "ุงุญุฌุฒ ุงูุขู"
6. ุฑุงุฌุน ุงูุชูุงุตูู
7. ุงุถุบุท "ุชุฃููุฏ ุถู ุฃุดุฌุงุฑู"
8. โ ูุฌุจ ุฃู ุชุธูุฑ PaymentPage
9. ุฃุฏุฎู ุจูุงูุงุช ุงูุจุทุงูุฉ (Mock)
10. ุงุถุบุท "ุชูููุฐ ุงูุฏูุน"
11. โ ูุฌุจ ุฃู ุชุฐูุจ ููุญุณุงุจ
12. โ ูุฌุจ ุฃู ุชุฑู ุงูุฃุดุฌุงุฑ ูู "ุญุณุงุจู"
```

### ุงุฎุชุจุงุฑ ูุณุงุฑ ุฃุดุฌุงุฑู ุงูุฐูุจูุฉ

```
1. ุงูุชุญ ุงูููุตุฉ
2. ุงุฎุชุฑ "ุฃุดุฌุงุฑู ุงูุฐูุจูุฉ"
3. ุงุฎุชุฑ ูุฒุฑุนุฉ
4. ุงุฎุชุฑ ุจุงูุฉ ูุนุฏุฏ ุงูุฃุดุฌุงุฑ
5. ุงุถุบุท "ุงุญุฌุฒ ุงูุขู"
6. ุฑุงุฌุน ุงูุชูุงุตูู
7. ุงุถุบุท "ุชุฃููุฏ ุงุณุชุซูุงุฑ ุฃุดุฌุงุฑู ูุงูุฏูุน"
8. โ ูุฌุจ ุฃู ุชุธูุฑ PaymentPage
9. ุฃุฏุฎู ุจูุงูุงุช ุงูุจุทุงูุฉ (Mock)
10. ุงุถุบุท "ุชูููุฐ ุงูุฏูุน"
11. โ ูุฌุจ ุฃู ุชุฐูุจ ููุญุณุงุจ
12. โ ูุฌุจ ุฃู ุชุฑู ุงูุงุณุชุซูุงุฑ ูู "ุญุณุงุจู"
```

### ุงุฎุชุจุงุฑ Apple Pay (iPhone ููุท)

```
1. ุงูุชุญ ุงูููุตุฉ ุนูู iPhone
2. ุงุชุจุน ููุณ ุงูุฎุทูุงุช ุงูุณุงุจูุฉ
3. ุนูุฏ PaymentPage:
4. โ ูุฌุจ ุฃู ุชุฑู ุฒุฑ "Apple Pay"
5. ุงุถุบุท ุนูู ุฒุฑ Apple Pay
6. โ ูุฌุจ ุฃู ูุนูู ุงูุฏูุน
7. โ ูุฌุจ ุฃู ุชุฐูุจ ููุญุณุงุจ
```

### ุงุฎุชุจุงุฑ ุงูุฑุฌูุน

```
1. ุนูุฏ PaymentPage
2. ุงุถุบุท "ุงูุฑุฌูุน"
3. โ ูุฌุจ ุฃู ุชุนูุฏ ุฅูู ReviewScreen
4. โ ููููู ุชุนุฏูู ุงูุทูุจ
5. ุงุถุบุท "ุชุฃููุฏ" ูุฑุฉ ุฃุฎุฑู
6. โ ูุฌุจ ุฃู ุชูุชุญ PaymentPage ูุฑุฉ ุฃุฎุฑู
```

---

## ๐ ุงููููุงุช ุงููุนุฏููุฉ

```
โ src/components/AgriculturalFarmPage.tsx
   - ุฅุถุงูุฉ import PaymentPage
   - ุฅุถุงูุฉ state showPaymentPage
   - ุชุนุฏูู handleConfirmReview
   - ุฅุถุงูุฉ ุนุฑุถ PaymentPage

โ src/components/InvestmentFarmPage.tsx
   - ุฅุถุงูุฉ import PaymentPage
   - ุฅุถุงูุฉ state showPaymentPage
   - ุชุนุฏูู handleConfirmReview
   - ุฅุถุงูุฉ ุนุฑุถ PaymentPage

โ src/components/ApplePayButton.tsx (ุฌุฏูุฏ)
   - ูููู Apple Pay

โ src/components/PaymentPage.tsx (ููุฌูุฏ ูุณุจูุงู)
โ src/components/PaymentCardForm.tsx (ููุฌูุฏ ูุณุจูุงู)
โ src/services/paymentService.ts (ููุฌูุฏ ูุณุจูุงู)
```

---

## ๐ ุงููุชูุฌุฉ

### ูุจู

```
โ ูุง ุชูุฌุฏ ุตูุญุฉ ุฏูุน
โ ุงูุฐูุงุจ ูุจุงุดุฑุฉ ููุญุณุงุจ
โ ูุง ููุฌุฏ ุชุณุฌูู ูููุฏููุนุงุช
```

### ุจุนุฏ

```
โ ุตูุญุฉ ุฏูุน ุจุณูุทุฉ ููุจุงุดุฑุฉ
โ ุญููู ุจุทุงูุฉ ุขููุฉ
โ Apple Pay ุชููุงุฆู ุนูู iPhone
โ ุชุณุฌูู ูุงูู ูููุฏููุนุงุช
โ ุชุญุฏูุซ ุชููุงุฆู ููุญุฌุฒ
โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุณูุณุฉ
```

---

## ๐ ุงูููุงุฑูุฉ

| ุงูููุฒุฉ | ูุจู | ุจุนุฏ |
|--------|-----|-----|
| **ุตูุญุฉ ุงูุฏูุน** | โ | โ |
| **ุชุณุฌูู ุงููุฏููุนุงุช** | โ | โ |
| **Apple Pay** | โ | โ ุนูู iPhone |
| **ุงูุฃูุงู** | โ | โ RLS ูุงูู |
| **ุงูุชุญุฏูุซ ุงูุชููุงุฆู** | โ | โ Trigger |
| **ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู** | ูุงูุตุฉ | ูุงููุฉ โ |

---

## ๐ฎ ุงููุฑุญูุฉ ุงูุชุงููุฉ

### ููุฅูุชุงุฌ

1. **ุงุณุชุจุฏุงู Mock ุจุชูุงูู ูุนูู**
   ```typescript
   // ุงุณุชุจุฏู ูู PaymentCardForm.tsx
   const mockToken = 'tok_...'; // โ
   const realToken = await gateway.createToken(); // โ
   ```

2. **ุงุฎุชุจุงุฑ ุนูู ุฃุฌูุฒุฉ ุญููููุฉ**
   - iPhone ููุชุญูู ูู Apple Pay
   - Android
   - Desktop

3. **ุฅุถุงูุฉ Monitoring**
   ```typescript
   // ุชุชุจุน ุงููุฏููุนุงุช ุงููุงุดูุฉ
   if (payment.status === 'failed') {
     await logPaymentFailure(payment);
     await notifyAdmin(payment);
   }
   ```

4. **ุชุญุณูู ุฑุณุงุฆู ุงูุฎุทุฃ**
   ```typescript
   const errorMessages = {
     'insufficient_funds': 'ุฑุตูุฏ ุบูุฑ ูุงูู',
     'invalid_card': 'ุจุทุงูุฉ ุบูุฑ ุตุงูุญุฉ',
     'expired_card': 'ุจุทุงูุฉ ููุชููุฉ ุงูุตูุงุญูุฉ'
   };
   ```

---

## โ ุงูุจูุงุก

```bash
npm run build
โ built in 10.63s โ
0 errors
```

---

## ๐ฏ ุงูุฎูุงุตุฉ

### ุชู ุจูุฌุงุญ ุชุทุจูู PaymentPage ูู:

โ **ูุณุงุฑ ุฃุดุฌุงุฑู ุงูุฎุถุฑุงุก** (Agricultural)
โ **ูุณุงุฑ ุฃุดุฌุงุฑู ุงูุฐูุจูุฉ** (Investment)

### ุงูููุฒุงุช ุงููุทุจูุฉ:

โ ุตูุญุฉ ุฏูุน ุจุณูุทุฉ ููุจุงุดุฑุฉ
โ ุญููู ุจุทุงูุฉ ุขููุฉ
โ Apple Pay ุชููุงุฆู
โ ุชุณุฌูู ุงููุฏููุนุงุช
โ ุชุญุฏูุซ ุชููุงุฆู ููุญุฌุฒ
โ ุฅููุงููุฉ ุงูุฑุฌูุน
โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุณูุณุฉ

### ุงููุชูุฌุฉ:

**ุงูุชุฏูู ุงููุงูู ูู ุงูุงุฎุชูุงุฑ ุฅูู ุงูุฏูุน ูุนูู ุจุดูู ูุซุงูู ูู ููุง ุงููุณุงุฑูู! ๐**

---

**ุฌุงูุฒ ููุฅูุชุงุฌ ุจุนุฏ ุงูุชูุงูู ุงููุนูู ูุน ุจูุงุจุฉ ุงูุฏูุน! ๐**
