# تدفق التزامن: من الحجز إلى "عقودي" 🔄

**التاريخ:** 2026-02-03

---

## 🎯 كيف يعمل التزامن؟

### التدفق الكامل من البداية للنهاية:

```
┌─────────────────────────────────────────────┐
│ 1️⃣ المستخدم يحجز أشجار في مزرعة           │
│    - يختار المزرعة                          │
│    - يختار عدد الأشجار                      │
│    - يحدد نوع العقد (زراعي/استثماري)       │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│ 2️⃣ يتم إنشاء record في جدول reservations   │
│                                             │
│    reservations table:                      │
│    ┌─────────────────────────────────────┐  │
│    │ id: uuid                            │  │
│    │ user_id: current_user_id           │  │
│    │ farm_id: selected_farm_id          │  │
│    │ number_of_trees: 50                │  │
│    │ tree_types: ['نخيل', 'زيتون']     │  │
│    │ contract_type: 'agricultural'      │  │
│    │ status: 'active'                   │  │
│    │ contract_start_date: 2026-02-03    │  │
│    │ contract_end_date: 2031-02-03      │  │
│    └─────────────────────────────────────┘  │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│ 3️⃣ المستخدم يفتح "حسابي"                   │
│    - يضغط على أيقونة المستخدم              │
│    - تفتح صفحة AccountProfile              │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│ 4️⃣ مكون MyContracts يتم تحميله تلقائياً   │
│    - useEffect يُنفَّذ                     │
│    - loadMyContracts() يُستدعى            │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│ 5️⃣ استعلام Supabase                        │
│                                             │
│    SELECT reservations.*, farms.*          │
│    FROM reservations                        │
│    JOIN farms ON farms.id = reservations.farm_id │
│    WHERE reservations.user_id = current_user_id  │
│      AND reservations.status IN (           │
│        'active',                            │
│        'completed',                         │
│        'waiting_for_payment'                │
│      )                                      │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│ 6️⃣ تجميع البيانات حسب المزرعة              │
│                                             │
│    const farmMap = new Map()                │
│                                             │
│    For each reservation:                    │
│      - احصل على farm_id                    │
│      - إذا لم تكن المزرعة موجودة في Map:   │
│        → أضف المزرعة الجديدة               │
│      - أضف العقد إلى قائمة عقود المزرعة   │
│      - زد contracts_count بمقدار 1         │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│ 7️⃣ عرض العقود في الواجهة                  │
│                                             │
│    ╔═══════════════════════════════════╗    │
│    ║  📄 عقودي          ⭐ 5 عقود    ║    │
│    ╚═══════════════════════════════════╝    │
│                                             │
│    ┌───────────────────────────────────┐    │
│    │  🌳 مزرعة النخيل     [3 عقود]  │    │
│    └───────────────────────────────────┘    │
│        - عقد زراعي #1                      │
│        - عقد استثماري #2                   │
│        - عقد زراعي #3                      │
│                                             │
│    ┌───────────────────────────────────┐    │
│    │  🌳 مزرعة الزيتون    [2 عقد]   │    │
│    └───────────────────────────────────┘    │
│        - عقد زراعي #4                      │
│        - عقد استثماري #5                   │
└─────────────────────────────────────────────┘
```

---

## 🔄 التزامن التلقائي

### عندما يتم إنشاء عقد جديد:

```typescript
// 1. في FarmPage أو أي صفحة حجز
const createReservation = async () => {
  await supabase.from('reservations').insert({
    user_id: user.id,
    farm_id: selectedFarm.id,
    number_of_trees: 50,
    tree_types: ['نخيل', 'زيتون'],
    contract_type: 'agricultural',
    status: 'active',
    contract_start_date: new Date().toISOString(),
    contract_end_date: calculateEndDate(5) // 5 سنوات
  });

  // ✅ تم حفظ العقد في قاعدة البيانات
};

// 2. في MyContracts
useEffect(() => {
  if (user) {
    loadMyContracts(); // يجلب آخر البيانات تلقائياً
  }
}, [user]);

// 3. النتيجة
// ✅ العقد الجديد يظهر فوراً عند فتح "حسابي"
```

---

## 📊 مثال عملي

### السيناريو: مستخدم يحجز للمرة الأولى

```
الخطوة 1: المستخدم جديد، لا عقود
┌─────────────────────────────────────┐
│  📄 عقودي                            │
│                                      │
│  لا توجد عقود بعد                   │
│  عندما تحجز أشجارك، ستظهر عقودك    │
│  هنا                                 │
└─────────────────────────────────────┘

الخطوة 2: يحجز 50 شجرة نخيل في "مزرعة النخيل"
→ يتم إنشاء reservation في قاعدة البيانات
→ status = 'active'
→ contract_type = 'agricultural'

الخطوة 3: يفتح "حسابي"
┌─────────────────────────────────────┐
│  📄 عقودي          ⭐ 1 عقد         │
└─────────────────────────────────────┘

┌───────────────────────────────────────┐
│  🌳 مزرعة النخيل           [1 عقد]  │ ← جديد!
└───────────────────────────────────────┘

  ┌─────────────────────────────────────┐
  │  🌿 عقد زراعي          [نشط]       │ ← جديد!
  │  #abc12345                          │
  │  🌳 50 شجرة   📅 2026/02/03        │
  │  [نخيل]                             │
  │  ⏰ 1825 يوم  █░░░░░░░░░ 0%        │
  └─────────────────────────────────────┘
```

---

## 🎯 النقاط الأساسية

### 1. لا حاجة لتحديث يدوي
```
❌ المستخدم لا يحتاج لتحديث الصفحة
❌ لا توجد أزرار "تحديث" مطلوبة
✅ البيانات تُجلب تلقائياً عند فتح "حسابي"
```

### 2. التجميع التلقائي
```
✅ إذا كان للمستخدم 3 عقود في نفس المزرعة
   → تظهر كلها تحت بطاقة المزرعة الواحدة
   → العدد: "3 عقود"

✅ إذا كان للمستخدم عقود في 3 مزارع مختلفة
   → تظهر 3 بطاقات منفصلة
   → كل مزرعة بعقودها الخاصة
```

### 3. الحالات المختلفة
```typescript
// العقود النشطة
status = 'active' → يظهر شريط التقدم والوقت المتبقي

// العقود بانتظار الدفع
status = 'waiting_for_payment' → badge أصفر، لا شريط تقدم

// العقود المكتملة
status = 'completed' → badge رمادي، للأرشيف
```

---

## 🔐 الأمان

### Row Level Security (RLS)

```sql
-- السياسة على جدول reservations
CREATE POLICY "Users can view own reservations"
  ON reservations
  FOR SELECT
  TO authenticated
  USING (auth.uid() = user_id);
```

**النتيجة:**
- ✅ المستخدم يرى عقوده فقط
- ❌ لا يستطيع رؤية عقود المستخدمين الآخرين
- ✅ محمي على مستوى قاعدة البيانات

---

## 🧪 اختبار التزامن

### كيف تختبر:

```
1. سجل دخول كمستخدم
2. افتح "حسابي" → لا عقود
3. اذهب إلى صفحة مزرعة
4. احجز أشجار
5. ارجع إلى "حسابي"
6. ✅ ستجد العقد الجديد ظهر تلقائياً!
```

### اختبارات متقدمة:

```
✅ اختبار 1: حجز في نفس المزرعة مرتين
   النتيجة: مزرعة واحدة، "2 عقد"

✅ اختبار 2: حجز في مزرعتين مختلفتين
   النتيجة: بطاقتين منفصلتين

✅ اختبار 3: عقد نشط + عقد بانتظار الدفع
   النتيجة: كلاهما يظهران، بألوان مختلفة

✅ اختبار 4: إغلاق وفتح "حسابي" عدة مرات
   النتيجة: البيانات محدثة دائماً
```

---

## 📱 تجربة المستخدم

### ما يراه المستخدم:

```
قبل الحجز:
"لا توجد عقود بعد"

بعد الحجز الأول:
"1 عقد نشط"
- مزرعة واحدة
- عقد واحد

بعد الحجز الثاني (نفس المزرعة):
"2 عقد نشط"
- مزرعة واحدة
- عقدين

بعد الحجز الثالث (مزرعة مختلفة):
"3 عقود نشطة"
- مزرعتين
- المزرعة الأولى: 2 عقد
- المزرعة الثانية: 1 عقد
```

---

## 🎓 الخلاصة

### التزامن يعمل بشكل كامل:

1. ✅ **فوري** - العقود تظهر مباشرة بعد الحجز
2. ✅ **تلقائي** - لا حاجة لتحديث يدوي
3. ✅ **ذكي** - التجميع حسب المزرعة
4. ✅ **آمن** - RLS يحمي بيانات كل مستخدم
5. ✅ **دقيق** - الأعداد والمعلومات صحيحة

### التدفق واضح:
```
حجز → قاعدة بيانات → استعلام → تجميع → عرض
  ✅        ✅           ✅        ✅      ✅
```

---

**التزامن كامل وجاهز للاستخدام** 🚀

**تاريخ التوثيق:** 2026-02-03
**الحالة:** ✅ مطبق ومختبر وجاهز
