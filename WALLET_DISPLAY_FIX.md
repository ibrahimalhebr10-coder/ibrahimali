# ุฅุตูุงุญ ูุดููุฉ ุนุฏู ุธููุฑ ุงูุชุญูููุงุช ูู ูุญูุธุฉ ุงูุฃุฑุจุงุญ

## ุงููุดููุฉ
ุจุนุฏ ุชูููุฐ ุนูููุฉ "ุฏูุน ูุงุฆุถ ูุงูู" ูู ุตูุญุฉ ูุงููุฉ ุงููุฒุฑุนุฉุ ูุง ุชุธูุฑ ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ ูู ุตูุญุฉ "ูุญูุธุฉ ุงูุฃุฑุจุงุญ" ูุจุงุดุฑุฉ.

## ุชุญููู ุงููุดููุฉ

### 1. ุงูุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช โ
ุชู ุงูุชุญูู ูู ุฃู ุงูุจูุงูุงุช ุชูุญูุธ ุจุดูู ุตุญูุญ ูู ุงูุฌุฏูู:
```sql
SELECT * FROM platform_wallet_transfers;
-- ุงููุชูุฌุฉ: ุงูุจูุงูุงุช ููุฌูุฏุฉ โ
-- ุฅุฌูุงูู ุงูุชุญูููุงุช: 14,000 ุฑูุงู
-- ุญุตุฉ ุงูููุตุฉ: 10,500 ุฑูุงู (75%)
-- ุญุตุฉ ุงูุฎูุฑูุฉ: 3,500 ุฑูุงู (25%)
```

### 2. ุฏุงูุฉ ุงูููุฎุต ุชุนูู ุจุดูู ุตุญูุญ โ
```sql
SELECT * FROM get_platform_wallet_summary();
-- ุชูุฑุฌุน ุงูุจูุงูุงุช ุงูุตุญูุญุฉ โ
```

### 3. ุงูุณุจุจ ุงูุญูููู โ
ุงููุดููุฉ ูู **ุงููุงุฌูุฉ**:
- ุตูุญุฉ ูุญูุธุฉ ุงูุฃุฑุจุงุญ ุชูุญููู ุงูุจูุงูุงุช ูุฑุฉ ูุงุญุฏุฉ ููุท ุนูุฏ ูุชุญูุง
- ูุง ููุฌุฏ ุขููุฉ ูุชุญุฏูุซ ุงูุจูุงูุงุช ุชููุงุฆูุงู ุฃู ูุฏููุงู
- ุงููุณุชุฎุฏู ูุญุชุงุฌ ุฅูู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ (F5) ูุฑุคูุฉ ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ

## ุงูุญู ุงููุทุจู

### 1. ุฅุถุงูุฉ ุฒุฑ ุชุญุฏูุซ โ
**ุงูููู:** `src/components/admin/PlatformWallet.tsx`

**ุงูุชุนุฏููุงุช:**
```typescript
// ุฅุถุงูุฉ state ููุชุญุฏูุซ
const [refreshing, setRefreshing] = useState(false);

// ุฏุงูุฉ ุงูุชุญุฏูุซ
const handleRefresh = async () => {
  try {
    setRefreshing(true);
    await loadData();
  } finally {
    setRefreshing(false);
  }
};
```

**ุงููุงุฌูุฉ:**
```jsx
<button
  onClick={handleRefresh}
  disabled={refreshing}
  className="..."
>
  <RefreshCw className={`w-4 h-4 ${refreshing ? 'animate-spin' : ''}`} />
  <span>{refreshing ? 'ุฌุงุฑู ุงูุชุญุฏูุซ...' : 'ุชุญุฏูุซ'}</span>
</button>
```

**ุงูููุงุฆุฏ:**
- ูููู ูููุณุชุฎุฏู ุชุญุฏูุซ ุงูุจูุงูุงุช ุจุถุบุทุฉ ุฒุฑ
- ุฑุณูู ูุชุญุฑูุฉ ุฃุซูุงุก ุงูุชุญุฏูุซ
- ูุง ุญุงุฌุฉ ูุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูุงููุฉ

---

### 2. ุชุญุณูู ุฑุณุงูุฉ ุงููุฌุงุญ โ
**ุงูููู:** `src/components/admin/FarmFinancialPage.tsx`

**ูุจู:**
```javascript
alert('ุชู ุงูุชุญููู ุจูุฌุงุญ!');
```

**ุจุนุฏ:**
```javascript
alert(
  `โ ุชู ุงูุชุญููู ุจูุฌุงุญ!\n\n` +
  `ุงููุจูุบ ุงููุญูู: ${amount.toLocaleString()} ุฑ.ุณ\n` +
  `โข ุญุตุฉ ุงูููุตุฉ (75%): ${platformShare} ุฑ.ุณ\n` +
  `โข ุญุตุฉ ุงูุฎูุฑูุฉ (25%): ${charityShare} ุฑ.ุณ\n\n` +
  `ููููู ุงูุขู ูุฑุงุฌุนุฉ ุงูุฑุตูุฏ ูู ูุณู "ูุญูุธุฉ ุงูุฃุฑุจุงุญ" ูู ููุญุฉ ุงูุชุญูู.`
);
```

**ุงูููุงุฆุฏ:**
- ุฑุณุงูุฉ ูุงุถุญุฉ ูููุตูุฉ
- ุชูุถูุญ ุงูุชูุณูู (75% / 25%)
- ุชูุฌูู ุงููุณุชุฎุฏู ูููุงู ุงูุฑุตูุฏ

---

### 3. ุฅุถุงูุฉ ูุนุงูุฌุฉ ุฃูุถู ููุฃุฎุทุงุก โ
**ุงูููู:** `src/services/platformWalletService.ts`

**ุงูุชุญุณููุงุช:**
```typescript
async getWalletSummary() {
  const { data, error } = await supabase
    .rpc('get_platform_wallet_summary');

  if (error) {
    console.error('ุฎุทุฃ ูู ุชุญููู ููุฎุต ุงููุญูุธุฉ:', error);
    throw error;
  }

  console.log('โ ุชู ุชุญููู ููุฎุต ุงููุญูุธุฉ:', data);
  return data?.[0] as WalletSummary;
}
```

**ุงูููุงุฆุฏ:**
- ุณุฌูุงุช ูุงุถุญุฉ ูู console ููุชุดุฎูุต
- ูุนุงูุฌุฉ ุงูุจูุงูุงุช ุงููุงุฑุบุฉ
- ุฑุณุงุฆู ุฎุทุฃ ูููุฏุฉ

---

### 4. ุชุญุณูู ุนุฑุถ ุงูุจูุงูุงุช ุงููุงุฑุบุฉ โ
**ุงูููู:** `src/components/admin/PlatformWallet.tsx`

**ูุจู:**
```jsx
{transfers.length === 0 ? (
  <tr>
    <td colSpan={5}>ูุง ุชูุฌุฏ ุชุญูููุงุช ุญุชู ุงูุขู</td>
  </tr>
) : (...)}
```

**ุจุนุฏ:**
```jsx
{!transfers || transfers.length === 0 ? (
  <tr>
    <td colSpan={5} className="px-6 py-8 text-center">
      <div className="text-gray-500">ูุง ุชูุฌุฏ ุชุญูููุงุช ุญุชู ุงูุขู</div>
      <div className="text-xs text-gray-400 mt-2">
        ูู ุจุชุญููู ูุงุฆุถ ูุงูู ูู ุตูุญุฉ ูุงููุฉ ุฃู ูุฒุฑุนุฉ ูุนุฑุถู ููุง
      </div>
    </td>
  </tr>
) : (...)}
```

**ุงูููุงุฆุฏ:**
- ูุนุงูุฌุฉ `null` ู `undefined`
- ุฑุณุงูุฉ ุฅุฑุดุงุฏูุฉ ูููุณุชุฎุฏู
- ุชุตููู ุฃูุถู

---

### 5. ุฅุถุงูุฉ ุณุฌูุงุช ุงูุชุดุฎูุต โ
**ุงูููู:** `src/components/admin/PlatformWallet.tsx`

```typescript
console.log('๐ ูุญูุธุฉ ุงูุฃุฑุจุงุญ - ุงูุจูุงูุงุช ุงููุญููุฉ:', {
  summary: summaryData,
  transfersCount: transfersData?.length || 0,
  transfers: transfersData
});
```

**ุงูููุงุฆุฏ:**
- ุณูููุฉ ุชุชุจุน ุงูุจูุงูุงุช ูู console
- ุชุดุฎูุต ุฃุณุฑุน ูููุดุงูู
- ุฑููุฒ ุชุนุจูุฑูุฉ ูุงุถุญุฉ (๐ โ โ)

---

## ููููุฉ ุงุณุชุฎุฏุงู ุงูุญู

### ุงูุณููุงุฑูู ุงููุงูู:

#### 1. ุชูููุฐ ุงูุชุญููู
1. ุณุฌู ุฏุฎูู ููุณุคูู
2. ุงูุชูู ุฅูู **ูุณู ุงููุงููุฉ** โ ุงุฎุชุฑ **ูุฒุฑุนุฉ**
3. ุงุถุบุท **"ุฏูุน ูุงุฆุถ ูุงูู"**
4. ุฃุฏุฎู ุงููุจูุบ โ ุงุถุบุท **"ุชุญููู"**
5. ุณุชุธูุฑ ุฑุณุงูุฉ ุชูุตูููุฉ:
   ```
   โ ุชู ุงูุชุญููู ุจูุฌุงุญ!

   ุงููุจูุบ ุงููุญูู: 5,000 ุฑ.ุณ
   โข ุญุตุฉ ุงูููุตุฉ (75%): 3,750 ุฑ.ุณ
   โข ุญุตุฉ ุงูุฎูุฑูุฉ (25%): 1,250 ุฑ.ุณ

   ููููู ุงูุขู ูุฑุงุฌุนุฉ ุงูุฑุตูุฏ ูู ูุณู "ูุญูุธุฉ ุงูุฃุฑุจุงุญ" ูู ููุญุฉ ุงูุชุญูู.
   ```

#### 2. ูุฑุงุฌุนุฉ ูุญูุธุฉ ุงูุฃุฑุจุงุญ
1. ุงูุชูู ุฅูู **ูุณู ุงููุงููุฉ** โ **ูุญูุธุฉ ุงูุฃุฑุจุงุญ**
2. ุฅุฐุง ูู ุชุธูุฑ ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ:
   - ุงุถุบุท ุฒุฑ **"ุชุญุฏูุซ"** ูู ุฃุนูู ูุณุงุฑ ุงูุตูุญุฉ
   - ุณูุฏูุฑ ุงูุฃููููุฉ ูููุญุฏูุซ ุงูุจูุงูุงุช ููุฑุงู โ
3. ุณุชุธูุฑ ุงูุจูุงูุงุช ุงูุฌุฏูุฏุฉ ูู:
   - **ุฅุฌูุงูู ุงูุฑุตูุฏ ุงูุฏุงุฎู**: ูุฒูุฏ ุจุงููุจูุบ ุงููุญูู
   - **ุฑุตูุฏ ุงูููุตุฉ**: ูุฒูุฏ ุจู 75%
   - **ุฑุตูุฏ ุงูุฃุนูุงู ุงูุฎูุฑูุฉ**: ูุฒูุฏ ุจู 25%
   - **ุณุฌู ุงูุชุญูููุงุช**: ูุธูุฑ ุงูุชุญููู ุงูุฌุฏูุฏ ูู ุงูุฃุนูู

---

## ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุงุฑ 1: ุชุญููู ุฌุฏูุฏ
```
โ ุงูุฎุทูุฉ 1: ุญูู 6,000 ุฑ.ุณ ูู ูุฒุฑุนุฉ
โ ุงูุฎุทูุฉ 2: ุงูุชุญ ูุญูุธุฉ ุงูุฃุฑุจุงุญ
โ ุงูุฎุทูุฉ 3: ุงุถุบุท "ุชุญุฏูุซ"
โ ุงููุชูุฌุฉ ุงููุชููุนุฉ:
  - ุฅุฌูุงูู ุงูุฑุตูุฏ: 14,000 + 6,000 = 20,000 ุฑ.ุณ
  - ุฑุตูุฏ ุงูููุตุฉ: 10,500 + 4,500 = 15,000 ุฑ.ุณ
  - ุฑุตูุฏ ุงูุฎูุฑูุฉ: 3,500 + 1,500 = 5,000 ุฑ.ุณ
```

### ุงุฎุชุจุงุฑ 2: ุชุนุฏุฏ ุงูุชุญูููุงุช
```
โ ุงูุฎุทูุฉ 1: ุญูู ูู 3 ูุฒุงุฑุน ูุฎุชููุฉ
โ ุงูุฎุทูุฉ 2: ุงูุชุญ ูุญูุธุฉ ุงูุฃุฑุจุงุญ
โ ุงูุฎุทูุฉ 3: ุชุญูู ูู ุณุฌู ุงูุชุญูููุงุช
โ ุงููุชูุฌุฉ ุงููุชููุนุฉ:
  - ุนุฑุถ 3 ุชุญูููุงุช ูู ุงูุฌุฏูู
  - ุงูุฃุญุฏุซ ูู ุงูุฃุนูู
  - ุฃุณูุงุก ุงููุฒุงุฑุน ุตุญูุญุฉ
```

### ุงุฎุชุจุงุฑ 3: ุงูุชุญุฏูุซ ุงูุชููุงุฆู
```
โ ุงูุฎุทูุฉ 1: ุงูุชุญ ูุญูุธุฉ ุงูุฃุฑุจุงุญ ูู ุชุจููุจ
โ ุงูุฎุทูุฉ 2: ุงูุชุญ ูุงููุฉ ูุฒุฑุนุฉ ูู ุชุจููุจ ุขุฎุฑ
โ ุงูุฎุทูุฉ 3: ููุฐ ุชุญููู
โ ุงูุฎุทูุฉ 4: ุงุฑุฌุน ููุญูุธุฉ ุงูุฃุฑุจุงุญ
โ ุงูุฎุทูุฉ 5: ุงุถุบุท "ุชุญุฏูุซ"
โ ุงููุชูุฌุฉ ุงููุชููุนุฉ:
  - ุงูุจูุงูุงุช ุชูุญุฏูุซ ููุฑุงู โ
```

---

## ูุนูููุงุช ุชูููุฉ

### ุงูุจูุงูุงุช ุงููุญููุธุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
```sql
-- ุฌุฏูู ุงูุชุญูููุงุช
platform_wallet_transfers (
  id uuid PRIMARY KEY,
  farm_id uuid NOT NULL,
  path_type text NOT NULL,
  transfer_amount decimal NOT NULL,
  platform_share decimal NOT NULL (75%),
  charity_share decimal NOT NULL (25%),
  transferred_by uuid NOT NULL,
  transferred_at timestamptz DEFAULT now()
)

-- ุฏุงูุฉ ุงูููุฎุต (SECURITY DEFINER)
get_platform_wallet_summary() RETURNS TABLE (
  total_transferred decimal,
  platform_balance decimal,
  charity_balance decimal
)
```

### ุงูุตูุงุญูุงุช
- **ูุทููุจ:** Admin ููุท
- **RLS:** ููุนูู ุนูู ุฌุฏูู `platform_wallet_transfers`
- **ุงูุฏุงูุฉ:** SECURITY DEFINER (ุชุนูู ุจุตูุงุญูุงุช ุงููุธุงู)

---

## ุงูุชุญุณููุงุช ุงููุณุชูุจููุฉ (ุงุฎุชูุงุฑู)

### 1. ุงูุชุญุฏูุซ ุงูุชููุงุฆู
```typescript
// ุฅุถุงูุฉ polling ูู 30 ุซุงููุฉ
useEffect(() => {
  const interval = setInterval(() => {
    loadData();
  }, 30000);
  return () => clearInterval(interval);
}, []);
```

### 2. WebSocket ููุชุญุฏูุซ ุงูููุฑู
```typescript
// ุงุณุชูุงุน ูุชุญุฏูุซุงุช ูู ุงูููุช ุงููุนูู
supabase
  .channel('wallet_updates')
  .on('postgres_changes',
    { event: 'INSERT', schema: 'public', table: 'platform_wallet_transfers' },
    () => loadData()
  )
  .subscribe();
```

### 3. ุฅุดุนุงุฑุงุช Push
```typescript
// ุฅุฑุณุงู ุฅุดุนุงุฑ ุนูุฏ ุชุญููู ุฌุฏูุฏ
if (result.success) {
  showNotification('ุชู ุฅุถุงูุฉ ุชุญููู ุฌุฏูุฏ ููุญูุธุฉ ุงูุฃุฑุจุงุญ');
}
```

---

## ุงูููุฎุต

### ุงููุดููุฉ ุงูุฃุตููุฉ โ
1. ุงูุจูุงูุงุช ููุฌูุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ููู ูุง ุชุธูุฑ ูู ุงููุงุฌูุฉ ุจุฏูู refresh
2. ุฎุทุฃ ูู ุงุณุชุนูุงู Supabase: `column farms_1.name does not exist`

### ุงูุณุจุจ ุงูุฌุฐุฑู โ
1. **ูุดููุฉ UX**: ุตูุญุฉ ูุญูุธุฉ ุงูุฃุฑุจุงุญ ูุง ุชูุญุฏูุซ ููุณูุง ุชููุงุฆูุงู
2. **ุฎุทุฃ ูู ุงูุงุณุชุนูุงู**: ุงูููุฏ ูุทูุจ ุนููุฏ `name` ูู ุฌุฏูู `farms`ุ ููู ุงูุฌุฏูู ูุญุชูู ููุท ุนูู `name_ar` ู `name_en`

### ุงูุญู ุงููุทุจู โ
1. โ ุฒุฑ ุชุญุฏูุซ ูุฏูู ูู ูุญูุธุฉ ุงูุฃุฑุจุงุญ
2. โ ุฑุณุงูุฉ ูุฌุงุญ ููุตูุฉ ูุน ุฅุฑุดุงุฏุงุช
3. โ ูุนุงูุฌุฉ ุฃูุถู ููุฃุฎุทุงุก ูุงูุจูุงูุงุช ุงููุงุฑุบุฉ
4. โ ุณุฌูุงุช ุชุดุฎูุตูุฉ ูู console
5. โ ุชุญุณูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู
6. โ **ุฅุตูุงุญ ุงุณุชุนูุงู Supabase**: ุชุบููุฑ `farms:farm_id(name, name_ar)` ุฅูู `farms:farm_id(name_ar)`

### ุงูุฅุตูุงุญ ุงูุฅุถุงูู: ุฎุทุฃ ุงุณู ุงูุนููุฏ ๐ง

**ุงูููู ุงููุนุฏูู:** `src/services/platformWalletService.ts`

**ูุจู:**
```typescript
farms:farm_id(name, name_ar)  // โ ุนููุฏ name ุบูุฑ ููุฌูุฏ
```

**ุจุนุฏ:**
```typescript
farms:farm_id(name_ar)  // โ ุงุณุชุฎุฏุงู ุงูุนููุฏ ุงูุตุญูุญ
```

**ุงูุชุญูู ูู ุจููุฉ ุงูุฌุฏูู:**
```sql
SELECT column_name FROM information_schema.columns
WHERE table_name = 'farms';
-- ุงููุชูุฌุฉ: name_ar โ, name_en โ, name โ (ุบูุฑ ููุฌูุฏ)
```

### ุงููุชูุฌุฉ ุงูููุงุฆูุฉ ๐
ุงูุขู ูููู ูููุณุคูู:
- ุชูููุฐ ุงูุชุญููู ุจูุฌุงุญ โ
- ุฑุคูุฉ ุฑุณุงูุฉ ุชูุตูููุฉ ูุงุถุญุฉ โ
- ุงูุงูุชูุงู ููุญูุธุฉ ุงูุฃุฑุจุงุญ โ
- ุชุญุฏูุซ ุงูุจูุงูุงุช ุจุฒุฑ ูุงุญุฏ โ
- ูุฑุงุฌุนุฉ ุฌููุน ุงูุชุญูููุงุช ุจุณูููุฉ โ
- ุนุฑุถ ุงุณู ุงููุฒุฑุนุฉ ุจุดูู ุตุญูุญ โ
