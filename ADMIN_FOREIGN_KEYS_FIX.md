# ุฅุตูุงุญ ุงูููุงุชูุญ ุงูุฃุฌูุจูุฉ ููุฃุฏูู

## ๐ ุงููุดููุฉ

ุนูุฏ ูุญุงููุฉ ุฅุถุงูุฉ ุนูููุฉ ุฒุฑุงุนูุฉ ูู ูุณู "ูุฒุฑุนุชู"ุ ุธูุฑ ุงูุฎุทุฃ:

```
409 Conflict - Foreign Key Constraint Violation
Key is not present in table: agricultural_operations_performed_by_fkey
```

---

## ๐ ุงูุณุจุจ ุงูุฌุฐุฑู

### ุงูุจููุฉ ุงููุฏููุฉ (ุงูุฎุงุทุฆุฉ):
```
ุงูููุฏ ูุฑุณู: auth.uid() โ admins.user_id
ููู ุงูุฌุฏูู ูุชููุน: admins.id
```

ูุซุงู:
- `auth.uid()` = `bfaef5ae-f1f8-4a1f-aa6a-752b2e116371` (user_id)
- `admins.id` = `5cb18491-ef24-41bd-8c1e-290bf68416c4` (UUID ุนุดูุงุฆู)
- โ **ุนุฏู ุชุทุงุจู!**

### ุงููุดููุฉ ุงููููููุฉ:
ุฌููุน ุงูุฌุฏุงูู ูุงูุช ุชุดูุฑ ุฅูู `admins.id` ุจุฏูุงู ูู `admins.user_id`ุ ููุง ูุณุจุจ:
- ุฎุทุฃ Foreign Key Constraint ุนูุฏ ุงูุฅุถุงูุฉ
- ุนุฏู ุงููุฏุฑุฉ ุนูู ุชุชุจุน ูู ูุงู ุจุงูุนูููุฉ

---

## โ ุงูุญู ุงููุทุจู

### 1๏ธโฃ ุฅุถุงูุฉ UNIQUE Constraint ุนูู user_id

```sql
ALTER TABLE admins
  ADD CONSTRAINT admins_user_id_unique UNIQUE (user_id);
```

**ุงูุณุจุจ:** ุญุชู ูููู ููููุงุชูุญ ุงูุฃุฌูุจูุฉ ุงูุฅุดุงุฑุฉ ุฅูู `user_id`.

### 2๏ธโฃ ุชุญุฏูุซ ุฌููุน ุงูููุงุชูุญ ุงูุฃุฌูุจูุฉ

ุชู ุชุญุฏูุซ **14 ููุฏ ูุฑุฌุนู** ูู `admins.id` ุฅูู `admins.user_id`:

| ุงูุฌุฏูู | ุงูุญูู | ุงููุตู |
|--------|------|-------|
| `agricultural_operations` | `performed_by` | ูู ูุงู ุจุงูุนูููุฉ ุงูุฒุฑุงุนูุฉ |
| `agricultural_documentation` | `uploaded_by` | ูู ุฑูุน ุงููุณุชูุฏ |
| `agricultural_experience_content` | `updated_by` | ูู ุญุฏุซ ุงููุญุชูู |
| `investment_experience_content` | `updated_by` | ูู ุญุฏุซ ุงููุญุชูู |
| `admin_farm_assignments` | `admin_id` | ูุนุฑู ุงูุฃุฏูู |
| `admin_farm_assignments` | `assigned_by` | ูู ูุงู ุจุงูุชุนููู |
| `admin_logs` | `admin_id` | ูุนุฑู ุงูุฃุฏูู ูู ุงูุณุฌูุงุช |
| `farm_tasks` | `assigned_to` | ุงููุนููู ูู |
| `farm_tasks` | `assigned_by` | ูู ูุงู ุจุงูุชุนููู |
| `investor_messages` | `sender_id` | ูู ุฃุฑุณู ุงูุฑุณุงูุฉ |
| `messaging_providers` | `created_by` | ูู ุฃูุดุฃ ุงููุฒูุฏ |
| `messaging_providers` | `updated_by` | ูู ุญุฏุซ ุงููุฒูุฏ |
| `payment_transactions` | `approved_by` | ูู ูุงูู ุนูู ุงูุฏูุนุฉ |
| `reservations` | `approved_by` | ูู ูุงูู ุนูู ุงูุญุฌุฒ |

### 3๏ธโฃ ุงูููุฏ ุงูุขู ูุนูู ุจุดูู ุตุญูุญ

```typescript
const { data: { user } } = await supabase.auth.getUser();

const payload = {
  ...formData,
  farm_id: selectedFarmId,
  performed_by: user?.id,  // โ ุงูุขู ูุทุงุจู admins.user_id
  photos: [],
};
```

---

## ๐ฏ ุงูููุงุฆุฏ

### 1. ููุทููุฉ ุงูุจููุฉ ุงููุนูุงุฑูุฉ
- `user_id` ูู ุงููุนุฑู ุงูุญูููู ูู `auth.users`
- ูุฑุจุท ูุจุงุดุฑุฉ ุจูู `admins` ู `auth.users`
- ูุง ุญุงุฌุฉ ูุนูู JOIN ุฅุถุงูู

### 2. ุงูุจุณุงุทุฉ ูู ุงูููุฏ
- ูุง ุญุงุฌุฉ ูุฌูุจ `admins.id` ูุจู ูู ุนูููุฉ
- ุงุณุชุฎุฏุงู `auth.uid()` ูุจุงุดุฑุฉ
- ููุฏ ุฃูู ูุฃุจุณุท

### 3. ุงูุฃูุงู
- ุชุชุจุน ุฏููู ููู ูุงู ุจูู ุนูููุฉ
- ุฑุจุท ูุจุงุดุฑ ูุน ุญุณุงุจ ุงููุณุชุฎุฏู
- ูุง ูููู ุงูุชูุงุนุจ ุจุงูุจูุงูุงุช

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### 1๏ธโฃ ุชุณุฌูู ุฏุฎูู ุงูุฃุฏูู

```
ุงูุจุฑูุฏ: admin@dev.com
ูููุฉ ุงููุฑูุฑ: Admin@123
```

ุฃู:
```
ุงูุจุฑูุฏ: ibrahimalhebr1@gmail.com
ูููุฉ ุงููุฑูุฑ: [ูููุฉ ูุฑูุฑู]
```

### 2๏ธโฃ ุงุฎุชุจุงุฑ ุงูุนูููุงุช ุงูุฒุฑุงุนูุฉ

1. ุงุฐูุจ ุฅูู: **ููุญุฉ ุงูุชุญูู** โ **ูุฒุฑุนุชู** โ **ุงููุณุงุฑ ุงูุฒุฑุงุนู**
2. ุงุฎุชุฑ ูุฒุฑุนุฉ
3. ุงูุชุญ ุชุจููุจ "ุงูุนูููุงุช ุงูุฒุฑุงุนูุฉ"
4. ุงุถุบุท "ุฅุถุงูุฉ ุนูููุฉ"
5. ุงููุฃ ุงูุจูุงูุงุช ูุงุถุบุท "ุฅุถุงูุฉ"
6. โ **ุณูุชู ุงูุฅุถุงูุฉ ุจูุฌุงุญ ุจุฏูู ุฃุฎุทุงุก 409!**

### 3๏ธโฃ ุงุฎุชุจุงุฑ ุงูุชุจููุจุงุช ุงูุฃุฎุฑู

ุฌููุน ุงูุชุจููุจุงุช ุงูุชุงููุฉ ุงูุขู ุชุนูู:

**ุงููุณุงุฑ ุงูุฒุฑุงุนู:**
- โ ุฎุฑูุทุฉ ุงูุฃุดุฌุงุฑ
- โ ูุฑุงุญู ุงูููู
- โ ุงูุนูููุงุช ุงูุฒุฑุงุนูุฉ
- โ ุงูุชูุซูู
- โ ุจุงูู ุงูุชุฌุฑุจุฉ

**ุงููุณุงุฑ ุงูุงุณุชุซูุงุฑู:**
- โ ุญุงูุฉ ุงูุงุณุชุซูุงุฑ
- โ ุงูุฃุตูู ุงูุฒุฑุงุนูุฉ
- โ ุงูููุชุฌุงุช
- โ ุงููุฎููุงุช
- โ ูุฑุต ุงูุชูุณุน
- โ ุจุงูู ุงูุชุฌุฑุจุฉ

---

## ๐ ุงูุชุบููุฑุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

### Migration 1: `add_unique_constraint_to_admins_user_id.sql`
ุฅุถุงูุฉ UNIQUE constraint ุนูู `admins.user_id`.

### Migration 2: `fix_admin_foreign_keys_to_use_user_id_v2.sql`
ุชุญุฏูุซ ุฌููุน ุงููููุฏ ุงููุฑุฌุนูุฉ (14 ููุฏ).

---

## ๐ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

โ **14 ููุฏ ูุฑุฌุนู** ุชู ุฅุตูุงุญู

โ **ุฌููุน ุงูุชุจููุจุงุช** ุชุนูู ุจููุงุกุฉ

โ **ุตูุฑ ุฃุฎุทุงุก 409** ูู ุฌููุน ุงูุนูููุงุช

โ **ุจููุฉ ูุนูุงุฑูุฉ ุตุญูุญุฉ** ูููุทููุฉ

---

## ๐ก ููุงุญุธุงุช ูููุฉ

### 1. ุงูุชูุงูู ูุน ุงูุจูุงูุงุช ุงููุฏููุฉ
- ูุญุณู ุงูุญุธุ ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ ูุงูุช ุชุณุชุฎุฏู `user_id` ุจุงููุนู
- ูู ูุญุชุฌ ูุชุญุฏูุซ ุฃู ุจูุงูุงุช ููุฌูุฏุฉ
- ุงูุฅุตูุงุญ ูุงู ููุท ูู ุงูุจููุฉ

### 2. ุงูุญุณุงุจุงุช ุงููุชุฃุซุฑุฉ
- โ `ibrahimalhebr1@gmail.com` (admin_id = user_id)
- โ `admin@dev.com` (user_id ูุฎุชูู ุนู admin_id ููู ูุง ุชูุฌุฏ ุจูุงูุงุช)

### 3. ุงููุณุชูุจู
- ุฃู ููุฏ ุฌุฏูุฏ ูุณุชุฎุฏู `auth.uid()` ุณูุนูู ูุจุงุดุฑุฉ
- ูุง ุญุงุฌุฉ ููุนุงูุฌุฉ ุฎุงุตุฉ
- ุงูุจููุฉ ุงูุขู ูุชุณูุฉ ูููุทููุฉ

---

**ุชุงุฑูุฎ ุงูุฅุตูุงุญ:** 2026-02-04
**ุนุฏุฏ ุงููููุฏ ุงูููุญุฏุซุฉ:** 14 ููุฏ ูุฑุฌุนู
**ุนุฏุฏ ุงูู Migrations:** 2 ูููุงุช migration
**ุงูุญุงูุฉ:** โ ููุชูู ููุฎุชุจุฑ
