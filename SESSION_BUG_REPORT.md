# ุชูุฑูุฑ ูุญุต ูุดููุฉ ุงูุฌูุณุฉ ุงูุนุงุฌู

## ุงูุชุงุฑูุฎ: 2026-02-03
## ุงูุฃููููุฉ: ุญุฑุฌุฉ ๐ด

---

## 1๏ธโฃ ูุญุต ูุตุฏุฑ ุงูุฌูุณุฉ

### โ AuthProvider ูุงุญุฏ
- **ุงููููุน**: `src/main.tsx`
- **ุงูุชุบููู**: ูุบูู ุงูุชุทุจูู ุจุงููุงูู ุจุดูู ุตุญูุญ
```tsx
<AuthProvider>
  <AdminAuthProvider>
    <App />
  </AdminAuthProvider>
</AuthProvider>
```

### โ ุงุณุชุฑุฌุงุน ุงูุฌูุณุฉ ุนูุฏ Reload
- **ุงูููู**: `src/contexts/AuthContext.tsx`
- **ุงูุณุทุฑ 65**: ูุณุชุฎุฏู `supabase.auth.getSession()` ูู `useEffect`
- **ุงูุณุทุฑ 81-97**: ูุณุชูุน ูู `onAuthStateChange` ูุชุญุฏูุซ ุงูุฌูุณุฉ ุชููุงุฆูุงู
- **ุงูุฎูุงุตุฉ**: โ ุงูุฌูุณุฉ ุชูุณุชุฑุฌุน ุจุดูู ุตุญูุญ ุนูุฏ reload

---

## 2๏ธโฃ ุฅุนุฏุงุฏุงุช Supabase

### โ ุงูุชุฎุฒูู ูููุนูู ุจุดูู ุตุญูุญ
**ุงูููู**: `src/lib/supabase.ts`

```typescript
auth: {
  autoRefreshToken: true,        // โ ูุฌุฏุฏ ุงูุชููู ุชููุงุฆูุงู
  persistSession: true,          // โ ูุญูุธ ุงูุฌูุณุฉ
  detectSessionInUrl: true,      // โ ููุชุดู ุงูุฌูุณุฉ ูู URL
  storageKey: 'farm-investment-auth',  // โ ููุชุงุญ ูุฎุตุต
  storage: window.localStorage,  // โ localStorage
  flowType: 'pkce'              // โ ุขูู
}
```

**ุงูุฎูุงุตุฉ**: โ ุฌููุน ุงูุฅุนุฏุงุฏุงุช ุตุญูุญุฉ

---

## 3๏ธโฃ ุจุนุฏ ุงูุฏูุน

### โ ูุณุงุฑ ุงูุชุณุฌูู ูุงูุฏูุน
1. **PrePaymentRegistration** (ุงูุณุทุฑ 84-94):
   - ูุณุชุฎุฏู `supabase.auth.signUp()` ุจุดูู ุตุญูุญ
   - ูููุดุฆ ุฌูุณุฉ ุฌุฏูุฏุฉ ุชููุงุฆูุงู

2. **PaymentSuccessScreen**:
   - โ ูุง ูุชูุงุนุจ ุจุงูุฌูุณุฉ
   - โ ูุนุชูุฏ ุนูู state ูู AuthProvider

**ุงูุฎูุงุตุฉ**: โ ุงููุณุงุฑ ุณููู

---

## 4๏ธโฃ ููุน ุฅูุดุงุก ุฌูุณุฉ ุฌุฏูุฏุฉ

### โ ูุง ููุฌุฏ ุชุฏุงุฎู
- PrePaymentRegistration ูุชุญูู ูู `if (user)` ูุจู ุงูุนุฑุถ
- ูุง ููุฌุฏ signIn/signUp ูุชุนุฏุฏ ูู ููุณ ุงููุณุงุฑ

**ุงูุฎูุงุตุฉ**: โ ูุง ููุฌุฏ ุชุฏุงุฎู

---

## 5๏ธโฃ ุงุฎุชุจุงุฑ ุงูุชุฎุฒูู

### โ localStorage
- **ุงูููุชุงุญ**: `farm-investment-auth`
- **ุงูุจูุงูุงุช ุงููุญููุธุฉ**: session, user, access_token, refresh_token
- **ุงูุฎูุงุตุฉ**: โ ุงูุชุฎุฒูู ูุนูู

---

## ๐ด ุงููุดููุฉ ุงูุญููููุฉ ุงูููุชุดูุฉ

### AdminAuthContext ูุฎุฑุฌ ุงููุณุชุฎุฏููู ุงูุนุงุฏููู!

**ุงูููู**: `src/contexts/AdminAuthContext.tsx`

#### ุงููุดููุฉ:
ุนูุฏ ุชุญููู ุงูุตูุญุฉุ ูุชู ุชุดุบูู `checkAdminSession()` ูู AdminAuthContext:

```typescript
// ุงูุณุทุฑ 28-70
const checkAdminSession = async () => {
  const { data: { session } } = await supabase.auth.getSession();

  if (!session) {
    return; // ูุง ูุดููุฉ ููุง
  }

  // ููุญุต ุฅุฐุง ูุงู ุงููุณุชุฎุฏู admin
  const { data: adminRecord, error: adminError } = await supabase
    .from('admins')
    .select('*')
    .eq('user_id', session.user.id)
    .maybeSingle();

  if (adminError || !adminRecord) {
    // ๐ด ุงููุดููุฉ ููุง!
    await supabase.auth.signOut(); // ุงูุณุทุฑ 48
    setAdmin(null);
    return;
  }
}
```

#### ุงูุณููุงุฑูู:
1. โ ุงููุณุชุฎุฏู ูุณุฌู (investor)
2. โ ูุฏูุน ุจูุฌุงุญ
3. โ ููุชุญ ุญุณุงุจู
4. โ ูุบูู ุงููุชุตูุญ
5. โ ููุชุญ ุงููููุน ูุฑุฉ ุฃุฎุฑู
6. โ AdminAuthContext ููุญุต ุงูุฌูุณุฉ
7. โ ูุฌุฏ ุฃู ุงููุณุชุฎุฏู ููุณ admin
8. โ ูุณุชุฏุนู `signOut()` โ ุงููุณุชุฎุฏู ูุฎุฑุฌ ูู ุงูุญุณุงุจ!

#### ููุณ ุงููุดููุฉ ูู:
- **ุงูุณุทุฑ 97**: ุนูุฏ ุฎุทุฃ ูู ุงูุงุณุชุนูุงู
- **ุงูุณุทุฑ 102**: ุนูุฏ ุนุฏู ูุฌูุฏ admin record

---

## ๐ฏ ุงูุญู ุงููุทููุจ

### ูุฌุจ ุชุนุฏูู AdminAuthContext:

#### ุงูุฎุทุฃ ุงูุญุงูู:
```typescript
if (adminError || !adminRecord) {
  await supabase.auth.signOut(); // โ ูุฎุฑุฌ ูู ุงููุณุชุฎุฏููู!
  setAdmin(null);
}
```

#### ุงูุญู ุงูุตุญูุญ:
```typescript
if (adminError || !adminRecord) {
  // โ ูุง ูุฎุฑุฌ ุงููุณุชุฎุฏูุ ููุท ูุชุฌุงูู ุงูู admin session
  sessionStorage.removeItem('admin_session');
  setAdmin(null);
  // โ ุงููุณุชุฎุฏู ุงูุนุงุฏู ูุจูู ูุณุฌู ูู AuthContext
}
```

---

## ๐ ุฎุทุฉ ุงูุฅุตูุงุญ

### ุงูุฎุทูุฉ 1: ุชุนุฏูู AdminAuthContext
- ุฅุฒุงูุฉ `signOut()` ูู checkAdminSession
- ุฅุฒุงูุฉ `signOut()` ูู login ุนูุฏ ุนุฏู ูุฌูุฏ admin record
- ุงูุงุญุชูุงุธ ุจู `signOut()` ููุท ูู logout

### ุงูุฎุทูุฉ 2: ุงุฎุชุจุงุฑ ุงูุณููุงุฑูู ุงููุงูู
1. ุชุณุฌูู ูุณุชุฎุฏู ุฌุฏูุฏ
2. ุฅููุงู ุงูุฏูุน
3. ูุชุญ ุงูุญุณุงุจ
4. ุฅุบูุงู ุงููุชุตูุญ
5. ูุชุญ ุงููููุน ูุฑุฉ ุฃุฎุฑู
6. โ ูุฌุจ ุฃู ูููู ูุณุฌู ุงูุฏุฎูู

### ุงูุฎุทูุฉ 3: ุงุฎุชุจุงุฑ Admin
1. ุชุณุฌูู ุฏุฎูู admin
2. ุฅุบูุงู ุงููุชุตูุญ
3. ูุชุญ ุงููููุน
4. โ ูุฌุจ ุฃู ูููู admin ูุณุฌู

---

## โ ูุนุงููุฑ ุงููุฌุงุญ

ุงูุฌูุณุฉ ุชูุนุชุจุฑ ุซุงุจุชุฉ 100% ุนูุฏูุง:

1. โ ุญุฌุฒ โ ุฏูุน โ ุฅุบูุงู โ ูุชุญ = ูุณุฌู ุฏุฎูู
2. โ admin login โ ุฅุบูุงู โ ูุชุญ = admin ูุณุฌู
3. โ investor login โ ุฅุบูุงู โ ูุชุญ = investor ูุณุฌู
4. โ ูุง ููุฌุฏ signOut ุบูุฑ ููุตูุฏ ูู ุฃู ููุงู

---

## ๐ ุงูุฎูุงุตุฉ

**ุงููุธุงู ููุตูู ุจุดูู ุตุญูุญ** โ
- AuthProvider โ
- Supabase config โ
- localStorage โ
- Session persistence โ

**ุงููุดููุฉ ุงููุญูุฏุฉ** โ
- AdminAuthContext ูุฎุฑุฌ ุงููุณุชุฎุฏููู ุงูุนุงุฏููู

**ุงูุญู** ๐ฏ
- ุฅุฒุงูุฉ `signOut()` ูู checkAdminSession
- ุฅุฒุงูุฉ `signOut()` ูู ูุญุต admin ูู login
- ุงูุงุญุชูุงุธ ููุท ุจู logout ููู admin

---

## ุงูุชุฃุซูุฑ

**ูุจู ุงูุฅุตูุงุญ**:
- ูู ูุณุชุฎุฏู ุนุงุฏู ูุฎุฑุฌ ูู ุญุณุงุจู ุนูุฏ reload

**ุจุนุฏ ุงูุฅุตูุงุญ**:
- ุงููุณุชุฎุฏููู ุงูุนุงุฏููู ูุจููู ูุณุฌููู
- Admins ูุจููู ูุณุฌููู
- ุงูุฌูุณุฉ ุซุงุจุชุฉ 100%

---

## ุงูุฃููููุฉ: ุญุฑุฌุฉ ๐ด
**ูุฌุจ ุงูุฅุตูุงุญ ูุจู ุฃู ุชุทููุฑ ุขุฎุฑ**
