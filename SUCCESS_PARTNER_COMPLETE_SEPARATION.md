# ูุตู ุญุณุงุจ ุดุฑูู ุงููุฌุงุญ - ุงูุชูููุฐ ุงููุงูู

## ุงููุดููุฉ ุงูุชู ุชู ุญููุง

ูุงู ููุงู ุชุฏุงุฎู ุฎุงุทุฆ ุจูู:
- โ ุญุณุงุจ ุดุฑูู ุงููุฌุงุญ (Success Partner)
- โ ุญุณุงุจ ุงูุนููู/ุงููุณุชุซูุฑ (ุฃุดุฌุงุฑู ุงูุฎุถุฑุงุก / ุงูุฐูุจูุฉ)
- โ ุฑุจุท ุฎุงุทุฆ ุจูู ุดุฑูู ุงููุฌุงุญ ูุฒุฑ "ุฃุดุฌุงุฑู"

## ุงูุญู ุงููุทุจู

ุชู ูุตู ุงูุญุณุงุจุงุช **ุชูุงูุงู** ูุชุทุจูู ุงููุงุนุฏุฉ ุงูุชุงููุฉ:

### ูุงุนุฏุฉ ุงููุตู ุงูุชุงู

**ุญุณุงุจ ุดุฑูู ุงููุฌุงุญ:**
- โ ูุณุชูู ุชูุงูุงู
- โ ูุง ูุชุฏุงุฎู ูุน ุฃู ูุณุงุฑ ูู ูุณุงุฑุงุช ุงูุฃุดุฌุงุฑ
- โ ูุง ูุฑู ุฃู ุจูุงูุงุช ุชุดุบูููุฉ ุฃู ูุงููุฉ
- โ ูุฑู ููุท: ุงููุดุฑุ ุงูููุงูุขุชุ ุงูุฃุซุฑ

**ุฏูุฑู ุงููุญูุฏ:**
- ูุดุฑ ุงูููุตุฉ ุนุจุฑ ุงุณูู ุฃู ุฑุงุจุทู
- ุชุชุจุน ุงูุญุฌูุฒุงุช ุงููุงุชุฌุฉ ุนูู
- ูุณุจ ุงูููุงูุขุช

---

## ุงููููุงุช ุงูุฌุฏูุฏุฉ

### 1. SuccessPartnerAccount.tsx

ุตูุญุฉ ูุงููุฉ ูููุตูุฉ ูุญุณุงุจ ุดุฑูู ุงููุฌุงุญ ุชุญุชูู ุนูู:

```tsx
- ุจุทุงูุฉ ูููุฉ ุดุฑูู ุงููุฌุงุญ (ููู ุฐูุจู/ููุฑูุงูู)
- ููุญุฉ ุดุฑูู ุงููุณูุฑุฉ (InfluencerDashboard)
- ูุง ุชูุฌุฏ ุฃู ุนููุฏ ุฃู ุฃุดุฌุงุฑ ุฃู ุตูุงูุฉ
```

**ุงูุจูุงูุงุช ุงููุนุฑูุถุฉ:**
- ุงูุฃุดุฌุงุฑ ุงูููุชุณุจุฉ (ุงูููุงูุขุช)
- ุงูุญุฌูุฒุงุช ุงููุงุฌุญุฉ
- ุงูุชูุฏู ูุญู ุงูููุงูุฃุฉ ุงูุชุงููุฉ
- ุฃุฏูุงุช ุงููุดุฑ (ุงุณููุ ุฑุงุจุทู)
- ุณุฌู ุงููุดุงุท (ุงูุญุฌูุฒุงุช ุงููุญุงูุฉ)

### 2. AccountTypeSelector.tsx

ูููู ูุนุฑุถ ุฎูุงุฑูู ูููุณุชุฎุฏู ุนูุฏูุง ูููู ุญุณุงุจูู:

```tsx
- ุฒุฑ "ุฃุดุฌุงุฑู ุงูุฎุถุฑุงุก/ุงูุฐูุจูุฉ" โ ููุชุญ ุญุณุงุจ ุงูุนููู
- ุฒุฑ "ุญุณุงุจ ุดุฑูู ุงููุฌุงุญ" โ ููุชุญ ุญุณุงุจ ุดุฑูู ุงููุฌุงุญ
```

**ุงูุฑุณุงูุฉ ุงููุนุฑูุถุฉ:**
> "ุงูุญุณุงุจุงู ูููุตูุงู ุชูุงูุงู - ููู ุญุณุงุจ ุจูุงูุงุชู ุงูุฎุงุตุฉ"

---

## ุงููููุงุช ุงููุนุฏูุฉ

### 1. AccountProfile.tsx

**ุงูุชุนุฏููุงุช:**
```diff
- import InfluencerDashboard from './InfluencerDashboard';
- import { influencerMarketingService } from '../services/influencerMarketingService';
- const [isInfluencer, setIsInfluencer] = useState(false);

- {isInfluencer && (
-   <div className="mb-6">
-     <InfluencerDashboard />
-   </div>
- )}
```

**ุงููุชูุฌุฉ:**
- โ ุชู ุฅุฒุงูุฉ `InfluencerDashboard` ูู ุญุณุงุจ ุงูุนููู
- โ ูุง ููุฌุฏ ุฃู ููุทู ูุชุนูู ุจุดุฑูุงุก ุงููุฌุงุญ
- โ ูุฑูุฒ ููุท ุนูู ุงูุนููุฏ ูุงูุฃุดุฌุงุฑ

### 2. App.tsx

**ุงูุชุนุฏููุงุช:**

#### ุฃ. Imports ุฌุฏูุฏุฉ
```typescript
import SuccessPartnerAccount from './components/SuccessPartnerAccount';
import AccountTypeSelector from './components/AccountTypeSelector';
```

#### ุจ. State variables ุฌุฏูุฏุฉ
```typescript
const [showSuccessPartnerAccount, setShowSuccessPartnerAccount] = useState(false);
const [showAccountTypeSelector, setShowAccountTypeSelector] = useState(false);
```

#### ุฌ. ุชุนุฏูู handleMyFarmClick
```typescript
const handleMyFarmClick = async () => {
  // ... existing code ...

  // ุงูุชุญูู ูู ููุน ุงููุณุชุฎุฏู
  const { influencerMarketingService } = await import('./services/influencerMarketingService');
  const isInfluencer = await influencerMarketingService.checkIfUserIsInfluencer();

  if (isInfluencer) {
    console.log('โญ [Footer Button] User is a Success Partner');
    setShowSuccessPartnerAccount(true);  // ูุชุญ ุญุณุงุจ ุดุฑูู ุงููุฌุงุญ
  } else {
    console.log(`โ [Footer Button] Opening My Trees for user`);
    setShowMyTrees(true);  // ูุชุญ ุญุณุงุจ ุงูุนููู ุงูุนุงุฏู
  }
};
```

#### ุฏ. ุนุฑุถ ุงูููููุงุช ุงูุฌุฏูุฏุฉ
```tsx
<SuccessPartnerAccount
  isOpen={showSuccessPartnerAccount}
  onClose={() => setShowSuccessPartnerAccount(false)}
/>

<AccountTypeSelector
  isOpen={showAccountTypeSelector}
  identity={identity}
  onClose={() => setShowAccountTypeSelector(false)}
  onSelectCustomerAccount={() => {
    setShowAccountTypeSelector(false);
    setShowMyTrees(true);
  }}
  onSelectPartnerAccount={() => {
    setShowAccountTypeSelector(false);
    setShowSuccessPartnerAccount(true);
  }}
/>
```

### 3. Migration: fix_influencer_partners_rls_for_unified_registration.sql

**ุงููุดููุฉ ุงููุญูููุฉ:**
```sql
-- โ ุงูุณูุงุณุฉ ุงููุฏููุฉ
WITH CHECK (
  status = 'pending'  -- ููุท pending
)

-- โ ุงูุณูุงุณุฉ ุงูุฌุฏูุฏุฉ
WITH CHECK (
  user_id = auth.uid()
  AND phone IS NOT NULL
  AND name IS NOT NULL
  AND status IN ('pending', 'active')  -- ูุณูุญ ุจุงูุงุซููู
)
```

**ุงููุชูุฌุฉ:**
- โ ุชู ุฅุตูุงุญ ุฎุทุฃ 403 Forbidden ุนูุฏ ุงูุชุณุฌูู
- โ ูููู ูููุณุชุฎุฏููู ุงููุตุงุฏู ุนูููู ุงูุชุณุฌูู ูุดุฑูุงุก ูุฌุงุญ
- โ ุชูุนูู ููุฑู (status = 'active')

---

## ููุทู ุงูุชุดุบูู

### ุณููุงุฑูู 1: ูุณุชุฎุฏู ุดุฑูู ูุฌุงุญ ููุท

```
ุงููุณุชุฎุฏู ูุถุบุท ุนูู ุฒุฑ "ุฃุดุฌุงุฑู"
  โ
ุงููุธุงู ูุชุญูู: ูู ูู ุดุฑูู ูุฌุงุญุ โ ูุนู
  โ
ููุชุญ: SuccessPartnerAccount
  โ
ูุนุฑุถ: ููุญุฉ ุดุฑูู ุงููุณูุฑุฉ (ุงูููุงูุขุชุ ุงููุดุฑุ ุงูุฃุซุฑ)
```

### ุณููุงุฑูู 2: ูุณุชุฎุฏู ุนููู ููุท

```
ุงููุณุชุฎุฏู ูุถุบุท ุนูู ุฒุฑ "ุฃุดุฌุงุฑู"
  โ
ุงููุธุงู ูุชุญูู: ูู ูู ุดุฑูู ูุฌุงุญุ โ ูุง
  โ
ููุชุญ: MyTrees (ุงูุนููุฏ ูุงูุฃุดุฌุงุฑ)
  โ
ูุนุฑุถ: ุงูุนููุฏุ ุงูุตูุงูุฉุ ุงูุฑุณูู
```

### ุณููุงุฑูู 3: ูุณุชุฎุฏู ูุฏูู ุญุณุงุจุงู (ูุณุชูุจูู)

```
ุงููุณุชุฎุฏู ูุถุบุท ุนูู ุฒุฑ "ุฃุดุฌุงุฑู"
  โ
ุงููุธุงู ูุชุญูู: ูู ูุฏูู ุญุณุงุจุงูุ โ ูุนู
  โ
ููุชุญ: AccountTypeSelector
  โ
ุฎูุงุฑุงู:
  1. ุฃุดุฌุงุฑู (ุงูุนููุฏ) โ MyTrees
  2. ุญุณุงุจ ุดุฑูู ุงููุฌุงุญ โ SuccessPartnerAccount
```

---

## ุนุฒู ุงูุจูุงูุงุช ุงููุงูู

### ุญุณุงุจ ุดุฑูู ุงููุฌุงุญ ูุฌูุจ ููุท:

```typescript
// ูู ุฌุฏูู influencer_partners
โ name (ุงุณู ุงูุดุฑูู)
โ display_name (ุงุณู ุงูุนุฑุถ)
โ total_bookings (ุนุฏุฏ ุงูุญุฌูุฒุงุช)
โ total_trees_booked (ุนุฏุฏ ุงูุฃุดุฌุงุฑ ุงููุญุงูุฉ)
โ total_rewards_earned (ุงูููุงูุขุช ุงูููุชุณุจุฉ)

// ูู ุฌุฏูู lead_activities
โ visits_count (ุนุฏุฏ ุงูุฒูุงุฑุงุช)

// ูู ุฌุฏูู influencer_rewards_details_view
โ activity_log (ุณุฌู ุงููุดุงุท)
```

### ุญุณุงุจ ุดุฑูู ุงููุฌุงุญ ูุง ูุฌูุจ ุฃุจุฏุงู:

```typescript
โ reservations (ุงูุญุฌูุฒุงุช)
โ contracts (ุงูุนููุฏ)
โ user_trees (ุงูุฃุดุฌุงุฑ)
โ maintenance_records (ุณุฌูุงุช ุงูุตูุงูุฉ)
โ maintenance_fees (ุฑุณูู ุงูุตูุงูุฉ)
โ maintenance_payments (ุณุฏุงุฏ ุงูุตูุงูุฉ)
โ financial_transactions (ุงููุนุงููุงุช ุงููุงููุฉ)
โ investment_assets (ุงูุฃุตูู ุงูุงุณุชุซูุงุฑูุฉ)
```

---

## ูุงุฌูุฉ ุญุณุงุจ ุดุฑูู ุงููุฌุงุญ

### ุจุทุงูุฉ ุงููููุฉ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ   โญ  ุดุฑูู ูุณูุฑุฉ               โ
โ   ูุญูุฏ ุฃุญูุฏ                    โ
โ   ูุดุฑ ุงูููุตุฉ ููุณุจ ุงูููุงูุขุช      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ุจุทุงูุงุช ุงูุฃุซุฑ

```
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโ
โ ุงูุฃุดุฌุงุฑ ุงูููุชุณุจุฉโ ุงูุญุฌูุฒุงุช ุงููุงุฌุญุฉโ ุงูุชูุฏู (15/20)  โ
โ      12        โ       8         โ     75%        โ
โโโโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโ
```

### ุฃุฏูุงุช ุงููุดุฑ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ููุฏู ุงูุฎุงุต: ูุญูุฏ_ุงุญูุฏ           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ [ุดุงุฑู ุจุงุณูู]  [ุดุงุฑู ุจุฑุงุจุทู]    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ุณุฌู ุงููุดุงุท

```
โโโโโโโโฌโโโโโโโโโโฌโโโโโโโโโฌโโโโโโโโโโฌโโโโโโโโโโโ
โ ุงูุชุงุฑูุฎโ ุงููุฒุฑุนุฉ โ ุงูุฃุดุฌุงุฑโ ุงูููุงูุขุชโ ุงูุชูุฏู   โ
โโโโโโโโผโโโโโโโโโโผโโโโโโโโโผโโโโโโโโโโผโโโโโโโโโโโค
โ ุงูููู โ ูุฒุฑุนุฉ A โ   10   โ   +1    โ 15/20   โ
โ ุฃูุณ  โ ูุฒุฑุนุฉ B โ    5   โ    -    โ 14/20   โ
โโโโโโโโดโโโโโโโโโโดโโโโโโโโโดโโโโโโโโโโดโโโโโโโโโโโ
```

---

## ุงูุฃูุงู ูุงูุตูุงุญูุงุช

### RLS Policies

```sql
-- โ ุดุฑูู ุงููุฌุงุญ ูุฑู ุณุฌูู ููุท
CREATE POLICY "Partners can view their own record"
  ON influencer_partners
  FOR SELECT
  TO authenticated
  USING (user_id = auth.uid());

-- โ ุงููุณุชุฎุฏููู ูููููู ุงูุชุณุฌูู ูุดุฑูุงุก ูุฌุงุญ
CREATE POLICY "Authenticated users can register as partner"
  ON influencer_partners
  FOR INSERT
  TO authenticated
  WITH CHECK (
    user_id = auth.uid()
    AND phone IS NOT NULL
    AND name IS NOT NULL
    AND status IN ('pending', 'active')
  );

-- โ ุดุฑูู ุงููุฌุงุญ ููููู ุชุญุฏูุซ ุณุฌูู
CREATE POLICY "Partners can update their own record"
  ON influencer_partners
  FOR UPDATE
  TO authenticated
  USING (user_id = auth.uid())
  WITH CHECK (user_id = auth.uid());
```

---

## ูุง ุชู ููุนู ููุงุฆูุงู

```
โ ุธููุฑ ุฃู ุจูุงูุงุช ุฃุดุฌุงุฑู ุฏุงุฎู ุญุณุงุจ ุดุฑูู ุงููุฌุงุญ
โ ุฑุจุท ุญุณุงุจ ุงูุดุฑูู ุจุฃู ูุณุงุฑ ุงุณุชุซูุงุฑู ุฃู ุฒุฑ ุฃุดุฌุงุฑู
โ ุฌูุจ ุฃู ุจูุงูุงุช ุบูุฑ ูุชุนููุฉ ุจุงููุดุฑ ูุงูุฃุซุฑ
โ ุงูุชุฏุงุฎู ุจูู ุงูุญุณุงุจูู
โ ูุดุงุฑูุฉ ุงูุจูุงูุงุช ุจูู ุงููุณุงุฑุงุช
```

---

## ุงููุฏู ุงูููุงุฆู ุงููุญูู

**ุญุณุงุจ ุดุฑูู ุงููุฌุงุญ ุฃุตุจุญ:**

โ ูุงุฌูุฉ ุฃุซุฑ ูุธููุฉ
โ ุจุณูุทุฉ ูุบูุฑ ูุฑุจูุฉ
โ ุชุฎุฏู ุงููุดุฑ ููุท
โ ูููุตูุฉ ุชูุงูุงู ุนู ุญุณุงุจ ุงูุนููู
โ ูุง ุชูุฌุฏ ุฃู ุจูุงูุงุช ุชุดุบูููุฉ ุฃู ูุงููุฉ

---

## ุงุฎุชุจุงุฑ ุงููุธุงู

### 1. ุชุณุฌูู ุดุฑูู ูุฌุงุญ ุฌุฏูุฏ

```bash
1. ุงูุชุญ ุตูุญุฉ ุงูุชุณุฌูู ูุดุฑูู ูุฌุงุญ
2. ุฃุฏุฎู:
   - ุงูุงุณู ุงูุซูุงุซู
   - ุฑูู ุงูุฌูุงู
   - ูููุฉ ุงููุฑูุฑ
3. ุงุถุบุท "ุชุณุฌูู"
4. โ ูุฌุจ ุฃู ูุชู ุงูุชุณุฌูู ุจูุฌุงุญ
5. โ ุชุณุฌูู ุฏุฎูู ุชููุงุฆู
```

### 2. ุงูุฏุฎูู ูุญุณุงุจ ุดุฑูู ุงููุฌุงุญ

```bash
1. ุณุฌู ุฏุฎูู ูุดุฑูู ูุฌุงุญ
2. ุงุถุบุท ุฒุฑ "ุฃุดุฌุงุฑู" ูู ุงูุฃุณูู
3. โ ูุฌุจ ุฃู ููุชุญ: SuccessPartnerAccount
4. โ ูุฌุจ ุฃู ูุนุฑุถ: ููุญุฉ ุดุฑูู ุงููุณูุฑุฉ
5. โ ูุง ุชูุฌุฏ: ุนููุฏ ุฃู ุฃุดุฌุงุฑ ุฃู ุตูุงูุฉ
```

### 3. ุงูุชุญูู ูู ุนุฒู ุงูุจูุงูุงุช

```bash
1. ุงูุชุญ ุญุณุงุจ ุดุฑูู ุงููุฌุงุญ
2. โ ุชุฃูุฏ ูู ุนุฏู ุธููุฑ ุฃู:
   - ุนููุฏ
   - ุฃุดุฌุงุฑ
   - ุตูุงูุฉ
   - ุฑุณูู
   - ูุนุงููุงุช ูุงููุฉ
3. โ ุชุฃูุฏ ูู ุธููุฑ ููุท:
   - ุงูููุงูุขุช
   - ุงูุญุฌูุฒุงุช ุงููุงุชุฌุฉ
   - ุฃุฏูุงุช ุงููุดุฑ
```

---

## ุงููููุงุช ุงููุชุฃุซุฑุฉ

```
โ ุงููููุงุช ุงูุฌุฏูุฏุฉ:
- src/components/SuccessPartnerAccount.tsx
- src/components/AccountTypeSelector.tsx
- supabase/migrations/fix_influencer_partners_rls_for_unified_registration.sql

โ ุงููููุงุช ุงููุนุฏูุฉ:
- src/components/AccountProfile.tsx
- src/App.tsx

โ ุงููููุงุช ุงูุชู ูู ุชุชุฃุซุฑ:
- src/components/InfluencerDashboard.tsx (ุชุณุชุฎุฏู ููุท ูู SuccessPartnerAccount)
- src/services/influencerMarketingService.ts (ูู ูุชุบูุฑ)
- Footer.tsx (ูู ูุชุบูุฑ - ุฒุฑ ุฃุดุฌุงุฑู ูุนูู ุจููุณ ุงูุทุฑููุฉ)
```

---

## ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

๐ฏ **ุชู ุชุญููู ุงููุฏู ุจุงููุงูู:**

1. โ ูุตู ุชุงู ุจูู ุญุณุงุจ ุดุฑูู ุงููุฌุงุญ ูุญุณุงุจ ุงูุนููู
2. โ ุนุฒู ูุงูู ููุจูุงูุงุช
3. โ ูุงุฌูุฉ ูุธููุฉ ูุจุณูุทุฉ ูุดุฑูู ุงููุฌุงุญ
4. โ ููุน ุฃู ุชุฏุงุฎู ุฃู ูุดุงุฑูุฉ
5. โ ุฅุตูุงุญ ูุดููุฉ RLS (403 Forbidden)

---

## ุงูุฎุทูุงุช ุงูุชุงููุฉ (ุงุฎุชูุงุฑู)

ุฅุฐุง ุฃุฑุฏุช ุชูุนูู ุงูุณููุงุฑูู 3 (ูุณุชุฎุฏู ูุฏูู ุญุณุงุจุงู):

```typescript
// ูู handleMyFarmClick
const [isInfluencer, hasReservations] = await Promise.all([
  influencerMarketingService.checkIfUserIsInfluencer(),
  // ุงูุชุญูู ูู ูุฌูุฏ ุญุฌูุฒุงุช ูููุณุชุฎุฏู
]);

if (isInfluencer && hasReservations) {
  // ูุฏูู ุญุณุงุจุงู - ุนุฑุถ AccountTypeSelector
  setShowAccountTypeSelector(true);
} else if (isInfluencer) {
  // ุดุฑูู ูุฌุงุญ ููุท
  setShowSuccessPartnerAccount(true);
} else {
  // ุนููู ููุท
  setShowMyTrees(true);
}
```

---

**ุชู ุงูุชูููุฐ ุจูุฌุงุญ** โ
**ุงูุชุงุฑูุฎ:** 2026-02-06
